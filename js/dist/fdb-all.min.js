!function(x){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=x();else if("function"==typeof define&&define.amd)define([],x);else{var h;"undefined"!=typeof window?h=window:"undefined"!=typeof global?h=global:"undefined"!=typeof self&&(h=self);h.ForerunnerDB=x()}}(function(){return function h(n,l,g){function d(a,b){if(!l[a]){if(!n[a]){var c="function"==typeof require&&require;if(!b&&c)return c(a,!0);if(e)return e(a,!0);c=Error("Cannot find module '"+a+"'");throw c.code="MODULE_NOT_FOUND",
c;}c=l[a]={exports:{}};n[a][0].call(c.exports,function(k){var A=n[a][1][k];return d(A?A:k)},c,c.exports,h,n,l,g)}return l[a].exports}for(var e="function"==typeof require&&require,b=0;b<g.length;b++)d(g[b]);return d}({1:[function(h,n,l){l=h("../lib/ForerunnerDB.Core");h("../lib/ForerunnerDB.CollectionGroup");h("../lib/ForerunnerDB.View");h("../lib/ForerunnerDB.OldView");h("../lib/ForerunnerDB.OldView.Bind");h("../lib/ForerunnerDB.Highcharts");h("../lib/ForerunnerDB.Persist");n.exports=l},{"../lib/ForerunnerDB.CollectionGroup":3,
"../lib/ForerunnerDB.Core":4,"../lib/ForerunnerDB.Highcharts":6,"../lib/ForerunnerDB.OldView":11,"../lib/ForerunnerDB.OldView.Bind":10,"../lib/ForerunnerDB.Persist":15,"../lib/ForerunnerDB.View":17}],2:[function(h,n,l){var g,d,e,b,a,f;g=h("./ForerunnerDB.Shared");var c=function(){this.init.apply(this,arguments)};c.prototype.init=function(k){this._primaryKey="_id";this._primaryIndex=new e("primary");this._primaryCrc=new e("primaryCrc");this._crcLookup=new e("crcLookup");this._name=k;this._data=[];
this._groups=[];this._metrics=new d;this._linked=0;this._debug={};this._deferQueue={insert:[],update:[],remove:[],upsert:[]};this._deferThreshold={insert:100,update:100,remove:100,upsert:100};this._deferTime={insert:1,update:1,remove:1,upsert:1};this._subsetOf(this)};g.modules.Collection=c;l=h("./ForerunnerDB.Overload");d=h("./ForerunnerDB.Metrics");e=h("./ForerunnerDB.KeyValueStore");b=h("./ForerunnerDB.Path");a=h("./ForerunnerDB.Index");f=h("./ForerunnerDB.Crc");h=g.modules.Core;c.prototype.debug=
new l([function(){return this._debug.all},function(k){if(void 0!==k){if("boolean"==typeof k){this._debug.all=k;for(var a=0;a<this._views.length;a++)this._views[a].debug(k);return this}return this._debug[k]||this._db&&this._db._debug&&this._db._debug[k]||this._debug.all}return this._debug.all},function(k,a){if(void 0!==k){if(void 0!==a){this._debug[k]=a;for(var c=0;c<this._views.length;c++)this._views[c].debug(k,a);return this}return this._debug[k]||this._db&&this._db._debug&&this._db._debug[k]}return this._debug.all}]);
c.prototype.crc=f;c.prototype.name=function(k){return void 0!==k?(this._name=k,this):this._name};c.prototype.on=new l([function(k,a){return this._listeners=this._listeners||{},this._listeners[k]=this._listeners[k]||{},this._listeners[k]["*"]=this._listeners[k]["*"]||[],this._listeners[k]["*"].push(a),this},function(k,a,c){return this._listeners=this._listeners||{},this._listeners[k]=this._listeners[k]||{},this._listeners[k][a]=this._listeners[k][a]||[],this._listeners[k][a].push(c),this}]);c.prototype.off=
new l([function(k){return this._listeners&&this._listeners[k]&&k in this._listeners&&delete this._listeners[k],this},function(k,a){var c,b;return"string"==typeof a?this._listeners&&this._listeners[k]&&this._listeners[k][a]&&delete this._listeners[k][a]:k in this._listeners&&(c=this._listeners[k]["*"],b=c.indexOf(a),-1<b&&c.splice(b,1)),this},function(k,a,c){this._listeners&&k in this._listeners&&(k=this._listeners[k][a],c=k.indexOf(c),-1<c&&k.splice(c,1))}]);c.prototype.emit=function(k,a){if(this._listeners=
this._listeners||{},k in this._listeners){if(this._listeners[k]["*"]){var c,b=this._listeners[k]["*"],f=b.length;for(c=0;f>c;c++)b[c].apply(this,Array.prototype.slice.call(arguments,1))}if(a instanceof Array&&a[0]&&a[0][this._primaryKey]){var d,e=this._listeners[k],f=a.length;for(c=0;f>c;c++)if(e[a[c][this._primaryKey]])for(b=e[a[c][this._primaryKey]].length,d=0;b>d;d++)e[a[c][this._primaryKey]][d].apply(this,Array.prototype.slice.call(arguments,1))}}return this};c.prototype.drop=function(){if(this._db&&
this._name){this.debug()&&console.log("Dropping collection "+this._name);this.emit("drop");delete this._db._collection[this._name];var k,a=[];for(k=0;k<this._groups.length;k++)a.push(this._groups[k]);for(k=0;k<a.length;k++)this._groups[k].removeCollection(this);return!0}return!1};c.prototype.primaryKey=function(k){return void 0!==k?(this._primaryKey=k,this._primaryIndex.primaryKey(k),this._rebuildPrimaryKeyIndex(),this):this._primaryKey};c.prototype._onInsert=function(k,a){this.emit("insert",k,a)};
c.prototype._onUpdate=function(k){this.emit("update",k)};c.prototype._onRemove=function(k){this.emit("remove",k)};c.prototype.db=function(k){return void 0!==k?(this._db=k,this):this._db};c.prototype.setData=function(k,a,c){if(k){var b=this._metrics.create("setData");b.start();k instanceof Array||(k=[k]);b.time("transformIn");k=this.transformIn(k);b.time("transformIn");var f=this._data;this._data=[];k.length&&(this._data=this._data.concat(k));b.time("_rebuildPrimaryKeyIndex");this._rebuildPrimaryKeyIndex(a);
b.time("_rebuildPrimaryKeyIndex");b.stop();this.emit("setData",this._data,f)}return c&&c(!1),this};c.prototype._rebuildPrimaryKeyIndex=function(k){var a,c,b,f=k&&void 0!==k.ensureKeys?k.ensureKeys:!0,d=k&&void 0!==k.violationCheck?k.violationCheck:!0,e=this._primaryIndex,h=this._primaryCrc,g=this._crcLookup,l=this._primaryKey;e.truncate();h.truncate();g.truncate();k=this._data;for(a=k.length;a--;)if(c=k[a],f&&this._ensurePrimaryKey(c),d){if(!e.uniqueSet(c[l],c))throw"Call to setData failed because your data violates the primary key unique constraint. One or more documents are using the same primary key: "+
c[this._primaryKey];}else b=JSON.stringify(c),e.set(c[l],c),h.set(c[l],b),g.set(b,c)};c.prototype._ensurePrimaryKey=function(k){void 0===k[this._primaryKey]&&(k[this._primaryKey]=this.objectId())};c.prototype.truncate=function(){return this.emit("truncate",this._data),this._data.length=0,this.deferEmit("change"),this};c.prototype.upsert=function(k,a){if(k){var c,b=this._deferQueue.upsert,f=this._deferThreshold.upsert,d={};if(k instanceof Array){if(k.length>f)return this._deferQueue.upsert=b.concat(k),
void this.processQueue("upsert",a);d=[];for(c=0;c<k.length;c++)d.push(this.upsert(k[c]));return a&&a(),d}switch(k[this._primaryKey]?(c={},c[this._primaryKey]=k[this._primaryKey],d.op=this.count(c)?"update":"insert"):d.op="insert",d.op){case "insert":d.result=this.insert(k);break;case "update":d.result=this.update(c,k)}return d}a&&a()};c.prototype.update=function(k,a,c){a=this.decouple(a);a=this.transformIn(a);this.debug()&&console.log('Updating some collection data for collection "'+this.name()+'"');
var b,f,d=this,e=this._metrics.create("update"),h=this._primaryKey,g=function(b){if(a&&void 0!==a[h]&&a[h]!=b[h]){d._primaryIndex.unSet(b[h]);var f=d._updateObject(b,a,k,c,"");if(d._primaryIndex.uniqueSet(b[h],b))return f;throw"Primary key violation in update! Key violated: "+b[h];}return d._updateObject(b,a,k,c,"")},l=this._views;if(e.start(),e.time("Retrieve documents to update"),b=this.find(k,{decouple:!1}),e.time("Retrieve documents to update"),b.length&&(e.time("Update documents"),f=b.filter(g),
e.time("Update documents"),f.length)){if(l&&l.length){this.debug("views")&&console.log("Updating views from collection: "+this.name());e.time("Inform views of update");for(b=0;b<l.length;b++)l[b].update(k,a);e.time("Inform views of update")}this._onUpdate(f);this.deferEmit("change",{type:"update",data:f})}return e.stop(),f||[]};c.prototype.updateById=function(k,a){var c={};return c[this._primaryKey]=k,this.update(c,a)};c.prototype._updateObject=function(k,a,c,f,d){a=this.decouple(a);d=d||"";"."===
d.substr(0,1)&&(d=d.substr(1,d.length-1));var e,h,g,l,n,s,m,p,q=!1,v=!1;for(m in a)if(a.hasOwnProperty(m)){if(e=!1,"$"===m.substr(0,1))switch(m){case "$inc":e=!0;for(p in a[m])if(a[m].hasOwnProperty(p)&&"$"!==p.substr(0,1)){if("number"!=typeof k[p])throw"Cannot increment field that is not a number! ("+p+")!";this._updateIncrement(k,p,a[m][p]);q=!0}break;case "$push":e=!0;for(p in a[m])if(a[m].hasOwnProperty(p)&&"$"!==p.substr(0,1)){if(!(k[p]instanceof Array))throw"Cannot push to a key that is not an array! ("+
p+")!";this._updatePush(k[p],a[m][p]);q=!0}break;case "$addToSet":e=!0;for(p in a[m])if(a[m].hasOwnProperty(p)&&"$"!==p.substr(0,1)){if(!(k[p]instanceof Array))throw"Cannot push to a key that is not an array! ("+p+")!";var t,w,y,z;h=k[p];g=h.length;v=!0;(t=f&&f.$addToSet)&&t.key?(y=!1,z=new b(t.key),w=z.value(a[m][p])[0]):(w=JSON.stringify(a[m][p]),y=!0);for(t=0;g>t;t++)if(y){if(JSON.stringify(h[t])===w){v=!1;break}}else if(w===z.value(h[t])[0]){v=!1;break}v&&(this._updatePush(k[p],a[m][p]),q=!0)}break;
case "$splicePush":e=!0;for(p in a[m])if(a[m].hasOwnProperty(p)&&"$"!==p.substr(0,1)){if(!(k[p]instanceof Array))throw"Cannot splicePush with a key that is not an array! ("+p+")!";q=a[m].$index;if(void 0===q)throw"Cannot splicePush without a $index integer value!";delete a[m][p].$index;this._updateSplicePush(k[p],q,a[m][p]);q=!0}break;case "$move":e=!0;for(p in a[m])if(a[m].hasOwnProperty(p)&&"$"!==p.substr(0,1)){if(!(k[p]instanceof Array))throw"Cannot pull from a key that is not an array! ("+p+")!";
for(g=0;g<k[p].length;g++)if(this._match(k[p][g],a[m][p])){q=a[m].$index;if(void 0===q)throw"Cannot move without a $index integer value!";this._updateSpliceMove(k[p],g,q);q=!0;break}}break;case "$pull":for(p in e=!0,a[m])if(a[m].hasOwnProperty(p)&&"$"!==p.substr(0,1)){if(!(k[p]instanceof Array))throw"Cannot pull from a key that is not an array! ("+p+")!";h=[];for(g=0;g<k[p].length;g++)this._match(k[p][g],a[m][p])&&h.push(g);for(g=h.length;g--;)this._updatePull(k[p],h[g]),q=!0}}if(".$"===m.substr(m.length-
2,2)&&(e=!0,m=m.substr(0,m.length-2),l=new b(d+"."+m),k[m]&&k[m]instanceof Array&&k[m].length)){h=[];for(g=0;g<k[m].length;g++)this._match(k[m][g],l.value(c)[0])&&h.push(g);for(g=0;g<h.length;g++)(v=this._updateObject(k[m][h[g]],a[m+".$"],c,f,d+"."+m))&&(q=!0)}if(!e)if("object"==typeof a[m])if(null!==k[m]&&"object"==typeof k[m])if(n=k[m]instanceof Array,s=a[m]instanceof Array,n||s)if(!s&&n)for(g=0;g<k[m].length;g++)(v=this._updateObject(k[m][g],a[m],c,f,d+"."+m))&&(q=!0);else this._updateProperty(k,
m,a[m]),q=!0;else(v=this._updateObject(k[m],a[m],c,f,d+"."+m))&&(q=!0);else this._updateProperty(k,m,a[m]),q=!0;else k[m]!==a[m]&&(this._updateProperty(k,m,a[m]),q=!0)}return q};c.prototype._updateProperty=function(k,a,c){this._linked?($.observable(k).setProperty(a,c),this.debug()&&console.log('ForerunnerDB.Collection: Setting data-bound document property "'+a+'" for collection "'+this.name()+'"')):(k[a]=c,this.debug()&&console.log('ForerunnerDB.Collection: Setting non-data-bound document property "'+
a+'" for collection "'+this.name()+'"'))};c.prototype._updateSpliceMove=function(k,a,c){this._linked?($.observable(k).move(a,c),this.debug()&&console.log('ForerunnerDB.Collection: Moving data-bound document array index from "'+a+'" to "'+c+'" for collection "'+this.name()+'"')):(k.splice(c,0,k.splice(a,1)[0]),this.debug()&&console.log('ForerunnerDB.Collection: Moving non-data-bound document array index from "'+a+'" to "'+c+'" for collection "'+this.name()+'"'))};c.prototype._updateSplicePush=function(k,
a,c){k.length>a?this._linked?$.observable(k).insert(a,c):k.splice(a,0,c):this._linked?$.observable(k).insert(c):k.push(c)};c.prototype._updatePush=function(a,c){this._linked?$.observable(a).insert(c):a.push(c)};c.prototype._updatePull=function(a,c){this._linked?$.observable(a).remove(c):a.splice(c,1)};c.prototype._updateIncrement=function(a,c,b){this._linked?$.observable(a).setProperty(c,a[c]+b):a[c]+=b};c.prototype.remove=function(a){var c,b,f,d;d=this._views;if(a instanceof Array){d=[];for(c=0;c<
a.length;c++)d.push(this.remove(a[c]));return d}if(c=this.find(a,{decouple:!1}),c.length){for(f=0;f<c.length;f++)b=c[f],this._removeIndex(b),b=this._data.indexOf(b),this._linked?$.observable(this._data).remove(b):this._data.splice(b,1);if(d&&d.length)for(f=0;f<d.length;f++)d[f].remove(a);this._onRemove(c);this.deferEmit("change",{type:"remove",data:c})}return c};c.prototype.removeById=function(a){var c={};return c[this._primaryKey]=a,this.remove(c)};c.prototype.deferEmit=function(){var a,c=this;this._noEmitDefer||
this._db&&(!this._db||this._db._noEmitDefer)?this.emit.apply(this,arguments):(a=arguments,this._changeTimeout&&clearTimeout(this._changeTimeout),this._changeTimeout=setTimeout(function(){c.debug()&&console.log("ForerunnerDB.Collection: Emitting "+a[0]);c.emit.apply(c,a)},100))};c.prototype.processQueue=function(a,c){var b=this._deferQueue[a],f=this._deferThreshold[a],d=this._deferTime[a];if(b.length){var e,g=this;b.length&&(e=b.length>f?b.splice(0,f):b.splice(0,b.length),this[a](e));setTimeout(function(){g.processQueue(a,
c)},d)}else c&&c()};c.prototype.insert=function(a,c,b){return"function"==typeof c?(b=c,c=this._data.length):void 0===c&&(c=this._data.length),a=this.transformIn(a),this._insertHandle(a,c,b)};c.prototype._insertHandle=function(a,c,b){var f,d;f=this._deferQueue.insert;d=this._deferThreshold.insert;var e=(this._deferTime.insert,[]),g=[],h=this._views;if(a instanceof Array){if(a.length>d)return this._deferQueue.insert=f.concat(a),void this.processQueue("insert",b);for(d=0;d<a.length;d++)f=this._insert(a[d],
c+d),!0===f?e.push(a[d]):g.push({doc:a[d],reason:f})}else f=this._insert(a,c),!0===f?e.push(a):g.push({doc:a,reason:f});if(h&&h.length)for(f=0;f<h.length;f++)h[f].insert(a,c);return this._onInsert(e,g),b&&b(),this.deferEmit("change",{type:"insert",data:e}),{inserted:e,failed:g}};c.prototype._insert=function(a,c){if(a){var b;return this._ensurePrimaryKey(a),b=this.insertIndexViolation(a),b?"Index violation in index: "+b:(this._insertIndex(a),this._linked?$.observable(this._data).insert(c,a):this._data.splice(c,
0,a),!0)}return"No document passed to insert"};c.prototype._insertIndex=function(a){var c,b=this._indexByName,f=JSON.stringify(a);this._primaryIndex.uniqueSet(a[this._primaryKey],a);this._primaryCrc.uniqueSet(a[this._primaryKey],f);this._crcLookup.uniqueSet(f,a);for(c in b)b.hasOwnProperty(c)&&b[c].insert(a)};c.prototype._removeIndex=function(a){var c,b=this._indexByName,f=JSON.stringify(a);this._primaryIndex.unSet(a[this._primaryKey]);this._primaryCrc.unSet(a[this._primaryKey]);this._crcLookup.unSet(f);
for(c in b)b.hasOwnProperty(c)&&b[c].remove(a)};c.prototype.subset=function(a,b){var f=this.find(a,b);return(new c)._subsetOf(this).primaryKey(this._primaryKey).setData(f)};c.prototype.subsetOf=function(){return this.__subsetOf};c.prototype._subsetOf=function(a){return this.__subsetOf=a,this};c.prototype.distinct=function(a,c,f){c=this.find(c,f);var d=new b(a),e={},g=[];for(f=0;f<c.length;f++)(a=d.value(c[f])[0])&&!e[a]&&(e[a]=!0,g.push(a));return g};c.prototype.decouple=function(a){return JSON.parse(JSON.stringify(a))};
c.prototype.findById=function(a,c){var b={};return b[this._primaryKey]=a,this.find(b,c)[0]};c.prototype.peek=function(a,b){var f,d,e=this._data,g=e.length,h=new c;if("string"===typeof a){for(f=0;g>f;f++)d=JSON.stringify(e[f]),-1<d.indexOf(a)&&h.insert(e[f]);return h.find({},b)}return this.find(a,b)};c.prototype.find=function(a,c){a=a||{};c=c||{};c.decouple=void 0!==c.decouple?c.decouple:!0;var f,d,e,g,h,l,r,n,s,m,p,q=this._metrics.create("find"),v=this,t=[];l=function(c){return v._match(c,a,"and")};
if(q.start(),a){if(q.time("_analyseQuery"),f=this._analyseQuery(a,c),q.time("_analyseQuery"),f.hasJoin&&f.queriesJoin){q.time("Get join collection references");for(e=0;e<f.joinsOn.length;e++)h=f.joinsOn[e],g=new b(f.joinQueries[h]),g=g.value(a)[0],this._db.collection(f.joinsOn[e]).subset(g);q.time("Get join collection references")}if(f.usesIndex.length&&(!c||c&&!c.skipIndex)?(d=f.usesIndex[0].lookup(a),q.flag("usedIndex",f.usesIndex[0])):(d=this._data.filter(l),c.sort&&(d=this.sort(c.sort,d)),q.flag("usedIndex",
!1)),c.limit&&d&&d.length>c.limit&&(d.length=c.limit,q.flag("limit",c.limit)),c.decouple&&(d=this.decouple(d),q.flag("decouple",c.decouple)),c.join){for(f=0;f<c.join.length;f++)for(h in c.join[f])if(c.join[f].hasOwnProperty(h))for(m=h,e=this._db.collection(h),l=c.join[f][h],p=0;p<d.length;p++){n={};s=g=!1;for(r in l)if(l.hasOwnProperty(r))if("$"===r.substr(0,1))switch(r){case "$as":m=l[r];break;case "$multi":g=l[r];break;case "$require":s=l[r];break;default:"$$."===r.substr(0,3)}else n[r]=(new b(l[r])).value(d[p])[0];
n=e.find(n);!s||s&&n[0]?d[p][m]=!1===g?n[0]:n:t.push(d[p])}q.flag("join",!0)}q.time("Process removal queue");for(r=0;r<t.length;r++)h=d.indexOf(t[r]),-1<h&&d.splice(h,1);if(q.time("Process removal queue"),c.transform){q.time("Transform data");for(r=0;r<d.length;r++)d.splice(r,1,c.transform(d[r]));q.time("Transform data");q.flag("transform",!0)}return q.time("Transform out data"),d=this.transformOut(d),q.time("Transform out data"),q.stop(),d.__fdbOp=q,d}return q.stop(),d=[],d.__fdbOp=q,d};c.prototype.transform=
function(a){return void 0!==a?("object"==typeof a?(void 0!==a.enabled&&(this._transformEnabled=a.enabled),void 0!==a.dataIn&&(this._transformIn=a.dataIn),void 0!==a.dataOut&&(this._transformOut=a.dataOut)):this._transformEnabled=!1===a?!1:!0,this):{enabled:this._transformEnabled,dataIn:this._transformIn,dataOut:this._transformOut}};c.prototype.transformIn=function(a){if(this._transformEnabled&&this._transformIn){if(a instanceof Array){var c,b=[];for(c=0;c<a.length;c++)b[c]=this._transformIn(a[c]);
return b}return this._transformIn(a)}return a};c.prototype.transformOut=function(a){if(this._transformEnabled&&this._transformOut){if(a instanceof Array){var c,b=[];for(c=0;c<a.length;c++)b[c]=this._transformOut(a[c]);return b}return this._transformOut(a)}return a};c.prototype.sort=function(a,c){c=c||[];var b,f,d=[];for(b in a)a.hasOwnProperty(b)&&(f={},f[b]=a[b],f.___fdbKey=b,d.push(f));return 2>d.length?this._sort(a,c):this._bucketSort(d,c)};c.prototype._bucketSort=function(a,c){var b,f,d;f=a.shift();
var e=[];if(0<a.length){c=this._sort(f,c);f=this.bucket(f.___fdbKey,c);for(d in f)f.hasOwnProperty(d)&&(b=[].concat(a),e=e.concat(this._bucketSort(b,f[d])));return e}return this._sort(f,c)};c.prototype._sort=function(a,c){var f,d=new b,e=d.parse(a,!0)[0];return d.path(e.path),f=1===e.value?function(a,c){var k=d.value(a)[0],b=d.value(c)[0];return"string"==typeof k&&"string"==typeof b?k.localeCompare(b):k>b?1:b>k?-1:0}:function(a,c){var k=d.value(a)[0],b=d.value(c)[0];return"string"==typeof k&&"string"==
typeof b?1===k.localeCompare(b)?-1:1:k>b?-1:b>k?1:0},c.sort(f)};c.prototype.bucket=function(a,c){var b,f={};for(b=0;b<c.length;b++)f[c[b][a]]=f[c[b][a]]||[],f[c[b][a]].push(c[b]);return f};c.prototype._analyseQuery=function(a,c){var b,f,d={queriesOn:[this._name],usesIndex:[],hasJoin:!1,queriesJoin:!1,joinQueries:{}},e=[],g=[];if(void 0!==a[this._primaryKey])d.usesIndex.push(this._primaryIndex);else{for(b in this._indexById)this._indexById.hasOwnProperty(b)&&this._indexById[b].match(a,c)&&d.usesIndex.push(this._indexById[b]);
d.usesIndex.sort(function(a,c){return c._keyCount-a._keyCount})}if(c.join){d.hasJoin=!0;for(b=0;b<c.join.length;b++)for(f in c.join[b])c.join[b].hasOwnProperty(f)&&(e.push(f),g.push("$as"in c.join[b][f]?c.join[b][f].$as:f));for(b=0;b<g.length;b++)(f=this._queryReferencesCollection(a,g[b],""))&&(d.joinQueries[e[b]]=f,d.queriesJoin=!0);d.joinsOn=e;d.queriesOn=d.queriesOn.concat(e)}return d};c.prototype._queryReferencesCollection=function(a,c,b){for(var f in a)if(a.hasOwnProperty(f)){if(f===c)return b&&
(b+="."),b+f;if("object"==typeof a[f])return b&&(b+="."),b+=f,this._queryReferencesCollection(a[f],c,b)}return!1};c.prototype._match=function(a,c,b){var f,d,e;f=typeof a;d=typeof c;var g=!0;if("string"!==f&&"number"!==f||"string"!==d&&"number"!==d)for(e in c){if(c.hasOwnProperty(e)){if(f=!1,"$"===e.substr(0,1))switch(e){case "$gt":if(a>c[e]){if("or"===b)return!0}else g=!1;f=!0;break;case "$gte":if(a>=c[e]){if("or"===b)return!0}else g=!1;f=!0;break;case "$lt":if(a<c[e]){if("or"===b)return!0}else g=
!1;f=!0;break;case "$lte":if(a<=c[e]){if("or"===b)return!0}else g=!1;f=!0;break;case "$exists":if(void 0===a!==c[e]){if("or"===b)return!0}else g=!1;f=!0;break;case "$or":f=!0;for(d=0;d<c[e].length;d++){if(this._match(a,c[e][d],"and"))return!0;g=!1}break;case "$and":f=!0;for(d=0;d<c[e].length;d++)if(!this._match(a,c[e][d],"and"))return!1;break;case "$in":if(!(c[e]instanceof Array))throw"Cannot use a $nin operator on a non-array key: "+e;d=c[e];var h=d.length,l=!1;for(f=0;h>f;f++)if(d[f]===a){l=!0;
break}if(l){if("or"===b)return!0}else g=!1;f=!0;break;case "$nin":if(!(c[e]instanceof Array))throw"Cannot use a $nin operator on a non-array key: "+e;d=c[e];h=d.length;l=!0;for(f=0;h>f;f++)if(d[f]===a){l=!1;break}if(l){if("or"===b)return!0}else g=!1;f=!0;break;case "$ne":if(a!=c[e]){if("or"===b)return!0}else g=!1;f=!0}if(!f&&c[e]instanceof RegExp)if(f=!0,"object"==typeof a&&void 0!==a[e]&&c[e].test(a[e])){if("or"===b)return!0}else g=!1;if(!f)if("object"==typeof c[e])if(void 0!==a[e])if(a[e]instanceof
Array&&!(c[e]instanceof Array)){f=!1;for(d=0;d<a[e].length&&!(f=this._match(a[e][d],c[e],void 0));d++);if(f){if("or"===b)return!0}else g=!1}else if(!(a[e]instanceof Array)&&c[e]instanceof Array){f=!1;for(d=0;d<c[e].length&&!(f=this._match(a[e],c[e][d],void 0));d++);if(f){if("or"===b)return!0}else g=!1}else if("object"==typeof a)if(this._match(a[e],c[e],void 0)){if("or"===b)return!0}else g=!1;else if(this._match(void 0,c[e],void 0)){if("or"===b)return!0}else g=!1;else if(c[e]&&void 0!==c[e].$exists)if(this._match(void 0,
c[e],void 0)){if("or"===b)return!0}else g=!1;else g=!1;else if(a&&a[e]===c[e]){if("or"===b)return!0}else if(a&&a[e]&&a[e]instanceof Array&&c[e]&&"object"!=typeof c[e]){f=!1;for(d=0;d<a[e].length&&!(f=this._match(a[e][d],c[e],void 0));d++);if(f){if("or"===b)return!0}else g=!1}else g=!1;if("and"===b&&!g)return!1}}else a!==c&&(g=!1);return g};c.prototype.count=function(a,c){return a?this.find(a,c).length:this._data.length};c.prototype.link=function(a,c){if(this._links=this._links||{},!this._links[c]){if($(a).length){if(!$.templates[c]){var b=
$(c);if(!b.length)throw"Unable to bind collection to target because template does not exist: "+c;$.views.templates(c,$(b[0]).html())}return $.templates[c].link(a,this._data),this._links[c]=a,this._linked++,this.debug()&&console.log('ForerunnerDB.Collection: Added binding collection "'+this.name()+'" to output target: '+a),this}throw'Cannot bind view data to output target selector "'+a+'" because it does not exist in the DOM!';}throw"Cannot create a duplicate link to the target: "+a+" with the template: "+
c;};c.prototype.unlink=function(a,c){return this._links=this._links||{},this._links[c]?($.templates[c].unlink(a),delete this._links[c],this._linked--,this.debug()&&console.log('ForerunnerDB.Collection: Removed binding collection "'+this.name()+'" to output target: '+a),this):void console.log("Cannot remove link, one does not exist to the target: "+a+" with the template: "+c)};c.prototype.findSub=function(a,c,f,d){var e,g,h=new b(c),l=this.find(a),n=l.length,u=this._db.collection("__FDB_temp_"+this.objectId()),
s={parents:n,subDocTotal:0,subDocs:[],pathFound:!1,err:""};for(a=0;n>a;a++)if(e=h.value(l[a])[0]){if(u.setData(e),g=u.find(f,d),d.returnFirst&&g.length)return g[0];s.subDocs.push(g);s.subDocTotal+=g.length;s.pathFound=!0}return u.drop(),d.noStats?s.subDocs:(s.pathFound||(s.err="No objects found in the parent documents with a matching path of: "+c),s)};c.prototype.insertIndexViolation=function(a){var c,b,f,d=this._indexByName;if(this._primaryIndex.get(a[this._primaryKey]))c=this._primaryIndex;else for(b in d)if(d.hasOwnProperty(b)&&
(f=d[b],f.unique()&&f.violation(a))){c=f;break}return c?c.name():!1};c.prototype.ensureIndex=function(c,b){this._indexByName=this._indexByName||{};this._indexById=this._indexById||{};var f=new a(c,b,this),d={start:(new Date).getTime()};return this._indexByName[f.name()]?{err:"Index with that name already exists"}:this._indexById[f.id()]?{err:"Index with those keys already exists"}:(f.rebuild(),this._indexByName[f.name()]=f,this._indexById[f.id()]=f,d.end=(new Date).getTime(),d.total=d.end-d.start,
this._lastOp={type:"ensureIndex",stats:{time:d}},{index:f,id:f.id(),name:f.name(),state:f.state()})};c.prototype.index=function(a){return this._indexByName[a]};c.prototype.lastOp=function(){return this._metrics.list()};c.prototype.objectId=function(a){if(a){var c,b=0,f=a.length;for(c=0;f>c;c++)b+=a.charCodeAt(c)*Math.pow(10,17);a=b.toString(16)}else g.idCounter++,a=(g.idCounter+(Math.random()*Math.pow(10,17)+Math.random()*Math.pow(10,17)+Math.random()*Math.pow(10,17)+Math.random()*Math.pow(10,17))).toString(16);
return a};c.prototype.diff=function(a){var c,b,f,d,e={insert:[],update:[],remove:[]},g=this.primaryKey();if(g===a.primaryKey()){c=a._data;d=c.length;for(b=0;d>b;b++)f=c[b],this._primaryIndex.get(f[g])?this._primaryCrc.get(f[g])===a._primaryCrc.get(f[g])||e.update.push(f):e.insert.push(f);c=this._data;d=c.length;for(b=0;d>b;b++)f=c[b],a._primaryIndex.get(f[g])||e.remove.push(f)}return e};h.prototype.collection=function(a,b){if(a)return this._collection[a]||this.debug()&&console.log("Creating collection "+
a),this._collection[a]=this._collection[a]||(new c(a)).db(this),void 0!==b&&this._collection[a].primaryKey(b),this._collection[a];throw"Cannot get collection with undefined name!";};h.prototype.collectionExists=function(a){return Boolean(this._collection[a])};h.prototype.collections=function(){var a,c=[];for(a in this._collection)this._collection.hasOwnProperty(a)&&c.push({name:a,count:this._collection[a].count()});return c};n.exports=c},{"./ForerunnerDB.Crc":5,"./ForerunnerDB.Index":7,"./ForerunnerDB.KeyValueStore":8,
"./ForerunnerDB.Metrics":9,"./ForerunnerDB.Overload":13,"./ForerunnerDB.Path":14,"./ForerunnerDB.Shared":16}],3:[function(h,n,l){var g,d,e;l=h("./ForerunnerDB.Shared");var b=function(){this.init.apply(this,arguments)};b.prototype.init=function(a){var b=this;this._name=a;this._collectionArr=[];this._views=[];this._onCollectionInsert=function(){b._onInsert.apply(b,arguments)};this._onCollectionUpdate=function(){b._onUpdate.apply(b,arguments)};this._onCollectionRemove=function(){b._onRemove.apply(b,
arguments)};this._onCollectionChange=function(){b._onChange.apply(b,arguments)}};l.modules.CollectionGroup=b;d=h("./ForerunnerDB.Collection");e=h("./ForerunnerDB.Overload");h=l.modules.Core;g=l.modules.Core.prototype.init;b.prototype.on=new e([function(a,b){return this._listeners=this._listeners||{},this._listeners[a]=this._listeners[a]||{},this._listeners[a]["*"]=this._listeners[a]["*"]||[],this._listeners[a]["*"].push(b),this},function(a,b,c){return this._listeners=this._listeners||{},this._listeners[a]=
this._listeners[a]||{},this._listeners[a][b]=this._listeners[a][b]||[],this._listeners[a][b].push(c),this}]);b.prototype.off=new e([function(a){return this._listeners&&this._listeners[a]&&a in this._listeners&&delete this._listeners[a],this},function(a,b){var c,d;return"string"==typeof b?this._listeners&&this._listeners[a]&&this._listeners[a][b]&&delete this._listeners[a][b]:a in this._listeners&&(c=this._listeners[a]["*"],d=c.indexOf(b),-1<d&&c.splice(d,1)),this},function(a,b,c){this._listeners&&
a in this._listeners&&(a=this._listeners[a][b],c=a.indexOf(c),-1<c&&a.splice(c,1))}]);b.prototype.emit=function(a,b){if(this._listeners=this._listeners||{},a in this._listeners){if(this._listeners[a]["*"]){var c,d=this._listeners[a]["*"],e=d.length;for(c=0;e>c;c++)d[c].apply(this,Array.prototype.slice.call(arguments,1))}if(b instanceof Array&&b[0]&&b[0][this._primaryKey]){var g,h=this._listeners[a],e=b.length;for(c=0;e>c;c++)if(h[b[c][this._primaryKey]])for(d=h[b[c][this._primaryKey]].length,g=0;d>
g;g++)h[b[c][this._primaryKey]][g].apply(this,Array.prototype.slice.call(arguments,1))}}return this};b.prototype.db=function(a){return void 0!==a?(this._db=a,this):this._db};b.prototype.addCollection=function(a){if(a&&-1===this._collectionArr.indexOf(a)){if(this._collectionArr.length){if(this._primaryKey!==a.primaryKey())throw"All collections in a collection group must have the same primary key!";}else this._primaryKey=a.primaryKey();this._collectionArr.push(a);a._groups.push(this);a.on("insert",
this._onCollectionInsert);a.on("update",this._onCollectionUpdate);a.on("remove",this._onCollectionRemove);a.on("change",this._onCollectionChange)}return this};b.prototype.removeCollection=function(a){if(a){var b,c=this._collectionArr.indexOf(a);-1!==c&&(a.off("insert",this._onCollectionInsert),a.off("update",this._onCollectionUpdate),a.off("remove",this._onCollectionRemove),a.off("change",this._onCollectionChange),this._collectionArr.splice(c,1),b=a._groups.indexOf(this),-1!==b&&a._groups.splice(b,
1));0===this._collectionArr.length&&delete this._primaryKey}return this};b.prototype.find=function(a,b){var c,e=(new d).primaryKey(this._collectionArr[0].primaryKey());for(c=0;c<this._collectionArr.length;c++)e.insert(this._collectionArr[c].find(a));return e.find(a,b)};b.prototype.insert=function(a,b){for(var c=0;c<this._collectionArr.length;c++)this._collectionArr[c].insert(a,b)};b.prototype.update=function(a,b){for(var c=0;c<this._collectionArr.length;c++)this._collectionArr[c].update(a,b)};b.prototype.updateById=
function(a,b){for(var c=0;c<this._collectionArr.length;c++)this._collectionArr[c].updateById(a,b)};b.prototype.remove=function(a){for(var b=0;b<this._collectionArr.length;b++)this._collectionArr[b].remove(a)};b.prototype.removeById=function(a){for(var b=0;b<this._collectionArr.length;b++)this._collectionArr[b].removeById(a)};b.prototype._onInsert=function(a,b){this.emit("insert",a,b)};b.prototype._onUpdate=function(a,b){this.emit("update",a,b)};b.prototype._onRemove=function(a,b){this.emit("remove",
a,b)};b.prototype._onChange=function(){this.emit("change")};b.prototype.subset=function(a,b){var c=this.find(a,b);return(new d)._subsetOf(this).primaryKey(this._primaryKey).setData(c)};b.prototype.drop=function(){var a,b=[].concat(this._collectionArr),c=[].concat(this._views);this._debug&&console.log("Dropping collection group "+this._name);for(a=0;a<b.length;a++)this.removeCollection(b[a]);for(a=0;a<c.length;a++)this._removeView(c[a]);return this.emit("drop"),!0};h.prototype.init=function(){this._collectionGroup=
{};g.apply(this,arguments)};h.prototype.collectionGroup=function(a){return a?(this._collectionGroup[a]=this._collectionGroup[a]||(new b(a)).db(this),this._collectionGroup[a]):this._collectionGroup};n.exports=b},{"./ForerunnerDB.Collection":2,"./ForerunnerDB.Overload":13,"./ForerunnerDB.Shared":16}],4:[function(h,n,l){var g,d;g=h("./ForerunnerDB.Shared.js");var e=function(){this.init.apply(this,arguments)};e.prototype.init=function(){this._collection={};this._debug={}};g.modules.Core=e;l=h("./ForerunnerDB.Overload.js");
d=h("./ForerunnerDB.Collection.js");h("./ForerunnerDB.Metrics.js");h=h("./ForerunnerDB.Crc.js");e.prototype._isServer=!1;e.prototype.isClient=function(){return!this._isServer};e.prototype.isServer=function(){return this._isServer};e.prototype.crc=h;e.prototype.isClient=function(){return!this._isServer};e.prototype.isServer=function(){return this._isServer};e.prototype.decouple=function(b){return JSON.parse(JSON.stringify(b))};e.prototype.debug=new l([function(){return this._debug.all},function(b){return void 0!==
b&&"boolean"==typeof b?(this._debug.all=b,this):this._debug.all},function(b,a){return void 0!==b?void 0!==a?(this._debug[b]=a,this):this._debug[b]:this._debug.all}]);e.prototype.arrayToCollection=function(b){return(new d).setData(b)};e.prototype.on=function(b,a){return this._listeners=this._listeners||{},this._listeners[b]=this._listeners[b]||[],this._listeners[b].push(a),this};e.prototype.off=function(b,a){if(b in this._listeners){var d=this._listeners[b],c=d.indexOf(a);-1<c&&d.splice(c,1)}return this};
e.prototype.emit=function(b){if(this._listeners=this._listeners||{},b in this._listeners){var a,d=this._listeners[b],c=d.length;for(a=0;c>a;a++)d[a].apply(this,Array.prototype.slice.call(arguments,1))}return this};e.prototype.objectId=function(b){if(b){var a,d=0,c=b.length;for(a=0;c>a;a++)d+=b.charCodeAt(a)*Math.pow(10,17);b=d.toString(16)}else g.idCounter++,b=(g.idCounter+(Math.random()*Math.pow(10,17)+Math.random()*Math.pow(10,17)+Math.random()*Math.pow(10,17)+Math.random()*Math.pow(10,17))).toString(16);
return b};e.prototype.peek=function(b){var a,d,c=[],e=typeof b;for(a in this._collection)this._collection.hasOwnProperty(a)&&(d=this._collection[a],c=c.concat("string"===e?d.peek(b):d.find(b)));return c};e.prototype.peekCat=function(b){var a,d,c,e={},g=typeof b;for(a in this._collection)this._collection.hasOwnProperty(a)&&(d=this._collection[a],"string"===g?(c=d.peek(b),c&&c.length&&(e[d.name()]=c)):(c=d.find(b),c&&c.length&&(e[d.name()]=c)));return e};n.exports=e},{"./ForerunnerDB.Collection.js":2,
"./ForerunnerDB.Crc.js":5,"./ForerunnerDB.Metrics.js":9,"./ForerunnerDB.Overload.js":13,"./ForerunnerDB.Shared.js":16}],5:[function(h,n,l){var g=function(){var d,e,b,a=[];for(e=0;256>e;e++){d=e;for(b=0;8>b;b++)d=1&d?3988292384^d>>>1:d>>>1;a[e]=d}return a}();n.exports=function(d){var e,b=-1;for(e=0;e<d.length;e++)b=b>>>8^g[255&(b^d.charCodeAt(e))];return(-1^b)>>>0}},{}],6:[function(h,n,l){var g;h=h("./ForerunnerDB.Shared");var d=function(){this.init.apply(this,arguments)};d.prototype.init=function(d,
b){this._options=b;this._selector=$(this._options.selector);this._listeners={};this._collection=d;this._options.series=[];var a,f;switch(this._options.type){case "pie":this._selector.highcharts(this._options.chartOptions);this._chart=this._selector.highcharts();a=this._collection.find();f={allowPointSelect:!0,cursor:"pointer",dataLabels:{enabled:!0,format:"<b>{point.name}</b>: {y} ({point.percentage:.0f}%)",style:{color:Highcharts.theme&&Highcharts.theme.contrastTextColor||"black"}}};a=this.pieDataFromCollectionData(a,
this._options.keyField,this._options.valField);$.extend(f,this._options.seriesOptions);$.extend(f,{type:"pie",name:this._options.seriesName,data:a});this._chart.addSeries(f);break;case "line":a=this.lineDataFromCollectionData(this._options.seriesField,this._options.keyField,this._options.valField,this._options.orderBy),this._options.chartOptions.xAxis=a.xAxis,this._options.chartOptions.series=a.series,this._selector.highcharts(this._options.chartOptions),this._chart=this._selector.highcharts()}this._hookEvents()};
h=h.modules.Collection;g=h.prototype.init;d.prototype.pieDataFromCollectionData=function(d,b,a){var f,c=[];for(f=0;f<d.length;f++)c.push([d[f][b],d[f][a]]);return c};d.prototype.lineDataFromCollectionData=function(d,b,a,f){var c,k,g,h,l,n=this._collection.distinct(d),B=[],C={categories:[]};for(h=0;h<n.length;h++){c=n[h];k={};k[d]=c;g=[];k=this._collection.find(k,{orderBy:f});for(l=0;l<k.length;l++)C.categories.push(k[l][b]),g.push(k[l][a]);B.push({name:c,data:g})}return{xAxis:C,series:B}};d.prototype._hookEvents=
function(){this._collection.on("change",this._changeListener);this._collection.on("drop",this._dropListener)};d.prototype._changeListener=function(){if("undefined"!=typeof this._collection&&this._chart){var d=this._collection.find();switch(this._options.type){case "pie":this._chart.series[0].setData(this.pieDataFromCollectionData(d,this._options.keyField,this._options.valField));break;case "line":d=this.lineDataFromCollectionData(this._options.seriesField,this._options.keyField,this._options.valField,
this._options.orderBy);this._chart.xAxis[0].setCategories(d.xAxis.categories);for(var b=0;b<d.series.length;b++)this._chart.series[b].setData(d.series[b].data)}}};d.prototype._dropListener=function(){this._collection.off("change",this._changeListener);this._collection.off("drop",this._dropListener)};d.prototype.drop=function(){return this._chart.destroy(),this._collection.off("change",this._changeListener),this._collection.off("drop",this._dropListener),delete this._collection._highcharts[this._options.selector],
delete this._chart,delete this._options,delete this._collection,this};h.prototype.init=function(){this._highcharts={};g.apply(this,arguments)};h.prototype.chart=function(e){return this._highcharts[e.selector]||(this._highcharts[e.selector]=new d(this,e)),this._highcharts[e.selector]};h.prototype.dropChart=function(d){this._highcharts[d]&&this._highcharts[d].drop()};n.exports=d},{"./ForerunnerDB.Shared":16}],7:[function(h,n,l){l=h("./ForerunnerDB.Shared");var g=h("./ForerunnerDB.Path");h=function(){this.init.apply(this,
arguments)};h.prototype.init=function(d,e,b){this._crossRef={};this._size=0;this._id=this._itemKeyHash(d,d);this.data({});this.unique(e&&e.unique?e.unique:!1);void 0!==d&&this.keys(d);void 0!==b&&this.collection(b);this.name(e&&e.name?e.name:this._id)};l.modules.Index=h;h.prototype.id=function(){return this._id};h.prototype.state=function(){return this._state};h.prototype.size=function(){return this._size};h.prototype.data=function(d){return void 0!==d?(this._data=d,this):this._data};h.prototype.name=
function(d){return void 0!==d?(this._name=d,this):this._name};h.prototype.collection=function(d){return void 0!==d?(this._collection=d,this):this._collection};h.prototype.keys=function(d){return void 0!==d?(this._keys=d,this._keyCount=(new g).parse(this._keys).length,this):this._keys};h.prototype.type=function(d){return void 0!==d?(this._type=d,this):this._type};h.prototype.unique=function(d){return void 0!==d?(this._unique=d,this):this._unique};h.prototype.rebuild=function(){if(this._collection){var d,
e=this._collection.subset({},{decouple:!1,sort:this._keys}).find(),b=e.length;this._data={};this._unique&&(this._uniqueLookup={});for(d=0;b>d;d++)this.insert(e[d])}this._state={name:this._name,keys:this._keys,indexSize:this._size,built:new Date,updated:new Date,ok:!0}};h.prototype.insert=function(d){var e,b;this._unique&&(e=this._itemHash(d,this._keys),this._uniqueLookup[e]=d);e=this._itemHashArr(d,this._keys);for(b=0;b<e.length;b++)this.pushToPathValue(e[b],d)};h.prototype.remove=function(d){var e,
b;this._unique&&(e=this._itemHash(d,this._keys),delete this._uniqueLookup[e]);e=this._itemHashArr(d,this._keys);for(b=0;b<e.length;b++)this.pullFromPathValue(e[b],d)};h.prototype.violation=function(d){d=this._itemHash(d,this._keys);return Boolean(this._uniqueLookup[d])};h.prototype.hashViolation=function(d){return Boolean(this._uniqueLookup[d])};h.prototype.pushToPathValue=function(d,e){var b=this._data[d]=this._data[d]||[];-1===b.indexOf(e)&&(b.push(e),this._size++,this.pushToCrossRef(e,b))};h.prototype.pullFromPathValue=
function(d,e){var b,a=this._data[d];b=a.indexOf(e);-1<b&&(a.splice(b,1),this._size--,this.pullFromCrossRef(e,a));a.length||delete this._data[d]};h.prototype.pull=function(d){var e,b,a=d[this._collection.primaryKey()],f=this._crossRef[a],c=f.length;for(e=0;c>e;e++)b=f[e],this._pullFromArray(b,d);this._size--;delete this._crossRef[a]};h.prototype._pullFromArray=function(d,e){for(var b=d.length;b--;)d[b]===e&&d.splice(b,1)};h.prototype.pushToCrossRef=function(d,e){var b;b=d[this._collection.primaryKey()];
this._crossRef[b]=this._crossRef[b]||[];b=this._crossRef[b];-1===b.indexOf(e)&&b.push(e)};h.prototype.pullFromCrossRef=function(d){d=d[this._collection.primaryKey()];delete this._crossRef[d]};h.prototype.lookup=function(d){return this._data[this._itemHash(d,this._keys)]||[]};h.prototype.match=function(d){return(new g).hasObjectPaths(this._keys,d)};h.prototype._itemHash=function(d,e){var b,a,f=new g,c="";b=f.parse(e);for(a=0;a<b.length;a++)c&&(c+="_"),c+=f.value(d,b[a].path).join(":");return c};h.prototype._itemKeyHash=
function(d,e){var b,a,f=new g,c="";b=f.parse(e);for(a=0;a<b.length;a++)c&&(c+="_"),c+=f.keyValue(d,b[a].path);return c};h.prototype._itemHashArr=function(d,e){var b,a,f,c,k,h=new g,l=[];b=h.parse(e);for(c=0;c<b.length;c++)for(a=h.value(d,b[c].path),f=0;f<a.length;f++)if(0===c)l.push(a[f]);else for(k=0;k<l.length;k++)l[k]=l[k]+"_"+a[f];return l};n.exports=h},{"./ForerunnerDB.Path":14,"./ForerunnerDB.Shared":16}],8:[function(h,n,l){h=h("./ForerunnerDB.Shared");l=function(){this.init.apply(this,arguments)};
l.prototype.init=function(g){this._name=g;this._data={};this._primaryKey="_id"};h.modules.KeyValueStore=l;l.prototype.name=function(g){return void 0!==g?(this._name=g,this):this._name};l.prototype.primaryKey=function(g){return void 0!==g?(this._primaryKey=g,this):this._primaryKey};l.prototype.truncate=function(){return this._data={},this};l.prototype.set=function(g,d){return this._data[g]=d?d:!0,this};l.prototype.get=function(g){return this._data[g]};l.prototype.lookup=function(g){var d,e,b,a=g[this._primaryKey];
if(a instanceof Array){g=a.length;b=[];for(d=0;g>d;d++)(e=this._data[a[d]])&&b.push(e);return b}if(a instanceof RegExp){b=[];for(d in this._data)this._data.hasOwnProperty(d)&&a.test(d)&&b.push(this._data[d]);return b}if("object"!=typeof a)return e=this._data[a],void 0!==e?[e]:[];if(a.$ne){b=[];for(d in this._data)this._data.hasOwnProperty(d)&&d!==a.$ne&&b.push(this._data[d]);return b}if(a.$in&&a.$in instanceof Array){b=[];for(d in this._data)this._data.hasOwnProperty(d)&&-1<a.$in.indexOf(d)&&b.push(this._data[d]);
return b}if(a.$nin&&a.$nin instanceof Array){b=[];for(d in this._data)this._data.hasOwnProperty(d)&&-1===a.$nin.indexOf(d)&&b.push(this._data[d]);return b}if(a.$or&&a.$or instanceof Array){b=[];for(d=0;d<a.$or.length;d++)b=b.concat(this.lookup(a.$or[d]));return b}};l.prototype.unSet=function(g){return delete this._data[g],this};l.prototype.uniqueSet=function(g,d){return void 0===this._data[g]?(this._data[g]=d,!0):!1};n.exports=l},{"./ForerunnerDB.Shared":16}],9:[function(h,n,l){l=h("./ForerunnerDB.Shared");
var g=h("./ForerunnerDB.Operation");h=function(){this.init.apply(this,arguments)};h.prototype.init=function(){this._data=[]};l.modules.Metrics=h;h.prototype.create=function(d){d=new g(d);return this._enabled&&this._data.push(d),d};h.prototype.start=function(){return this._enabled=!0,this};h.prototype.stop=function(){return this._enabled=!1,this};h.prototype.clear=function(){return this._data=[],this};h.prototype.list=function(){return this._data};n.exports=h},{"./ForerunnerDB.Operation":12,"./ForerunnerDB.Shared":16}],
10:[function(h,n,l){var g;h=h("./ForerunnerDB.Shared").modules.OldView;g=h.prototype.init;h.prototype.init=function(){var d=this;this._binds=[];this._renderEnd=this._renderStart=0;this._deferQueue={insert:[],update:[],remove:[],upsert:[],_bindInsert:[],_bindUpdate:[],_bindRemove:[],_bindUpsert:[]};this._deferThreshold={insert:100,update:100,remove:100,upsert:100,_bindInsert:100,_bindUpdate:100,_bindRemove:100,_bindUpsert:100};this._deferTime={insert:100,update:1,remove:1,upsert:1,_bindInsert:100,
_bindUpdate:1,_bindRemove:1,_bindUpsert:1};g.apply(this,arguments);this.on("insert",function(e,b){d._bindEvent("insert",e,b)});this.on("update",function(e,b){d._bindEvent("update",e,b)});this.on("remove",function(e,b){d._bindEvent("remove",e,b)});this.on("change",d._bindChange)};h.prototype.bind=function(d,e){if(!e||!e.template)throw"Cannot bind data to element, missing options information!";return this._binds[d]=e,this};h.prototype.unBind=function(d){return delete this._binds[d],this};h.prototype.isBound=
function(d){return Boolean(this._binds[d])};h.prototype.bindSortDom=function(d,e){var b,a,f,c=$(d);this.debug()&&console.log("ForerunnerDB.OldView.Bind: Sorting data in DOM...",e);for(b=0;b<e.length;b++)a=e[b],f=c.find("#"+a[this._primaryKey]),f.length?0===b?(this.debug()&&console.log("ForerunnerDB.OldView.Bind: Sort, moving to index 0...",f),c.prepend(f)):(this.debug()&&console.log("ForerunnerDB.OldView.Bind: Sort, moving to index "+b+"...",f),f.insertAfter(c.children(":eq("+(b-1)+")"))):this.debug()&&
console.log("ForerunnerDB.OldView.Bind: Warning, element for array item not found!",a)};h.prototype.bindRefresh=function(d){var e,b,a=this._binds;d||(d={data:this.find()});for(e in a)a.hasOwnProperty(e)&&(b=a[e],this.debug()&&console.log("ForerunnerDB.OldView.Bind: Sorting DOM..."),this.bindSortDom(e,d.data),b.afterOperation&&b.afterOperation(),b.refresh&&b.refresh())};h.prototype.bindRender=function(d,e){var b,a,f,c=this._binds[d],k=$(d),g=$("<ul></ul>");if(c){b=this._data.find();for(f=0;f<b.length;f++)a=
b[f],c.template(a,function(a){g.append(a)});e?e(d,g.html()):k.append(g.html())}};h.prototype.processQueue=function(d,e){var b=this._deferQueue[d],a=this._deferThreshold[d],f=this._deferTime[d];if(b.length){var c,k=this;b.length&&(c=b.length>a?b.splice(0,a):b.splice(0,b.length),this._bindEvent(d,c,[]));setTimeout(function(){k.processQueue(d,e)},f)}else e&&e(),this.emit("bindQueueComplete")};h.prototype._bindEvent=function(d,e,b){var a,f,c=(this._deferQueue[d],this._deferThreshold[d],this._deferTime[d],
this._binds),k=this.find({});for(f in c)if(c.hasOwnProperty(f))switch(a=c[f].reduce?this.find(c[f].reduce.query,c[f].reduce.options):k,d){case "insert":this._bindInsert(f,c[f],e,b,a);break;case "update":this._bindUpdate(f,c[f],e,b,a);break;case "remove":this._bindRemove(f,c[f],e,b,a)}};h.prototype._bindChange=function(d){this.debug()&&console.log("ForerunnerDB.OldView.Bind: Bind data change, refreshing bind...",d);this.bindRefresh(d)};h.prototype._bindInsert=function(d,e,b,a,f){var c,k=$(d);for(c=
0;c<b.length;c++)d=k.find("#"+b[c][this._primaryKey]),d.length||e.template(b[c],function(a,c,b,d){return function(a){e.insert?e.insert(a,c,b,d):e.prependInsert?k.prepend(a):k.append(a);e.afterInsert&&e.afterInsert(a,c,b,d)}}(d,b[c],a,f))};h.prototype._bindUpdate=function(d,e,b,a,f){var c=$(d);for(a=0;a<b.length;a++)d=c.find("#"+b[a][this._primaryKey]),e.template(b[a],function(a,b){return function(d){e.update?e.update(d,b,f,a.length?"update":"append"):a.length?a.replaceWith(d):e.prependUpdate?c.prepend(d):
c.append(d);e.afterUpdate&&e.afterUpdate(d,b,f)}}(d,b[a]))};h.prototype._bindRemove=function(d,e,b,a,f){var c=$(d);for(a=0;a<b.length;a++)d=c.find("#"+b[a][this._primaryKey]),d.length&&(e.beforeRemove?e.beforeRemove(d,b[a],f,function(a,c,b){return function(){e.remove?e.remove(a,c,b):(a.remove(),e.afterRemove&&e.afterRemove(a,c,b))}}(d,b[a],f)):e.remove?e.remove(d,b[a],f):(d.remove(),e.afterRemove&&e.afterRemove(d,b[a],f)))}},{"./ForerunnerDB.Shared":16}],11:[function(h,n,l){var g,d,e,b,a;g=h("./ForerunnerDB.Shared");
var f=function(){this.init.apply(this,arguments)};f.prototype.init=function(a){var b=this;this._name=a;this._groups=[];this._listeners={};this._query={query:{},options:{}};this._onFromSetData=function(){b._onSetData.apply(b,arguments)};this._onFromInsert=function(){b._onInsert.apply(b,arguments)};this._onFromUpdate=function(){b._onUpdate.apply(b,arguments)};this._onFromRemove=function(){b._onRemove.apply(b,arguments)};this._onFromChange=function(){b.debug()&&console.log("ForerunnerDB.OldView: Received change");
b._onChange.apply(b,arguments)}};g.modules.OldView=f;l=h("./ForerunnerDB.CollectionGroup");d=h("./ForerunnerDB.Collection");e=d.prototype.init;b=l.prototype.init;h=h("./ForerunnerDB.Overload");g=g.modules.Core;a=g.prototype.init;f.prototype.on=new h([function(a,b){return this._listeners=this._listeners||{},this._listeners[a]=this._listeners[a]||{},this._listeners[a]["*"]=this._listeners[a]["*"]||[],this._listeners[a]["*"].push(b),this},function(a,b,d){return this._listeners=this._listeners||{},this._listeners[a]=
this._listeners[a]||{},this._listeners[a][b]=this._listeners[a][b]||[],this._listeners[a][b].push(d),this}]);f.prototype.off=new h([function(a){return this._listeners&&this._listeners[a]&&a in this._listeners&&delete this._listeners[a],this},function(a,b){var d,f;return"string"==typeof b?this._listeners&&this._listeners[a]&&this._listeners[a][b]&&delete this._listeners[a][b]:a in this._listeners&&(d=this._listeners[a]["*"],f=d.indexOf(b),-1<f&&d.splice(f,1)),this},function(a,b,d){this._listeners&&
a in this._listeners&&(a=this._listeners[a][b],d=a.indexOf(d),-1<d&&a.splice(d,1))}]);f.prototype.emit=function(a,b){if(this._listeners=this._listeners||{},a in this._listeners){if(this._listeners[a]["*"]){var d,f=this._listeners[a]["*"],e=f.length;for(d=0;e>d;d++)f[d].apply(this,Array.prototype.slice.call(arguments,1))}if(b instanceof Array&&b[0]&&b[0][this._primaryKey]){var g,h=this._listeners[a],e=b.length;for(d=0;e>d;d++)if(h[b[d][this._primaryKey]])for(f=h[b[d][this._primaryKey]].length,g=0;f>
g;g++)h[b[d][this._primaryKey]][g].apply(this,Array.prototype.slice.call(arguments,1))}}return this};f.prototype.drop=function(){return(this._db||this._from)&&this._name?(this.debug()&&console.log("ForerunnerDB.OldView: Dropping view "+this._name),this.emit("drop"),this._db&&delete this._db._oldViews[this._name],this._from&&delete this._from._oldViews[this._name],!0):!1};f.prototype.debug=function(){return!1};f.prototype.db=function(a){return void 0!==a?(this._db=a,this):this._db};f.prototype.from=
function(a){if(void 0!==a){if("string"==typeof a){if(!this._db.collectionExists(a))throw"Invalid collection in view.from() call.";a=this._db.collection(a)}return this._from!==a&&(this._from&&this.removeFrom(),this.addFrom(a)),this}return this._from};f.prototype.addFrom=function(a){if(this._from=a,this._from)return this._from.on("setData",this._onFromSetData),this._from.on("change",this._onFromChange),this._from._addOldView(this),this._primaryKey=this._from._primaryKey,this.refresh(),this;throw"Cannot determine collection type in view.from()";
};f.prototype.removeFrom=function(){this._from.off("setData",this._onFromSetData);this._from.off("change",this._onFromChange);this._from._removeOldView(this)};f.prototype.primaryKey=function(){return this._from?this._from.primaryKey():void 0};f.prototype.queryData=function(a,b,d){return void 0!==a&&(this._query.query=a),void 0!==b&&(this._query.options=b),void 0!==a||void 0!==b?((void 0===d||!0===d)&&this.refresh(),this):this._query};f.prototype.queryAdd=function(a,b,d){var f,e=this._query.query;
if(void 0!==a)for(f in a)a.hasOwnProperty(f)&&(void 0===e[f]||void 0!==e[f]&&b)&&(e[f]=a[f]);void 0!==d&&!0!==d||this.refresh()};f.prototype.queryRemove=function(a,b){var d,f=this._query.query;if(void 0!==a)for(d in a)a.hasOwnProperty(d)&&delete f[d];void 0!==b&&!0!==b||this.refresh()};f.prototype.query=function(a,b){return void 0!==a?(this._query.query=a,(void 0===b||!0===b)&&this.refresh(),this):this._query.query};f.prototype.queryOptions=function(a,b){return void 0!==a?(this._query.options=a,(void 0===
b||!0===b)&&this.refresh(),this):this._query.options};f.prototype.refresh=function(a){if(this._from){var b,d,f,e,g,h,l=this._data,n=[],r=[],u=[];if(this.debug()&&(console.log("ForerunnerDB.OldView: Refreshing view "+this._name),console.log("ForerunnerDB.OldView: Existing data: "+("undefined"!=typeof this._data)),"undefined"!=typeof this._data&&console.log("ForerunnerDB.OldView: Current data rows: "+this._data.find().length)),this._query?(this.debug()&&console.log("ForerunnerDB.OldView: View has query and options, getting subset..."),
this._data=this._from.subset(this._query.query,this._query.options)):this._query.options?(this.debug()&&console.log("ForerunnerDB.OldView: View has options, getting subset..."),this._data=this._from.subset({},this._query.options)):(this.debug()&&console.log("ForerunnerDB.OldView: View has no query or options, getting subset..."),this._data=this._from.subset({})),!a&&l)if(this.debug()&&console.log("ForerunnerDB.OldView: Refresh not forced, old data detected..."),d=this._data,l.subsetOf()===d.subsetOf()){this.debug()&&
console.log("ForerunnerDB.OldView: Old and new data are from same collection...");f=d.find();a=l.find();e=d._primaryKey;for(h=0;h<f.length;h++)g=f[h],b={},b[e]=g[e],(b=l.find(b)[0])?JSON.stringify(b)!==JSON.stringify(g)&&r.push(g):n.push(g);for(h=0;h<a.length;h++)g=a[h],b={},b[e]=g[e],d.find(b)[0]||u.push(g);this.debug()&&(console.log("ForerunnerDB.OldView: Removed "+u.length+" rows"),console.log("ForerunnerDB.OldView: Inserted "+n.length+" rows"),console.log("ForerunnerDB.OldView: Updated "+r.length+
" rows"));n.length&&this._onInsert(n,[]);r.length&&this._onUpdate(r,[]);u.length&&this._onRemove(u,[])}else this.debug()&&console.log("ForerunnerDB.OldView: Old and new data are from different collections..."),u=l.find(),u.length&&this._onRemove(u),n=d.find(),n.length&&this._onInsert(n);else this.debug()&&console.log("ForerunnerDB.OldView: Forcing data update",f),this._data=this._from.subset(this._query.query,this._query.options),f=this._data.find(),this.debug()&&console.log("ForerunnerDB.OldView: Emitting change event with data",
f),this._onInsert(f,[]);this.debug()&&console.log("ForerunnerDB.OldView: Emitting change");this.emit("change")}return this};f.prototype.count=function(){return this._data&&this._data._data?this._data._data.length:0};f.prototype.find=function(){return this._data?(this.debug()&&console.log("ForerunnerDB.OldView: Finding data in view collection...",this._data),this._data.find.apply(this._data,arguments)):[]};f.prototype.insert=function(){return this._from?this._from.insert.apply(this._from,arguments):
[]};f.prototype.update=function(){return this._from?this._from.update.apply(this._from,arguments):[]};f.prototype.remove=function(){return this._from?this._from.remove.apply(this._from,arguments):[]};f.prototype._onSetData=function(a,b){this.emit("remove",b,[]);this.emit("insert",a,[])};f.prototype._onInsert=function(a,b){this.emit("insert",a,b)};f.prototype._onUpdate=function(a,b){this.emit("update",a,b)};f.prototype._onRemove=function(a,b){this.emit("remove",a,b)};f.prototype._onChange=function(){this.debug()&&
console.log("ForerunnerDB.OldView: Refreshing data");this.refresh()};d.prototype.init=function(){this._oldViews=[];e.apply(this,arguments)};d.prototype._addOldView=function(a){return void 0!==a&&(this._oldViews[a._name]=a),this};d.prototype._removeOldView=function(a){return void 0!==a&&delete this._oldViews[a._name],this};l.prototype.init=function(){this._oldViews=[];b.apply(this,arguments)};l.prototype._addOldView=function(a){return void 0!==a&&(this._oldViews[a._name]=a),this};l.prototype._removeOldView=
function(a){return void 0!==a&&delete this._oldViews[a._name],this};g.prototype.init=function(){this._oldViews={};a.apply(this,arguments)};g.prototype.oldView=function(a){return this._oldViews[a]||this.debug()&&console.log("ForerunnerDB.OldView: Creating view "+a),this._oldViews[a]=this._oldViews[a]||(new f(a)).db(this),this._oldViews[a]};g.prototype.oldViewExists=function(a){return Boolean(this._oldViews[a])};g.prototype.oldViews=function(){var a,b=[];for(a in this._oldViews)this._oldViews.hasOwnProperty(a)&&
b.push({name:a,count:this._oldViews[a].count()});return b};n.exports=f},{"./ForerunnerDB.Collection":2,"./ForerunnerDB.CollectionGroup":3,"./ForerunnerDB.Overload":13,"./ForerunnerDB.Shared":16}],12:[function(h,n,l){h=h("./ForerunnerDB.Shared");l=function(){this.init.apply(this,arguments)};l.prototype.init=function(g){this._name=g;this._time={process:{}};this._flag={};this._log=[]};h.modules.Operation=l;l.prototype.start=function(){this._time.start=(new Date).getTime()};l.prototype.log=function(g){if(g){var d=
0<this._log.length?this._log[this._log.length-1].time:0;g={event:g,time:(new Date).getTime(),delta:0};return this._log.push(g),d&&(g.delta=g.time-d),this}return this._log};l.prototype.time=function(g){if(void 0!==g){var d=this._time.process;g=d[g]=d[g]||{};return g.start?(g.end=(new Date).getTime(),g.totalMs=g.end-g.start):g.start=(new Date).getTime(),this}return this._time};l.prototype.flag=function(g,d){return void 0===g||void 0===d?void 0!==g?this._flag[g]:this._flag:void(this._flag[g]=d)};l.prototype.stop=
function(){this._time.stop=(new Date).getTime();this._time.totalMs=this._time.stop-this._time.start};n.exports=l},{"./ForerunnerDB.Shared":16}],13:[function(h,n,l){l=function(g){if(g){var d,e=g.length;return function(){for(d=0;e>d;d++)if(g[d].length===arguments.length)return g[d].apply(this,arguments);return null}}return function(){}};h("./ForerunnerDB.Shared").modules.Overload=l;n.exports=l},{"./ForerunnerDB.Shared":16}],14:[function(h,n,l){h=h("./ForerunnerDB.Shared");l=function(){this.init.apply(this,
arguments)};l.prototype.init=function(g){g&&this.path(g)};h.modules.Path=l;l.prototype.path=function(g){return void 0!==g?(this._path=this.clean(g),this._pathParts=this._path.split("."),this):this._path};l.prototype.hasObjectPaths=function(g,d){var e,b=!0;for(e in g)if(g.hasOwnProperty(e)&&(void 0===d[e]||"object"==typeof g[e]&&(b=this.hasObjectPaths(g[e],d[e]),!b)))return!1;return b};l.prototype.parse=function(g,d){var e,b,a,f=[],c="";for(b in g)if(g.hasOwnProperty(b))if(c=b,"object"==typeof g[b])if(d)for(e=
this.parse(g[b],d),a=0;a<e.length;a++)f.push({path:c+"."+e[a].path,value:e[a].value});else for(e=this.parse(g[b]),a=0;a<e.length;a++)f.push({path:c+"."+e[a].path});else f.push(d?{path:c,value:g[b]}:{path:c});return f};l.prototype.parseArr=function(g,d){return d=d||{},this._parseArr(g,"",[],d)};l.prototype._parseArr=function(g,d,e,b){var a,f="";d=d||"";e=e||[];for(a in g)g.hasOwnProperty(a)&&(!b.ignore||b.ignore&&!b.ignore.test(a))&&(f=d?d+"."+a:a,"object"==typeof g[a]?this._parseArr(g[a],f,e,b):e.push(f));
return e};l.prototype.value=function(g,d){if(void 0!==g&&"object"==typeof g){var e,b,a,f,c,k=[];void 0!==d&&(d=this.clean(d),e=d.split("."));e=e||this._pathParts;b=e.length;a=g;for(c=0;b>c;c++){if(a=a[e[c]],f instanceof Array){for(b=0;b<f.length;b++)k=k.concat(this.value(f,b+"."+e[c]));return k}if(!a||"object"!=typeof a)break;f=a}return[a]}return[]};l.prototype.keyValue=function(g,d){var e,b,a,f,c;void 0!==d&&(d=this.clean(d),e=d.split("."));e=e||this._pathParts;b=e.length;a=g;for(c=0;b>c;c++)if(a=
a[e[c]],!a||"object"!=typeof a){f=e[c]+":"+a;break}return f};l.prototype.clean=function(g){return"."===g.substr(0,1)&&(g=g.substr(1,g.length-1)),g};n.exports=l},{"./ForerunnerDB.Shared":16}],15:[function(h,n,l){l=h("./ForerunnerDB.Shared");var g,d,e,b;b=function(){this.init.apply(this,arguments)};b.prototype.init=function(a){a.isClient()&&void 0!==Storage&&this.mode("localStorage")};l.modules.Persist=b;l=l.modules.Core;g=h("./ForerunnerDB.Collection");d=g.prototype.drop;h("./ForerunnerDB.CollectionGroup");
h("./ForerunnerDB.Overload");e=l.prototype.init;b.prototype.mode=function(a){return void 0!==a?(this._mode=a,this):this._mode};b.prototype.save=function(a,b,c){switch(this.mode()){case "localStorage":b="object"==typeof b?"json::fdb::"+JSON.stringify(b):"raw::fdb::"+b,localStorage.setItem(a,b),c&&c(!1)}c&&c("No data handler.")};b.prototype.load=function(a,b){var c,d,e;switch(this.mode()){case "localStorage":if(c=localStorage.getItem(a)){switch(d=c.split("::fdb::"),d[0]){case "json":e=JSON.parse(d[1]);
break;case "raw":e=d[1]}b&&b(!1,e)}}b&&b("No data handler or unrecognised data type.")};b.prototype.drop=function(a,b){switch(this.mode()){case "localStorage":localStorage.removeItem(a),b&&b(!1)}b&&b("No data handler or unrecognised data type.")};g.prototype.drop=function(a){if(a){if(!this._name)return callback&&callback("Cannot drop a collection's persistent storage when no name assigned to collection!"),"Cannot drop a collection's persistent storage when no name assigned to collection!";if(!this._db)return callback&&
callback("Cannot drop a collection's persistent storage when the collection is not attached to a database!"),"Cannot drop a collection's persistent storage when the collection is not attached to a database!";this._db.persist.drop(this._name)}d.apply(this)};g.prototype.save=function(a){return this._name?this._db?void this._db.persist.save(this._name,this._data):(a&&a("Cannot save a collection that is not attached to a database!"),"Cannot save a collection that is not attached to a database!"):(a&&
a("Cannot save a collection with no assigned name!"),"Cannot save a collection with no assigned name!")};g.prototype.load=function(a){var b=this;return this._name?this._db?void this._db.persist.load(this._name,function(c,d){return c?(a&&a(c),c):(d&&b.setData(d),void(a&&a(!1)))}):(a&&a("Cannot load a collection that is not attached to a database!"),"Cannot load a collection that is not attached to a database!"):(a&&a("Cannot load a collection with no assigned name!"),"Cannot load a collection with no assigned name!")};
l.prototype.init=function(){this.persist=new b(this);e.apply(this,arguments)};n.exports=b},{"./ForerunnerDB.Collection":2,"./ForerunnerDB.CollectionGroup":3,"./ForerunnerDB.Overload":13,"./ForerunnerDB.Shared":16}],16:[function(h,n,l){n.exports={idCounter:0,modules:{},prototypes:{}}},{}],17:[function(h,n,l){var g,d,e;l=h("./ForerunnerDB.Shared");var b=function(){this.init.apply(this,arguments)};b.prototype.init=function(a,b,c){this._name=a;this._collections=[];this._groups=[];this._listeners={};this._querySettings=
{query:b,options:c};this._debug={};this._privateData=new g("__FDB__view_privateData_"+this._name)};l.modules.View=b;g=h("./ForerunnerDB.Collection");h("./ForerunnerDB.CollectionGroup");h=h("./ForerunnerDB.Overload");d=g.prototype.init;l=l.modules.Core;e=l.prototype.init;b.prototype.debug=new h([function(){return this._debug.all},function(a){return void 0!==a&&"boolean"==typeof a?(this._debug.all=a,this.privateData().debug(a),this.publicData().debug(a),this):this._debug.all},function(a,b){return void 0!==
a?void 0!==b?(this._debug[a]=b,this.privateData().debug(a,b),this.publicData().debug(a,b),this):this._debug[a]:this._debug.all}]);b.prototype.name=function(a){return void 0!==a?(this._name=a,this):this._name};b.prototype.find=function(a,b){return this.publicData().find(a,b)};b.prototype.insert=function(a,b,c){return a=this._privateData.decouple(a),"function"==typeof b?(c=b,b=this._privateData.length):void 0===b&&(b=this._privateData.length),this._transformInsert(a,b),this.debug()&&console.log('ForerunnerDB.View: Inserting some data on view "'+
this.name()+'" in underlying (internal) view collection "'+this._privateData.name()+'"'),this._privateData._insertHandle(a,b,c)};b.prototype.update=function(a,b){this.debug()&&console.log('ForerunnerDB.View: Updating some data on view "'+this.name()+'" in underlying (internal) view collection "'+this._privateData.name()+'"');var c,d,e,g=this._privateData.update(a,b);if(this._transformEnabled&&this._transformIn){c=this._publicData.primaryKey();for(var h=0;h<g.length;h++)d={},e=g[h],d[c]=e[c],this._transformUpdate(d,
e)}return g};b.prototype.remove=function(a){return this._transformRemove(a),this.debug()&&console.log('ForerunnerDB.View: Removing some data on view "'+this.name()+'" in underlying (internal) view collection "'+this._privateData.name()+'"'),this._privateData.remove(a)};b.prototype.link=function(a,b){var c=this.publicData();return this.debug()&&console.log('ForerunnerDB.View: Setting up data binding on view "'+this.name()+'" in underlying (internal) view collection "'+c.name()+'" for output target: '+
a),c.link(a,b)};b.prototype.unlink=function(a,b){var c=this.publicData();return this.debug()&&console.log('ForerunnerDB.View: Removing data binding on view "'+this.name()+'" in underlying (internal) view collection "'+c.name()+'" for output target: '+a),c.unlink(a,b)};b.prototype.from=function(a){return void 0!==a&&("string"==typeof a&&(a=this._db.collection(a)),this._addCollection(a)),this};b.prototype._addCollection=function(a){if(-1===this._collections.indexOf(a)){this._collections.push(a);a._addView(this);
var b=a.find(this._querySettings.query,this._querySettings.options);this._transformPrimaryKey(a.primaryKey());this._transformInsert(b);this._privateData.primaryKey(a.primaryKey());this._privateData.insert(b)}return this};b.prototype._removeCollection=function(a){return-1<this._collections.indexOf(a)&&(this._collections.splice(a,1),a._removeView(this),this._privateData.remove(a.find(this._querySettings.query,this._querySettings.options))),this};b.prototype.on=function(){this._privateData.on.apply(this._privateData,
arguments)};b.prototype.off=function(){this._privateData.off.apply(this._privateData,arguments)};b.prototype.emit=function(){this._privateData.emit.apply(this._privateData,arguments)};b.prototype.drop=function(){if(this._collections&&this._collections.length){(this._debug||this._db&&this._db._debug)&&console.log("ForerunnerDB.View: Dropping view "+this._name);this.emit("drop");for(var a=this._collections.length;a--;)this._removeCollection(this._collections[a]);return this._privateData.drop(),!0}return!1};
b.prototype.db=function(a){return void 0!==a?(this._db=a,this.privateData().db(a),this.publicData().db(a),this):this._db};b.prototype.primaryKey=function(){return this._privateData.primaryKey()};b.prototype.queryData=function(a,b,c){return void 0!==a&&(this._querySettings.query=a),void 0!==b&&(this._querySettings.options=b),void 0!==a||void 0!==b?((void 0===c||!0===c)&&this.refresh(),this):this._querySettings};b.prototype.queryAdd=function(a,b,c){var d,e=this._querySettings.query;if(void 0!==a)for(d in a)a.hasOwnProperty(d)&&
(void 0===e[d]||void 0!==e[d]&&b)&&(e[d]=a[d]);void 0!==c&&!0!==c||this.refresh()};b.prototype.queryRemove=function(a,b){var c,d=this._querySettings.query;if(void 0!==a)for(c in a)a.hasOwnProperty(c)&&delete d[c];void 0!==b&&!0!==b||this.refresh()};b.prototype.query=function(a,b){return void 0!==a?(this._querySettings.query=a,(void 0===b||!0===b)&&this.refresh(),this):this._querySettings.query};b.prototype.queryOptions=function(a,b){return void 0!==a?(this._querySettings.options=a,void 0===a.decouple&&
(a.decouple=!0),(void 0===b||!0===b)&&this.refresh(),this):this._querySettings.options};b.prototype.refresh=function(){var a,b,c,d=this.publicData();this._privateData.remove();d.remove();for(c=0;c<this._collections.length;c++)b=this._collections[c],this._privateData.insert(b.find(this._querySettings.query,this._querySettings.options));return a=this._privateData.find({},this._querySettings.options),d._linked?$.observable(d._data).refresh(a):(this._privateData._data.length=0,this._privateData._data=
this._privateData._data.concat(a)),this};b.prototype.count=function(){return this._privateData&&this._privateData._data?this._privateData._data.length:0};b.prototype.transform=function(a){return void 0!==a?("object"==typeof a?(void 0!==a.enabled&&(this._transformEnabled=a.enabled),void 0!==a.dataIn&&(this._transformIn=a.dataIn),void 0!==a.dataOut&&(this._transformOut=a.dataOut)):this._transformEnabled=!1===a?!1:!0,this._transformPrimaryKey(this.privateData().primaryKey()),this._transformSetData(this.privateData().find()),
this):{enabled:this._transformEnabled,dataIn:this._transformIn,dataOut:this._transformOut}};b.prototype.privateData=function(){return this._privateData};b.prototype.publicData=function(){return this._transformEnabled?this._publicData:this._privateData};b.prototype._transformSetData=function(a){this._transformEnabled&&(this._publicData=new g("__FDB__view_publicData_"+this._name),this._publicData.db(this._privateData._db),this._publicData.transform({enabled:!0,dataIn:this._transformIn,dataOut:this._transformOut}),
this._publicData.setData(a))};b.prototype._transformInsert=function(a,b){this._transformEnabled&&this._publicData&&this._publicData.insert(a,b)};b.prototype._transformUpdate=function(a,b){this._transformEnabled&&this._publicData&&this._publicData.update(a,b)};b.prototype._transformRemove=function(a){this._transformEnabled&&this._publicData&&this._publicData.remove(a)};b.prototype._transformPrimaryKey=function(a){this._transformEnabled&&this._publicData&&this._publicData.primaryKey(a)};g.prototype.init=
function(){this._views=[];d.apply(this,arguments)};g.prototype.view=function(a,d,c){a=(new b(a,d,c)).db(this._db)._addCollection(this);return this._views=this._views||[],this._views.push(a),a};g.prototype._addView=function(a){return void 0!==a&&this._views.push(a),this};g.prototype._removeView=function(a){void 0!==a&&(a=this._views.indexOf(a),-1<a&&this._views.splice(a,1));return this};l.prototype.init=function(){this._views={};e.apply(this,arguments)};l.prototype.view=function(a){return this._views[a]||
(this._debug||this._db&&this._db._debug)&&console.log("Core.View: Creating view "+a),this._views[a]=this._views[a]||(new b(a)).db(this),this._views[a]};l.prototype.viewExists=function(a){return Boolean(this._views[a])};l.prototype.views=function(){var a,b=[];for(a in this._views)this._views.hasOwnProperty(a)&&b.push({name:a,count:this._views[a].count()});return b};n.exports=b},{"./ForerunnerDB.Collection":2,"./ForerunnerDB.CollectionGroup":3,"./ForerunnerDB.Overload":13,"./ForerunnerDB.Shared":16}]},
{},[1])(1)});
