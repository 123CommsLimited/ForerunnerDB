(function(){var q=function(){var q=0,r=function(a){if(a){var b,c=a.length;return function(){for(b=0;b<c;b++)if(a[b].length===arguments.length)return a[b].apply(this,arguments)}}return function(){}},p=function(){this.init.apply(this,arguments)};p.prototype.init=function(a){a&&this.path(a)};p.prototype.path=function(a){return void 0!==a?(this._path=this.clean(a),this._pathParts=this._path.split("."),this):this._path};p.prototype.parse=function(a,b){var c="",d,e;for(e in a)if(a.hasOwnProperty(e)){c+=
e;"object"===typeof a[e]?b?(d=this.parse(a[e],b),c+="."+d.path,d=d.value):c+="."+this.parse(a[e],b):b&&(d=a[e]);break}return b?{path:c,value:d}:{path:c}};p.prototype.parseArr=function(a,b){b=b||{};return this._parseArr(a,"",[],b)};p.prototype._parseArr=function(a,b,c,d){var e,m="";b=b||"";c=c||[];for(e in a)if(a.hasOwnProperty(e)&&(!d.ignore||d.ignore&&!d.ignore.test(e)))m=b?b+"."+e:e,"object"===typeof a[e]?this._parseArr(a[e],m,c,d):c.push(m);return c};p.prototype.value=function(a){var b=this._pathParts,
c=b.length,d;for(d=0;d<c&&!(a=a[b[d]],!a||"object"!==typeof a);d++);return a};p.prototype.clean=function(a){"."===a.substr(0,1)&&(a=a.substr(1,a.length-1));return a};var f=function(a){this.init.apply(this,arguments)};f.prototype.init=function(a){this._primaryKey="_id";this._name=a;this._data=[];this._groups=[];this._deferQueue={insert:[],update:[],remove:[],upsert:[]};this._deferThreshold={insert:100,update:100,remove:100,upsert:100};this._deferTime={insert:1,update:1,remove:1,upsert:1};this._subsetOf(this)};
f.prototype.on=new r([function(a,b){this._listeners=this._listeners||{};this._listeners[a]=this._listeners[a]||{};this._listeners[a]["*"]=this._listeners[a]["*"]||[];this._listeners[a]["*"].push(b);return this},function(a,b,c){this._listeners=this._listeners||{};this._listeners[a]=this._listeners[a]||{};this._listeners[a][b]=this._listeners[a][b]||[];this._listeners[a][b].push(c);return this}]);f.prototype.off=new r([function(a){this._listeners&&(this._listeners[a]&&a in this._listeners)&&delete this._listeners[a];
return this},function(a,b){var c,d;"string"===typeof b?this._listeners&&(this._listeners[a]&&this._listeners[a][b])&&delete this._listeners[a][b]:a in this._listeners&&(c=this._listeners[a]["*"],d=c.indexOf(b),-1<d&&c.splice(d,1));return this},function(a,b,c){this._listeners&&a in this._listeners&&(a=this._listeners[a][b],c=a.indexOf(c),-1<c&&a.splice(c,1))}]);f.prototype.emit=function(a,b){this._listeners=this._listeners||{};if(a in this._listeners){if(this._listeners[a]["*"]){var c=this._listeners[a]["*"],
d=c.length,e;for(e=0;e<d;e++)c[e].apply(this,Array.prototype.slice.call(arguments,1))}if(b instanceof Array&&b[0]&&b[0][this._primaryKey]){var c=this._listeners[a],m,g,d=b.length;for(e=0;e<d;e++)if(c[b[e][this._primaryKey]]){m=c[b[e][this._primaryKey]].length;for(g=0;g<m;g++)c[b[e][this._primaryKey]][g].apply(this,Array.prototype.slice.call(arguments,1))}}}return this};f.prototype.drop=function(){if(this._db&&this._name){(this._debug||this._db&&this._db._debug)&&console.log("Dropping collection "+
this._name);this.emit("drop");delete this._db._collection[this._name];var a=[],b;for(b=0;b<this._groups.length;b++)a.push(this._groups[b]);for(b=0;b<a.length;b++)this._groups[b].removeCollection(this);return!0}return!1};f.prototype.primaryKey=function(a){return void 0!==a?(this._primaryKey=a,this):this._primaryKey};f.prototype._onInsert=function(a,b){this.emit("insert",a,b)};f.prototype._onUpdate=function(a){this.emit("update",a)};f.prototype._onRemove=function(a){this.emit("remove",a)};f.prototype.db=
function(a){return void 0!==a?(this._db=a,this):this._db};f.prototype.setData=function(a){if(a){a instanceof Array||(a=[a]);var b=this._data;this._data=[];a.length&&(this._data=this._data.concat(a));this.emit("setData",this._data,b)}return this};f.prototype.truncate=function(){this.emit("truncate",this._data);this._data.length=0;this.deferEmit("change");return this};f.prototype.upsert=function(a,b){if(a){var c=this._deferQueue.upsert,d=this._deferThreshold.upsert,e={},m;if(a instanceof Array){if(a.length>
d){this._deferQueue.upsert=c.concat(a);this.processQueue("upsert",b);return}e=[];for(c=0;c<a.length;c++)e.push(this.upsert(a[c]));b&&b();return e}a[this._primaryKey]?(m={},m[this._primaryKey]=a[this._primaryKey],this.count(m)?e.op="update":e.op="insert"):e.op="insert";switch(e.op){case "insert":e.result=this.insert(a);break;case "update":e.result=this.update(m,a)}return e}};f.prototype.update=function(a,b){var c=this,d=this.find(a,{decouple:!1}),e,m=function(d){return c._updateObject(d,b,a)},g=this._views;
if(d.length&&(e=d.filter(m),e.length)){if(g&&g.length)for(d=0;d<g.length;d++)g[d].update(a,b);this._onUpdate(e);this.deferEmit("change",{type:"update",data:e})}return e||[]};f.prototype.updateById=function(a,b){var c={};c[this._primaryKey]=a;return this.update(c,b)};f.prototype._updateObject=function(a,b,c,d){d=d||"";"."===d.substr(0,1)&&(d=d.substr(1,d.length-1));var e=!1,m=!1,g,f,k,h,l;for(h in b)if(b.hasOwnProperty(h)){g=!1;if("$"===h.substr(0,1))switch(h){case "$inc":g=!0;for(l in b[h])if(b[h].hasOwnProperty(l)&&
"$"!==l.substr(0,1))if("number"===typeof a[l])this._updateIncrement(a,l,b[h][l]),e=!0;else throw"Cannot increment field that is not a number! ("+l+")!";break;case "$push":g=!0;for(l in b[h])if(b[h].hasOwnProperty(l)&&"$"!==l.substr(0,1))if(a[l]instanceof Array)this._updatePush(a[l],b[h][l]),e=!0;else throw"Cannot push to a key that is not an array! ("+l+")!";break;case "$splicePush":g=!0;for(l in b[h])if(b[h].hasOwnProperty(l)&&"$"!==l.substr(0,1))if(a[l]instanceof Array){var n=b[h].$index;if(void 0!==
n)delete b[h][l].$index,this._updateSplicePush(a[l],n,b[h][l]),e=!0;else throw"Cannot splicePush without a $index integer value!";}else throw"Cannot splicePush with a key that is not an array! ("+l+")!";break;case "$move":g=!0;for(l in b[h])if(b[h].hasOwnProperty(l)&&"$"!==l.substr(0,1))if(a[l]instanceof Array)for(k=0;k<a[l].length;k++){if(this._match(a[l][k],b[h][l])){e=b[h].$index;if(void 0!==n)this._updateSpliceMove(a[l],k,e),e=!0;else throw"Cannot move without a $index integer value!";break}}else throw"Cannot pull from a key that is not an array! ("+
l+")!";break;case "$pull":for(l in g=!0,b[h])if(b[h].hasOwnProperty(l)&&"$"!==l.substr(0,1))if(a[l]instanceof Array){f=[];for(k=0;k<a[l].length;k++)this._match(a[l][k],b[h][l])&&f.push(k);for(k=f.length;k--;)this._updatePull(a[l],f[k]),e=!0}else throw"Cannot pull from a key that is not an array! ("+l+")!";}if(".$"===h.substr(h.length-2,2)&&(g=!0,h=h.substr(0,h.length-2),m=new p(d+"."+h),a[h]&&a[h]instanceof Array&&a[h].length)){f=[];for(k=0;k<a[h].length;k++)this._match(a[h][k],m.value(c))&&f.push(k);
for(k=0;k<f.length;k++)(m=this._updateObject(a[h][f[k]],b[h+".$"],c,d+"."+h))&&(e=!0)}if(!g)if("object"===typeof b[h])if(null!==a[h]&&"object"===typeof a[h])if(g=a[h]instanceof Array,f=b[h]instanceof Array,g||f)if(!f&&g)for(k=0;k<a[h].length;k++)(m=this._updateObject(a[h][k],b[h],c,d+"."+h))&&(e=!0);else this._updateProperty(a,h,b[h]),e=!0;else(m=this._updateObject(a[h],b[h],c,d+"."+h))&&(e=!0);else this._updateProperty(a,h,b[h]),e=!0;else a[h]!==b[h]&&(this._updateProperty(a,h,b[h]),e=!0)}return e};
f.prototype._updateProperty=function(a,b,c){this._linked?$.observable(a).setProperty(b,c):a[b]=c};f.prototype._updateSpliceMove=function(a,b,c){this._linked?$.observable(a).move(b,c):a.splice(c,0,a.splice(b,1)[0])};f.prototype._updateSplicePush=function(a,b,c){a.length>b?this._linked?$.observable(a).insert(b,c):a.splice(b,0,c):this._linked?$.observable(a).insert(c):a.push(c)};f.prototype._updatePush=function(a,b){this._linked?$.observable(a).insert(b):a.push(b)};f.prototype._updatePull=function(a,
b){this._linked?$.observable(a).remove(b):a.splice(b,1)};f.prototype._updateIncrement=function(a,b,c){this._linked?$.observable(a).setProperty(b,a[b]+c):a[b]+=c};f.prototype.remove=function(a){var b=this.find(a,{decouple:!1}),c,d=this._views;if(b.length){for(var e=0;e<b.length;e++)c=this._data.indexOf(b[e]),this._linked?$.observable(this._data).remove(c):this._data.splice(c,1);if(d&&d.length)for(c=0;c<d.length;c++)d[c].remove(a);this._onRemove(b);this.deferEmit("change",{type:"remove",data:b})}return b};
f.prototype.removeById=function(a){var b={};b[this._primaryKey]=a;return this.remove(b)};f.prototype.deferEmit=function(){var a=this,b;!this._noEmitDefer&&(!this._db||this._db&&!this._db._noEmitDefer)?(b=arguments,this._changeTimeout&&clearTimeout(this._changeTimeout),this._changeTimeout=setTimeout(function(){(a._debug||a._db&&a._db._debug)&&console.log("Collection: emitting "+b[0]);a.emit.apply(a,b)},100)):this.emit.apply(this,arguments)};f.prototype.processQueue=function(a,b){var c=this._deferQueue[a],
d=this._deferThreshold[a],e=this._deferTime[a];if(c.length){var m=this;c.length&&(c=c.length>d?c.splice(0,d):c.splice(0,c.length),this[a](c));setTimeout(function(){m.processQueue(a,b)},e)}else b&&b()};f.prototype.insert=function(a,b,c){"function"===typeof b?(c=b,b=this._data.length):void 0===b&&(b=this._data.length);return this._insertHandle(a,b,c)};f.prototype._insertHandle=function(a,b,c){var d=this._deferQueue.insert,e=this._deferThreshold.insert,m=[],g=[],f=this._views;if(a instanceof Array){if(a.length>
e){this._deferQueue.insert=d.concat(a);this.processQueue("insert",c);return}for(e=0;e<a.length;e++)d=this._insert(a[e],b+e),!0===d?m.push(a[e]):g.push({doc:a[e],reason:d})}else d=this._insert(a,b),!0===d?m.push(a):g.push({doc:a,reason:d});if(f&&f.length)for(d=0;d<f.length;d++)f[d].insert(a,b);this._onInsert(m,g);c&&c();this.deferEmit("change",{type:"insert",data:m});return{inserted:m,failed:g}};f.prototype._insert=function(a,b){return a&&(void 0===a[this._primaryKey]&&(a[this._primaryKey]=this._db.objectId()),
!this._indexViolation(a))?(this._linked?$.observable(this._data).insert(b,a):this._data.splice(b,0,a),!0):!1};f.prototype._indexViolation=function(a){a=this.findById(a[this._primaryKey]);return Boolean(a)};f.prototype.ensureIndex=function(a,b){this._index=this._index||{};b=b||{};b.name||(b.name=JSON.stringify(a));if(this._index[b.name])return{err:"Index already exists"};this._index[b.name]=a;this._reIndex(b.name)};f.prototype._reIndex=function(a){if(!this._index[a])return{err:"Index not found"}};
f.prototype.subset=function(a,b){var c=this.find(a,b);return(new f)._subsetOf(this).primaryKey(this._primaryKey).setData(c)};f.prototype.subsetOf=function(){return this.__subsetOf};f.prototype._subsetOf=function(a){this.__subsetOf=a;return this};f.prototype.decouple=function(a){return JSON.parse(JSON.stringify(a))};f.prototype.findById=function(a,b){var c={};c[this._primaryKey]=a;return this.find(c,b)[0]};f.prototype.find=function(a,b){a=a||{};b=b||{};b.decouple=void 0!==b.decouple?b.decouple:!0;
var c,d=this,e,m,g,f,k,h,l,n,q,s,r=[];f=function(b){return d._match(b,a,"and")};if(a){c=this._analyseQuery(a,b);if(c.hasJoin&&c.queriesJoin)for(e=0;e<c.joinsOn.length;e++)g=c.joinsOn[e],m=new p(c.joinQueries[g]),m=m.value(a),this._db.collection(c.joinsOn[e]).subset(m);c=this._data.filter(f);b.sort&&(c=this.sort(b.sort,c));b.limit&&(c&&c.length>b.limit)&&(c.length=b.limit);b.decouple&&(c=this.decouple(c));if(b.join)for(e=0;e<b.join.length;e++)for(g in b.join[e])if(b.join[e].hasOwnProperty(g)){q=g;
f=this._db.collection(g);m=b.join[e][g];for(s=0;s<c.length;s++){h={};n=l=!1;for(k in m)if(m.hasOwnProperty(k))if("$"===k.substr(0,1))switch(k){case "$as":q=m[k];break;case "$multi":l=m[k];break;case "$require":n=m[k];break;default:k.substr(0,3)}else h[k]=(new p(m[k])).value(c[s]);h=f.find(h);!n||n&&h[0]?c[s][q]=!1===l?h[0]:h:r.push(c[s])}}for(k=0;k<r.length;k++)g=c.indexOf(r[k]),-1<g&&c.splice(g,1);return c}return[]};f.prototype.sort=function(a,b){b=b||[];var c=[],d,e;for(d in a)a.hasOwnProperty(d)&&
(e={},e[d]=a[d],e.___fdbKey=d,c.push(e));return 2>c.length?this._sort(a,b):this._bucketSort(c,b)};f.prototype._bucketSort=function(a,b){var c=a.shift(),d,e,f=[];if(0<a.length){b=this._sort(c,b);d=this.bucket(c.___fdbKey,b);for(e in d)d.hasOwnProperty(e)&&(c=[].concat(a),f=f.concat(this._bucketSort(c,d[e])));return f}return this._sort(c,b)};f.prototype._sort=function(a,b){var c=new p,d=c.parse(a,!0);c.path(d.path);return b.sort(1===d.value?function(a,b){var d=c.value(a),f=c.value(b);return"string"===
typeof d&&"string"===typeof f?d.localeCompare(f):d>f?1:d<f?-1:0}:function(a,b){var d=c.value(a),f=c.value(b);return"string"===typeof d&&"string"===typeof f?1===d.localeCompare(f)?-1:1:d>f?-1:d<f?1:0})};f.prototype.bucket=function(a,b){var c,d={};for(c=0;c<b.length;c++)d[b[c][a]]=d[b[c][a]]||[],d[b[c][a]].push(b[c]);return d};f.prototype._analyseQuery=function(a,b){var c={queriesOn:[this._name],usesIndex:[],hasJoin:!1,queriesJoin:!1,joinQueries:{}},d,e,f=[],g=[];if(b.join){c.hasJoin=!0;for(d=0;d<b.join.length;d++)for(e in b.join[d])b.join[d].hasOwnProperty(e)&&
(f.push(e),"$as"in b.join[d][e]?g.push(b.join[d][e].$as):g.push(e));for(e=0;e<g.length;e++)if(d=this._queryReferencesCollection(a,g[e],""))c.joinQueries[f[e]]=d,c.queriesJoin=!0;c.joinsOn=f;c.queriesOn=c.queriesOn.concat(f)}return c};f.prototype._queryReferencesCollection=function(a,b,c){for(var d in a)if(a.hasOwnProperty(d)){if(d===b)return c&&(c+="."),c+d;if("object"===typeof a[d])return c&&(c+="."),c+=d,this._queryReferencesCollection(a[d],b,c)}return!1};f.prototype._match=function(a,b,c){var d,
e;d=typeof a;e=typeof b;var f=!0,g;if(("string"===d||"number"===d)&&("string"===e||"number"===e))a!==b&&(f=!1);else for(g in b)if(b.hasOwnProperty(g)){d=!1;if("$"===g.substr(0,1))switch(g){case "$gt":if(a>b[g]){if("or"===c)return!0}else f=!1;d=!0;break;case "$gte":if(a>=b[g]){if("or"===c)return!0}else f=!1;d=!0;break;case "$lt":if(a<b[g]){if("or"===c)return!0}else f=!1;d=!0;break;case "$lte":if(a<=b[g]){if("or"===c)return!0}else f=!1;d=!0;break;case "$exists":if(void 0===a!==b[g]){if("or"===c)return!0}else f=
!1;d=!0;break;case "$or":d=!0;for(e=0;e<b[g].length;e++){if(this._match(a,b[g][e],"and"))return!0;f=!1}break;case "$and":d=!0;for(e=0;e<b[g].length;e++)if(!this._match(a,b[g][e],"and"))return!1;break;case "$ne":if(a!=b[g]){if("or"===c)return!0}else f=!1;d=!0}if(!d&&b[g]instanceof RegExp)if(d=!0,"object"===typeof a&&void 0!==a[g]&&b[g].test(a[g])){if("or"===c)return!0}else f=!1;if(!d)if("object"===typeof b[g])if(void 0!==a[g]){if(a[g]instanceof Array&&!(b[g]instanceof Array)){d=!1;for(e=0;e<a[g].length&&
!(d=this._match(a[g][e],b[g],void 0));e++);}else if(!(a[g]instanceof Array)&&b[g]instanceof Array){d=!1;for(e=0;e<b[g].length&&!(d=this._match(a[g],b[g][e],void 0));e++);}else d="object"===typeof a?this._match(a[g],b[g],void 0):this._match(void 0,b[g],void 0);if(d){if("or"===c)return!0}else f=!1}else if(b[g]&&void 0!==b[g].$exists)if(d=this._match(void 0,b[g],void 0)){if("or"===c)return!0}else f=!1;else f=!1;else if(a&&a[g]===b[g]){if("or"===c)return!0}else if(a&&a[g]&&a[g]instanceof Array&&b[g]&&
"object"!==typeof b[g]){d=!1;for(e=0;e<a[g].length&&!(d=this._match(a[g][e],b[g],void 0));e++);if(d){if("or"===c)return!0}else f=!1}else f=!1;if("and"===c&&!f)return!1}return f};f.prototype.count=function(a,b){return a?this.find(a,b).length:this._data.length};f.prototype.link=function(a,b){$.templates[b].link(a,this._data);this._linked=!0};f.prototype.unlink=function(a,b){$.templates[b].unlink(a);this._linked=!1};f.prototype.findSub=function(a,b,c,d){var e=new p(b);a=this.find(a);var f=a.length,g,
n,k=this._db.collection("__FDB_temp_"+this._db.objectId()),h={parents:f,subDocTotal:0,subDocs:[],pathFound:!1,err:""};for(g=0;g<f;g++)if(n=e.value(a[g])){k.setData(n);n=k.find(c,d);if(d.returnFirst&&n.length)return n[0];h.subDocs.push(n);h.subDocTotal+=n.length;h.pathFound=!0}k.drop();if(d.noStats)return h.subDocs;h.pathFound||(h.err="No objects found in the parent documents with a matching path of: "+b);return h};var n=function(){this.init.apply(this,arguments)};n.prototype._isServer=!1;n.prototype.isClient=
function(){return!this._isServer};n.prototype.isServer=function(){return this._isServer};n.prototype.init=function(){this._collection={};for(var a in this.Plugin)this.Plugin.hasOwnProperty(a)&&(this[a.substr(0,1).toLowerCase()+a.substr(1,a.length-1)]=new this.Plugin[a](this))};n.prototype.debug=function(a){return void 0!==a?(this._debug=a,this):this._debug};n.prototype.arrayToCollection=function(a){return(new f).setData(a)};n.prototype.on=function(a,b){this._listeners=this._listeners||{};this._listeners[a]=
this._listeners[a]||[];this._listeners[a].push(b);return this};n.prototype.off=function(a,b){if(a in this._listeners){var c=this._listeners[a],d=c.indexOf(b);-1<d&&c.splice(d,1)}return this};n.prototype.emit=function(a,b){this._listeners=this._listeners||{};if(a in this._listeners){var c=this._listeners[a],d=c.length,e;for(e=0;e<d;e++)c[e].apply(this,Array.prototype.slice.call(arguments,1))}return this};n.prototype.collection=function(a,b){if(a)return this._collection[a]||(this._debug||this._db&&
this._db._debug)&&console.log("Creating collection "+a),this._collection[a]=this._collection[a]||(new f(a)).db(this),void 0!==b&&this._collection[a].primaryKey(b),this._collection[a];throw"Cannot get collection with undefined name!";};n.prototype.collectionExists=function(a){return Boolean(this._collection[a])};n.prototype.collections=function(){var a=[],b;for(b in this._collection)this._collection.hasOwnProperty(b)&&a.push({name:b,count:this._collection[b].count()});return a};n.prototype.objectId=
function(a){if(a){var b=0,c=a.length,d;for(d=0;d<c;d++)b+=a.charCodeAt(d)*Math.pow(10,17);a=b.toString(16)}else q++,a=(q+(Math.random()*Math.pow(10,17)+Math.random()*Math.pow(10,17)+Math.random()*Math.pow(10,17)+Math.random()*Math.pow(10,17))).toString(16);return a};n.classes={Path:p,Collection:f,Overload:r};n.prototype.Plugin={};return n};if("undefined"!==typeof module&&"undefined"!==typeof module.exports){var t=q();t.prototype._isServer=!0;module.exports=t}else"function"===typeof define&&define.amd?
define([],function(){window.ForerunnerDB=q();return window.ForerunnerDB}):window.ForerunnerDB=q()})();
