var ForerunnerDB=function(){var u=0,n=function(){this.init.apply(this,arguments)};n.prototype.init=function(a){a&&this.path(a)};n.prototype.path=function(a){return void 0!==a?(this._path=this.clean(a),this._pathParts=this._path.split("."),this):this._path};n.prototype.parse=function(a,b){var c="",d,f;for(f in a)if(a.hasOwnProperty(f)){c+=f;"object"===typeof a[f]?b?(d=this.parse(a[f],b),c+="."+d.path,d=d.value):c+="."+this.parse(a[f],b):b&&(d=a[f]);break}return b?{path:c,value:d}:{path:c}};n.prototype.value=
function(a){var b=this._pathParts,c=b.length,d;for(d=0;d<c&&!(a=a[b[d]],!a||"object"!==typeof a);d++);return a};n.prototype.clean=function(a){"."===a.substr(0,1)&&(a=a.substr(1,a.length-1));return a};var e=function(a){this.init.apply(this,arguments)};e.prototype.init=function(a){this._primaryKey="_id";this._name=a;this._data=[];this._groups=[];this._subsetOf(this)};e.prototype.on=function(a,b){this._listeners=this._listeners||{};this._listeners[a]=this._listeners[a]||[];this._listeners[a].push(b);
return this};e.prototype.off=function(a,b){if(a in this._listeners){var c=this._listeners[a],d=c.indexOf(b);-1<d&&c.splice(d,1)}return this};e.prototype.emit=function(a,b){this._listeners=this._listeners||{};if(a in this._listeners){var c=this._listeners[a],d=c.length,f;for(f=0;f<d;f++)c[f].apply(this,Array.prototype.slice.call(arguments,1))}return this};e.prototype.drop=function(){if(this._db&&this._name){(this._debug||this._db&&this._db._debug)&&console.log("Dropping collection "+this._name);this.emit("drop");
delete this._db._collection[this._name];var a=[],b;for(b=0;b<this._groups.length;b++)a.push(this._groups[b]);for(b=0;b<a.length;b++)this._groups[b].removeCollection(this);return!0}return!1};e.prototype.primaryKey=function(a){return void 0!==a?(this._primaryKey=a,this):this._primaryKey};e.prototype._onInsert=function(a,b){this.emit("insert",a,b)};e.prototype._onUpdate=function(a){this.emit("update",a)};e.prototype._onRemove=function(a){this.emit("remove",a)};e.prototype.db=function(a){return void 0!==
a?(this._db=a,this):this._db};e.prototype.setData=function(a){a&&(this._data=[],this._data=this._data.concat(a),this.emit("setData",this._data));return this};e.prototype.truncate=function(){this.emit("truncate",this._data);this._data.length=0;return this};e.prototype.upsert=function(a){var b={},c;if(a instanceof Array){b=[];for(c=0;c<a.length;c++)b.push(this.upsert(a[c]));return b}a[this._primaryKey]?(c={},c[this._primaryKey]=a[this._primaryKey],this.count(c)?b.op="update":b.op="insert"):b.op="insert";
switch(b.op){case "insert":b.result=this.insert(a);break;case "update":b.result=this.update(c,a)}return b};e.prototype.update=function(a,b){var c=this,d=this.find(a,{decouple:!1}),f,p=function(d){return c._updateObject(d,b,a)};d.length&&(f=d.filter(p),f.length&&this._onUpdate(f));return f||[]};e.prototype.updateById=function(a,b){var c={};c[this._primaryKey]=a;return this.update(c,b)};e.prototype._updateObject=function(a,b,c,d){d=d||"";"."===d.substr(0,1)&&(d=d.substr(1,d.length-1));var f=!1,p=!1,
g,e,k,h,l;for(h in b)if(b.hasOwnProperty(h)){g=!1;if("$"===h.substr(0,1))switch(h){case "$inc":g=!0;for(l in b[h])if(b[h].hasOwnProperty(l))if("number"===typeof a[l])a[l]+=b[h][l],f=!0;else throw"Cannot increment field that is not a number! ("+l+")!";break;case "$push":g=!0;for(l in b[h])if(b[h].hasOwnProperty(l))if(a[l]instanceof Array)a[l].push(b[h][l]),f=!0;else throw"Cannot push to a key that is not an array! ("+l+")!";break;case "$pull":for(l in g=!0,b[h])if(b[h].hasOwnProperty(l))if(a[l]instanceof
Array){e=[];for(k=0;k<a[l].length;k++)this._match(a[l][k],b[h][l])&&e.push(k);for(k=e.length;k--;)a[l].splice(e[k],1),f=!0}else throw"Cannot pull from a key that is not an array! ("+l+")!";}if(".$"===h.substr(h.length-2,2)&&(g=!0,h=h.substr(0,h.length-2),p=new n(d+"."+h),a[h]&&a[h]instanceof Array&&a[h].length)){e=[];for(k=0;k<a[h].length;k++)this._match(a[h][k],p.value(c))&&e.push(k);for(k=0;k<e.length;k++)(p=this._updateObject(a[h][e[k]],b[h+".$"],c,d+"."+h))&&(f=!0)}if(!g)if("object"===typeof b[h])if(null!==
a[h]&&"object"===typeof a[h])if(g=a[h]instanceof Array,e=b[h]instanceof Array,g||e)if(!e&&g)for(k=0;k<a[h].length;k++)(p=this._updateObject(a[h][k],b[h],c,d+"."+h))&&(f=!0);else a[h]=b[h],f=!0;else(p=this._updateObject(a[h],b[h],c,d+"."+h))&&(f=!0);else a[h]=b[h],f=!0;else a[h]!==b[h]&&(a[h]=b[h],f=!0)}return f};e.prototype.remove=function(a){a=this.find(a,{decouple:!1});var b;if(a.length){for(var c=0;c<a.length;c++)b=this._data.indexOf(a[c]),this._data.splice(b,1);this._onRemove(a)}return a};e.prototype.removeById=
function(a){var b={};b[this._primaryKey]=a;return this.remove(b)};e.prototype.insert=function(a){var b=[],c=[],d,f;if(a instanceof Array)for(f=0;f<a.length;f++)d=this._insert(a[f]),!0===d?b.push(a[f]):c.push({doc:a[f],reason:d});else d=this._insert(a),!0===d?b.push(a):c.push({doc:a,reason:d});this._onInsert(b,c);return{inserted:b,failed:c}};e.prototype._insert=function(a){return a&&!this._indexViolation(a)?(this._data.push(a),!0):!1};e.prototype._indexViolation=function(a){a=this.findById(a[this._primaryKey]);
return Boolean(a)};e.prototype.subset=function(a,b){var c=this.find(a,b);return(new e)._subsetOf(this).primaryKey(this._primaryKey).setData(c)};e.prototype.subsetOf=function(){return this.__subsetOf};e.prototype._subsetOf=function(a){this.__subsetOf=a;return this};e.prototype.decouple=function(a){return JSON.parse(JSON.stringify(a))};e.prototype.findById=function(a,b){var c={};c[this._primaryKey]=a;return this.find(c,b)[0]};e.prototype.find=function(a,b){a=a||{};b=b||{};b.decouple=void 0!==b.decouple?
b.decouple:!0;var c,d=this,f,e,g,m,k,h,l,r,s,q,t=[];m=function(b){return d._match(b,a,"and")};if(a){c=this._analyseQuery(a,b);if(c.hasJoin&&c.queriesJoin)for(f=0;f<c.joinsOn.length;f++)g=c.joinsOn[f],e=new n(c.joinQueries[g]),e=e.value(a),this._db.collection(c.joinsOn[f]).subset(e);c=this._data.filter(m);b.sort&&(c=this.sort(b.sort,c));b.limit&&(c.length=b.limit);b.decouple&&(c=this.decouple(c));if(b.join)for(f=0;f<b.join.length;f++)for(g in b.join[f])if(b.join[f].hasOwnProperty(g)){s=g;m=this._db.collection(g);
e=b.join[f][g];for(q=0;q<c.length;q++){h={};r=l=!1;for(k in e)if(e.hasOwnProperty(k))if("$"===k.substr(0,1))switch(k){case "$as":s=e[k];break;case "$multi":l=e[k];break;case "$require":r=e[k]}else h[k]=(new n(e[k])).value(c[q]);h=m.find(h);!r||r&&h[0]?c[q][s]=!1===l?h[0]:h:t.push(c[q])}}for(k=0;k<t.length;k++)g=c.indexOf(t[k]),-1<g&&c.splice(g,1);return c}return[]};e.prototype.sort=function(a,b){b=b||[];var c=[],d,f;for(d in a)a.hasOwnProperty(d)&&(f={},f[d]=a[d],f.___fdbKey=d,c.push(f));return 2>
c.length?this._sort(a,b):this._bucketSort(c,b)};e.prototype._bucketSort=function(a,b){var c=a.shift(),d,f,e=[];if(0<a.length){b=this._sort(c,b);d=this.bucket(c.___fdbKey,b);for(f in d)d.hasOwnProperty(f)&&(c=[].concat(a),e=e.concat(this._bucketSort(c,d[f])));return e}return this._sort(c,b)};e.prototype._sort=function(a,b){var c=new n,d=c.parse(a,!0);c.path(d.path);return b.sort(1===d.value?function(a,b){var d=c.value(a),e=c.value(b);return d>e?1:d<e?-1:0}:function(a,b){var d=c.value(a),e=c.value(b);
return d>e?-1:d<e?1:0})};e.prototype.bucket=function(a,b){var c,d={};for(c=0;c<b.length;c++)d[b[c][a]]=d[b[c][a]]||[],d[b[c][a]].push(b[c]);return d};e.prototype._analyseQuery=function(a,b){var c={queriesOn:[this._name],usesIndex:[],hasJoin:!1,queriesJoin:!1,joinQueries:{}},d,f,e=[],g=[];if(b.join){c.hasJoin=!0;for(d=0;d<b.join.length;d++)for(f in b.join[d])b.join[d].hasOwnProperty(f)&&(e.push(f),"$as"in b.join[d][f]?g.push(b.join[d][f].$as):g.push(f));for(f=0;f<g.length;f++)if(d=this._queryReferencesCollection(a,
g[f],""))c.joinQueries[e[f]]=d,c.queriesJoin=!0;c.joinsOn=e;c.queriesOn=c.queriesOn.concat(e)}return c};e.prototype._queryReferencesCollection=function(a,b,c){for(var d in a)if(a.hasOwnProperty(d)){if(d===b)return c&&(c+="."),c+d;if("object"===typeof a[d])return c&&(c+="."),c+=d,this._queryReferencesCollection(a[d],b,c)}return!1};e.prototype._match=function(a,b,c){if(this._debug)debugger;var d,f;d=typeof a;f=typeof b;var e=!0,g;if(("string"===d||"number"===d)&&("string"===f||"number"===f))a!==b&&
(e=!1);else for(g in b)if(b.hasOwnProperty(g)){d=!1;if("$"===g.substr(0,1))switch(g){case "$gt":if(a>b[g]){if("or"===c)return!0}else e=!1;d=!0;break;case "$gte":if(a>=b[g]){if("or"===c)return!0}else e=!1;d=!0;break;case "$lt":if(a<b[g]){if("or"===c)return!0}else e=!1;d=!0;break;case "$lte":if(a<=b[g]){if("or"===c)return!0}else e=!1;d=!0;break;case "$exists":if(void 0===a!==b[g]){if("or"===c)return!0}else e=!1;d=!0;break;case "$or":d=!0;for(f=0;f<b[g].length;f++){if(this._match(a,b[g][f],"and"))return!0;
e=!1}break;case "$and":d=!0;for(f=0;f<b[g].length;f++)if(!this._match(a,b[g][f],"and"))return!1}if(!d&&b[g]instanceof RegExp)if(d=!0,"object"===typeof a&&void 0!==a[g]&&b[g].test(a[g])){if("or"===c)return!0}else e=!1;if(!d)if("object"===typeof b[g])if(void 0!==a[g]){if(a[g]instanceof Array&&!(b[g]instanceof Array)){d=!1;for(f=0;f<a[g].length&&!(d=this._match(a[g][f],b[g],void 0));f++);}else if(!(a[g]instanceof Array)&&b[g]instanceof Array){d=!1;for(f=0;f<b[g].length&&!(d=this._match(a[g],b[g][f],
void 0));f++);}else d="object"===typeof a?this._match(a[g],b[g],void 0):this._match(void 0,b[g],void 0);if(d){if("or"===c)return!0}else e=!1}else if(void 0!==b[g].$exists)if(d=this._match(void 0,b[g],void 0)){if("or"===c)return!0}else e=!1;else e=!1;else if(a&&a[g]===b[g]){if("or"===c)return!0}else e=!1;if("and"===c&&!e)return!1}return e};e.prototype.count=function(a,b){return a?this.find(a,b).length:this._data.length};var v=function(a){u++;this._val=a?a:(u+(Math.random()*Math.pow(10,17)+Math.random()*
Math.pow(10,17)+Math.random()*Math.pow(10,17)+Math.random()*Math.pow(10,17))).toString(24)};v.prototype.toString=function(){return this._val};var m=function(){this.init.apply(this,arguments)};m.prototype.init=function(){this._collection={};for(var a in this.Plugin)this.Plugin.hasOwnProperty(a)&&(this[a.substr(0,1).toLowerCase()+a.substr(1,a.length-1)]=new this.Plugin[a](this))};m.prototype.debug=function(a){return void 0!==a?(this._debug=a,this):this._debug};m.prototype.arrayToCollection=function(a){return(new e).setData(a)};
m.prototype.on=function(a,b){this._listeners=this._listeners||{};this._listeners[a]=this._listeners[a]||[];this._listeners[a].push(b);return this};m.prototype.off=function(a,b){if(a in this._listeners){var c=this._listeners[a],d=c.indexOf(b);-1<d&&c.splice(d,1)}return this};m.prototype.emit=function(a,b){this._listeners=this._listeners||{};if(a in this._listeners){var c=this._listeners[a],d=c.length,e;for(e=0;e<d;e++)c[e].apply(this,Array.prototype.slice.call(arguments,1))}return this};m.prototype.collection=
function(a,b){if(a)return this._collection[a]||(this._debug||this._db&&this._db._debug)&&console.log("Creating collection "+a),this._collection[a]=this._collection[a]||(new e(a)).db(this),void 0!==b&&this._collection[a].primaryKey(b),this._collection[a];throw"Cannot get collection with undefined name!";};m.prototype.collectionExists=function(a){return Boolean(this._collection[a])};m.prototype.collections=function(){var a=[],b;for(b in this._collection)this._collection.hasOwnProperty(b)&&a.push({name:b,
count:this._collection[b].count()});return a};m.classes={Path:n,Collection:e,ObjectId:v};m.prototype.Plugin={};return m}();"undefined"!==typeof module&&"undefined"!==typeof module.exports&&(module.exports=ForerunnerDB);
