exports=module.exports=function(){var g=function(a){this._db=a;this._app=require("http").createServer(function(a,d){d.writeHead(200);d.end()});this._io=require("socket.io").listen(this._app);this._fs=require("fs");console.log("Init ")};g.prototype.addAuth=function(a){return a.user&&a.pass?(this._db.collection("_fdbAuth").insert(a),!0):!1};g.prototype.start=function(){console.log("Starting listener...");var a=this;this._app.listen(9E3);this._io.sockets.on("connection",function(c){var d=null,f;c.on("auth",
function(b,e){var c=a._db.collection("_fdbAuth").find({user:b.user,pass:b.pass});d=c[0];f=Boolean(c[0]);e({err:!1,result:f})});c.on("setData",function(b,e){a.isAllowed("setData",d,b,{},e)&&(a._db.collection(b.collection).setData(b.query,b.options),e({err:!1,result:!0}))});c.on("insert",function(b,e){if(a.isAllowed("insert",d,b,{},e)){var c=a._db.collection(b.collection).insert(b.query,b.options);e({err:!1,result:c})}});c.on("find",function(b,e){if(a.isAllowed("find",d,b,{},e)){var c=a._db.collection(b.collection).find(b.query,
b.options);e({err:!1,result:c})}});c.on("update",function(b,c){if(a.isAllowed("update",d,b,{},c)){var f=a._db.collection(b.collection).update(b.query,b.update,b.options);c({err:!1,result:f})}});c.on("remove",function(b,c){if(a.isAllowed("remove",d,b,{},c)){var f=a._db.collection(b.collection).remove(b.query,b.options);c({err:!1,result:f})}})})};g.prototype.hasPermission=function(a,c,d){return a?c?a.collectionActions&&a.collectionActions[c]&&void 0!==a.collectionActions[c][d]?a.collectionActions[c][d]:
a.globalActions&&a.globalActions[d]:a.globalActions&&a.globalActions[d]:!1};g.prototype.isAllowed=function(a,c,d,f,b){if("_"===d.collection.substr(0,1)&&!this.hasPermission(c,null,"root"))return b({err:"Cannot remotely interact with private collection: "+d.collection,result:null}),!1;if(!this.hasPermission(c,d.collection,a))return b({err:'No permission to "'+a+'" on collection "'+d.collection+'"',result:null}),!1;if(d.options&&d.options.join)for(f=0;f<d.options.join.length;f++)for(var e in d.options.join[f])if(d.options.join[f].hasOwnProperty(e))if("_"===
e.substr(0,1)){if(!this.hasPermission(c,e,"root"))return b({err:'Cannot remotely interact with private collection "'+e+'" via join',result:null}),!1}else if(!this.hasPermission(c,e,a))return b({err:'Cannot "'+a+'" on collection "'+e+'" via join',result:null}),!1;return!0};return g}();
