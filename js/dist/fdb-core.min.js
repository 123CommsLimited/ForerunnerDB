!function(w){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=w();else if("function"==typeof define&&define.amd)define([],w);else{var h;"undefined"!=typeof window?h=window:"undefined"!=typeof global?h=global:"undefined"!=typeof self&&(h=self);h.ForerunnerDB=w()}}(function(){return function h(r,l,f){function a(d,q){if(!l[d]){if(!r[d]){var c="function"==typeof require&&require;if(!q&&c)return c(d,!0);if(e)return e(d,!0);c=Error("Cannot find module '"+d+"'");throw c.code="MODULE_NOT_FOUND",
c;}c=l[d]={exports:{}};r[d][0].call(c.exports,function(b){var g=r[d][1][b];return a(g?g:b)},c,c.exports,h,r,l,f)}return l[d].exports}for(var e="function"==typeof require&&require,d=0;d<f.length;d++)a(f[d]);return a}({1:[function(h,r,l){h=h("../lib/Core");r.exports=h},{"../lib/Core":3}],2:[function(h,r,l){var f,a,e,d,k,q;f=h("./Shared");var c=function(b){this.init.apply(this,arguments)};c.prototype.init=function(b){this._primaryKey="_id";this._primaryIndex=new e("primary");this._primaryCrc=new e("primaryCrc");
this._crcLookup=new e("crcLookup");this._name=b;this._data=[];this._groups=[];this._metrics=new a;this._linked=0;this._debug={};this._deferQueue={insert:[],update:[],remove:[],upsert:[]};this._deferThreshold={insert:100,update:100,remove:100,upsert:100};this._deferTime={insert:1,update:1,remove:1,upsert:1};this._subsetOf(this)};f.modules.Collection=c;l=h("./Overload");a=h("./Metrics");e=h("./KeyValueStore");d=h("./Path");k=h("./Index");q=h("./Crc");h=f.modules.Core;c.prototype.debug=new l([function(){return this._debug.all},
function(b){if(void 0!==b){if("boolean"===typeof b){this._debug.all=b;for(var g=0;g<this._views.length;g++)this._views[g].debug(b);return this}return this._debug[b]||this._db&&this._db._debug&&this._db._debug[b]||this._debug.all}return this._debug.all},function(b,g){if(void 0!==b){if(void 0!==g){this._debug[b]=g;for(var m=0;m<this._views.length;m++)this._views[m].debug(b,g);return this}return this._debug[b]||this._db&&this._db._debug&&this._db._debug[b]}return this._debug.all}]);c.prototype.crc=q;
c.prototype.name=function(b){return void 0!==b?(this._name=b,this):this._name};c.prototype.on=new l([function(b,g){this._listeners=this._listeners||{};this._listeners[b]=this._listeners[b]||{};this._listeners[b]["*"]=this._listeners[b]["*"]||[];this._listeners[b]["*"].push(g);return this},function(b,g,m){this._listeners=this._listeners||{};this._listeners[b]=this._listeners[b]||{};this._listeners[b][g]=this._listeners[b][g]||[];this._listeners[b][g].push(m);return this}]);c.prototype.off=new l([function(b){this._listeners&&
this._listeners[b]&&b in this._listeners&&delete this._listeners[b];return this},function(b,g){var m,a;"string"===typeof g?this._listeners&&this._listeners[b]&&this._listeners[b][g]&&delete this._listeners[b][g]:b in this._listeners&&(m=this._listeners[b]["*"],a=m.indexOf(g),-1<a&&m.splice(a,1));return this},function(b,g,m){this._listeners&&b in this._listeners&&(b=this._listeners[b][g],m=b.indexOf(m),-1<m&&b.splice(m,1))}]);c.prototype.emit=function(b,g){this._listeners=this._listeners||{};if(b in
this._listeners){if(this._listeners[b]["*"]){var m=this._listeners[b]["*"],a=m.length,s;for(s=0;s<a;s++)m[s].apply(this,Array.prototype.slice.call(arguments,1))}if(g instanceof Array&&g[0]&&g[0][this._primaryKey]){var m=this._listeners[b],d,e,a=g.length;for(s=0;s<a;s++)if(m[g[s][this._primaryKey]])for(d=m[g[s][this._primaryKey]].length,e=0;e<d;e++)m[g[s][this._primaryKey]][e].apply(this,Array.prototype.slice.call(arguments,1))}}return this};c.prototype.drop=function(){if(this._db&&this._name){this.debug()&&
console.log("Dropping collection "+this._name);this.emit("drop");delete this._db._collection[this._name];var b=[],g;for(g=0;g<this._groups.length;g++)b.push(this._groups[g]);for(g=0;g<b.length;g++)this._groups[g].removeCollection(this);return!0}return!1};c.prototype.primaryKey=function(b){return void 0!==b?(this._primaryKey=b,this._primaryIndex.primaryKey(b),this._rebuildPrimaryKeyIndex(),this):this._primaryKey};c.prototype._onInsert=function(b,g){this.emit("insert",b,g)};c.prototype._onUpdate=function(b){this.emit("update",
b)};c.prototype._onRemove=function(b){this.emit("remove",b)};c.prototype.db=function(b){return void 0!==b?(this._db=b,this):this._db};c.prototype.setData=function(b,g,m){if(b){var a=this._metrics.create("setData");a.start();b instanceof Array||(b=[b]);a.time("transformIn");b=this.transformIn(b);a.time("transformIn");var d=this._data;this._data=[];b.length&&(this._data=this._data.concat(b));a.time("_rebuildPrimaryKeyIndex");this._rebuildPrimaryKeyIndex(g);a.time("_rebuildPrimaryKeyIndex");a.stop();
this.emit("setData",this._data,d)}m&&m(!1);return this};c.prototype._rebuildPrimaryKeyIndex=function(b){var g=b&&void 0!==b.ensureKeys?b.ensureKeys:!0;b=b&&void 0!==b.violationCheck?b.violationCheck:!0;var m,a,d,e=this._primaryIndex,c=this._primaryCrc,f=this._crcLookup,k=this._primaryKey,h;e.truncate();c.truncate();f.truncate();m=this._data;for(a=m.length;a--;)if(d=m[a],g&&this._ensurePrimaryKey(d),b){if(!e.uniqueSet(d[k],d))throw"Call to setData failed because your data violates the primary key unique constraint. One or more documents are using the same primary key: "+
d[this._primaryKey];}else h=JSON.stringify(d),e.set(d[k],d),c.set(d[k],h),f.set(h,d)};c.prototype._ensurePrimaryKey=function(b){void 0===b[this._primaryKey]&&(b[this._primaryKey]=this.objectId())};c.prototype.truncate=function(){this.emit("truncate",this._data);this._data.length=0;this.deferEmit("change");return this};c.prototype.upsert=function(b,g){if(b){var m=this._deferQueue.upsert,a=this._deferThreshold.upsert,d={},e;if(b instanceof Array){if(b.length>a){this._deferQueue.upsert=m.concat(b);this.processQueue("upsert",
g);return}d=[];for(m=0;m<b.length;m++)d.push(this.upsert(b[m]));g&&g();return d}b[this._primaryKey]?(e={},e[this._primaryKey]=b[this._primaryKey],this.count(e)?d.op="update":d.op="insert"):d.op="insert";switch(d.op){case "insert":d.result=this.insert(b);break;case "update":d.result=this.update(e,b)}return d}g&&g()};c.prototype.update=function(b,g,m){g=this.decouple(g);g=this.transformIn(g);this.debug()&&console.log('Updating some collection data for collection "'+this.name()+'"');var a=this,d=this._metrics.create("update"),
e=this._primaryKey,c,f,k=function(d){if(g&&void 0!==g[e]&&g[e]!=d[e]){a._primaryIndex.unSet(d[e]);var c=a._updateObject(d,g,b,m,"");if(a._primaryIndex.uniqueSet(d[e],d))return c;throw"Primary key violation in update! Key violated: "+d[e];}return a._updateObject(d,g,b,m,"")},h=this._views;d.start();d.time("Retrieve documents to update");c=this.find(b,{decouple:!1});d.time("Retrieve documents to update");if(c.length&&(d.time("Update documents"),f=c.filter(k),d.time("Update documents"),f.length)){if(h&&
h.length){this.debug("views")&&console.log("Updating views from collection: "+this.name());d.time("Inform views of update");for(c=0;c<h.length;c++)h[c].update(b,g);d.time("Inform views of update")}this._onUpdate(f);this.deferEmit("change",{type:"update",data:f})}d.stop();return f||[]};c.prototype.updateById=function(b,g){var m={};m[this._primaryKey]=b;return this.update(m,g)};c.prototype._updateObject=function(b,g,m,a,e){g=this.decouple(g);e=e||"";"."===e.substr(0,1)&&(e=e.substr(1,e.length-1));var c=
!1,f=!1,k,h,q,p,n;for(p in g)if(g.hasOwnProperty(p)){k=!1;if("$"===p.substr(0,1))switch(p){case "$inc":k=!0;for(n in g[p])if(g[p].hasOwnProperty(n)&&"$"!==n.substr(0,1))if("number"===typeof b[n])this._updateIncrement(b,n,g[p][n]),c=!0;else throw"Cannot increment field that is not a number! ("+n+")!";break;case "$push":k=!0;for(n in g[p])if(g[p].hasOwnProperty(n)&&"$"!==n.substr(0,1))if(void 0===b[n]&&(b[n]=[]),b[n]instanceof Array)this._updatePush(b[n],g[p][n]),c=!0;else throw"Cannot push to a key that is not an array! ("+
n+")!";break;case "$addToSet":k=!0;for(n in g[p])if(g[p].hasOwnProperty(n)&&"$"!==n.substr(0,1))if(b[n]instanceof Array){h=b[n];var l;q=h.length;var r,f=!0;l=a&&a.$addToSet;var t,v;l&&l.key?(t=!1,v=new d(l.key),r=v.value(g[p][n])[0]):(r=JSON.stringify(g[p][n]),t=!0);for(l=0;l<q;l++)if(t){if(JSON.stringify(h[l])===r){f=!1;break}}else if(r===v.value(h[l])[0]){f=!1;break}f&&(this._updatePush(b[n],g[p][n]),c=!0)}else throw"Cannot push to a key that is not an array! ("+n+")!";break;case "$splicePush":k=
!0;for(n in g[p])if(g[p].hasOwnProperty(n)&&"$"!==n.substr(0,1))if(b[n]instanceof Array)if(c=g[p].$index,void 0!==c)delete g[p][n].$index,this._updateSplicePush(b[n],c,g[p][n]),c=!0;else throw"Cannot splicePush without a $index integer value!";else throw"Cannot splicePush with a key that is not an array! ("+n+")!";break;case "$move":k=!0;for(n in g[p])if(g[p].hasOwnProperty(n)&&"$"!==n.substr(0,1))if(b[n]instanceof Array)for(q=0;q<b[n].length;q++){if(this._match(b[n][q],g[p][n])){c=g[p].$index;if(void 0!==
c)this._updateSpliceMove(b[n],q,c),c=!0;else throw"Cannot move without a $index integer value!";break}}else throw"Cannot pull from a key that is not an array! ("+n+")!";break;case "$pull":for(n in k=!0,g[p])if(g[p].hasOwnProperty(n)&&"$"!==n.substr(0,1))if(b[n]instanceof Array){h=[];for(q=0;q<b[n].length;q++)this._match(b[n][q],g[p][n])&&h.push(q);for(q=h.length;q--;)this._updatePull(b[n],h[q]),c=!0}else throw"Cannot pull from a key that is not an array! ("+n+")!";}if(".$"===p.substr(p.length-2,2)&&
(k=!0,p=p.substr(0,p.length-2),f=new d(e+"."+p),b[p]&&b[p]instanceof Array&&b[p].length)){h=[];for(q=0;q<b[p].length;q++)this._match(b[p][q],f.value(m)[0])&&h.push(q);for(q=0;q<h.length;q++)(f=this._updateObject(b[p][h[q]],g[p+".$"],m,a,e+"."+p))&&(c=!0)}if(!k)if("object"===typeof g[p])if(null!==b[p]&&"object"===typeof b[p])if(k=b[p]instanceof Array,h=g[p]instanceof Array,k||h)if(!h&&k)for(q=0;q<b[p].length;q++)(f=this._updateObject(b[p][q],g[p],m,a,e+"."+p))&&(c=!0);else this._updateProperty(b,p,
g[p]),c=!0;else(f=this._updateObject(b[p],g[p],m,a,e+"."+p))&&(c=!0);else this._updateProperty(b,p,g[p]),c=!0;else b[p]!==g[p]&&(this._updateProperty(b,p,g[p]),c=!0)}return c};c.prototype._updateProperty=function(b,g,m){this._linked?($.observable(b).setProperty(g,m),this.debug()&&console.log('ForerunnerDB.Collection: Setting data-bound document property "'+g+'" for collection "'+this.name()+'"')):(b[g]=m,this.debug()&&console.log('ForerunnerDB.Collection: Setting non-data-bound document property "'+
g+'" for collection "'+this.name()+'"'))};c.prototype._updateSpliceMove=function(b,g,m){this._linked?($.observable(b).move(g,m),this.debug()&&console.log('ForerunnerDB.Collection: Moving data-bound document array index from "'+g+'" to "'+m+'" for collection "'+this.name()+'"')):(b.splice(m,0,b.splice(g,1)[0]),this.debug()&&console.log('ForerunnerDB.Collection: Moving non-data-bound document array index from "'+g+'" to "'+m+'" for collection "'+this.name()+'"'))};c.prototype._updateSplicePush=function(b,
g,m){b.length>g?this._linked?$.observable(b).insert(g,m):b.splice(g,0,m):this._linked?$.observable(b).insert(m):b.push(m)};c.prototype._updatePush=function(b,g){this._linked?$.observable(b).insert(g):b.push(g)};c.prototype._updatePull=function(b,g){this._linked?$.observable(b).remove(g):b.splice(g,1)};c.prototype._updateIncrement=function(b,g,m){this._linked?$.observable(b).setProperty(g,b[g]+m):b[g]+=m};c.prototype.remove=function(b){var g,m,a=this._views,d;if(b instanceof Array){a=[];for(g=0;g<
b.length;g++)a.push(this.remove(b[g]));return a}g=this.find(b,{decouple:!1});if(g.length){for(d=0;d<g.length;d++)m=g[d],this._removeIndex(m),m=this._data.indexOf(m),this._linked?$.observable(this._data).remove(m):this._data.splice(m,1);if(a&&a.length)for(d=0;d<a.length;d++)a[d].remove(b);this._onRemove(g);this.deferEmit("change",{type:"remove",data:g})}return g};c.prototype.removeById=function(b){var g={};g[this._primaryKey]=b;return this.remove(g)};c.prototype.deferEmit=function(){var b=this,g;this._noEmitDefer||
this._db&&(!this._db||this._db._noEmitDefer)?this.emit.apply(this,arguments):(g=arguments,this._changeTimeout&&clearTimeout(this._changeTimeout),this._changeTimeout=setTimeout(function(){b.debug()&&console.log("ForerunnerDB.Collection: Emitting "+g[0]);b.emit.apply(b,g)},100))};c.prototype.processQueue=function(b,g){var m=this._deferQueue[b],a=this._deferThreshold[b],d=this._deferTime[b];if(m.length){var e=this;m.length&&(m=m.length>a?m.splice(0,a):m.splice(0,m.length),this[b](m));setTimeout(function(){e.processQueue(b,
g)},d)}else g&&g()};c.prototype.insert=function(b,g,m){"function"===typeof g?(m=g,g=this._data.length):void 0===g&&(g=this._data.length);b=this.transformIn(b);return this._insertHandle(b,g,m)};c.prototype._insertHandle=function(b,g,m){var a=this._deferQueue.insert,d=this._deferThreshold.insert,e=[],c=[],f=this._views;if(b instanceof Array){if(b.length>d){this._deferQueue.insert=a.concat(b);this.processQueue("insert",m);return}for(d=0;d<b.length;d++)a=this._insert(b[d],g+d),!0===a?e.push(b[d]):c.push({doc:b[d],
reason:a})}else a=this._insert(b,g),!0===a?e.push(b):c.push({doc:b,reason:a});if(f&&f.length)for(a=0;a<f.length;a++)f[a].insert(b,g);this._onInsert(e,c);m&&m();this.deferEmit("change",{type:"insert",data:e});return{inserted:e,failed:c}};c.prototype._insert=function(b,g){if(b){var a;this._ensurePrimaryKey(b);if(a=this.insertIndexViolation(b))return"Index violation in index: "+a;this._insertIndex(b);this._linked?$.observable(this._data).insert(g,b):this._data.splice(g,0,b);return!0}return"No document passed to insert"};
c.prototype._insertIndex=function(b){var g=this._indexByName,a,d=JSON.stringify(b);this._primaryIndex.uniqueSet(b[this._primaryKey],b);this._primaryCrc.uniqueSet(b[this._primaryKey],d);this._crcLookup.uniqueSet(d,b);for(a in g)g.hasOwnProperty(a)&&g[a].insert(b)};c.prototype._removeIndex=function(b){var g=this._indexByName,a,d=JSON.stringify(b);this._primaryIndex.unSet(b[this._primaryKey]);this._primaryCrc.unSet(b[this._primaryKey]);this._crcLookup.unSet(d);for(a in g)g.hasOwnProperty(a)&&g[a].remove(b)};
c.prototype.subset=function(b,g){var a=this.find(b,g);return(new c)._subsetOf(this).primaryKey(this._primaryKey).setData(a)};c.prototype.subsetOf=function(){return this.__subsetOf};c.prototype._subsetOf=function(b){this.__subsetOf=b;return this};c.prototype.distinct=function(b,g,a){g=this.find(g,a);b=new d(b);a={};var e=[],c,f;for(f=0;f<g.length;f++)(c=b.value(g[f])[0])&&!a[c]&&(a[c]=!0,e.push(c));return e};c.prototype.decouple=function(b){return JSON.parse(JSON.stringify(b))};c.prototype.findById=
function(b,g){var a={};a[this._primaryKey]=b;return this.find(a,g)[0]};c.prototype.peek=function(b,g){var a=this._data,d=a.length,e,f,k=new c;if("string"===typeof b){for(e=0;e<d;e++)f=JSON.stringify(a[e]),-1<f.indexOf(b)&&k.insert(a[e]);return k.find({},g)}return this.find(b,g)};c.prototype.explain=function(b,g){return this.find(b,g).__fdbOp._data};c.prototype.find=function(b,g){b=b||{};g=g||{};g.decouple=void 0!==g.decouple?g.decouple:!0;var a=this._metrics.create("find"),e=this,c,f=!0,k,h,q,l,p,
n,r,x,t,v=[];h=function(g){return e._match(g,b,"and")};a.start();if(b){a.time("analyseQuery");c=this._analyseQuery(b,g,a);a.time("analyseQuery");a.data("analysis",c);if(c.hasJoin&&c.queriesJoin){a.time("joinReferences");for(q=0;q<c.joinsOn.length;q++)p=c.joinsOn[q],l=new d(c.joinQueries[p]),l=l.value(b)[0],this._db.collection(c.joinsOn[q]).subset(l);a.time("joinReferences")}c.indexMatch.length&&(!g||g&&!g.skipIndex)?(a.data("index.potential",c.indexMatch),a.data("index.used",c.indexMatch[0].index),
a.time("indexLookup"),k=c.indexMatch[0].lookup,a.time("indexLookup"),c.indexMatch[0].keyData.totalKeyCount===c.indexMatch[0].keyData.matchedKeyCount&&(f=!1)):a.flag("usedIndex",!1);f&&(k&&k.length?(c=k.length,a.time("tableScan: "+c),k=k.filter(h)):(c=this._data.length,a.time("tableScan: "+c),k=this._data.filter(h)),g.sort&&(a.time("sort"),k=this.sort(g.sort,k),a.time("sort")),a.time("tableScan: "+c));g.limit&&k&&k.length>g.limit&&(k.length=g.limit,a.data("limit",g.limit));g.decouple&&(a.time("decouple"),
k=this.decouple(k),a.time("decouple"),a.data("flag.decouple",!0));if(g.join){for(h=0;h<g.join.length;h++)for(p in g.join[h])if(g.join[h].hasOwnProperty(p))for(x=p,c=this._db.collection(p),f=g.join[h][p],t=0;t<k.length;t++){r={};l=q=!1;for(n in f)if(f.hasOwnProperty(n))if("$"===n.substr(0,1))switch(n){case "$as":x=f[n];break;case "$multi":q=f[n];break;case "$require":l=f[n];break;default:n.substr(0,3)}else r[n]=(new d(f[n])).value(k[t])[0];r=c.find(r);!l||l&&r[0]?k[t][x]=!1===q?r[0]:r:v.push(k[t])}a.data("flag.join",
!0)}if(v.length){a.time("removalQueue");for(n=0;n<v.length;n++)p=k.indexOf(v[n]),-1<p&&k.splice(p,1);a.time("removalQueue")}if(g.transform){a.time("transform");for(n=0;n<k.length;n++)k.splice(n,1,g.transform(k[n]));a.time("transform");a.data("flag.transform",!0)}this._transformEnabled&&this._transformOut&&(a.time("transformOut"),k=this.transformOut(k),a.time("transformOut"));a.data("results",k.length);a.stop()}else a.stop(),k=[];k.__fdbOp=a;return k};c.prototype.transform=function(b){return void 0!==
b?("object"===typeof b?(void 0!==b.enabled&&(this._transformEnabled=b.enabled),void 0!==b.dataIn&&(this._transformIn=b.dataIn),void 0!==b.dataOut&&(this._transformOut=b.dataOut)):this._transformEnabled=!1===b?!1:!0,this):{enabled:this._transformEnabled,dataIn:this._transformIn,dataOut:this._transformOut}};c.prototype.transformIn=function(b){if(this._transformEnabled&&this._transformIn){if(b instanceof Array){var g=[],a;for(a=0;a<b.length;a++)g[a]=this._transformIn(b[a]);return g}return this._transformIn(b)}return b};
c.prototype.transformOut=function(b){if(this._transformEnabled&&this._transformOut){if(b instanceof Array){var g=[],a;for(a=0;a<b.length;a++)g[a]=this._transformOut(b[a]);return g}return this._transformOut(b)}return b};c.prototype.sort=function(b,g){g=g||[];var a=[],d,c;for(d in b)b.hasOwnProperty(d)&&(c={},c[d]=b[d],c.___fdbKey=d,a.push(c));return 2>a.length?this._sort(b,g):this._bucketSort(a,g)};c.prototype._bucketSort=function(b,g){var a=b.shift(),d,c,e=[];if(0<b.length){g=this._sort(a,g);d=this.bucket(a.___fdbKey,
g);for(c in d)d.hasOwnProperty(c)&&(a=[].concat(b),e=e.concat(this._bucketSort(a,d[c])));return e}return this._sort(a,g)};c.prototype._sort=function(b,a){var c=new d,e=c.parse(b,!0)[0];c.path(e.path);return a.sort(1===e.value?function(b,a){var g=c.value(b)[0],d=c.value(a)[0];return"string"===typeof g&&"string"===typeof d?g.localeCompare(d):g>d?1:g<d?-1:0}:function(b,a){var g=c.value(b)[0],d=c.value(a)[0];return"string"===typeof g&&"string"===typeof d?1===g.localeCompare(d)?-1:1:g>d?-1:g<d?1:0})};
c.prototype.bucket=function(b,g){var a,d={};for(a=0;a<g.length;a++)d[g[a][b]]=d[g[a][b]]||[],d[g[a][b]].push(g[a]);return d};c.prototype._analyseQuery=function(b,a,c){var e={queriesOn:[this._name],indexMatch:[],hasJoin:!1,queriesJoin:!1,joinQueries:{},query:b,options:a},f,k=[],h=[],q,l,r,p,n;c.time("checkIndexes");void 0!==b[this._primaryKey]&&(c.time("checkIndexMatch: Primary Key"),q=new d,e.indexMatch.push({lookup:this._primaryIndex.lookup(b,a),keyData:{matchedKeys:[this._primaryKey],matchedKeyCount:1,
totalKeyCount:q.countKeys(b)},index:this._primaryIndex}),c.time("checkIndexMatch: Primary Key"));for(n in this._indexById)if(this._indexById.hasOwnProperty(n)&&(l=this._indexById[n],r=l.name(),c.time("checkIndexMatch: "+r),q=l.match(b,a),p=l.lookup(b,a),0<q.matchedKeyCount&&e.indexMatch.push({lookup:p,keyData:q,index:l}),c.time("checkIndexMatch: "+r),q.totalKeyCount===q.matchedKeyCount))break;c.time("checkIndexes");1<e.indexMatch.length&&(c.time("findOptimalIndex"),e.indexMatch.sort(function(b,a){return b.keyData.totalKeyCount===
b.keyData.matchedKeyCount?-1:a.keyData.totalKeyCount===a.keyData.matchedKeyCount?1:b.keyData.matchedKeyCount===a.keyData.matchedKeyCount?b.lookup.length-a.lookup.length:a.keyData.matchedKeyCount-b.keyData.matchedKeyCount}),c.time("findOptimalIndex"));if(a.join){e.hasJoin=!0;for(c=0;c<a.join.length;c++)for(f in a.join[c])a.join[c].hasOwnProperty(f)&&(k.push(f),"$as"in a.join[c][f]?h.push(a.join[c][f].$as):h.push(f));for(f=0;f<h.length;f++)if(a=this._queryReferencesCollection(b,h[f],""))e.joinQueries[k[f]]=
a,e.queriesJoin=!0;e.joinsOn=k;e.queriesOn=e.queriesOn.concat(k)}return e};c.prototype._queryReferencesCollection=function(b,a,d){for(var c in b)if(b.hasOwnProperty(c)){if(c===a)return d&&(d+="."),d+c;if("object"===typeof b[c])return d&&(d+="."),d+=c,this._queryReferencesCollection(b[c],a,d)}return!1};c.prototype._match=function(b,a,d){var c,e;c=typeof b;e=typeof a;var f=!0,k;if(!("string"!==c&&"number"!==c||"string"!==e&&"number"!==e))b!==a&&(f=!1);else for(k in a)if(a.hasOwnProperty(k)){c=!1;if("$"===
k.substr(0,1))switch(k){case "$gt":if(b>a[k]){if("or"===d)return!0}else f=!1;c=!0;break;case "$gte":if(b>=a[k]){if("or"===d)return!0}else f=!1;c=!0;break;case "$lt":if(b<a[k]){if("or"===d)return!0}else f=!1;c=!0;break;case "$lte":if(b<=a[k]){if("or"===d)return!0}else f=!1;c=!0;break;case "$exists":if(void 0===b!==a[k]){if("or"===d)return!0}else f=!1;c=!0;break;case "$or":c=!0;for(e=0;e<a[k].length;e++){if(this._match(b,a[k][e],"and"))return!0;f=!1}break;case "$and":c=!0;for(e=0;e<a[k].length;e++)if(!this._match(b,
a[k][e],"and"))return!1;break;case "$in":if(a[k]instanceof Array){c=a[k];e=c.length;var h,q=!1;for(h=0;h<e;h++)if(c[h]===b){q=!0;break}if(q){if("or"===d)return!0}else f=!1}else throw"Cannot use a $nin operator on a non-array key: "+k;c=!0;break;case "$nin":if(a[k]instanceof Array){c=a[k];e=c.length;q=!0;for(h=0;h<e;h++)if(c[h]===b){q=!1;break}if(q){if("or"===d)return!0}else f=!1}else throw"Cannot use a $nin operator on a non-array key: "+k;c=!0;break;case "$ne":if(b!=a[k]){if("or"===d)return!0}else f=
!1;c=!0}if(!c&&a[k]instanceof RegExp)if(c=!0,"object"===typeof b&&void 0!==b[k]&&a[k].test(b[k])){if("or"===d)return!0}else f=!1;if(!c)if("object"===typeof a[k])if(void 0!==b[k]){if(b[k]instanceof Array&&!(a[k]instanceof Array))for(c=!1,e=0;e<b[k].length&&!(c=this._match(b[k][e],a[k],void 0));e++);else if(!(b[k]instanceof Array)&&a[k]instanceof Array)for(c=!1,e=0;e<a[k].length&&!(c=this._match(b[k],a[k][e],void 0));e++);else c="object"===typeof b?this._match(b[k],a[k],void 0):this._match(void 0,a[k],
void 0);if(c){if("or"===d)return!0}else f=!1}else if(a[k]&&void 0!==a[k].$exists)if(c=this._match(void 0,a[k],void 0)){if("or"===d)return!0}else f=!1;else f=!1;else if(b&&b[k]===a[k]){if("or"===d)return!0}else if(b&&b[k]&&b[k]instanceof Array&&a[k]&&"object"!==typeof a[k]){c=!1;for(e=0;e<b[k].length&&!(c=this._match(b[k][e],a[k],void 0));e++);if(c){if("or"===d)return!0}else f=!1}else f=!1;if("and"===d&&!f)return!1}return f};c.prototype.count=function(b,a){return b?this.find(b,a).length:this._data.length};
c.prototype.link=function(b,a){this._links=this._links||{};if(!this._links[a]){if($(b).length){if(!$.templates[a]){var d=$(a);if(d.length)$.views.templates(a,$(d[0]).html());else throw"Unable to bind collection to target because template does not exist: "+a;}$.templates[a].link(b,this._data);this._links[a]=b;this._linked++;this.debug()&&console.log('ForerunnerDB.Collection: Added binding collection "'+this.name()+'" to output target: '+b);return this}throw'Cannot bind view data to output target selector "'+
b+'" because it does not exist in the DOM!';}throw"Cannot create a duplicate link to the target: "+b+" with the template: "+a;};c.prototype.unlink=function(a,d){this._links=this._links||{};if(this._links[d])return $.templates[d].unlink(a),delete this._links[d],this._linked--,this.debug()&&console.log('ForerunnerDB.Collection: Removed binding collection "'+this.name()+'" to output target: '+a),this;console.log("Cannot remove link, one does not exist to the target: "+a+" with the template: "+d)};c.prototype.findSub=
function(a,c,e,k){var f=new d(c);a=this.find(a);var h=a.length,q,l,r=this._db.collection("__FDB_temp_"+this.objectId()),u={parents:h,subDocTotal:0,subDocs:[],pathFound:!1,err:""};for(q=0;q<h;q++)if(l=f.value(a[q])[0]){r.setData(l);l=r.find(e,k);if(k.returnFirst&&l.length)return l[0];u.subDocs.push(l);u.subDocTotal+=l.length;u.pathFound=!0}r.drop();if(k.noStats)return u.subDocs;u.pathFound||(u.err="No objects found in the parent documents with a matching path of: "+c);return u};c.prototype.insertIndexViolation=
function(a){var d,c=this._indexByName,e,k;if(this._primaryIndex.get(a[this._primaryKey]))d=this._primaryIndex;else for(e in c)if(c.hasOwnProperty(e)&&(k=c[e],k.unique()&&k.violation(a))){d=k;break}return d?d.name():!1};c.prototype.ensureIndex=function(a,d){this._indexByName=this._indexByName||{};this._indexById=this._indexById||{};var c=new k(a,d,this),e={start:(new Date).getTime()};if(this._indexByName[c.name()])return{err:"Index with that name already exists"};if(this._indexById[c.id()])return{err:"Index with those keys already exists"};
c.rebuild();this._indexByName[c.name()]=c;this._indexById[c.id()]=c;e.end=(new Date).getTime();e.total=e.end-e.start;this._lastOp={type:"ensureIndex",stats:{time:e}};return{index:c,id:c.id(),name:c.name(),state:c.state()}};c.prototype.index=function(a){if(this._indexByName)return this._indexByName[a]};c.prototype.lastOp=function(){return this._metrics.list()};c.prototype.objectId=function(a){var d=Math.pow(10,17);if(a){var c=0,e=a.length,k;for(k=0;k<e;k++)c+=a.charCodeAt(k)*d;a=c.toString(16)}else f.idCounter++,
a=(f.idCounter+(Math.random()*d+Math.random()*d+Math.random()*d+Math.random()*d)).toString(16);return a};c.prototype.diff=function(a){var d={insert:[],update:[],remove:[]},c=this.primaryKey(),e,k,f,h;if(c===a.primaryKey()){e=a._data;h=e.length;for(k=0;k<h;k++)f=e[k],this._primaryIndex.get(f[c])?this._primaryCrc.get(f[c])!==a._primaryCrc.get(f[c])&&d.update.push(f):d.insert.push(f);e=this._data;h=e.length;for(k=0;k<h;k++)f=e[k],a._primaryIndex.get(f[c])||d.remove.push(f)}return d};h.prototype.collection=
function(a,d){if(a)return this._collection[a]||this.debug()&&console.log("Creating collection "+a),this._collection[a]=this._collection[a]||(new c(a)).db(this),void 0!==d&&this._collection[a].primaryKey(d),this._collection[a];throw"Cannot get collection with undefined name!";};h.prototype.collectionExists=function(a){return Boolean(this._collection[a])};h.prototype.collections=function(){var a=[],d;for(d in this._collection)this._collection.hasOwnProperty(d)&&a.push({name:d,count:this._collection[d].count()});
return a};r.exports=c},{"./Crc":4,"./Index":5,"./KeyValueStore":6,"./Metrics":7,"./Overload":9,"./Path":10,"./Shared":11}],3:[function(h,r,l){var f,a;f=h("./Shared.js");var e=function(){this.init.apply(this,arguments)};e.prototype.init=function(){this._collection={};this._debug={}};f.modules.Core=e;l=h("./Overload.js");a=h("./Collection.js");h("./Metrics.js");h=h("./Crc.js");e.prototype._isServer=!1;e.prototype.isClient=function(){return!this._isServer};e.prototype.isServer=function(){return this._isServer};
e.prototype.crc=h;e.prototype.isClient=function(){return!this._isServer};e.prototype.isServer=function(){return this._isServer};e.prototype.decouple=function(a){return JSON.parse(JSON.stringify(a))};e.prototype.debug=new l([function(){return this._debug.all},function(a){return void 0!==a&&"boolean"===typeof a?(this._debug.all=a,this):this._debug.all},function(a,e){return void 0!==a?void 0!==e?(this._debug[a]=e,this):this._debug[a]:this._debug.all}]);e.prototype.arrayToCollection=function(d){return(new a).setData(d)};
e.prototype.on=function(a,e){this._listeners=this._listeners||{};this._listeners[a]=this._listeners[a]||[];this._listeners[a].push(e);return this};e.prototype.off=function(a,e){if(a in this._listeners){var f=this._listeners[a],c=f.indexOf(e);-1<c&&f.splice(c,1)}return this};e.prototype.emit=function(a,e){this._listeners=this._listeners||{};if(a in this._listeners){var f=this._listeners[a],c=f.length,b;for(b=0;b<c;b++)f[b].apply(this,Array.prototype.slice.call(arguments,1))}return this};e.prototype.objectId=
function(a){var e,h,c=Math.pow(10,17),b;if(a){e=0;h=a.length;for(b=0;b<h;b++)e+=a.charCodeAt(b)*c;a=e.toString(16)}else f.idCounter++,a=(f.idCounter+(Math.random()*c+Math.random()*c+Math.random()*c+Math.random()*c)).toString(16);return a};e.prototype.peek=function(a){var e,f,c=[],b=typeof a;for(e in this._collection)this._collection.hasOwnProperty(e)&&(f=this._collection[e],c="string"===b?c.concat(f.peek(a)):c.concat(f.find(a)));return c};e.prototype.peekCat=function(a){var e,f,c={},b,g=typeof a;
for(e in this._collection)this._collection.hasOwnProperty(e)&&(f=this._collection[e],(b="string"===g?f.peek(a):f.find(a))&&b.length&&(c[f.name()]=b));return c};r.exports=e},{"./Collection.js":2,"./Crc.js":4,"./Metrics.js":7,"./Overload.js":9,"./Shared.js":11}],4:[function(h,r,l){var f=function(){var a=[],e,d,f;for(d=0;256>d;d++){e=d;for(f=0;8>f;f++)e=e&1?3988292384^e>>>1:e>>>1;a[d]=e}return a}();r.exports=function(a){var e=-1,d;for(d=0;d<a.length;d++)e=e>>>8^f[(e^a.charCodeAt(d))&255];return(e^-1)>>>
0}},{}],5:[function(h,r,l){l=h("./Shared");var f=h("./Path");h=function(){this.init.apply(this,arguments)};h.prototype.init=function(a,e,d){this._crossRef={};this._size=0;this._id=this._itemKeyHash(a,a);this.data({});this.unique(e&&e.unique?e.unique:!1);void 0!==a&&this.keys(a);void 0!==d&&this.collection(d);this.name(e&&e.name?e.name:this._id)};l.modules.Index=h;h.prototype.id=function(){return this._id};h.prototype.state=function(){return this._state};h.prototype.size=function(){return this._size};
h.prototype.data=function(a){return void 0!==a?(this._data=a,this):this._data};h.prototype.name=function(a){return void 0!==a?(this._name=a,this):this._name};h.prototype.collection=function(a){return void 0!==a?(this._collection=a,this):this._collection};h.prototype.keys=function(a){return void 0!==a?(this._keys=a,this._keyCount=(new f).parse(this._keys).length,this):this._keys};h.prototype.type=function(a){return void 0!==a?(this._type=a,this):this._type};h.prototype.unique=function(a){return void 0!==
a?(this._unique=a,this):this._unique};h.prototype.rebuild=function(){if(this._collection){var a=this._collection.subset({},{decouple:!1,sort:this._keys}).find(),e,d=a.length;this._data={};this._unique&&(this._uniqueLookup={});for(e=0;e<d;e++)this.insert(a[e])}this._state={name:this._name,keys:this._keys,indexSize:this._size,built:new Date,updated:new Date,ok:!0}};h.prototype.insert=function(a,e){var d,f;this._unique&&(d=this._itemHash(a,this._keys),this._uniqueLookup[d]=a);d=this._itemHashArr(a,this._keys);
for(f=0;f<d.length;f++)this.pushToPathValue(d[f],a)};h.prototype.remove=function(a,e){var d,f;this._unique&&(d=this._itemHash(a,this._keys),delete this._uniqueLookup[d]);d=this._itemHashArr(a,this._keys);for(f=0;f<d.length;f++)this.pullFromPathValue(d[f],a)};h.prototype.violation=function(a){a=this._itemHash(a,this._keys);return Boolean(this._uniqueLookup[a])};h.prototype.hashViolation=function(a){return Boolean(this._uniqueLookup[a])};h.prototype.pushToPathValue=function(a,e){var d=this._data[a]=
this._data[a]||[];-1===d.indexOf(e)&&(d.push(e),this._size++,this.pushToCrossRef(e,d))};h.prototype.pullFromPathValue=function(a,e){var d=this._data[a],f;f=d.indexOf(e);-1<f&&(d.splice(f,1),this._size--,this.pullFromCrossRef(e,d));d.length||delete this._data[a]};h.prototype.pull=function(a){var e=a[this._collection.primaryKey()],d=this._crossRef[e],f,h=d.length,c;for(f=0;f<h;f++)c=d[f],this._pullFromArray(c,a);this._size--;delete this._crossRef[e]};h.prototype._pullFromArray=function(a,e){for(var d=
a.length;d--;)a[d]===e&&a.splice(d,1)};h.prototype.pushToCrossRef=function(a,e){var d=a[this._collection.primaryKey()];this._crossRef[d]=this._crossRef[d]||[];d=this._crossRef[d];-1===d.indexOf(e)&&d.push(e)};h.prototype.pullFromCrossRef=function(a,e){var d=a[this._collection.primaryKey()];delete this._crossRef[d]};h.prototype.lookup=function(a){return this._data[this._itemHash(a,this._keys)]||[]};h.prototype.match=function(a,e){return(new f).countObjectPaths(this._keys,a)};h.prototype._itemHash=
function(a,e){var d=new f,k,h="",c;k=d.parse(e);for(c=0;c<k.length;c++)h&&(h+="_"),h+=d.value(a,k[c].path).join(":");return h};h.prototype._itemKeyHash=function(a,e){var d=new f,k,h="",c;k=d.parse(e);for(c=0;c<k.length;c++)h&&(h+="_"),h+=d.keyValue(a,k[c].path);return h};h.prototype._itemHashArr=function(a,e){var d=new f,k,h=[],c,b,g,l;k=d.parse(e);for(g=0;g<k.length;g++)for(c=d.value(a,k[g].path),b=0;b<c.length;b++)if(0===g)h.push(c[b]);else for(l=0;l<h.length;l++)h[l]=h[l]+"_"+c[b];return h};r.exports=
h},{"./Path":10,"./Shared":11}],6:[function(h,r,l){h=h("./Shared");l=function(f){this.init.apply(this,arguments)};l.prototype.init=function(f){this._name=f;this._data={};this._primaryKey="_id"};h.modules.KeyValueStore=l;l.prototype.name=function(f){return void 0!==f?(this._name=f,this):this._name};l.prototype.primaryKey=function(f){return void 0!==f?(this._primaryKey=f,this):this._primaryKey};l.prototype.truncate=function(){this._data={};return this};l.prototype.set=function(f,a){this._data[f]=a?
a:!0;return this};l.prototype.get=function(f){return this._data[f]};l.prototype.lookup=function(f){f=f[this._primaryKey];var a,e,d,k;if(f instanceof Array){e=f.length;k=[];for(a=0;a<e;a++)(d=this._data[f[a]])&&k.push(d);return k}if(f instanceof RegExp){k=[];for(a in this._data)this._data.hasOwnProperty(a)&&f.test(a)&&k.push(this._data[a]);return k}if("object"===typeof f){if(f.$ne){k=[];for(a in this._data)this._data.hasOwnProperty(a)&&a!==f.$ne&&k.push(this._data[a]);return k}if(f.$in&&f.$in instanceof
Array){k=[];for(a in this._data)this._data.hasOwnProperty(a)&&-1<f.$in.indexOf(a)&&k.push(this._data[a]);return k}if(f.$nin&&f.$nin instanceof Array){k=[];for(a in this._data)this._data.hasOwnProperty(a)&&-1===f.$nin.indexOf(a)&&k.push(this._data[a]);return k}if(f.$or&&f.$or instanceof Array){k=[];for(a=0;a<f.$or.length;a++)k=k.concat(this.lookup(f.$or[a]));return k}}else return d=this._data[f],void 0!==d?[d]:[]};l.prototype.unSet=function(f){delete this._data[f];return this};l.prototype.uniqueSet=
function(f,a){return void 0===this._data[f]?(this._data[f]=a,!0):!1};r.exports=l},{"./Shared":11}],7:[function(h,r,l){l=h("./Shared");var f=h("./Operation");h=function(){this.init.apply(this,arguments)};h.prototype.init=function(){this._data=[]};l.modules.Metrics=h;h.prototype.create=function(a){a=new f(a);this._enabled&&this._data.push(a);return a};h.prototype.start=function(){this._enabled=!0;return this};h.prototype.stop=function(){this._enabled=!1;return this};h.prototype.clear=function(){this._data=
[];return this};h.prototype.list=function(){return this._data};r.exports=h},{"./Operation":8,"./Shared":11}],8:[function(h,r,l){l=h("./Shared");var f=h("./Path");h=function(a){this.pathSolver=new f;this.counter=0;this.init.apply(this,arguments)};h.prototype.init=function(a){this._data={operation:a,index:{potential:[],used:!1},steps:[],time:{startMs:0,stopMs:0,totalMs:0,process:{}},flag:{},log:[]}};l.modules.Operation=h;h.prototype.start=function(){this._data.time.startMs=(new Date).getTime()};h.prototype.log=
function(a){if(a){var e=0<this._log.length?this._data.log[this._data.log.length-1].time:0;a={event:a,time:(new Date).getTime(),delta:0};this._data.log.push(a);e&&(a.delta=a.time-e);return this}return this._data.log};h.prototype.time=function(a){if(void 0!==a){var e=this._data.time.process,e=e[a]=e[a]||{};e.startMs?(e.stopMs=(new Date).getTime(),e.totalMs=e.stopMs-e.startMs,e.stepObj.totalMs=e.totalMs,delete e.stepObj):(e.startMs=(new Date).getTime(),e.stepObj={name:a},this._data.steps.push(e.stepObj));
return this}return this._data.time};h.prototype.flag=function(a,e){if(void 0!==a&&void 0!==e)this._data.flag[a]=e;else return void 0!==a?this._data.flag[a]:this._data.flag};h.prototype.data=function(a,e,d){return void 0!==e?(this.pathSolver.set(this._data,a,e),this):this.pathSolver.get(this._data,a)};h.prototype.pushData=function(a,e,d){this.pathSolver.push(this._data,a,e)};h.prototype.stop=function(){this._data.time.stopMs=(new Date).getTime();this._data.time.totalMs=this._data.time.stopMs-this._data.time.startMs};
r.exports=h},{"./Path":10,"./Shared":11}],9:[function(h,r,l){l=function(f){if(f){var a,e=f.length;return function(){for(a=0;a<e;a++)if(f[a].length===arguments.length)return f[a].apply(this,arguments);return null}}return function(){}};h("./Shared").modules.Overload=l;r.exports=l},{"./Shared":11}],10:[function(h,r,l){h=h("./Shared");l=function(f){this.init.apply(this,arguments)};l.prototype.init=function(f){f&&this.path(f)};h.modules.Path=l;l.prototype.path=function(f){return void 0!==f?(this._path=
this.clean(f),this._pathParts=this._path.split("."),this):this._path};l.prototype.hasObjectPaths=function(f,a){var e=!0,d;for(d in f)if(f.hasOwnProperty(d)&&(void 0===a[d]||"object"===typeof f[d]&&(e=this.hasObjectPaths(f[d],a[d]),!e)))return!1;return e};l.prototype.countKeys=function(f){var a=0,e;for(e in f)f.hasOwnProperty(e)&&void 0!==f[e]&&("object"!==typeof f[e]?a++:a+=this.countKeys(f[e]));return a};l.prototype.countObjectPaths=function(f,a){var e,d={},k=0,h=0,c;for(c in a)a.hasOwnProperty(c)&&
("object"===typeof a[c]?(e=this.countObjectPaths(f[c],a[c]),d[c]=e.matchedKeys,h+=e.totalKeyCount,k+=e.matchedKeyCount):(h++,f&&f[c]&&"object"!==typeof f[c]?(d[c]=!0,k++):d[c]=!1));return{matchedKeys:d,matchedKeyCount:k,totalKeyCount:h}};l.prototype.parse=function(f,a){var e=[],d="",k,h,c;for(h in f)if(f.hasOwnProperty(h))if(d=h,"object"===typeof f[h])if(a)for(k=this.parse(f[h],a),c=0;c<k.length;c++)e.push({path:d+"."+k[c].path,value:k[c].value});else for(k=this.parse(f[h]),c=0;c<k.length;c++)e.push({path:d+
"."+k[c].path});else a?e.push({path:d,value:f[h]}):e.push({path:d});return e};l.prototype.parseArr=function(f,a){a=a||{};return this._parseArr(f,"",[],a)};l.prototype._parseArr=function(f,a,e,d){var k,h="";a=a||"";e=e||[];for(k in f)f.hasOwnProperty(k)&&(!d.ignore||d.ignore&&!d.ignore.test(k))&&(h=a?a+"."+k:k,"object"===typeof f[k]?this._parseArr(f[k],h,e,d):e.push(h));return e};l.prototype.value=function(f,a){if(void 0!==f&&"object"===typeof f){var e,d,k,h,c=[],b;void 0!==a&&(a=this.clean(a),e=a.split("."));
e=e||this._pathParts;d=e.length;k=f;for(b=0;b<d;b++){k=k[e[b]];if(h instanceof Array){for(d=0;d<h.length;d++)c=c.concat(this.value(h,d+"."+e[b]));return c}if(!k||"object"!==typeof k)break;h=k}return[k]}return[]};l.prototype.set=function(f,a,e){if(void 0!==f&&void 0!==a){var d;a=this.clean(a);a=a.split(".");d=a.shift();a.length?(f[d]=f[d]||{},this.set(f[d],a.join("."),e)):f[d]=e}return f};l.prototype.get=function(f,a){return this.value(f,a)[0]};l.prototype.push=function(f,a,e){if(void 0!==f&&void 0!==
a){var d;a=this.clean(a);a=a.split(".");d=a.shift();if(a.length)f[d]=f[d]||{},this.set(f[d],a.join("."),e);else if(f[d]=f[d]||[],f[d]instanceof Array)f[d].push(e);else throw"Cannot push to a path whose endpoint is not an array!";}return f};l.prototype.keyValue=function(f,a){var e,d,h,l,c;void 0!==a&&(a=this.clean(a),e=a.split("."));e=e||this._pathParts;d=e.length;h=f;for(c=0;c<d;c++)if(h=h[e[c]],!h||"object"!==typeof h){l=e[c]+":"+h;break}return l};l.prototype.clean=function(f){"."===f.substr(0,1)&&
(f=f.substr(1,f.length-1));return f};r.exports=l},{"./Shared":11}],11:[function(h,r,l){r.exports={idCounter:0,modules:{},prototypes:{}}},{}]},{},[1])(1)});
