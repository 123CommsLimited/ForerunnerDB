/*
 btree.js (c) 2013 Daniel Wirtz <dcode@dcode.io>
 Released under the Apache License, Version 2.0
 see: http://github.com/dcodeIO/btree.js for details
*/
!function(y){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=y();else if("function"==typeof define&&define.amd)define([],y);else{var d;"undefined"!=typeof window?d=window:"undefined"!=typeof global?d=global:"undefined"!=typeof self&&(d=self);d.ForerunnerDB=y()}}(function(){return function d(l,g,b){function a(c,p){if(!g[c]){if(!l[c]){var e="function"==typeof require&&require;if(!p&&e)return e(c,!0);if(k)return k(c,!0);e=Error("Cannot find module '"+c+"'");throw e.code="MODULE_NOT_FOUND",
e;}e=g[c]={exports:{}};l[c][0].call(e.exports,function(f){var h=l[c][1][f];return a(h?h:f)},e,e.exports,d,l,g,b)}return g[c].exports}for(var k="function"==typeof require&&require,c=0;c<b.length;c++)a(b[c]);return a}({1:[function(d,l,g){g=d("../lib/Core");d("../lib/View");l.exports=g},{"../lib/Core":5,"../lib/View":24}],2:[function(d,l,g){g=d("./Shared");d("./Path");d=function(b){var a;this._primaryKey="_id";this._keyArr=[];this._data=[];this._objLookup={};this._count=0;for(a in b)b.hasOwnProperty(a)&&
this._keyArr.push({key:a,dir:b[a]})};g.addModule("ActiveBucket",d);g.synthesize(d.prototype,"primaryKey");g.mixin(d.prototype,"Mixin.Sorting");d.prototype.qs=function(b,a,k,c){if(!a.length)return 0;for(var m=-1,d,e,f=0,h=a.length-1;h>=f;){d=Math.floor((f+h)/2);if(m===d)break;m=a[d];void 0!==m&&(e=c(this,b,k,m),0<e&&(f=d+1),0>e&&(h=d-1));m=d}return 0<e?d+1:d};d.prototype._sortFunc=function(b,a,k,c){k=k.split(".:.");c=c.split(".:.");var m=b._keyArr,d=m.length,e,f,h;for(e=0;e<d;e++)if(f=m[e],h=typeof a[f.key],
"number"===h&&(k[e]=Number(k[e]),c[e]=Number(c[e])),k[e]!==c[e]){if(1===f.dir)return b.sortAsc(k[e],c[e]);if(-1===f.dir)return b.sortDesc(k[e],c[e])}};d.prototype.insert=function(b){var a,k;a=this.documentKey(b);k=this._data.indexOf(a);-1===k&&(k=this.qs(b,this._data,a,this._sortFunc));this._data.splice(k,0,a);this._objLookup[b[this._primaryKey]]=a;this._count++;return k};d.prototype.remove=function(b){var a;if(a=this._objLookup[b[this._primaryKey]])if(a=this._data.indexOf(a),-1<a)return this._data.splice(a,
1),delete this._objLookup[b[this._primaryKey]],this._count--,!0;return!1};d.prototype.index=function(b){var a,k;a=this.documentKey(b);k=this._data.indexOf(a);-1===k&&(k=this.qs(b,this._data,a,this._sortFunc));return k};d.prototype.documentKey=function(b){var a="",k=this._keyArr,c=k.length,m,d;for(m=0;m<c;m++)d=k[m],a&&(a+=".:."),a+=b[d.key];return a+=".:."+b[this._primaryKey]};d.prototype.count=function(){return this._count};g.finishModule("ActiveBucket");l.exports=d},{"./Path":21,"./Shared":23}],
3:[function(d,l,g){var b,a,k,c,m,p;g=d("./Shared");var e=function(f){this.init.apply(this,arguments)};e.prototype.init=function(f){this._primaryKey="_id";this._primaryIndex=new a("primary");this._primaryCrc=new a("primaryCrc");this._crcLookup=new a("crcLookup");this._name=f;this._data=[];this._groups=[];this._metrics=new b;this._deferQueue={insert:[],update:[],remove:[],upsert:[]};this._deferThreshold={insert:100,update:100,remove:100,upsert:100};this._deferTime={insert:1,update:1,remove:1,upsert:1};
this._subsetOf(this)};g.addModule("Collection",e);g.mixin(e.prototype,"Mixin.Common");g.mixin(e.prototype,"Mixin.Events");g.mixin(e.prototype,"Mixin.ChainReactor");g.mixin(e.prototype,"Mixin.CRUD");g.mixin(e.prototype,"Mixin.Constants");g.mixin(e.prototype,"Mixin.Triggers");g.mixin(e.prototype,"Mixin.Sorting");g.mixin(e.prototype,"Mixin.Matching");b=d("./Metrics");a=d("./KeyValueStore");k=d("./Path");c=d("./IndexHashMap");m=d("./IndexBinaryTree");p=d("./Crc");d=g.modules.Core;e.prototype.crc=p;g.synthesize(e.prototype,
"state");g.synthesize(e.prototype,"name");e.prototype.data=function(){return this._data};e.prototype.drop=function(){if("dropped"!==this._state){if(this._db&&this._db._collection&&this._name){this.debug()&&console.log("Dropping collection "+this._name);this._state="dropped";this.emit("drop",this);delete this._db._collection[this._name];if(this._groups&&this._groups.length){var f=[],h;for(h=0;h<this._groups.length;h++)f.push(this._groups[h]);for(h=0;h<f.length;h++)this._groups[h].removeCollection(this)}delete this._primaryKey;
delete this._primaryIndex;delete this._primaryCrc;delete this._crcLookup;delete this._name;delete this._data;delete this._groups;delete this._metrics;return!0}}else return!0;return!1};e.prototype.primaryKey=function(f){return void 0!==f?(this._primaryKey!==f&&(this._primaryKey=f,this._primaryIndex.primaryKey(f),this.rebuildPrimaryKeyIndex()),this):this._primaryKey};e.prototype._onInsert=function(f,h){this.emit("insert",f,h)};e.prototype._onUpdate=function(f){this.emit("update",f)};e.prototype._onRemove=
function(f){this.emit("remove",f)};g.synthesize(e.prototype,"db");e.prototype.setData=function(f,h,a){if(f){var c=this._metrics.create("setData");c.start();h=this.options(h);this.preSetData(f,h,a);h.$decouple&&(f=this.decouple(f));f instanceof Array||(f=[f]);c.time("transformIn");f=this.transformIn(f);c.time("transformIn");var b=[].concat(this._data);this._dataReplace(f);c.time("Rebuild Primary Key Index");this.rebuildPrimaryKeyIndex(h);c.time("Rebuild Primary Key Index");c.time("Rebuild All Other Indexes");
this._rebuildIndexes();c.time("Rebuild All Other Indexes");c.time("Resolve chains");this.chainSend("setData",f,{oldData:b});c.time("Resolve chains");c.stop();this.emit("setData",this._data,b)}a&&a(!1);return this};e.prototype.rebuildPrimaryKeyIndex=function(f){var h=f&&void 0!==f.$ensureKeys?f.$ensureKeys:!0;f=f&&void 0!==f.$violationCheck?f.$violationCheck:!0;var a,c,b,k=this._primaryIndex,e=this._primaryCrc,m=this._crcLookup,d=this._primaryKey,g;k.truncate();e.truncate();m.truncate();a=this._data;
for(c=a.length;c--;){b=a[c];h&&this.ensurePrimaryKey(b);if(f){if(!k.uniqueSet(b[d],b))throw'ForerunnerDB.Collection "'+this.name()+'": Call to setData on collection failed because your data violates the primary key unique constraint. One or more documents are using the same primary key: '+b[this._primaryKey];}else k.set(b[d],b);g=JSON.stringify(b);e.set(b[d],g);m.set(g,b)}};e.prototype.ensurePrimaryKey=function(f){void 0===f[this._primaryKey]&&(f[this._primaryKey]=this.objectId())};e.prototype.truncate=
function(){this.emit("truncate",this._data);this._data.length=0;this._primaryIndex=new a("primary");this._primaryCrc=new a("primaryCrc");this._crcLookup=new a("crcLookup");this.deferEmit("change",{type:"truncate"});return this};e.prototype.upsert=function(f,h){if(f){var a=this._deferQueue.upsert,c=this._deferThreshold.upsert,b={},k;if(f instanceof Array){if(f.length>c)return this._deferQueue.upsert=a.concat(f),this.processQueue("upsert",h),{};b=[];for(a=0;a<f.length;a++)b.push(this.upsert(f[a]));
h&&h();return b}f[this._primaryKey]?(k={},k[this._primaryKey]=f[this._primaryKey],this._primaryIndex.lookup(k)[0]?b.op="update":b.op="insert"):b.op="insert";switch(b.op){case "insert":b.result=this.insert(f);break;case "update":b.result=this.update(k,f)}return b}h&&h();return{}};e.prototype.update=function(f,h,a){h=this.decouple(h);h=this.transformIn(h);this.debug()&&console.log('Updating some collection data for collection "'+this.name()+'"');var c=this,b=this._metrics.create("update"),k,e,m=function(k){var e=
c.decouple(k),m,d;if(c.willTrigger(c.TYPE_UPDATE,c.PHASE_BEFORE)||c.willTrigger(c.TYPE_UPDATE,c.PHASE_AFTER)){m={type:"update",query:c.decouple(f),update:c.decouple(h),options:c.decouple(a),op:b};if(!1===c.processTrigger(m,c.TYPE_UPDATE,c.PHASE_BEFORE,e)||c.willTrigger(c.TYPE_UPDATE,c.PHASE_BEFORE)&&(d=c.updateObject(e,m.update,m.query,m.options,""))&&!1===c.processTrigger(m,c.TYPE_UPDATE,c.PHASE_AFTER,k,e))return!1;d=c.updateObject(k,m.update,m.query,m.options,"")}else d=c.updateObject(k,h,f,a,"");
return d};b.start();b.time("Retrieve documents to update");k=this.find(f,{$decouple:!1});b.time("Retrieve documents to update");k.length&&(b.time("Update documents"),e=k.filter(m),b.time("Update documents"),e.length&&(b.time("Resolve chains"),this.chainSend("update",{query:f,update:h,dataSet:k},a),b.time("Resolve chains"),this._onUpdate(e),this.deferEmit("change",{type:"update",data:e})));b.stop();return e||[]};e.prototype._replaceObj=function(f,h){var c;this._removeFromIndexes(f);for(c in f)f.hasOwnProperty(c)&&
delete f[c];for(c in h)h.hasOwnProperty(c)&&(f[c]=h[c]);if(!this._insertIntoIndexes(f))throw'ForerunnerDB.Collection "'+this.name()+'": Primary key violation in update! Key violated: '+f[this._primaryKey];return!0};e.prototype.updateById=function(f,h){var c={};c[this._primaryKey]=f;return this.update(c,h)};e.prototype.updateObject=function(f,h,c,a,b,e){h=this.decouple(h);b=b||"";"."===b.substr(0,1)&&(b=b.substr(1,b.length-1));this.decouple(f);var m=!1,d=!1,g,p,l,n;for(n in h)if(h.hasOwnProperty(n)){g=
!1;if("$"===n.substr(0,1))switch(n){case "$key":case "$index":g=!0;break;default:g=!0,d=this.updateObject(f,h[n],c,a,b,n),m=m||d}if(this._isPositionalKey(n)&&(g=!0,n=n.substr(0,n.length-2),d=new k(b+"."+n),f[n]&&f[n]instanceof Array&&f[n].length)){p=[];for(l=0;l<f[n].length;l++)this._match(f[n][l],d.value(c)[0])&&p.push(l);for(l=0;l<p.length;l++)d=this.updateObject(f[n][p[l]],h[n+".$"],c,a,b+"."+n,e),m=m||d}if(!g)if(e||"object"!==typeof h[n])switch(e){case "$inc":this._updateIncrement(f,n,h[n]);m=
!0;break;case "$push":void 0===f[n]&&this._updateProperty(f,n,[]);if(f[n]instanceof Array){if(void 0!==h[n].$position&&h[n].$each instanceof Array)for(d=h[n].$position,g=h[n].$each.length,l=0;l<g;l++)this._updateSplicePush(f[n],d+l,h[n].$each[l]);else if(h[n].$each instanceof Array)for(g=h[n].$each.length,l=0;l<g;l++)this._updatePush(f[n],h[n].$each[l]);else this._updatePush(f[n],h[n]);m=!0}else throw'ForerunnerDB.Collection "'+this.name()+'": Cannot push to a key that is not an array! ('+n+")";break;
case "$pull":if(f[n]instanceof Array){p=[];for(l=0;l<f[n].length;l++)this._match(f[n][l],h[n])&&p.push(l);for(g=p.length;g--;)this._updatePull(f[n],p[g]),m=!0}break;case "$pullAll":if(f[n]instanceof Array)if(h[n]instanceof Array){if(p=f[n],g=p.length,0<g)for(;g--;){for(d=0;d<h[n].length;d++)p[g]===h[n][d]&&(this._updatePull(f[n],g),g--,m=!0);if(0>g)break}}else throw'ForerunnerDB.Collection "'+this.name()+'": Cannot pullAll without being given an array of values to pull! ('+n+")";break;case "$addToSet":void 0===
f[n]&&this._updateProperty(f,n,[]);if(f[n]instanceof Array){l=f[n];var q;p=l.length;var v;g=!0;q=a&&a.$addToSet;var t;h[n].$key?(d=!1,t=new k(h[n].$key),v=t.value(h[n])[0],delete h[n].$key):q&&q.key?(d=!1,t=new k(q.key),v=t.value(h[n])[0]):(v=JSON.stringify(h[n]),d=!0);for(q=0;q<p;q++)if(d){if(JSON.stringify(l[q])===v){g=!1;break}}else if(v===t.value(l[q])[0]){g=!1;break}g&&(this._updatePush(f[n],h[n]),m=!0)}else throw'ForerunnerDB.Collection "'+this.name()+'": Cannot addToSet on a key that is not an array! (undefined)';
break;case "$splicePush":void 0===f[n]&&this._updateProperty(f,n,[]);if(f[n]instanceof Array)if(d=h.$index,void 0!==d)delete h.$index,d>f[n].length&&(d=f[n].length),this._updateSplicePush(f[n],d,h[n]),m=!0;else throw'ForerunnerDB.Collection "'+this.name()+'": Cannot splicePush without a $index integer value!';else throw'ForerunnerDB.Collection "'+this.name()+'": Cannot splicePush with a key that is not an array! ('+n+")";break;case "$move":if(f[n]instanceof Array)for(l=0;l<f[n].length;l++){if(this._match(f[n][l],
h[n])){m=h.$index;if(void 0!==m)delete h.$index,this._updateSpliceMove(f[n],l,m),m=!0;else throw'ForerunnerDB.Collection "'+this.name()+'": Cannot move without a $index integer value!';break}}else throw'ForerunnerDB.Collection "'+this.name()+'": Cannot move on a key that is not an array! ('+n+")";break;case "$mul":this._updateMultiply(f,n,h[n]);m=!0;break;case "$rename":this._updateRename(f,n,h[n]);m=!0;break;case "$unset":this._updateUnset(f,n);m=!0;break;case "$pop":if(f[n]instanceof Array)this._updatePop(f[n],
h[n])&&(m=!0);else throw'ForerunnerDB.Collection "'+this.name()+'": Cannot pop from a key that is not an array! ('+n+")";break;default:f[n]!==h[n]&&(this._updateProperty(f,n,h[n]),m=!0)}else if(null!==f[n]&&"object"===typeof f[n])if(l=f[n]instanceof Array,p=h[n]instanceof Array,l||p)if(!p&&l)for(l=0;l<f[n].length;l++)d=this.updateObject(f[n][l],h[n],c,a,b+"."+n,e),m=m||d;else f[n]!==h[n]&&(this._updateProperty(f,n,h[n]),m=!0);else d=this.updateObject(f[n],h[n],c,a,b+"."+n,e),m=m||d;else f[n]!==h[n]&&
(this._updateProperty(f,n,h[n]),m=!0)}return m};e.prototype._isPositionalKey=function(f){return".$"===f.substr(f.length-2,2)};e.prototype._updateProperty=function(f,h,c){f[h]=c;this.debug()&&console.log('ForerunnerDB.Collection: Setting non-data-bound document property "'+h+'" for collection "'+this.name()+'"')};e.prototype._updateIncrement=function(f,h,c){f[h]+=c};e.prototype._updateSpliceMove=function(f,h,c){f.splice(c,0,f.splice(h,1)[0]);this.debug()&&console.log('ForerunnerDB.Collection: Moving non-data-bound document array index from "'+
h+'" to "'+c+'" for collection "'+this.name()+'"')};e.prototype._updateSplicePush=function(f,h,c){f.length>h?f.splice(h,0,c):f.push(c)};e.prototype._updatePush=function(f,h){f.push(h)};e.prototype._updatePull=function(f,h){f.splice(h,1)};e.prototype._updateMultiply=function(f,h,c){f[h]*=c};e.prototype._updateRename=function(f,h,c){f[c]=f[h];delete f[h]};e.prototype._updateUnset=function(f,h){delete f[h]};e.prototype._updatePop=function(f,h){var c=!1;0<f.length&&(1===h?(f.pop(),c=!0):-1===h&&(f.shift(),
c=!0));return c};e.prototype.remove=function(f,h,c){var a,b;if(f instanceof Array){a=[];for(c=0;c<f.length;c++)a.push(this.remove(f[c],{noEmit:!0}));(!h||h&&!h.noEmit)&&this._onRemove(a);return a}c=this.find(f,{$decouple:!1});if(c.length){for(var k=0;k<c.length;k++)b=c[k],this._removeFromIndexes(b),a=this._data.indexOf(b),this._dataRemoveAtIndex(a),this.processTrigger(this.TYPE_REMOVE,this.PHASE_AFTER,b,{});this.chainSend("remove",{query:f,dataSet:c},h);(!h||h&&!h.noEmit)&&this._onRemove(c);this.deferEmit("change",
{type:"remove",data:c})}return c};e.prototype.removeById=function(f){var h={};h[this._primaryKey]=f;return this.remove(h)};e.prototype.deferEmit=function(){var f=this,h;this._noEmitDefer||this._db&&(!this._db||this._db._noEmitDefer)?this.emit.apply(this,arguments):(h=arguments,this._changeTimeout&&clearTimeout(this._changeTimeout),this._changeTimeout=setTimeout(function(){f.debug()&&console.log("ForerunnerDB.Collection: Emitting "+h[0]);f.emit.apply(f,h)},100))};e.prototype.processQueue=function(f,
h){var c=this._deferQueue[f],a=this._deferThreshold[f],b=this._deferTime[f];if(c.length){var k=this;c.length&&(c=c.length>a?c.splice(0,a):c.splice(0,c.length),this[f](c));setTimeout(function(){k.processQueue(f,h)},b)}else h&&h()};e.prototype.insert=function(f,h,c){"function"===typeof h?(c=h,h=this._data.length):void 0===h&&(h=this._data.length);f=this.transformIn(f);return this._insertHandle(f,h,c)};e.prototype._insertHandle=function(f,h,c){var a=this._deferQueue.insert,b=this._deferThreshold.insert,
k=[],e=[];if(f instanceof Array){if(f.length>b){this._deferQueue.insert=a.concat(f);this.processQueue("insert",c);return}for(b=0;b<f.length;b++)a=this._insert(f[b],h+b),!0===a?k.push(f[b]):e.push({doc:f[b],reason:a})}else a=this._insert(f,h),!0===a?k.push(f):e.push({doc:f,reason:a});this.chainSend("insert",f,{index:h});this._onInsert(k,e);c&&c();this.deferEmit("change",{type:"insert",data:k});return{inserted:k,failed:e}};e.prototype._insert=function(f,h){if(f){var c;this.ensurePrimaryKey(f);if(c=
this.insertIndexViolation(f))return"Index violation in index: "+c;this._insertIntoIndexes(f);h>this._data.length&&(h=this._data.length);this._dataInsertAtIndex(h,f);this.processTrigger(this.TYPE_INSERT,this.PHASE_AFTER,{},f);return!0}return"No document passed to insert"};e.prototype._dataInsertAtIndex=function(f,h){this._data.splice(f,0,h)};e.prototype._dataRemoveAtIndex=function(f){this._data.splice(f,1)};e.prototype._dataReplace=function(f){for(;this._data.length;)this._data.pop();this._data=this._data.concat(f)};
e.prototype._insertIntoIndexes=function(f){var h=this._indexByName,c,a,b=JSON.stringify(f);a=this._primaryIndex.uniqueSet(f[this._primaryKey],f);this._primaryCrc.uniqueSet(f[this._primaryKey],b);this._crcLookup.uniqueSet(b,f);for(c in h)h.hasOwnProperty(c)&&h[c].insert(f);return a};e.prototype._removeFromIndexes=function(f){var h=this._indexByName,c,a=JSON.stringify(f);this._primaryIndex.unSet(f[this._primaryKey]);this._primaryCrc.unSet(f[this._primaryKey]);this._crcLookup.unSet(a);for(c in h)h.hasOwnProperty(c)&&
h[c].remove(f)};e.prototype._rebuildIndexes=function(){var f=this._indexByName,c;for(c in f)f.hasOwnProperty(c)&&f[c].rebuild()};e.prototype.indexOfDocById=function(f){return this._data.indexOf(this._primaryIndex.get(f[this._primaryKey]))};e.prototype.subset=function(f,c){var a=this.find(f,c);return(new e)._subsetOf(this).primaryKey(this._primaryKey).setData(a)};e.prototype.subsetOf=function(){return this.__subsetOf};e.prototype._subsetOf=function(f){this.__subsetOf=f;return this};e.prototype.distinct=
function(f,c,a){c=this.find(c,a);f=new k(f);a={};var b=[],e,m;for(m=0;m<c.length;m++)(e=f.value(c[m])[0])&&!a[e]&&(a[e]=!0,b.push(e));return b};e.prototype.findById=function(f,c){var a={};a[this._primaryKey]=f;return this.find(a,c)[0]};e.prototype.peek=function(f,c){var a=this._data,b=a.length,k,m,d=new e;if("string"===typeof f){for(k=0;k<b;k++)m=JSON.stringify(a[k]),-1<m.indexOf(f)&&d.insert(a[k]);return d.find({},c)}return this.find(f,c)};e.prototype.explain=function(f,c){return this.find(f,c).__fdbOp._data};
e.prototype.options=function(f){f=f||{};f.$decouple=void 0!==f.$decouple?f.$decouple:!0;f.$explain=void 0!==f.$explain?f.$explain:!1;return f};e.prototype.find=function(f,c){f=f||{};c=this.options(c);var a=this._metrics.create("find"),b=this,e,m=!0,d,g,p,l,r,n,q,v,t,x=[];g=function(c){return b._match(c,f,"and")};a.start();if(f){a.time("analyseQuery");e=this._analyseQuery(f,c,a);a.time("analyseQuery");a.data("analysis",e);if(e.hasJoin&&e.queriesJoin){a.time("joinReferences");for(p=0;p<e.joinsOn.length;p++)r=
e.joinsOn[p],l=new k(e.joinQueries[r]),l=l.value(f)[0],this._db.collection(e.joinsOn[p]).subset(l);a.time("joinReferences")}e.indexMatch.length&&(!c||c&&!c.$skipIndex)?(a.data("index.potential",e.indexMatch),a.data("index.used",e.indexMatch[0].index),a.time("indexLookup"),d=e.indexMatch[0].lookup,a.time("indexLookup"),e.indexMatch[0].keyData.totalKeyCount===e.indexMatch[0].keyData.score&&(m=!1)):a.flag("usedIndex",!1);m&&(d&&d.length?(e=d.length,a.time("tableScan: "+e),d=d.filter(g)):(e=this._data.length,
a.time("tableScan: "+e),d=this._data.filter(g)),c.$orderBy&&(a.time("sort"),d=this.sort(c.$orderBy,d),a.time("sort")),a.time("tableScan: "+e));c.limit&&d&&d.length>c.limit&&(d.length=c.limit,a.data("limit",c.limit));c.$decouple&&(a.time("decouple"),d=this.decouple(d),a.time("decouple"),a.data("flag.decouple",!0));if(c.join){for(g=0;g<c.join.length;g++)for(r in c.join[g])if(c.join[g].hasOwnProperty(r))for(v=r,e=this._db.collection(r),m=c.join[g][r],t=0;t<d.length;t++){q={};l=p=!1;for(n in m)if(m.hasOwnProperty(n))if("$"===
n.substr(0,1))switch(n){case "$as":v=m[n];break;case "$multi":p=m[n];break;case "$require":l=m[n];break;default:n.substr(0,3)}else q[n]=(new k(m[n])).value(d[t])[0];q=e.find(q);!l||l&&q[0]?d[t][v]=!1===p?q[0]:q:x.push(d[t])}a.data("flag.join",!0)}if(x.length){a.time("removalQueue");for(n=0;n<x.length;n++)r=d.indexOf(x[n]),-1<r&&d.splice(r,1);a.time("removalQueue")}if(c.transform){a.time("transform");for(n=0;n<d.length;n++)d.splice(n,1,c.transform(d[n]));a.time("transform");a.data("flag.transform",
!0)}this._transformEnabled&&this._transformOut&&(a.time("transformOut"),d=this.transformOut(d),a.time("transformOut"));a.data("results",d.length);a.stop()}else a.stop(),d=[];d.__fdbOp=a;return d};e.prototype.indexOf=function(f){if(f=this.find(f,{$decouple:!1})[0])return this._data.indexOf(f)};e.prototype.transform=function(f){return void 0!==f?("object"===typeof f?(void 0!==f.enabled&&(this._transformEnabled=f.enabled),void 0!==f.dataIn&&(this._transformIn=f.dataIn),void 0!==f.dataOut&&(this._transformOut=
f.dataOut)):this._transformEnabled=!1===f?!1:!0,this):{enabled:this._transformEnabled,dataIn:this._transformIn,dataOut:this._transformOut}};e.prototype.transformIn=function(f){if(this._transformEnabled&&this._transformIn){if(f instanceof Array){var c=[],a;for(a=0;a<f.length;a++)c[a]=this._transformIn(f[a]);return c}return this._transformIn(f)}return f};e.prototype.transformOut=function(f){if(this._transformEnabled&&this._transformOut){if(f instanceof Array){var c=[],a;for(a=0;a<f.length;a++)c[a]=
this._transformOut(f[a]);return c}return this._transformOut(f)}return f};e.prototype.sort=function(f,c){c=c||[];var a=[],b,e;for(b in f)f.hasOwnProperty(b)&&(e={},e[b]=f[b],e.___fdbKey=b,a.push(e));return 2>a.length?this._sort(f,c):this._bucketSort(a,c)};e.prototype._bucketSort=function(f,c){var a=f.shift(),b,e,k=[];if(0<f.length){c=this._sort(a,c);b=this.bucket(a.___fdbKey,c);for(e in b)b.hasOwnProperty(e)&&(a=[].concat(f),k=k.concat(this._bucketSort(a,b[e])));return k}return this._sort(a,c)};e.prototype._sort=
function(c,a){var b=this,e,m=new k;e=m.parse(c,!0)[0];m.path(e.path);if(1===e.value)e=function(c,f){var a=m.value(c)[0],h=m.value(f)[0];return b.sortAsc(a,h)};else if(-1===e.value)e=function(c,f){var a=m.value(c)[0],h=m.value(f)[0];return b.sortDesc(a,h)};else throw'ForerunnerDB.Collection "'+this.name()+'": $orderBy clause has invalid direction: '+e.value+", accepted values are 1 or -1 for ascending or descending!";return a.sort(e)};e.prototype.bucket=function(c,a){var b,e={};for(b=0;b<a.length;b++)e[a[b][c]]=
e[a[b][c]]||[],e[a[b][c]].push(a[b]);return e};e.prototype._analyseQuery=function(c,a,b){var e={queriesOn:[this._name],indexMatch:[],hasJoin:!1,queriesJoin:!1,joinQueries:{},query:c,options:a},m,d=[],g=[],p,l,s,r,n,q;b.time("checkIndexes");if(n=(new k).countKeys(c)){void 0!==c[this._primaryKey]&&(b.time("checkIndexMatch: Primary Key"),e.indexMatch.push({lookup:this._primaryIndex.lookup(c,a),keyData:{matchedKeys:[this._primaryKey],totalKeyCount:n,score:1},index:this._primaryIndex}),b.time("checkIndexMatch: Primary Key"));
for(q in this._indexById)if(this._indexById.hasOwnProperty(q)&&(l=this._indexById[q],s=l.name(),b.time("checkIndexMatch: "+s),p=l.match(c,a),0<p.score&&(r=l.lookup(c,a),e.indexMatch.push({lookup:r,keyData:p,index:l})),b.time("checkIndexMatch: "+s),p.score===n))break;b.time("checkIndexes");1<e.indexMatch.length&&(b.time("findOptimalIndex"),e.indexMatch.sort(function(c,a){if(c.keyData.score>a.keyData.score)return-1;if(c.keyData.score<a.keyData.score)return 1;if(c.keyData.score===a.keyData.score)return c.lookup.length-
a.lookup.length}),b.time("findOptimalIndex"))}if(a.join){e.hasJoin=!0;for(b=0;b<a.join.length;b++)for(m in a.join[b])a.join[b].hasOwnProperty(m)&&(d.push(m),"$as"in a.join[b][m]?g.push(a.join[b][m].$as):g.push(m));for(m=0;m<g.length;m++)if(a=this._queryReferencesCollection(c,g[m],""))e.joinQueries[d[m]]=a,e.queriesJoin=!0;e.joinsOn=d;e.queriesOn=e.queriesOn.concat(d)}return e};e.prototype._queryReferencesCollection=function(c,a,b){for(var e in c)if(c.hasOwnProperty(e)){if(e===a)return b&&(b+="."),
b+e;if("object"===typeof c[e])return b&&(b+="."),b+=e,this._queryReferencesCollection(c[e],a,b)}return!1};e.prototype.count=function(c,a){return c?this.find(c,a).length:this._data.length};e.prototype.findSub=function(c,a,b,e){var m=new k(a);c=this.find(c);var d=c.length,g,p,l=this._db.collection("__FDB_temp_"+this.objectId()),s={parents:d,subDocTotal:0,subDocs:[],pathFound:!1,err:""};for(g=0;g<d;g++)if(p=m.value(c[g])[0]){l.setData(p);p=l.find(b,e);if(e.returnFirst&&p.length)return p[0];s.subDocs.push(p);
s.subDocTotal+=p.length;s.pathFound=!0}l.drop();if(e.noStats)return s.subDocs;s.pathFound||(s.err="No objects found in the parent documents with a matching path of: "+a);return s};e.prototype.insertIndexViolation=function(c){var a,b=this._indexByName,e,k;if(this._primaryIndex.get(c[this._primaryKey]))a=this._primaryIndex;else for(e in b)if(b.hasOwnProperty(e)&&(k=b[e],k.unique()&&k.violation(c))){a=k;break}return a?a.name():!1};e.prototype.ensureIndex=function(a,b){this._indexByName=this._indexByName||
{};this._indexById=this._indexById||{};var e,k={start:(new Date).getTime()};if(b)switch(b.type){case "hashed":e=new c(a,b,this);break;case "btree":e=new m(a,b,this);break;default:e=new c(a,b,this)}else e=new c(a,b,this);if(this._indexByName[e.name()])return{err:"Index with that name already exists"};if(this._indexById[e.id()])return{err:"Index with those keys already exists"};e.rebuild();this._indexByName[e.name()]=e;this._indexById[e.id()]=e;k.end=(new Date).getTime();k.total=k.end-k.start;this._lastOp=
{type:"ensureIndex",stats:{time:k}};return{index:e,id:e.id(),name:e.name(),state:e.state()}};e.prototype.index=function(c){if(this._indexByName)return this._indexByName[c]};e.prototype.lastOp=function(){return this._metrics.list()};e.prototype.diff=function(c){var a={insert:[],update:[],remove:[]},b=this.primaryKey(),e,k,m,d;if(b===c.primaryKey()){for(e=c._data;e&&!(e instanceof Array);)c=e,e=c._data;d=e.length;for(k=0;k<d;k++)m=e[k],this._primaryIndex.get(m[b])?this._primaryCrc.get(m[b])!==c._primaryCrc.get(m[b])&&
a.update.push(m):a.insert.push(m);e=this._data;d=e.length;for(k=0;k<d;k++)m=e[k],c._primaryIndex.get(m[b])||a.remove.push(m)}else throw'ForerunnerDB.Collection "'+this.name()+'": Collection diffing requires that both collections have the same primary key!';return a};d.prototype.collection=function(c,a){if(c)return this._collection[c]||this.debug()&&console.log("Creating collection "+c),this._collection[c]=this._collection[c]||(new e(c)).db(this),void 0!==a&&this._collection[c].primaryKey(a),this._collection[c];
throw'ForerunnerDB.Core "'+this.name()+'": Cannot get collection with undefined name!';};d.prototype.collectionExists=function(c){return Boolean(this._collection[c])};d.prototype.collections=function(c){var a=[],b;c&&(c instanceof RegExp||(c=RegExp(c)));for(b in this._collection)this._collection.hasOwnProperty(b)&&(c?c.exec(b)&&a.push({name:b,count:this._collection[b].count()}):a.push({name:b,count:this._collection[b].count()}));return a};g.finishModule("Collection");l.exports=e},{"./Crc":6,"./IndexBinaryTree":7,
"./IndexHashMap":8,"./KeyValueStore":9,"./Metrics":10,"./Path":21,"./Shared":23}],4:[function(d,l,g){var b,a;g=d("./Shared");var k=function(){this.init.apply(this,arguments)};k.prototype.init=function(c){this._name=c;this._data=new a("__FDB__cg_data_"+this._name);this._collections=[];this._view=[]};g.addModule("CollectionGroup",k);g.mixin(k.prototype,"Mixin.Common");g.mixin(k.prototype,"Mixin.ChainReactor");g.mixin(k.prototype,"Mixin.Constants");g.mixin(k.prototype,"Mixin.Triggers");a=d("./Collection");
d=g.modules.Core;b=g.modules.Core.prototype.init;k.prototype.on=function(){this._data.on.apply(this._data,arguments)};k.prototype.off=function(){this._data.off.apply(this._data,arguments)};k.prototype.emit=function(){this._data.emit.apply(this._data,arguments)};k.prototype.primaryKey=function(c){return void 0!==c?(this._primaryKey=c,this):this._primaryKey};g.synthesize(k.prototype,"state");g.synthesize(k.prototype,"db");k.prototype.addCollection=function(c){if(c&&-1===this._collections.indexOf(c)){if(this._collections.length){if(this._primaryKey!==
c.primaryKey())throw'ForerunnerDB.CollectionGroup "'+this.name()+'": All collections in a collection group must have the same primary key!';}else this.primaryKey(c.primaryKey());this._collections.push(c);c._groups.push(this);c.chain(this);this._data.insert(c.find())}return this};k.prototype.removeCollection=function(c){if(c){var a=this._collections.indexOf(c);-1!==a&&(c.unChain(this),this._collections.splice(a,1),a=c._groups.indexOf(this),-1!==a&&c._groups.splice(a,1));0===this._collections.length&&
delete this._primaryKey}return this};k.prototype._chainHandler=function(c){switch(c.type){case "setData":c.data=this.decouple(c.data);this._data.remove(c.options.oldData);this._data.insert(c.data);break;case "insert":c.data=this.decouple(c.data);this._data.insert(c.data);break;case "update":this._data.update(c.data.query,c.data.update,c.options);break;case "remove":this._data.remove(c.data.query,c.options)}};k.prototype.insert=function(){this._collectionsRun("insert",arguments)};k.prototype.update=
function(){this._collectionsRun("update",arguments)};k.prototype.updateById=function(){this._collectionsRun("updateById",arguments)};k.prototype.remove=function(){this._collectionsRun("remove",arguments)};k.prototype._collectionsRun=function(c,a){for(var b=0;b<this._collections.length;b++)this._collections[b][c].apply(this._collections[b],a)};k.prototype.find=function(c,a){return this._data.find(c,a)};k.prototype.removeById=function(c){for(var a=0;a<this._collections.length;a++)this._collections[a].removeById(c)};
k.prototype.subset=function(c,b){var k=this.find(c,b);return(new a)._subsetOf(this).primaryKey(this._primaryKey).setData(k)};k.prototype.drop=function(){if("dropped"!==this._state){var c,a;this._debug&&console.log("Dropping collection group "+this._name);this._state="dropped";if(this._collections&&this._collections.length)for(a=[].concat(this._collections),c=0;c<a.length;c++)this.removeCollection(a[c]);if(this._view&&this._view.length)for(a=[].concat(this._view),c=0;c<a.length;c++)this._removeView(a[c]);
this.emit("drop",this)}return!0};d.prototype.init=function(){this._collectionGroup={};b.apply(this,arguments)};d.prototype.collectionGroup=function(c){return c?(this._collectionGroup[c]=this._collectionGroup[c]||(new k(c)).db(this),this._collectionGroup[c]):this._collectionGroup};d.prototype.collectionGroups=function(){var c=[],a;for(a in this._collectionGroup)this._collectionGroup.hasOwnProperty(a)&&c.push({name:a});return c};l.exports=k},{"./Collection":3,"./Shared":23}],5:[function(d,l,g){var b,
a,k;b=d("./Shared");k=d("./Overload");g=function(c){this.init.apply(this,arguments)};g.prototype.init=function(c){this._name=c;this._collection={};this._debug={}};g.prototype.moduleLoaded=k({string:function(c){if(void 0!==c){c=c.replace(/ /g,"");c=c.split(",");var a;for(a=0;a<c.length;a++)if(!b.modules[c[a]])return!1;return!0}return!1},"string, function":function(c,a){if(void 0!==c){c=c.replace(/ /g,"");var k=c.split(","),e;for(e=0;e<k.length;e++)if(!b.modules[k[e]])return!1;a()}},"string, function, function":function(c,
a,k){if(void 0!==c){c=c.replace(/ /g,"");c=c.split(",");var e;for(e=0;e<c.length;e++)if(!b.modules[c[e]])return k(),!1;a()}}});g.prototype.version=function(c,a){return void 0!==c?0===b.version.indexOf(c)?(a&&a(),!0):!1:b.version};g.moduleLoaded=g.prototype.moduleLoaded;g.version=g.prototype.version;g.shared=b;g.prototype.shared=b;b.addModule("Core",g);b.mixin(g.prototype,"Mixin.Common");b.mixin(g.prototype,"Mixin.ChainReactor");b.mixin(g.prototype,"Mixin.Constants");a=d("./Collection.js");d("./Metrics.js");
d=d("./Crc.js");g.prototype._isServer=!1;b.synthesize(g.prototype,"state");b.synthesize(g.prototype,"name");g.prototype.isClient=function(){return!this._isServer};g.prototype.isServer=function(){return this._isServer};g.prototype.crc=d;g.prototype.isClient=function(){return!this._isServer};g.prototype.isServer=function(){return this._isServer};g.prototype.arrayToCollection=function(c){return(new a).setData(c)};g.prototype.on=function(c,a){this._listeners=this._listeners||{};this._listeners[c]=this._listeners[c]||
[];this._listeners[c].push(a);return this};g.prototype.off=function(a,b){if(a in this._listeners){var k=this._listeners[a],e=k.indexOf(b);-1<e&&k.splice(e,1)}return this};g.prototype.emit=function(a,b){this._listeners=this._listeners||{};if(a in this._listeners){var k=this._listeners[a],e=k.length,f;for(f=0;f<e;f++)k[f].apply(this,Array.prototype.slice.call(arguments,1))}return this};g.prototype.peek=function(a){var b,k,e=[],f=typeof a;for(b in this._collection)this._collection.hasOwnProperty(b)&&
(k=this._collection[b],e="string"===f?e.concat(k.peek(a)):e.concat(k.find(a)));return e};g.prototype.peekCat=function(a){var b,k,e={},f,h=typeof a;for(b in this._collection)this._collection.hasOwnProperty(b)&&(k=this._collection[b],(f="string"===h?k.peek(a):k.find(a))&&f.length&&(e[k.name()]=f));return e};g.prototype.drop=function(a){if("dropped"!==this._state){var b=this.collections(),k=b.length,e,f=0;this._state="dropped";for(e=0;e<k;e++)this.collection(b[e].name).drop(function(){f++;f===k&&a&&
a()}),delete this._collection[b[e].name];this.emit("drop",this)}return!0};l.exports=g},{"./Collection.js":3,"./Crc.js":6,"./Metrics.js":10,"./Overload":20,"./Shared":23}],6:[function(d,l,g){var b=function(){var a=[],b,c,m;for(c=0;256>c;c++){b=c;for(m=0;8>m;m++)b=b&1?3988292384^b>>>1:b>>>1;a[c]=b}return a}();l.exports=function(a){var k=-1,c;for(c=0;c<a.length;c++)k=k>>>8^b[(k^a.charCodeAt(c))&255];return(k^-1)>>>0}},{}],7:[function(d,l,g){g=d("./Shared");var b=d("./Path"),a=d("./vendor/btree");d=function(){this.init.apply(this,
arguments)};d.prototype.init=function(b,c,m){this._btree=new (a.create(2,this.sortAsc));this._size=0;this._id=this._itemKeyHash(b,b);this.unique(c&&c.unique?c.unique:!1);void 0!==b&&this.keys(b);void 0!==m&&this.collection(m);this.name(c&&c.name?c.name:this._id)};g.addModule("IndexBinaryTree",d);g.mixin(d.prototype,"Mixin.ChainReactor");g.mixin(d.prototype,"Mixin.Sorting");d.prototype.id=function(){return this._id};d.prototype.state=function(){return this._state};d.prototype.size=function(){return this._size};
g.synthesize(d.prototype,"data");g.synthesize(d.prototype,"name");g.synthesize(d.prototype,"collection");g.synthesize(d.prototype,"type");g.synthesize(d.prototype,"unique");d.prototype.keys=function(a){return void 0!==a?(this._keys=a,this._keyCount=(new b).parse(this._keys).length,this):this._keys};d.prototype.rebuild=function(){if(this._collection){var b=this._collection.subset({},{$decouple:!1,$orderBy:this._keys}).find(),c,m=b.length;this._btree=new (a.create(2,this.sortAsc));this._unique&&(this._uniqueLookup=
{});for(c=0;c<m;c++)this.insert(b[c])}this._state={name:this._name,keys:this._keys,indexSize:this._size,built:new Date,updated:new Date,ok:!0}};d.prototype.insert=function(a,c){var b=this._unique,d=this._itemKeyHash(a,this._keys);b&&(b=this._itemHash(a,this._keys),this._uniqueLookup[b]=a);b=this._btree.get(d);void 0===b&&(b=[],this._btree.put(d,b));b.push(a);this._size++};d.prototype.remove=function(a,c){var b=this._unique,d=this._itemKeyHash(a,this._keys),e;b&&(b=this._itemHash(a,this._keys),delete this._uniqueLookup[b]);
b=this._btree.get(d);void 0!==b&&(e=b.indexOf(a),-1<e&&(1===b.length?this._btree.del(d):b.splice(e,1),this._size--))};d.prototype.violation=function(a){a=this._itemHash(a,this._keys);return Boolean(this._uniqueLookup[a])};d.prototype.hashViolation=function(a){return Boolean(this._uniqueLookup[a])};d.prototype.lookup=function(a){return this._data[this._itemHash(a,this._keys)]||[]};d.prototype.match=function(a,c){var m=new b,d=m.parseArr(this._keys),m=m.parseArr(a),e=[],f=0,h;for(h=0;h<d.length;h++)if(m[h]===
d[h])f++,e.push(m[h]);else return{matchedKeys:[],totalKeyCount:m.length,score:0};return{matchedKeys:e,totalKeyCount:m.length,score:f}};d.prototype._itemHash=function(a,c){var m=new b,d,e="",f;d=m.parse(c);for(f=0;f<d.length;f++)e&&(e+="_"),e+=m.value(a,d[f].path).join(":");return e};d.prototype._itemKeyHash=function(a,c){var d=new b,g,e="",f;g=d.parse(c);for(f=0;f<g.length;f++)e&&(e+="_"),e+=d.keyValue(a,g[f].path);return e};d.prototype._itemHashArr=function(a,c){var d=new b,g,e=[],f,h,u,w;g=d.parse(c);
for(u=0;u<g.length;u++)for(f=d.value(a,g[u].path),h=0;h<f.length;h++)if(0===u)e.push(f[h]);else for(w=0;w<e.length;w++)e[w]=e[w]+"_"+f[h];return e};g.finishModule("IndexBinaryTree");l.exports=d},{"./Path":21,"./Shared":23,"./vendor/btree":25}],8:[function(d,l,g){g=d("./Shared");var b=d("./Path");d=function(){this.init.apply(this,arguments)};d.prototype.init=function(a,b,c){this._crossRef={};this._size=0;this._id=this._itemKeyHash(a,a);this.data({});this.unique(b&&b.unique?b.unique:!1);void 0!==a&&
this.keys(a);void 0!==c&&this.collection(c);this.name(b&&b.name?b.name:this._id)};g.addModule("IndexHashMap",d);g.mixin(d.prototype,"Mixin.ChainReactor");d.prototype.id=function(){return this._id};d.prototype.state=function(){return this._state};d.prototype.size=function(){return this._size};g.synthesize(d.prototype,"data");g.synthesize(d.prototype,"name");g.synthesize(d.prototype,"collection");g.synthesize(d.prototype,"type");g.synthesize(d.prototype,"unique");d.prototype.keys=function(a){return void 0!==
a?(this._keys=a,this._keyCount=(new b).parse(this._keys).length,this):this._keys};d.prototype.rebuild=function(){if(this._collection){var a=this._collection.subset({},{$decouple:!1,$orderBy:this._keys}).find(),b,c=a.length;this._data={};this._unique&&(this._uniqueLookup={});for(b=0;b<c;b++)this.insert(a[b])}this._state={name:this._name,keys:this._keys,indexSize:this._size,built:new Date,updated:new Date,ok:!0}};d.prototype.insert=function(a,b){var c,d;this._unique&&(c=this._itemHash(a,this._keys),
this._uniqueLookup[c]=a);c=this._itemHashArr(a,this._keys);for(d=0;d<c.length;d++)this.pushToPathValue(c[d],a)};d.prototype.remove=function(a,b){var c,d;this._unique&&(c=this._itemHash(a,this._keys),delete this._uniqueLookup[c]);c=this._itemHashArr(a,this._keys);for(d=0;d<c.length;d++)this.pullFromPathValue(c[d],a)};d.prototype.violation=function(a){a=this._itemHash(a,this._keys);return Boolean(this._uniqueLookup[a])};d.prototype.hashViolation=function(a){return Boolean(this._uniqueLookup[a])};d.prototype.pushToPathValue=
function(a,b){var c=this._data[a]=this._data[a]||[];-1===c.indexOf(b)&&(c.push(b),this._size++,this.pushToCrossRef(b,c))};d.prototype.pullFromPathValue=function(a,b){var c=this._data[a],d;d=c.indexOf(b);-1<d&&(c.splice(d,1),this._size--,this.pullFromCrossRef(b,c));c.length||delete this._data[a]};d.prototype.pull=function(a){var b=a[this._collection.primaryKey()],c=this._crossRef[b],d,g=c.length,e;for(d=0;d<g;d++)e=c[d],this._pullFromArray(e,a);this._size--;delete this._crossRef[b]};d.prototype._pullFromArray=
function(a,b){for(var c=a.length;c--;)a[c]===b&&a.splice(c,1)};d.prototype.pushToCrossRef=function(a,b){var c=a[this._collection.primaryKey()];this._crossRef[c]=this._crossRef[c]||[];c=this._crossRef[c];-1===c.indexOf(b)&&c.push(b)};d.prototype.pullFromCrossRef=function(a,b){var c=a[this._collection.primaryKey()];delete this._crossRef[c]};d.prototype.lookup=function(a){return this._data[this._itemHash(a,this._keys)]||[]};d.prototype.match=function(a,k){var c=new b,d=c.parseArr(this._keys),c=c.parseArr(a),
g=[],e=0,f;for(f=0;f<d.length;f++)if(c[f]===d[f])e++,g.push(c[f]);else return{matchedKeys:[],totalKeyCount:c.length,score:0};return{matchedKeys:g,totalKeyCount:c.length,score:e}};d.prototype._itemHash=function(a,k){var c=new b,d,g="",e;d=c.parse(k);for(e=0;e<d.length;e++)g&&(g+="_"),g+=c.value(a,d[e].path).join(":");return g};d.prototype._itemKeyHash=function(a,k){var c=new b,d,g="",e;d=c.parse(k);for(e=0;e<d.length;e++)g&&(g+="_"),g+=c.keyValue(a,d[e].path);return g};d.prototype._itemHashArr=function(a,
k){var c=new b,d,g=[],e,f,h,u;d=c.parse(k);for(h=0;h<d.length;h++)for(e=c.value(a,d[h].path),f=0;f<e.length;f++)if(0===h)g.push(e[f]);else for(u=0;u<g.length;u++)g[u]=g[u]+"_"+e[f];return g};g.finishModule("IndexHashMap");l.exports=d},{"./Path":21,"./Shared":23}],9:[function(d,l,g){d=d("./Shared");g=function(b){this.init.apply(this,arguments)};g.prototype.init=function(b){this._name=b;this._data={};this._primaryKey="_id"};d.addModule("KeyValueStore",g);d.mixin(g.prototype,"Mixin.ChainReactor");d.synthesize(g.prototype,
"name");g.prototype.primaryKey=function(b){return void 0!==b?(this._primaryKey=b,this):this._primaryKey};g.prototype.truncate=function(){this._data={};return this};g.prototype.set=function(b,a){this._data[b]=a?a:!0;return this};g.prototype.get=function(b){return this._data[b]};g.prototype.lookup=function(b){b=b[this._primaryKey];var a,k,c,d;if(b instanceof Array){k=b.length;d=[];for(a=0;a<k;a++)(c=this._data[b[a]])&&d.push(c);return d}if(b instanceof RegExp){d=[];for(a in this._data)this._data.hasOwnProperty(a)&&
b.test(a)&&d.push(this._data[a]);return d}if("object"===typeof b){if(b.$ne){d=[];for(a in this._data)this._data.hasOwnProperty(a)&&a!==b.$ne&&d.push(this._data[a]);return d}if(b.$in&&b.$in instanceof Array){d=[];for(a in this._data)this._data.hasOwnProperty(a)&&-1<b.$in.indexOf(a)&&d.push(this._data[a]);return d}if(b.$nin&&b.$nin instanceof Array){d=[];for(a in this._data)this._data.hasOwnProperty(a)&&-1===b.$nin.indexOf(a)&&d.push(this._data[a]);return d}if(b.$or&&b.$or instanceof Array){d=[];for(a=
0;a<b.$or.length;a++)d=d.concat(this.lookup(b.$or[a]));return d}}else return c=this._data[b],void 0!==c?[c]:[]};g.prototype.unSet=function(b){delete this._data[b];return this};g.prototype.uniqueSet=function(b,a){return void 0===this._data[b]?(this._data[b]=a,!0):!1};d.finishModule("KeyValueStore");l.exports=g},{"./Shared":23}],10:[function(d,l,g){g=d("./Shared");var b=d("./Operation");d=function(){this.init.apply(this,arguments)};d.prototype.init=function(){this._data=[]};g.addModule("Metrics",d);
g.mixin(d.prototype,"Mixin.ChainReactor");d.prototype.create=function(a){a=new b(a);this._enabled&&this._data.push(a);return a};d.prototype.start=function(){this._enabled=!0;return this};d.prototype.stop=function(){this._enabled=!1;return this};d.prototype.clear=function(){this._data=[];return this};d.prototype.list=function(){return this._data};g.finishModule("Metrics");l.exports=d},{"./Operation":19,"./Shared":23}],11:[function(d,l,g){l.exports={preSetData:function(){},postSetData:function(){}}},
{}],12:[function(d,l,g){l.exports={chain:function(b){this._chain=this._chain||[];-1===this._chain.indexOf(b)&&this._chain.push(b)},unChain:function(b){this._chain&&(b=this._chain.indexOf(b),-1<b&&this._chain.splice(b,1))},chainSend:function(b,a,d){if(this._chain){var c=this._chain,m=c.length,g;for(g=0;g<m;g++)c[g].chainReceive(this,b,a,d)}},chainReceive:function(b,a,d,c){b={sender:b,type:a,data:d,options:c};(!this._chainHandler||this._chainHandler&&!this._chainHandler(b))&&this.chainSend(b.type,b.data,
b.options)}}},{}],13:[function(d,l,g){var b=0;d={decouple:function(a,b){if(void 0!==a){if(b){var c,d=JSON.stringify(a),g=[];for(c=0;c<b;c++)g.push(JSON.parse(d));return g}return JSON.parse(JSON.stringify(a))}},objectId:function(a){var d=Math.pow(10,17);if(a){var c=0,g=a.length,l;for(l=0;l<g;l++)c+=a.charCodeAt(l)*d;a=c.toString(16)}else b++,a=(b+(Math.random()*d+Math.random()*d+Math.random()*d+Math.random()*d)).toString(16);return a},debug:d("./Overload")([function(){return this._debug&&this._debug.all},
function(a){return void 0!==a?"boolean"===typeof a?(this._debug=this._debug||{},this._debug.all=a,this.chainSend("debug",this._debug),this):this._debug&&this._debug[a]||this._db&&this._db._debug&&this._db._debug[a]||this._debug&&this._debug.all:this._debug&&this._debug.all},function(a,b){return void 0!==a?void 0!==b?(this._debug=this._debug||{},this._debug[a]=b,this.chainSend("debug",this._debug),this):this._debug&&this._debug[b]||this._db&&this._db._debug&&this._db._debug[a]:this._debug&&this._debug.all}])};
l.exports=d},{"./Overload":20}],14:[function(d,l,g){l.exports={TYPE_INSERT:0,TYPE_UPDATE:1,TYPE_REMOVE:2,PHASE_BEFORE:0,PHASE_AFTER:1}},{}],15:[function(d,l,g){d={on:new Overload({"string, function":function(b,a){this._listeners=this._listeners||{};this._listeners[b]=this._listeners[b]||{};this._listeners[b]["*"]=this._listeners[b]["*"]||[];this._listeners[b]["*"].push(a);return this},"string, *, function":function(b,a,d){this._listeners=this._listeners||{};this._listeners[b]=this._listeners[b]||
{};this._listeners[b][a]=this._listeners[b][a]||[];this._listeners[b][a].push(d);return this}}),off:new Overload({string:function(b){this._listeners&&this._listeners[b]&&b in this._listeners&&delete this._listeners[b];return this},"string, function":function(b,a){var d,c;"string"===typeof a?this._listeners&&this._listeners[b]&&this._listeners[b][a]&&delete this._listeners[b][a]:b in this._listeners&&(d=this._listeners[b]["*"],c=d.indexOf(a),-1<c&&d.splice(c,1));return this},"string, *, function":function(b,
a,d){this._listeners&&b in this._listeners&&a in this.listeners[b]&&(b=this._listeners[b][a],d=b.indexOf(d),-1<d&&b.splice(d,1))},"string, *":function(b,a){this._listeners&&b in this._listeners&&a in this._listeners[b]&&delete this._listeners[b][a]}}),emit:function(b,a){this._listeners=this._listeners||{};if(b in this._listeners){if(this._listeners[b]["*"]){var d=this._listeners[b]["*"],c=d.length,g;for(g=0;g<c;g++)d[g].apply(this,Array.prototype.slice.call(arguments,1))}if(a instanceof Array&&a[0]&&
a[0][this._primaryKey]){var d=this._listeners[b],l,e,c=a.length;for(g=0;g<c;g++)if(d[a[g][this._primaryKey]])for(l=d[a[g][this._primaryKey]].length,e=0;e<l;e++)d[a[g][this._primaryKey]][e].apply(this,Array.prototype.slice.call(arguments,1))}}return this}};l.exports=d},{}],16:[function(d,l,g){l.exports={_match:function(b,a,d){var c,g;c=typeof b;g=typeof a;var l=!0,e;if(!("string"!==c&&"number"!==c||"string"!==g&&"number"!==g))b!==a&&(l=!1);else for(e in a)if(a.hasOwnProperty(e)){c=!1;if("$"===e.substr(0,
1)&&(g=this._matchOp(e,b,a[e]),-1<g)){if(g){if("or"===d)return!0}else l=g;c=!0}if(!c&&a[e]instanceof RegExp)if(c=!0,"object"===typeof b&&void 0!==b[e]&&a[e].test(b[e])){if("or"===d)return!0}else l=!1;if(!c)if("object"===typeof a[e])if(void 0!==b[e]){if(b[e]instanceof Array&&!(a[e]instanceof Array))for(c=!1,g=0;g<b[e].length&&!(c=this._match(b[e][g],a[e],void 0));g++);else if(!(b[e]instanceof Array)&&a[e]instanceof Array)for(c=!1,g=0;g<a[e].length&&!(c=this._match(b[e],a[e][g],void 0));g++);else c=
"object"===typeof b?this._match(b[e],a[e],void 0):this._match(void 0,a[e],void 0);if(c){if("or"===d)return!0}else l=!1}else if(a[e]&&void 0!==a[e].$exists)if(c=this._match(void 0,a[e],void 0)){if("or"===d)return!0}else l=!1;else l=!1;else if(b&&b[e]===a[e]){if("or"===d)return!0}else if(b&&b[e]&&b[e]instanceof Array&&a[e]&&"object"!==typeof a[e]){c=!1;for(g=0;g<b[e].length&&!(c=this._match(b[e][g],a[e],void 0));g++);if(c){if("or"===d)return!0}else l=!1}else l=!1;if("and"===d&&!l)return!1}return l},
_matchOp:function(b,a,d){switch(b){case "$gt":return a>d;case "$gte":return a>=d;case "$lt":return a<d;case "$lte":return a<=d;case "$exists":return void 0===a!==d;case "$ne":return a!=d;case "$or":for(b=0;b<d.length;b++)if(this._match(a,d[b],"and"))return!0;return!1;case "$and":for(b=0;b<d.length;b++)if(!this._match(a,d[b],"and"))return!1;return!0;case "$in":if(d instanceof Array){b=d.length;var c;for(c=0;c<b;c++)if(d[c]===a)return!0;return!1}throw'ForerunnerDB.Mixin.Matching "'+this.name()+'": Cannot use an $in operator on a non-array key: '+
b;case "$nin":if(d instanceof Array){b=d.length;for(c=0;c<b;c++)if(d[c]===a)return!1;return!0}throw'ForerunnerDB.Mixin.Matching "'+this.name()+'": Cannot use a $nin operator on a non-array key: '+b;}return-1}}},{}],17:[function(d,l,g){l.exports={sortAsc:function(b,a){return"string"===typeof b&&"string"===typeof a?b.localeCompare(a):b>a?1:b<a?-1:0},sortDesc:function(b,a){return"string"===typeof b&&"string"===typeof a?a.localeCompare(b):b>a?-1:b<a?1:0}}},{}],18:[function(d,l,g){l.exports={addTrigger:function(b,
a,d,c){return-1===this._triggerIndex(b,a,d)?(this._trigger=this._trigger||{},this._trigger[a]=this._trigger[a]||{},this._trigger[a][d]=this._trigger[a][d]||[],this._trigger[a][d].push({id:b,method:c}),!0):!1},removeTrigger:function(b,a,d){b=this._triggerIndex(b,a,d);-1<b&&this._trigger[a][d].splice(b,1);return!1},willTrigger:function(b,a){return this._trigger&&this._trigger[b]&&this._trigger[b][a]&&this._trigger[b][a].length},processTrigger:function(b,a,d,c,g){var l,e;if(this._trigger&&this._trigger[a]&&
this._trigger[a][d]){a=this._trigger[a][d];l=a.length;for(d=0;d<l;d++){e=a[d];this.debug();e=e.method.call(this,b,c,g);if(!1===e)return!1;if(void 0!==e&&!0!==e&&!1!==e)throw"ForerunnerDB.Mixin.Triggers: Trigger error: "+e;}return!0}},_triggerIndex:function(b,a,d){var c;if(this._trigger&&this._trigger[a]&&this._trigger[a][d])for(a=this._trigger[a][d],d=a.length,c=0;c<d;c++)if(a[c].id===b)return c;return-1}}},{}],19:[function(d,l,g){g=d("./Shared");var b=d("./Path");d=function(a){this.pathSolver=new b;
this.counter=0;this.init.apply(this,arguments)};d.prototype.init=function(a){this._data={operation:a,index:{potential:[],used:!1},steps:[],time:{startMs:0,stopMs:0,totalMs:0,process:{}},flag:{},log:[]}};g.addModule("Operation",d);g.mixin(d.prototype,"Mixin.ChainReactor");d.prototype.start=function(){this._data.time.startMs=(new Date).getTime()};d.prototype.log=function(a){if(a){var b=0<this._log.length?this._data.log[this._data.log.length-1].time:0;a={event:a,time:(new Date).getTime(),delta:0};this._data.log.push(a);
b&&(a.delta=a.time-b);return this}return this._data.log};d.prototype.time=function(a){if(void 0!==a){var b=this._data.time.process,b=b[a]=b[a]||{};b.startMs?(b.stopMs=(new Date).getTime(),b.totalMs=b.stopMs-b.startMs,b.stepObj.totalMs=b.totalMs,delete b.stepObj):(b.startMs=(new Date).getTime(),b.stepObj={name:a},this._data.steps.push(b.stepObj));return this}return this._data.time};d.prototype.flag=function(a,b){if(void 0!==a&&void 0!==b)this._data.flag[a]=b;else return void 0!==a?this._data.flag[a]:
this._data.flag};d.prototype.data=function(a,b,c){return void 0!==b?(this.pathSolver.set(this._data,a,b),this):this.pathSolver.get(this._data,a)};d.prototype.pushData=function(a,b,c){this.pathSolver.push(this._data,a,b)};d.prototype.stop=function(){this._data.time.stopMs=(new Date).getTime();this._data.time.totalMs=this._data.time.stopMs-this._data.time.startMs};g.finishModule("Operation");l.exports=d},{"./Path":21,"./Shared":23}],20:[function(d,l,g){Overload=function(b){if(b){var a,d,c,g,l;if(!(b instanceof
Array)){c={};for(a in b)if(b.hasOwnProperty(a))if(g=a.replace(/ /g,""),-1===g.indexOf("*"))c[g]=b[a];else for(l=generateSignaturePermutations(g),g=0;g<l.length;g++)c[l[g]]||(c[l[g]]=b[a]);b=c}return function(){if(b instanceof Array)for(d=b.length,a=0;a<d;a++){if(b[a].length===arguments.length)return b[a].apply(this,arguments)}else{var c=[],f;for(a=0;a<arguments.length;a++)f=typeof arguments[a],"object"===f&&arguments[a]instanceof Array&&(f="array"),c.push(f);f=c.join(",");if(b[f])return b[f].apply(this,
arguments);for(a=c.length;0<=a;a--)if(f=c.slice(0,a).join(","),b[f+",..."])return b[f+",..."].apply(this,arguments)}throw'ForerunnerDB.Overload "'+this.name()+'": Overloaded method does not have a matching signature for the passed arguments: '+JSON.stringify(c);}}return function(){}};generateSignaturePermutations=function(b){var a=[],d,c=["string","object","number","function","undefined"],g;if(-1<b.indexOf("*"))for(g=0;g<c.length;g++)d=b.replace("*",c[g]),a=a.concat(generateSignaturePermutations(d));
else a.push(b);return a};l.exports=Overload},{}],21:[function(d,l,g){d=d("./Shared");g=function(b){this.init.apply(this,arguments)};g.prototype.init=function(b){b&&this.path(b)};d.addModule("Path",g);d.mixin(g.prototype,"Mixin.ChainReactor");g.prototype.path=function(b){return void 0!==b?(this._path=this.clean(b),this._pathParts=this._path.split("."),this):this._path};g.prototype.hasObjectPaths=function(b,a){var d=!0,c;for(c in b)if(b.hasOwnProperty(c)&&(void 0===a[c]||"object"===typeof b[c]&&(d=
this.hasObjectPaths(b[c],a[c]),!d)))return!1;return d};g.prototype.countKeys=function(b){var a=0,d;for(d in b)b.hasOwnProperty(d)&&void 0!==b[d]&&("object"!==typeof b[d]?a++:a+=this.countKeys(b[d]));return a};g.prototype.countObjectPaths=function(b,a){var d,c={},g=0,l=0,e;for(e in a)a.hasOwnProperty(e)&&("object"===typeof a[e]?(d=this.countObjectPaths(b[e],a[e]),c[e]=d.matchedKeys,l+=d.totalKeyCount,g+=d.matchedKeyCount):(l++,b&&b[e]&&"object"!==typeof b[e]?(c[e]=!0,g++):c[e]=!1));return{matchedKeys:c,
matchedKeyCount:g,totalKeyCount:l}};g.prototype.parse=function(b,a){var d=[],c="",g,l,e;for(l in b)if(b.hasOwnProperty(l))if(c=l,"object"===typeof b[l])if(a)for(g=this.parse(b[l],a),e=0;e<g.length;e++)d.push({path:c+"."+g[e].path,value:g[e].value});else for(g=this.parse(b[l]),e=0;e<g.length;e++)d.push({path:c+"."+g[e].path});else a?d.push({path:c,value:b[l]}):d.push({path:c});return d};g.prototype.parseArr=function(b,a){a=a||{};return this._parseArr(b,"",[],a)};g.prototype._parseArr=function(b,a,
d,c){var g,l="";a=a||"";d=d||[];for(g in b)b.hasOwnProperty(g)&&(!c.ignore||c.ignore&&!c.ignore.test(g))&&(l=a?a+"."+g:g,"object"===typeof b[g]?this._parseArr(b[g],l,d,c):d.push(l));return d};g.prototype.value=function(b,a){if(void 0!==b&&"object"===typeof b){var d,c,g,l,e=[],f;void 0!==a&&(a=this.clean(a),d=a.split("."));d=d||this._pathParts;c=d.length;g=b;for(f=0;f<c;f++){g=g[d[f]];if(l instanceof Array){for(c=0;c<l.length;c++)e=e.concat(this.value(l,c+"."+d[f]));return e}if(!g||"object"!==typeof g)break;
l=g}return[g]}return[]};g.prototype.set=function(b,a,d){if(void 0!==b&&void 0!==a){var c;a=this.clean(a);a=a.split(".");c=a.shift();a.length?(b[c]=b[c]||{},this.set(b[c],a.join("."),d)):b[c]=d}return b};g.prototype.get=function(b,a){return this.value(b,a)[0]};g.prototype.push=function(b,a,d){if(void 0!==b&&void 0!==a){var c;a=this.clean(a);a=a.split(".");c=a.shift();if(a.length)b[c]=b[c]||{},this.set(b[c],a.join("."),d);else if(b[c]=b[c]||[],b[c]instanceof Array)b[c].push(d);else throw"ForerunnerDB.Path: Cannot push to a path whose endpoint is not an array!";
}return b};g.prototype.keyValue=function(b,a){var d,c,g,l,e;void 0!==a&&(a=this.clean(a),d=a.split("."));d=d||this._pathParts;c=d.length;g=b;for(e=0;e<c;e++)if(g=g[d[e]],!g||"object"!==typeof g){l=d[e]+":"+g;break}return l};g.prototype.clean=function(b){"."===b.substr(0,1)&&(b=b.substr(1,b.length-1));return b};d.finishModule("Path");l.exports=g},{"./Shared":23}],22:[function(d,l,g){d=d("./Shared");g=function(b,a,d){if(b&&a&&d){this._reactorIn=b;this._reactorOut=a;this._chainHandler=d;if(!b.chain||
!a.chainReceive)throw"ForerunnerDB.ReactorIO: ReactorIO requires passed in and out objects to implement the ChainReactor mixin!";b.chain(this);this.chain(a)}else throw"ForerunnerDB.ReactorIO: ReactorIO requires an in, out and process argument to instantiate!";};d.addModule("ReactorIO",g);g.prototype.drop=function(){"dropped"!==this._state&&(this._state="dropped",this._reactorIn&&this._reactorIn.unChain(this),this._reactorOut&&this.unChain(this._reactorOut),delete this._reactorIn,delete this._reactorOut,
delete this._chainHandler,this.emit("drop",this));return!0};d.synthesize(g.prototype,"state");d.mixin(g.prototype,"Mixin.ChainReactor");d.mixin(g.prototype,"Mixin.Events");d.finishModule("ReactorIO");l.exports=g},{"./Shared":23}],23:[function(d,l,g){d={version:"1.3.4",modules:{},_synth:{},addModule:function(b,a){this.modules[b]=a;this.emit("moduleLoad",[b,a])},finishModule:function(b){if(this.modules[b])this.modules[b]._fdbFinished=!0,this.emit("moduleFinished",[b,this.modules[b]]);else throw"ForerunnerDB.Shared: finishModule called on a module that has not been registered with addModule(): "+
b;},moduleFinished:function(b,a){if(this.modules[b]&&this.modules[b]._fdbFinished)a(b,this.modules[b]);else this.on("moduleFinished",a)},moduleExists:function(b){return Boolean(this.modules[b])},mixin:function(b,a){var d=this.mixins[a];if(d)for(var c in d)d.hasOwnProperty(c)&&(b[c]=d[c]);else throw"ForerunnerDB.Shared: Cannot find mixin named: "+a;},synthesize:function(b,a,d){this._synth[a]=this._synth[a]||function(b){return void 0!==b?(this["_"+a]=b,this):this["_"+a]};if(d){var c=this;b[a]=function(){var b=
this.$super,g;this.$super=c._synth[a];g=d.apply(this,arguments);this.$super=b;return g}}else b[a]=this._synth[a]},overload:d("./Overload"),mixins:{"Mixin.Common":d("./Mixin.Common"),"Mixin.Events":d("./Mixin.Events"),"Mixin.ChainReactor":d("./Mixin.ChainReactor"),"Mixin.CRUD":d("./Mixin.CRUD"),"Mixin.Constants":d("./Mixin.Constants"),"Mixin.Triggers":d("./Mixin.Triggers"),"Mixin.Sorting":d("./Mixin.Sorting"),"Mixin.Matching":d("./Mixin.Matching")}};d.mixin(d,"Mixin.Events");l.exports=d},{"./Mixin.CRUD":11,
"./Mixin.ChainReactor":12,"./Mixin.Common":13,"./Mixin.Constants":14,"./Mixin.Events":15,"./Mixin.Matching":16,"./Mixin.Sorting":17,"./Mixin.Triggers":18,"./Overload":20}],24:[function(d,l,g){var b,a,k,c,m,p;g=d("./Shared");var e=function(a,b,c){this.init.apply(this,arguments)};e.prototype.init=function(a,c,d){var e=this;this._name=a;this._groups=[];this._listeners={};this._querySettings={};this._debug={};this.query(c,!1);this.queryOptions(d,!1);this._collectionDroppedWrap=function(){e._collectionDropped.apply(e,
arguments)};this._privateData=new b("__FDB__view_privateData_"+this._name)};g.addModule("View",e);g.mixin(e.prototype,"Mixin.Common");g.mixin(e.prototype,"Mixin.ChainReactor");g.mixin(e.prototype,"Mixin.Constants");g.mixin(e.prototype,"Mixin.Triggers");b=d("./Collection");a=d("./CollectionGroup");p=d("./ActiveBucket");m=d("./ReactorIO");k=b.prototype.init;d=g.modules.Core;c=d.prototype.init;g.synthesize(e.prototype,"state");g.synthesize(e.prototype,"name");e.prototype.insert=function(){this._from.insert.apply(this._from,
arguments)};e.prototype.update=function(){this._from.update.apply(this._from,arguments)};e.prototype.updateById=function(){this._from.updateById.apply(this._from,arguments)};e.prototype.remove=function(){this._from.remove.apply(this._from,arguments)};e.prototype.find=function(a,b){return this.publicData().find(a,b)};e.prototype.data=function(){return this._privateData};e.prototype.from=function(a){var b=this;if(void 0!==a){this._from&&(this._from.off("drop",this._collectionDroppedWrap),this._from._removeView(this));
"string"===typeof a&&(a=this._db.collection(a));this._from=a;this._io=new m(a,this,function(a){var c,d,f;if(b._querySettings.query){if("insert"===a.type){c=a.data;if(c instanceof Array)for(d=[],a=0;a<c.length;a++)b._privateData._match(c[a],b._querySettings.query,"and")&&(d.push(c[a]),f=!0);else b._privateData._match(c,b._querySettings.query,"and")&&(d=c,f=!0);f&&this.chainSend("insert",d);return!0}if("update"===a.type&&(d=b._privateData.diff(b._from.subset(b._querySettings.query,b._querySettings.options)),
d.insert.length||d.remove.length)){d.insert.length&&this.chainSend("insert",d.insert);if(d.update.length)for(f=b._privateData.primaryKey(),a=0;a<d.update.length;a++)c={},c[f]=d.update[a][f],this.chainSend("update",{query:c,update:d.update[a]});if(d.remove.length){f=b._privateData.primaryKey();c=[];var e={query:{$or:c}};for(a=0;a<d.remove.length;a++)c.push({_id:d.remove[a][f]});this.chainSend("remove",e)}return!0}}return!1});var c=a.find(this._querySettings.query,this._querySettings.options);this._transformPrimaryKey(a.primaryKey());
this._transformSetData(c);this._privateData.primaryKey(a.primaryKey());this._privateData.setData(c);this._querySettings.options&&this._querySettings.options.$orderBy?this.rebuildActiveBucket(this._querySettings.options.$orderBy):this.rebuildActiveBucket()}return this};e.prototype._collectionDropped=function(a){a&&delete this._from};e.prototype.ensureIndex=function(){return this._privateData.ensureIndex.apply(this._privateData,arguments)};e.prototype._chainHandler=function(a){var b,c,d,e;switch(a.type){case "setData":this.debug()&&
console.log('ForerunnerDB.View: Setting data on view "'+this.name()+'" in underlying (internal) view collection "'+this._privateData.name()+'"');a=this._from.find(this._querySettings.query,this._querySettings.options);this._transformSetData(a);this._privateData.setData(a);break;case "insert":this.debug()&&console.log('ForerunnerDB.View: Inserting some data on view "'+this.name()+'" in underlying (internal) view collection "'+this._privateData.name()+'"');a.data=this.decouple(a.data);a.data instanceof
Array||(a.data=[a.data]);if(this._querySettings.options&&this._querySettings.options.$orderBy)for(b=a.data,c=b.length,d=0;d<c;d++)e=this._activeBucket.insert(b[d]),this._transformInsert(a.data,e),this._privateData._insertHandle(a.data,e);else e=this._privateData._data.length,this._transformInsert(a.data,e),this._privateData._insertHandle(a.data,e);break;case "update":this.debug()&&console.log('ForerunnerDB.View: Updating some data on view "'+this.name()+'" in underlying (internal) view collection "'+
this._privateData.name()+'"');this._privateData.primaryKey();a=this._privateData.update(a.data.query,a.data.update,a.data.options);if(this._querySettings.options&&this._querySettings.options.$orderBy)for(c=a.length,d=0;d<c;d++)e=a[d],this._activeBucket.remove(e),b=this._privateData._data.indexOf(e),e=this._activeBucket.insert(e),b!==e&&this._privateData._updateSpliceMove(this._privateData._data,b,e);if(this._transformEnabled&&this._transformIn)for(c=this._publicData.primaryKey(),b=0;b<a.length;b++)d=
{},e=a[b],d[c]=e[c],this._transformUpdate(d,e);break;case "remove":this.debug()&&console.log('ForerunnerDB.View: Removing some data on view "'+this.name()+'" in underlying (internal) view collection "'+this._privateData.name()+'"'),this._transformRemove(a.data.query,a.options),this._privateData.remove(a.data.query,a.options)}};e.prototype.on=function(){this._privateData.on.apply(this._privateData,arguments)};e.prototype.off=function(){this._privateData.off.apply(this._privateData,arguments)};e.prototype.emit=
function(){this._privateData.emit.apply(this._privateData,arguments)};e.prototype.drop=function(){if("dropped"!==this._state){if(this._from)return this._from.off("drop",this._collectionDroppedWrap),this._from._removeView(this),(this.debug()||this._db&&this._db.debug())&&console.log("ForerunnerDB.View: Dropping view "+this._name),this._state="dropped",this._io&&this._io.drop(),this._privateData&&this._privateData.drop(),this._db&&this._name&&delete this._db._view[this._name],this.emit("drop",this),
delete this._chain,delete this._from,delete this._privateData,delete this._io,delete this._groups,delete this._listeners,delete this._querySettings,delete this._db,!0}else return!0;return!1};e.prototype.db=function(a){return void 0!==a?(this._db=a,this.privateData().db(a),this.publicData().db(a),this):this._db};e.prototype.primaryKey=function(){return this._privateData.primaryKey()};e.prototype.queryData=function(a,b,c){void 0!==a&&(this._querySettings.query=a);void 0!==b&&(this._querySettings.options=
b);return void 0!==a||void 0!==b?(void 0!==c&&!0!==c||this.refresh(),this):this._querySettings};e.prototype.queryAdd=function(a,b,c){var d=this._querySettings.query,e;if(void 0!==a)for(e in a)a.hasOwnProperty(e)&&(void 0===d[e]||void 0!==d[e]&&b)&&(d[e]=a[e]);void 0!==c&&!0!==c||this.refresh()};e.prototype.queryRemove=function(a,b){var c=this._querySettings.query,d;if(void 0!==a)for(d in a)a.hasOwnProperty(d)&&delete c[d];void 0!==b&&!0!==b||this.refresh()};e.prototype.query=function(a,b){return void 0!==
a?(this._querySettings.query=a,void 0!==b&&!0!==b||this.refresh(),this):this._querySettings.query};e.prototype.orderBy=function(a){if(void 0!==a){var b=this.queryOptions()||{};b.$orderBy=a;this.queryOptions(b);return this}return(this.queryOptions()||{}).$orderBy};e.prototype.queryOptions=function(a,b){return void 0!==a?(this._querySettings.options=a,void 0===a.$decouple&&(a.$decouple=!0),void 0===b||!0===b?this.refresh():this.rebuildActiveBucket(a.$orderBy),this):this._querySettings.options};e.prototype.rebuildActiveBucket=
function(a){if(a){var b=this._privateData._data,c=b.length;this._activeBucket=new p(a);this._activeBucket.primaryKey(this._privateData.primaryKey());for(a=0;a<c;a++)this._activeBucket.insert(b[a])}else delete this._activeBucket};e.prototype.refresh=function(){if(this._from){var a=this.publicData();this._privateData.remove();a.remove();this._privateData.insert(this._from.find(this._querySettings.query,this._querySettings.options))}this._querySettings.options&&this._querySettings.options.$orderBy?this.rebuildActiveBucket(this._querySettings.options.$orderBy):
this.rebuildActiveBucket();return this};e.prototype.count=function(){return this._privateData&&this._privateData._data?this._privateData._data.length:0};e.prototype.transform=function(a){return void 0!==a?("object"===typeof a?(void 0!==a.enabled&&(this._transformEnabled=a.enabled),void 0!==a.dataIn&&(this._transformIn=a.dataIn),void 0!==a.dataOut&&(this._transformOut=a.dataOut)):this._transformEnabled=!1===a?!1:!0,this._transformPrimaryKey(this.privateData().primaryKey()),this._transformSetData(this.privateData().find()),
this):{enabled:this._transformEnabled,dataIn:this._transformIn,dataOut:this._transformOut}};e.prototype.privateData=function(){return this._privateData};e.prototype.publicData=function(){return this._transformEnabled?this._publicData:this._privateData};e.prototype._transformSetData=function(a){this._transformEnabled&&(this._publicData=new b("__FDB__view_publicData_"+this._name),this._publicData.db(this._privateData._db),this._publicData.transform({enabled:!0,dataIn:this._transformIn,dataOut:this._transformOut}),
this._publicData.setData(a))};e.prototype._transformInsert=function(a,b){this._transformEnabled&&this._publicData&&this._publicData.insert(a,b)};e.prototype._transformUpdate=function(a,b,c){this._transformEnabled&&this._publicData&&this._publicData.update(a,b,c)};e.prototype._transformRemove=function(a,b){this._transformEnabled&&this._publicData&&this._publicData.remove(a,b)};e.prototype._transformPrimaryKey=function(a){this._transformEnabled&&this._publicData&&this._publicData.primaryKey(a)};b.prototype.init=
function(){this._view=[];k.apply(this,arguments)};b.prototype.view=function(a,b,c){if(this._db&&this._db._view){if(this._db._view[a])throw'ForerunnerDB.Collection "'+this.name()+'": Cannot create a view using this collection because a view with this name already exists: '+a;a=(new e(a,b,c)).db(this._db).from(this);this._view=this._view||[];this._view.push(a);return a}};b.prototype._addView=a.prototype._addView=function(a){void 0!==a&&this._view.push(a);return this};b.prototype._removeView=a.prototype._removeView=
function(a){void 0!==a&&(a=this._view.indexOf(a),-1<a&&this._view.splice(a,1));return this};d.prototype.init=function(){this._view={};c.apply(this,arguments)};d.prototype.view=function(a){this._view[a]||(this.debug()||this._db&&this._db.debug())&&console.log("Core.View: Creating view "+a);this._view[a]=this._view[a]||(new e(a)).db(this);return this._view[a]};d.prototype.viewExists=function(a){return Boolean(this._view[a])};d.prototype.views=function(){var a=[],b;for(b in this._view)this._view.hasOwnProperty(b)&&
a.push({name:b,count:this._view[b].count()});return a};g.finishModule("View");l.exports=e},{"./ActiveBucket":2,"./Collection":3,"./CollectionGroup":4,"./ReactorIO":22,"./Shared":23}],25:[function(d,l,g){d=function(){function b(a){for(var b=[],d=0;d<arguments.length;d++)b=b.concat(arguments[d]);return b}var a={strcmp:function(a,b){for(var d,g,e=0;e<a.length;e++){if(e>=b.length)return 1;if((d=a.charCodeAt(e))<(g=b.charCodeAt(e)))return-1;if(d>g)return 1}return a.length==b.length?0:-1},numcmp:function(a,
b){return a<b?-1:a>b?1:0},create:function(d,c){function g(){this.root=new e(this)}d="undefined"==typeof d?52:"number"==typeof d?Math.floor(d):parseInt(d,10);1>d&&(d=1);var l=1<d?Math.floor(d/2):1;"function"!=typeof c&&(c=a.numcmp);var e=function(a,b,c){this.parent=a;this.leaves=b||[];this.leaves.forEach(function(a){a.parent=this},this);this.nodes=c||[null];this.nodes.forEach(function(a){null!==a&&(a.parent=this)},this)};e.prototype.search=function(a){if(0<this.leaves.length){var b=this.leaves[0];
if(0==c(b.key,a))return{leaf:b,index:0};if(0>c(a,b.key))return null!==this.nodes[0]?this.nodes[0].search(a):{node:this,index:0};for(b=1;b<this.leaves.length;b++){var d=this.leaves[b];if(0==c(d.key,a))return{leaf:d,index:b};if(0>c(a,d.key))break}return null!==this.nodes[b]?this.nodes[b].search(a):{node:this,index:b}}return{node:this,index:0}};e.prototype.get=function(a){a=this.search(a);if(a.leaf)return a.leaf.value};e.prototype.put=function(a,b,c){var e=this.search(a);if(e.leaf){if("undefined"!==
typeof c&&!c)return!1;e.leaf.value=b;return!0}c=e.node;e=e.index;c.leaves.splice(e,0,new f(c,a,b));c.nodes.splice(e+1,0,null);c.leaves.length>d&&c.split();return!0};e.prototype.del=function(a){var b=this.search(a);if(!b.leaf)return!1;a=b.leaf.parent;var b=b.index,c=a.nodes[b];if(null===c)a.leaves.splice(b,1),a.nodes.splice(b,1),a.balance();else{var d=c.leaves[c.leaves.length-1];c.del(d.key);d.parent=a;a.leaves.splice(b,1,d)}return!0};e.prototype.balance=function(){if(this.parent instanceof g)0==this.leaves.length&&
null!==this.nodes[0]&&(this.parent.root=this.nodes[0],this.parent.root.parent=this.parent);else if(!(this.leaves.length>=l)){var a=this.parent.nodes.indexOf(this),c=0<a?this.parent.nodes[a-1]:null,d=this.parent.nodes.length>a+1?this.parent.nodes[a+1]:null,f;if(null!==d&&d.leaves.length>l)f=this.parent.leaves[a],f.parent=this,this.leaves.push(f),f=d.leaves.shift(),f.parent=this.parent,this.parent.leaves[a]=f,a=d.nodes.shift(),null!==a&&(a.parent=this),this.nodes.push(a);else if(null!==c&&c.leaves.length>
l)f=this.parent.leaves[a-1],f.parent=this,this.leaves.unshift(f),f=c.leaves.pop(),f.parent=this.parent,this.parent.leaves[a-1]=f,a=c.nodes.pop(),null!==a&&(a.parent=this),this.nodes.unshift(a);else{if(null!==d)f=this.parent.leaves[a],c=new e(this.parent,b(this.leaves,[f],d.leaves),b(this.nodes,d.nodes)),this.parent.leaves.splice(a,1),this.parent.nodes.splice(a,2,c);else if(null!==c)f=this.parent.leaves[a-1],c=new e(this.parent,b(c.leaves,[f],this.leaves),b(c.nodes,this.nodes)),this.parent.leaves.splice(a-
1,1),this.parent.nodes.splice(a-1,2,c);else throw Error("Internal error: "+this.toString(!0)+" has neither a left nor a right sibling");this.parent.balance()}}};e.prototype.unsplit=function(a,b){a.parent=this;b.parent=this;if(0>c(a.key,this.leaves[0].key))this.leaves.unshift(a),this.nodes.splice(1,0,b);else{for(var e=1;e<this.leaves.length;e++)if(0>c(a.key,this.leaves[e].key)){this.leaves.splice(e,0,a);this.nodes.splice(e+1,0,b);break}e==this.leaves.length&&(this.leaves.push(a),this.nodes.push(b))}this.leaves.length>
d&&this.split()};e.prototype.split=function(){var a=Math.floor(this.leaves.length/2);if(this.parent instanceof g)this.nodes=[new e(this,this.leaves.slice(0,a),this.nodes.slice(0,a+1)),new e(this,this.leaves.slice(a+1),this.nodes.slice(a+1))],this.leaves=[this.leaves[a]];else{var b=this.leaves[a],c=new e(this.parent,this.leaves.slice(a+1),this.nodes.slice(a+1));this.leaves=this.leaves.slice(0,a);this.nodes=this.nodes.slice(0,a+1);this.parent.unsplit(b,c)}};e.prototype.toString=function(a){for(var b=
[],c=0;c<this.leaves.length;c++)b.push(this.leaves[c].key);b="["+b.toString()+"]"+(this.parent instanceof g?":*":":"+this.parent);if(a)for(c=0;c<this.nodes.length;c++)b+=" -> "+this.nodes[c];return b};e.prototype.print=function(a){for(var b="",c=0;c<a;c++)b+=" ";for(c=this.leaves.length-1;0<=c;c--)null!==this.nodes[c+1]&&this.nodes[c+1].print(a+2),console.log(b+this.leaves[c].key+(this.parent instanceof g?"*":""));null!==this.nodes[0]&&this.nodes[0].print(a+2)};var f=function(a,b,c){this.parent=a;
this.key=b;this.value=c};f.prototype.toString=function(){return""+this.key};g.prototype.put=function(a,b,c){if("undefined"===typeof a||null===a)throw Error("Illegal key: "+a);if("undefined"===typeof b)throw Error("Illegal value: "+b);return this.root.put(a,b,c)};g.prototype.get=function(a){if("undefined"===typeof a||null===a)throw Error("Illegal key: "+a);return this.root.get(a)};g.prototype.del=function(a){if("undefined"===typeof a||null===a)throw Error("Illegal key: "+a);return this.root.del(a)};
g.prototype.walkAsc=function(a,b,d){if(0!=this.root.leaves.length){"function"==typeof a?(d=a,a=b=null):"function"==typeof b&&(d=b,b=null);a="undefined"!=typeof a?a:null;b="undefined"!=typeof b?b:null;var e;if(null===a){for(a=this.root;null!==a.nodes[0];)a=a.nodes[0];e=0}else if(e=this.root.search(a),e.leaf)a=e.leaf.parent,e=a.leaves.indexOf(e.leaf);else if(a=e.node,e=e.index,e>=a.leaves.length){if(a.parent instanceof g)return;e=a.parent.nodes.indexOf(a);if(e>=a.parent.leaves.length)return;a=a.parent}for(;!(null!==
b&&0<c(a.leaves[e].key,b)||d(a.leaves[e].key,a.leaves[e].value));)if(null!==a.nodes[e+1])for(a=a.nodes[e+1],e=0;null!==a.nodes[0];)a=a.nodes[0];else if(a.leaves.length>e+1)e++;else{do{if(a.parent instanceof g)return;e=a.parent.nodes.indexOf(a);a=a.parent}while(e>=a.leaves.length)}}};g.prototype.walk=g.prototype.walkAsc;g.prototype.walkDesc=function(a,b,d){"function"==typeof a?(d=a,a=b=null):"function"==typeof b&&(d=b,b=null);a="undefined"!=typeof a?a:null;b="undefined"!=typeof b?b:null;var e;if(null===
b){for(b=this.root;null!==b.nodes[b.nodes.length-1];)b=b.nodes[b.nodes.length-1];e=b.leaves.length-1}else if(e=this.root.search(b),e.leaf)b=e.leaf.parent,e=b.leaves.indexOf(e.leaf);else for(b=e.node,e=e.index-1;0>e;){if(b.parent instanceof g)return;e=b.parent.nodes.indexOf(b)-1;if(0>e)return;b=b.parent}for(;!(null!==a&&0>c(b.leaves[e].key,a)||d(b.leaves[e].key,b.leaves[e].value));)if(null!==b.nodes[e]){for(b=b.nodes[e];null!==b.nodes[b.nodes.length-1];)b=b.nodes[b.nodes.length-1];e=b.leaves.length-
1}else if(0<e)e--;else{do{if(b.parent instanceof g)return;e=b.parent.nodes.indexOf(b)-1;b=b.parent}while(0>e)}};g.prototype.count=function(a,b){var c=0;this.walk("undefined"!=typeof a?a:null,"undefined"!=typeof b?b:null,function(a,b){c++});return c};g.prototype.print=function(){this.root.print(0)};g.prototype.toString=function(){return"Tree("+d+") "+this.root.toString()};return g}};return a}();l.exports=d},{}]},{},[1])(1)});
