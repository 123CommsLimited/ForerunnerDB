!function(w){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=w();else if("function"==typeof define&&define.amd)define([],w);else{var k;"undefined"!=typeof window?k=window:"undefined"!=typeof global?k=global:"undefined"!=typeof self&&(k=self);k.ForerunnerDB=w()}}(function(){return function k(p,l,c){function a(d,q){if(!l[d]){if(!p[d]){var f="function"==typeof require&&require;if(!q&&f)return f(d,!0);if(g)return g(d,!0);f=Error("Cannot find module '"+d+"'");throw f.code="MODULE_NOT_FOUND",
f;}f=l[d]={exports:{}};p[d][0].call(f.exports,function(b){var e=p[d][1][b];return a(e?e:b)},f,f.exports,k,p,l,c)}return l[d].exports}for(var g="function"==typeof require&&require,d=0;d<c.length;d++)a(c[d]);return a}({1:[function(k,p,l){k=k("../lib/Core");p.exports=k},{"../lib/Core":3}],2:[function(k,p,l){var c,a,g,d,h,q;c=k("./Shared");var f=function(b){this.init.apply(this,arguments)};f.prototype.init=function(b){this._primaryKey="_id";this._primaryIndex=new g("primary");this._primaryCrc=new g("primaryCrc");
this._crcLookup=new g("crcLookup");this._name=b;this._data=[];this._groups=[];this._metrics=new a;this._linked=0;this._debug={};this._deferQueue={insert:[],update:[],remove:[],upsert:[]};this._deferThreshold={insert:100,update:100,remove:100,upsert:100};this._deferTime={insert:1,update:1,remove:1,upsert:1};this._subsetOf(this)};c.modules.Collection=f;l=k("./Overload");a=k("./Metrics");g=k("./KeyValueStore");d=k("./Path");h=k("./Index");q=k("./Crc");k=c.modules.Core;f.prototype.debug=new l([function(){return this._debug.all},
function(b){if(void 0!==b){if("boolean"===typeof b){this._debug.all=b;for(var e=0;e<this._views.length;e++)this._views[e].debug(b);return this}return this._debug[b]||this._db&&this._db._debug&&this._db._debug[b]||this._debug.all}return this._debug.all},function(b,e){if(void 0!==b){if(void 0!==e){this._debug[b]=e;for(var n=0;n<this._views.length;n++)this._views[n].debug(b,e);return this}return this._debug[b]||this._db&&this._db._debug&&this._db._debug[b]}return this._debug.all}]);f.prototype.crc=q;
f.prototype.name=function(b){return void 0!==b?(this._name=b,this):this._name};f.prototype.on=new l([function(b,e){this._listeners=this._listeners||{};this._listeners[b]=this._listeners[b]||{};this._listeners[b]["*"]=this._listeners[b]["*"]||[];this._listeners[b]["*"].push(e);return this},function(b,e,n){this._listeners=this._listeners||{};this._listeners[b]=this._listeners[b]||{};this._listeners[b][e]=this._listeners[b][e]||[];this._listeners[b][e].push(n);return this}]);f.prototype.off=new l([function(b){this._listeners&&
this._listeners[b]&&b in this._listeners&&delete this._listeners[b];return this},function(b,e){var n,a;"string"===typeof e?this._listeners&&this._listeners[b]&&this._listeners[b][e]&&delete this._listeners[b][e]:b in this._listeners&&(n=this._listeners[b]["*"],a=n.indexOf(e),-1<a&&n.splice(a,1));return this},function(b,e,n){this._listeners&&b in this._listeners&&(b=this._listeners[b][e],n=b.indexOf(n),-1<n&&b.splice(n,1))}]);f.prototype.emit=function(b,e){this._listeners=this._listeners||{};if(b in
this._listeners){if(this._listeners[b]["*"]){var n=this._listeners[b]["*"],a=n.length,r;for(r=0;r<a;r++)n[r].apply(this,Array.prototype.slice.call(arguments,1))}if(e instanceof Array&&e[0]&&e[0][this._primaryKey]){var n=this._listeners[b],d,g,a=e.length;for(r=0;r<a;r++)if(n[e[r][this._primaryKey]])for(d=n[e[r][this._primaryKey]].length,g=0;g<d;g++)n[e[r][this._primaryKey]][g].apply(this,Array.prototype.slice.call(arguments,1))}}return this};f.prototype.drop=function(){if(this._db&&this._name){this.debug()&&
console.log("Dropping collection "+this._name);this.emit("drop");delete this._db._collection[this._name];var b=[],e;for(e=0;e<this._groups.length;e++)b.push(this._groups[e]);for(e=0;e<b.length;e++)this._groups[e].removeCollection(this);return!0}return!1};f.prototype.primaryKey=function(b){return void 0!==b?(this._primaryKey=b,this._primaryIndex.primaryKey(b),this._rebuildPrimaryKeyIndex(),this):this._primaryKey};f.prototype._onInsert=function(b,e){this.emit("insert",b,e)};f.prototype._onUpdate=function(b){this.emit("update",
b)};f.prototype._onRemove=function(b){this.emit("remove",b)};f.prototype.db=function(b){return void 0!==b?(this._db=b,this):this._db};f.prototype.setData=function(b,e,n){if(b){var a=this._metrics.create("setData");a.start();b instanceof Array||(b=[b]);a.time("transformIn");b=this.transformIn(b);a.time("transformIn");var r=this._data;this._data=[];b.length&&(this._data=this._data.concat(b));a.time("_rebuildPrimaryKeyIndex");this._rebuildPrimaryKeyIndex(e);a.time("_rebuildPrimaryKeyIndex");a.stop();
this.emit("setData",this._data,r)}n&&n(!1);return this};f.prototype._rebuildPrimaryKeyIndex=function(b){var e=b&&void 0!==b.ensureKeys?b.ensureKeys:!0;b=b&&void 0!==b.violationCheck?b.violationCheck:!0;var n,a,r,d=this._primaryIndex,g=this._primaryCrc,f=this._crcLookup,c=this._primaryKey,h;d.truncate();g.truncate();f.truncate();n=this._data;for(a=n.length;a--;)if(r=n[a],e&&this._ensurePrimaryKey(r),b){if(!d.uniqueSet(r[c],r))throw"Call to setData failed because your data violates the primary key unique constraint. One or more documents are using the same primary key: "+
r[this._primaryKey];}else h=JSON.stringify(r),d.set(r[c],r),g.set(r[c],h),f.set(h,r)};f.prototype._ensurePrimaryKey=function(b){void 0===b[this._primaryKey]&&(b[this._primaryKey]=this.objectId())};f.prototype.truncate=function(){this.emit("truncate",this._data);this._data.length=0;this.deferEmit("change");return this};f.prototype.upsert=function(b,e){if(b){var n=this._deferQueue.upsert,a=this._deferThreshold.upsert,d={},g;if(b instanceof Array){if(b.length>a){this._deferQueue.upsert=n.concat(b);this.processQueue("upsert",
e);return}d=[];for(n=0;n<b.length;n++)d.push(this.upsert(b[n]));e&&e();return d}b[this._primaryKey]?(g={},g[this._primaryKey]=b[this._primaryKey],this.count(g)?d.op="update":d.op="insert"):d.op="insert";switch(d.op){case "insert":d.result=this.insert(b);break;case "update":d.result=this.update(g,b)}return d}e&&e()};f.prototype.update=function(b,e,n){e=this.decouple(e);e=this.transformIn(e);this.debug()&&console.log('Updating some collection data for collection "'+this.name()+'"');var a=this,d=this._metrics.create("update"),
g=this._primaryKey,f,c,h=function(d){if(e&&void 0!==e[g]&&e[g]!=d[g]){a._primaryIndex.unSet(d[g]);var r=a._updateObject(d,e,b,n,"");if(a._primaryIndex.uniqueSet(d[g],d))return r;throw"Primary key violation in update! Key violated: "+d[g];}return a._updateObject(d,e,b,n,"")},k=this._views;d.start();d.time("Retrieve documents to update");f=this.find(b,{decouple:!1});d.time("Retrieve documents to update");if(f.length&&(d.time("Update documents"),c=f.filter(h),d.time("Update documents"),c.length)){if(k&&
k.length){this.debug("views")&&console.log("Updating views from collection: "+this.name());d.time("Inform views of update");for(f=0;f<k.length;f++)k[f].update(b,e);d.time("Inform views of update")}this._onUpdate(c);this.deferEmit("change",{type:"update",data:c})}d.stop();return c||[]};f.prototype.updateById=function(b,e){var n={};n[this._primaryKey]=b;return this.update(n,e)};f.prototype._updateObject=function(b,e,n,a,g,f){e=this.decouple(e);g=g||"";"."===g.substr(0,1)&&(g=g.substr(1,g.length-1));
var c=!1,h=!1,k,q,l,m;for(m in e)if(e.hasOwnProperty(m)){k=!1;if("$"===m.substr(0,1))switch(m){case "$index":break;default:k=!0,(h=this._updateObject(b,e[m],n,a,g,m))&&(c=!0)}if(this._isPositionalKey(m)&&(k=!0,m=m.substr(0,m.length-2),h=new d(g+"."+m),b[m]&&b[m]instanceof Array&&b[m].length)){q=[];for(l=0;l<b[m].length;l++)this._match(b[m][l],h.value(n)[0])&&q.push(l);for(l=0;l<q.length;l++)(h=this._updateObject(b[m][q[l]],e[m+".$"],n,a,g+"."+m,f))&&(c=!0)}if(!k)if(f||"object"!==typeof e[m])switch(f){case "$inc":this._updateIncrement(b,
m,e[m]);c=!0;break;case "$push":void 0===b[m]&&(b[m]=[]);if(b[m]instanceof Array)this._updatePush(b[m],e[m]),c=!0;else throw"Cannot push to a key that is not an array! ("+m+")!";break;case "$pull":if(b[m]instanceof Array){q=[];for(l=0;l<b[m].length;l++)this._match(b[m][l],e[m])&&q.push(l);for(l=q.length;l--;)this._updatePull(b[m],q[l]),c=!0}else throw"Cannot pull from a key that is not an array! ("+m+")!";break;case "$addToSet":void 0===b[m]&&(b[m]=[]);if(b[m]instanceof Array){q=b[m];var p;l=q.length;
var t;k=!0;p=a&&a.$addToSet;var s;p&&p.key?(h=!1,s=new d(p.key),t=s.value(e[m])[0]):(t=JSON.stringify(e[m]),h=!0);for(p=0;p<l;p++)if(h){if(JSON.stringify(q[p])===t){k=!1;break}}else if(t===s.value(q[p])[0]){k=!1;break}k&&(this._updatePush(b[m],e[m]),c=!0)}else throw"Cannot push to a key that is not an array! (undefined)!";break;case "$splicePush":void 0===b[m]&&(b[m]=[]);if(b[m]instanceof Array)if(c=e.$index,void 0!==c)delete e.$index,this._updateSplicePush(b[m],c,e[m]),c=!0;else throw"Cannot splicePush without a $index integer value!";
else throw"Cannot splicePush with a key that is not an array! ("+m+")!";break;case "$move":if(b[m]instanceof Array)for(l=0;l<b[m].length;l++){if(this._match(b[m][l],e[m])){c=e[m].$index;if(void 0!==c)this._updateSpliceMove(b[m],l,c),c=!0;else throw"Cannot move without a $index integer value!";break}}else throw"Cannot pull from a key that is not an array! ("+m+")!";break;case "$mul":this._updateMultiply(b,m,e[m]);c=!0;break;default:b[m]!==e[m]&&(this._updateProperty(b,m,e[m]),c=!0)}else if(null!==
b[m]&&"object"===typeof b[m])if(q=b[m]instanceof Array,l=e[m]instanceof Array,q||l)if(!l&&q)for(l=0;l<b[m].length;l++)(h=this._updateObject(b[m][l],e[m],n,a,g+"."+m,f))&&(c=!0);else b[m]!==e[m]&&(this._updateProperty(b,m,e[m]),c=!0);else(h=this._updateObject(b[m],e[m],n,a,g+"."+m,f))&&(c=!0);else b[m]!==e[m]&&(this._updateProperty(b,m,e[m]),c=!0)}return c};f.prototype._isPositionalKey=function(b){return".$"===b.substr(b.length-2,2)};f.prototype._updateProperty=function(b,e,n){this._linked?($.observable(b).setProperty(e,
n),this.debug()&&console.log('ForerunnerDB.Collection: Setting data-bound document property "'+e+'" for collection "'+this.name()+'"')):(b[e]=n,this.debug()&&console.log('ForerunnerDB.Collection: Setting non-data-bound document property "'+e+'" for collection "'+this.name()+'"'))};f.prototype._updateIncrement=function(b,e,n){this._linked?$.observable(b).setProperty(e,b[e]+n):b[e]+=n};f.prototype._updateSpliceMove=function(b,e,n){this._linked?($.observable(b).move(e,n),this.debug()&&console.log('ForerunnerDB.Collection: Moving data-bound document array index from "'+
e+'" to "'+n+'" for collection "'+this.name()+'"')):(b.splice(n,0,b.splice(e,1)[0]),this.debug()&&console.log('ForerunnerDB.Collection: Moving non-data-bound document array index from "'+e+'" to "'+n+'" for collection "'+this.name()+'"'))};f.prototype._updateSplicePush=function(b,e,n){b.length>e?this._linked?$.observable(b).insert(e,n):b.splice(e,0,n):this._linked?$.observable(b).insert(n):b.push(n)};f.prototype._updatePush=function(b,e){this._linked?$.observable(b).insert(e):b.push(e)};f.prototype._updatePull=
function(b,e){this._linked?$.observable(b).remove(e):b.splice(e,1)};f.prototype._updateMultiply=function(b,e,n){this._linked?$.observable(b).setProperty(e,b[e]*n):b[e]*=n};f.prototype.remove=function(b){var e,n,a=this._views,d;if(b instanceof Array){a=[];for(e=0;e<b.length;e++)a.push(this.remove(b[e]));return a}e=this.find(b,{decouple:!1});if(e.length){for(d=0;d<e.length;d++)n=e[d],this._removeIndex(n),n=this._data.indexOf(n),this._linked?$.observable(this._data).remove(n):this._data.splice(n,1);
if(a&&a.length)for(d=0;d<a.length;d++)a[d].remove(b);this._onRemove(e);this.deferEmit("change",{type:"remove",data:e})}return e};f.prototype.removeById=function(b){var e={};e[this._primaryKey]=b;return this.remove(e)};f.prototype.deferEmit=function(){var b=this,e;this._noEmitDefer||this._db&&(!this._db||this._db._noEmitDefer)?this.emit.apply(this,arguments):(e=arguments,this._changeTimeout&&clearTimeout(this._changeTimeout),this._changeTimeout=setTimeout(function(){b.debug()&&console.log("ForerunnerDB.Collection: Emitting "+
e[0]);b.emit.apply(b,e)},100))};f.prototype.processQueue=function(b,e){var n=this._deferQueue[b],a=this._deferThreshold[b],d=this._deferTime[b];if(n.length){var g=this;n.length&&(n=n.length>a?n.splice(0,a):n.splice(0,n.length),this[b](n));setTimeout(function(){g.processQueue(b,e)},d)}else e&&e()};f.prototype.insert=function(b,e,n){"function"===typeof e?(n=e,e=this._data.length):void 0===e&&(e=this._data.length);b=this.transformIn(b);return this._insertHandle(b,e,n)};f.prototype._insertHandle=function(b,
e,n){var a=this._deferQueue.insert,d=this._deferThreshold.insert,g=[],c=[],f=this._views;if(b instanceof Array){if(b.length>d){this._deferQueue.insert=a.concat(b);this.processQueue("insert",n);return}for(d=0;d<b.length;d++)a=this._insert(b[d],e+d),!0===a?g.push(b[d]):c.push({doc:b[d],reason:a})}else a=this._insert(b,e),!0===a?g.push(b):c.push({doc:b,reason:a});if(f&&f.length)for(a=0;a<f.length;a++)f[a].insert(b,e);this._onInsert(g,c);n&&n();this.deferEmit("change",{type:"insert",data:g});return{inserted:g,
failed:c}};f.prototype._insert=function(b,e){if(b){var n;this._ensurePrimaryKey(b);if(n=this.insertIndexViolation(b))return"Index violation in index: "+n;this._insertIndex(b);this._linked?$.observable(this._data).insert(e,b):this._data.splice(e,0,b);return!0}return"No document passed to insert"};f.prototype._insertIndex=function(b){var e=this._indexByName,n,a=JSON.stringify(b);this._primaryIndex.uniqueSet(b[this._primaryKey],b);this._primaryCrc.uniqueSet(b[this._primaryKey],a);this._crcLookup.uniqueSet(a,
b);for(n in e)e.hasOwnProperty(n)&&e[n].insert(b)};f.prototype._removeIndex=function(b){var e=this._indexByName,a,d=JSON.stringify(b);this._primaryIndex.unSet(b[this._primaryKey]);this._primaryCrc.unSet(b[this._primaryKey]);this._crcLookup.unSet(d);for(a in e)e.hasOwnProperty(a)&&e[a].remove(b)};f.prototype.subset=function(b,e){var a=this.find(b,e);return(new f)._subsetOf(this).primaryKey(this._primaryKey).setData(a)};f.prototype.subsetOf=function(){return this.__subsetOf};f.prototype._subsetOf=function(b){this.__subsetOf=
b;return this};f.prototype.distinct=function(b,e,a){e=this.find(e,a);b=new d(b);a={};var g=[],c,f;for(f=0;f<e.length;f++)(c=b.value(e[f])[0])&&!a[c]&&(a[c]=!0,g.push(c));return g};f.prototype.decouple=function(b){return JSON.parse(JSON.stringify(b))};f.prototype.findById=function(b,e){var a={};a[this._primaryKey]=b;return this.find(a,e)[0]};f.prototype.peek=function(b,e){var a=this._data,d=a.length,g,c,h=new f;if("string"===typeof b){for(g=0;g<d;g++)c=JSON.stringify(a[g]),-1<c.indexOf(b)&&h.insert(a[g]);
return h.find({},e)}return this.find(b,e)};f.prototype.explain=function(b,e){return this.find(b,e).__fdbOp._data};f.prototype.find=function(b,e){b=b||{};e=e||{};e.decouple=void 0!==e.decouple?e.decouple:!0;var a=this._metrics.create("find"),g=this,c,f=!0,h,k,l,q,p,m,u,t,s,v=[];k=function(e){return g._match(e,b,"and")};a.start();if(b){a.time("analyseQuery");c=this._analyseQuery(b,e,a);a.time("analyseQuery");a.data("analysis",c);if(c.hasJoin&&c.queriesJoin){a.time("joinReferences");for(l=0;l<c.joinsOn.length;l++)p=
c.joinsOn[l],q=new d(c.joinQueries[p]),q=q.value(b)[0],this._db.collection(c.joinsOn[l]).subset(q);a.time("joinReferences")}c.indexMatch.length&&(!e||e&&!e.skipIndex)?(a.data("index.potential",c.indexMatch),a.data("index.used",c.indexMatch[0].index),a.time("indexLookup"),h=c.indexMatch[0].lookup,a.time("indexLookup"),c.indexMatch[0].keyData.totalKeyCount===c.indexMatch[0].keyData.matchedKeyCount&&(f=!1)):a.flag("usedIndex",!1);f&&(h&&h.length?(c=h.length,a.time("tableScan: "+c),h=h.filter(k)):(c=
this._data.length,a.time("tableScan: "+c),h=this._data.filter(k)),e.sort&&(a.time("sort"),h=this.sort(e.sort,h),a.time("sort")),a.time("tableScan: "+c));e.limit&&h&&h.length>e.limit&&(h.length=e.limit,a.data("limit",e.limit));e.decouple&&(a.time("decouple"),h=this.decouple(h),a.time("decouple"),a.data("flag.decouple",!0));if(e.join){for(k=0;k<e.join.length;k++)for(p in e.join[k])if(e.join[k].hasOwnProperty(p))for(t=p,c=this._db.collection(p),f=e.join[k][p],s=0;s<h.length;s++){u={};q=l=!1;for(m in f)if(f.hasOwnProperty(m))if("$"===
m.substr(0,1))switch(m){case "$as":t=f[m];break;case "$multi":l=f[m];break;case "$require":q=f[m];break;default:m.substr(0,3)}else u[m]=(new d(f[m])).value(h[s])[0];u=c.find(u);!q||q&&u[0]?h[s][t]=!1===l?u[0]:u:v.push(h[s])}a.data("flag.join",!0)}if(v.length){a.time("removalQueue");for(m=0;m<v.length;m++)p=h.indexOf(v[m]),-1<p&&h.splice(p,1);a.time("removalQueue")}if(e.transform){a.time("transform");for(m=0;m<h.length;m++)h.splice(m,1,e.transform(h[m]));a.time("transform");a.data("flag.transform",
!0)}this._transformEnabled&&this._transformOut&&(a.time("transformOut"),h=this.transformOut(h),a.time("transformOut"));a.data("results",h.length);a.stop()}else a.stop(),h=[];h.__fdbOp=a;return h};f.prototype.transform=function(b){return void 0!==b?("object"===typeof b?(void 0!==b.enabled&&(this._transformEnabled=b.enabled),void 0!==b.dataIn&&(this._transformIn=b.dataIn),void 0!==b.dataOut&&(this._transformOut=b.dataOut)):this._transformEnabled=!1===b?!1:!0,this):{enabled:this._transformEnabled,dataIn:this._transformIn,
dataOut:this._transformOut}};f.prototype.transformIn=function(b){if(this._transformEnabled&&this._transformIn){if(b instanceof Array){var e=[],a;for(a=0;a<b.length;a++)e[a]=this._transformIn(b[a]);return e}return this._transformIn(b)}return b};f.prototype.transformOut=function(b){if(this._transformEnabled&&this._transformOut){if(b instanceof Array){var e=[],a;for(a=0;a<b.length;a++)e[a]=this._transformOut(b[a]);return e}return this._transformOut(b)}return b};f.prototype.sort=function(b,e){e=e||[];
var a=[],d,c;for(d in b)b.hasOwnProperty(d)&&(c={},c[d]=b[d],c.___fdbKey=d,a.push(c));return 2>a.length?this._sort(b,e):this._bucketSort(a,e)};f.prototype._bucketSort=function(b,e){var a=b.shift(),d,c,g=[];if(0<b.length){e=this._sort(a,e);d=this.bucket(a.___fdbKey,e);for(c in d)d.hasOwnProperty(c)&&(a=[].concat(b),g=g.concat(this._bucketSort(a,d[c])));return g}return this._sort(a,e)};f.prototype._sort=function(b,a){var c=new d,g=c.parse(b,!0)[0];c.path(g.path);return a.sort(1===g.value?function(b,
a){var e=c.value(b)[0],d=c.value(a)[0];return"string"===typeof e&&"string"===typeof d?e.localeCompare(d):e>d?1:e<d?-1:0}:function(b,a){var e=c.value(b)[0],d=c.value(a)[0];return"string"===typeof e&&"string"===typeof d?1===e.localeCompare(d)?-1:1:e>d?-1:e<d?1:0})};f.prototype.bucket=function(b,e){var a,d={};for(a=0;a<e.length;a++)d[e[a][b]]=d[e[a][b]]||[],d[e[a][b]].push(e[a]);return d};f.prototype._analyseQuery=function(b,a,c){var g={queriesOn:[this._name],indexMatch:[],hasJoin:!1,queriesJoin:!1,
joinQueries:{},query:b,options:a},f,h=[],k=[],l,q,p,x,m;c.time("checkIndexes");void 0!==b[this._primaryKey]&&(c.time("checkIndexMatch: Primary Key"),l=new d,g.indexMatch.push({lookup:this._primaryIndex.lookup(b,a),keyData:{matchedKeys:[this._primaryKey],matchedKeyCount:1,totalKeyCount:l.countKeys(b)},index:this._primaryIndex}),c.time("checkIndexMatch: Primary Key"));for(m in this._indexById)if(this._indexById.hasOwnProperty(m)&&(q=this._indexById[m],p=q.name(),c.time("checkIndexMatch: "+p),l=q.match(b,
a),x=q.lookup(b,a),0<l.matchedKeyCount&&g.indexMatch.push({lookup:x,keyData:l,index:q}),c.time("checkIndexMatch: "+p),l.totalKeyCount===l.matchedKeyCount))break;c.time("checkIndexes");1<g.indexMatch.length&&(c.time("findOptimalIndex"),g.indexMatch.sort(function(b,a){return b.keyData.totalKeyCount===b.keyData.matchedKeyCount?-1:a.keyData.totalKeyCount===a.keyData.matchedKeyCount?1:b.keyData.matchedKeyCount===a.keyData.matchedKeyCount?b.lookup.length-a.lookup.length:a.keyData.matchedKeyCount-b.keyData.matchedKeyCount}),
c.time("findOptimalIndex"));if(a.join){g.hasJoin=!0;for(c=0;c<a.join.length;c++)for(f in a.join[c])a.join[c].hasOwnProperty(f)&&(h.push(f),"$as"in a.join[c][f]?k.push(a.join[c][f].$as):k.push(f));for(f=0;f<k.length;f++)if(a=this._queryReferencesCollection(b,k[f],""))g.joinQueries[h[f]]=a,g.queriesJoin=!0;g.joinsOn=h;g.queriesOn=g.queriesOn.concat(h)}return g};f.prototype._queryReferencesCollection=function(b,a,d){for(var c in b)if(b.hasOwnProperty(c)){if(c===a)return d&&(d+="."),d+c;if("object"===
typeof b[c])return d&&(d+="."),d+=c,this._queryReferencesCollection(b[c],a,d)}return!1};f.prototype._match=function(b,a,d){var c,g;c=typeof b;g=typeof a;var f=!0,h;if(!("string"!==c&&"number"!==c||"string"!==g&&"number"!==g))b!==a&&(f=!1);else for(h in a)if(a.hasOwnProperty(h)){c=!1;if("$"===h.substr(0,1))switch(h){case "$gt":if(b>a[h]){if("or"===d)return!0}else f=!1;c=!0;break;case "$gte":if(b>=a[h]){if("or"===d)return!0}else f=!1;c=!0;break;case "$lt":if(b<a[h]){if("or"===d)return!0}else f=!1;c=
!0;break;case "$lte":if(b<=a[h]){if("or"===d)return!0}else f=!1;c=!0;break;case "$exists":if(void 0===b!==a[h]){if("or"===d)return!0}else f=!1;c=!0;break;case "$or":c=!0;for(g=0;g<a[h].length;g++){if(this._match(b,a[h][g],"and"))return!0;f=!1}break;case "$and":c=!0;for(g=0;g<a[h].length;g++)if(!this._match(b,a[h][g],"and"))return!1;break;case "$in":if(a[h]instanceof Array){c=a[h];g=c.length;var k,l=!1;for(k=0;k<g;k++)if(c[k]===b){l=!0;break}if(l){if("or"===d)return!0}else f=!1}else throw"Cannot use a $nin operator on a non-array key: "+
h;c=!0;break;case "$nin":if(a[h]instanceof Array){c=a[h];g=c.length;l=!0;for(k=0;k<g;k++)if(c[k]===b){l=!1;break}if(l){if("or"===d)return!0}else f=!1}else throw"Cannot use a $nin operator on a non-array key: "+h;c=!0;break;case "$ne":if(b!=a[h]){if("or"===d)return!0}else f=!1;c=!0}if(!c&&a[h]instanceof RegExp)if(c=!0,"object"===typeof b&&void 0!==b[h]&&a[h].test(b[h])){if("or"===d)return!0}else f=!1;if(!c)if("object"===typeof a[h])if(void 0!==b[h]){if(b[h]instanceof Array&&!(a[h]instanceof Array))for(c=
!1,g=0;g<b[h].length&&!(c=this._match(b[h][g],a[h],void 0));g++);else if(!(b[h]instanceof Array)&&a[h]instanceof Array)for(c=!1,g=0;g<a[h].length&&!(c=this._match(b[h],a[h][g],void 0));g++);else c="object"===typeof b?this._match(b[h],a[h],void 0):this._match(void 0,a[h],void 0);if(c){if("or"===d)return!0}else f=!1}else if(a[h]&&void 0!==a[h].$exists)if(c=this._match(void 0,a[h],void 0)){if("or"===d)return!0}else f=!1;else f=!1;else if(b&&b[h]===a[h]){if("or"===d)return!0}else if(b&&b[h]&&b[h]instanceof
Array&&a[h]&&"object"!==typeof a[h]){c=!1;for(g=0;g<b[h].length&&!(c=this._match(b[h][g],a[h],void 0));g++);if(c){if("or"===d)return!0}else f=!1}else f=!1;if("and"===d&&!f)return!1}return f};f.prototype.count=function(b,a){return b?this.find(b,a).length:this._data.length};f.prototype.link=function(b,a){this._links=this._links||{};if(!this._links[a]){if($(b).length){if(!$.templates[a]){var d=$(a);if(d.length)$.views.templates(a,$(d[0]).html());else throw"Unable to bind collection to target because template does not exist: "+
a;}$.templates[a].link(b,this._data);this._links[a]=b;this._linked++;this.debug()&&console.log('ForerunnerDB.Collection: Added binding collection "'+this.name()+'" to output target: '+b);return this}throw'Cannot bind view data to output target selector "'+b+'" because it does not exist in the DOM!';}throw"Cannot create a duplicate link to the target: "+b+" with the template: "+a;};f.prototype.unlink=function(b,a){this._links=this._links||{};if(this._links[a])return $.templates[a].unlink(b),delete this._links[a],
this._linked--,this.debug()&&console.log('ForerunnerDB.Collection: Removed binding collection "'+this.name()+'" to output target: '+b),this;console.log("Cannot remove link, one does not exist to the target: "+b+" with the template: "+a)};f.prototype.findSub=function(b,a,c,g){var h=new d(a);b=this.find(b);var f=b.length,k,l,q=this._db.collection("__FDB_temp_"+this.objectId()),p={parents:f,subDocTotal:0,subDocs:[],pathFound:!1,err:""};for(k=0;k<f;k++)if(l=h.value(b[k])[0]){q.setData(l);l=q.find(c,g);
if(g.returnFirst&&l.length)return l[0];p.subDocs.push(l);p.subDocTotal+=l.length;p.pathFound=!0}q.drop();if(g.noStats)return p.subDocs;p.pathFound||(p.err="No objects found in the parent documents with a matching path of: "+a);return p};f.prototype.insertIndexViolation=function(b){var a,d=this._indexByName,c,g;if(this._primaryIndex.get(b[this._primaryKey]))a=this._primaryIndex;else for(c in d)if(d.hasOwnProperty(c)&&(g=d[c],g.unique()&&g.violation(b))){a=g;break}return a?a.name():!1};f.prototype.ensureIndex=
function(a,d){this._indexByName=this._indexByName||{};this._indexById=this._indexById||{};var c=new h(a,d,this),g={start:(new Date).getTime()};if(this._indexByName[c.name()])return{err:"Index with that name already exists"};if(this._indexById[c.id()])return{err:"Index with those keys already exists"};c.rebuild();this._indexByName[c.name()]=c;this._indexById[c.id()]=c;g.end=(new Date).getTime();g.total=g.end-g.start;this._lastOp={type:"ensureIndex",stats:{time:g}};return{index:c,id:c.id(),name:c.name(),
state:c.state()}};f.prototype.index=function(a){if(this._indexByName)return this._indexByName[a]};f.prototype.lastOp=function(){return this._metrics.list()};f.prototype.objectId=function(a){var d=Math.pow(10,17);if(a){var g=0,h=a.length,f;for(f=0;f<h;f++)g+=a.charCodeAt(f)*d;a=g.toString(16)}else c.idCounter++,a=(c.idCounter+(Math.random()*d+Math.random()*d+Math.random()*d+Math.random()*d)).toString(16);return a};f.prototype.diff=function(a){var d={insert:[],update:[],remove:[]},c=this.primaryKey(),
g,f,h,k;if(c===a.primaryKey()){g=a._data;k=g.length;for(f=0;f<k;f++)h=g[f],this._primaryIndex.get(h[c])?this._primaryCrc.get(h[c])!==a._primaryCrc.get(h[c])&&d.update.push(h):d.insert.push(h);g=this._data;k=g.length;for(f=0;f<k;f++)h=g[f],a._primaryIndex.get(h[c])||d.remove.push(h)}return d};k.prototype.collection=function(a,d){if(a)return this._collection[a]||this.debug()&&console.log("Creating collection "+a),this._collection[a]=this._collection[a]||(new f(a)).db(this),void 0!==d&&this._collection[a].primaryKey(d),
this._collection[a];throw"Cannot get collection with undefined name!";};k.prototype.collectionExists=function(a){return Boolean(this._collection[a])};k.prototype.collections=function(){var a=[],d;for(d in this._collection)this._collection.hasOwnProperty(d)&&a.push({name:d,count:this._collection[d].count()});return a};p.exports=f},{"./Crc":4,"./Index":5,"./KeyValueStore":6,"./Metrics":7,"./Overload":9,"./Path":10,"./Shared":11}],3:[function(k,p,l){var c,a;c=k("./Shared.js");var g=function(){this.init.apply(this,
arguments)};g.prototype.init=function(){this._collection={};this._debug={}};c.modules.Core=g;l=k("./Overload.js");a=k("./Collection.js");k("./Metrics.js");k=k("./Crc.js");g.prototype._isServer=!1;g.prototype.isClient=function(){return!this._isServer};g.prototype.isServer=function(){return this._isServer};g.prototype.crc=k;g.prototype.isClient=function(){return!this._isServer};g.prototype.isServer=function(){return this._isServer};g.prototype.decouple=function(a){return JSON.parse(JSON.stringify(a))};
g.prototype.debug=new l([function(){return this._debug.all},function(a){return void 0!==a&&"boolean"===typeof a?(this._debug.all=a,this):this._debug.all},function(a,c){return void 0!==a?void 0!==c?(this._debug[a]=c,this):this._debug[a]:this._debug.all}]);g.prototype.arrayToCollection=function(d){return(new a).setData(d)};g.prototype.on=function(a,c){this._listeners=this._listeners||{};this._listeners[a]=this._listeners[a]||[];this._listeners[a].push(c);return this};g.prototype.off=function(a,c){if(a in
this._listeners){var g=this._listeners[a],f=g.indexOf(c);-1<f&&g.splice(f,1)}return this};g.prototype.emit=function(a,c){this._listeners=this._listeners||{};if(a in this._listeners){var g=this._listeners[a],f=g.length,b;for(b=0;b<f;b++)g[b].apply(this,Array.prototype.slice.call(arguments,1))}return this};g.prototype.objectId=function(a){var g,k,f=Math.pow(10,17),b;if(a){g=0;k=a.length;for(b=0;b<k;b++)g+=a.charCodeAt(b)*f;a=g.toString(16)}else c.idCounter++,a=(c.idCounter+(Math.random()*f+Math.random()*
f+Math.random()*f+Math.random()*f)).toString(16);return a};g.prototype.peek=function(a){var c,g,f=[],b=typeof a;for(c in this._collection)this._collection.hasOwnProperty(c)&&(g=this._collection[c],f="string"===b?f.concat(g.peek(a)):f.concat(g.find(a)));return f};g.prototype.peekCat=function(a){var c,g,f={},b,e=typeof a;for(c in this._collection)this._collection.hasOwnProperty(c)&&(g=this._collection[c],(b="string"===e?g.peek(a):g.find(a))&&b.length&&(f[g.name()]=b));return f};p.exports=g},{"./Collection.js":2,
"./Crc.js":4,"./Metrics.js":7,"./Overload.js":9,"./Shared.js":11}],4:[function(k,p,l){var c=function(){var a=[],c,d,h;for(d=0;256>d;d++){c=d;for(h=0;8>h;h++)c=c&1?3988292384^c>>>1:c>>>1;a[d]=c}return a}();p.exports=function(a){var g=-1,d;for(d=0;d<a.length;d++)g=g>>>8^c[(g^a.charCodeAt(d))&255];return(g^-1)>>>0}},{}],5:[function(k,p,l){l=k("./Shared");var c=k("./Path");k=function(){this.init.apply(this,arguments)};k.prototype.init=function(a,c,d){this._crossRef={};this._size=0;this._id=this._itemKeyHash(a,
a);this.data({});this.unique(c&&c.unique?c.unique:!1);void 0!==a&&this.keys(a);void 0!==d&&this.collection(d);this.name(c&&c.name?c.name:this._id)};l.modules.Index=k;k.prototype.id=function(){return this._id};k.prototype.state=function(){return this._state};k.prototype.size=function(){return this._size};k.prototype.data=function(a){return void 0!==a?(this._data=a,this):this._data};k.prototype.name=function(a){return void 0!==a?(this._name=a,this):this._name};k.prototype.collection=function(a){return void 0!==
a?(this._collection=a,this):this._collection};k.prototype.keys=function(a){return void 0!==a?(this._keys=a,this._keyCount=(new c).parse(this._keys).length,this):this._keys};k.prototype.type=function(a){return void 0!==a?(this._type=a,this):this._type};k.prototype.unique=function(a){return void 0!==a?(this._unique=a,this):this._unique};k.prototype.rebuild=function(){if(this._collection){var a=this._collection.subset({},{decouple:!1,sort:this._keys}).find(),c,d=a.length;this._data={};this._unique&&
(this._uniqueLookup={});for(c=0;c<d;c++)this.insert(a[c])}this._state={name:this._name,keys:this._keys,indexSize:this._size,built:new Date,updated:new Date,ok:!0}};k.prototype.insert=function(a,c){var d,h;this._unique&&(d=this._itemHash(a,this._keys),this._uniqueLookup[d]=a);d=this._itemHashArr(a,this._keys);for(h=0;h<d.length;h++)this.pushToPathValue(d[h],a)};k.prototype.remove=function(a,c){var d,h;this._unique&&(d=this._itemHash(a,this._keys),delete this._uniqueLookup[d]);d=this._itemHashArr(a,
this._keys);for(h=0;h<d.length;h++)this.pullFromPathValue(d[h],a)};k.prototype.violation=function(a){a=this._itemHash(a,this._keys);return Boolean(this._uniqueLookup[a])};k.prototype.hashViolation=function(a){return Boolean(this._uniqueLookup[a])};k.prototype.pushToPathValue=function(a,c){var d=this._data[a]=this._data[a]||[];-1===d.indexOf(c)&&(d.push(c),this._size++,this.pushToCrossRef(c,d))};k.prototype.pullFromPathValue=function(a,c){var d=this._data[a],h;h=d.indexOf(c);-1<h&&(d.splice(h,1),this._size--,
this.pullFromCrossRef(c,d));d.length||delete this._data[a]};k.prototype.pull=function(a){var c=a[this._collection.primaryKey()],d=this._crossRef[c],h,k=d.length,f;for(h=0;h<k;h++)f=d[h],this._pullFromArray(f,a);this._size--;delete this._crossRef[c]};k.prototype._pullFromArray=function(a,c){for(var d=a.length;d--;)a[d]===c&&a.splice(d,1)};k.prototype.pushToCrossRef=function(a,c){var d=a[this._collection.primaryKey()];this._crossRef[d]=this._crossRef[d]||[];d=this._crossRef[d];-1===d.indexOf(c)&&d.push(c)};
k.prototype.pullFromCrossRef=function(a,c){var d=a[this._collection.primaryKey()];delete this._crossRef[d]};k.prototype.lookup=function(a){return this._data[this._itemHash(a,this._keys)]||[]};k.prototype.match=function(a,g){return(new c).countObjectPaths(this._keys,a)};k.prototype._itemHash=function(a,g){var d=new c,h,k="",f;h=d.parse(g);for(f=0;f<h.length;f++)k&&(k+="_"),k+=d.value(a,h[f].path).join(":");return k};k.prototype._itemKeyHash=function(a,g){var d=new c,h,k="",f;h=d.parse(g);for(f=0;f<
h.length;f++)k&&(k+="_"),k+=d.keyValue(a,h[f].path);return k};k.prototype._itemHashArr=function(a,g){var d=new c,h,k=[],f,b,e,l;h=d.parse(g);for(e=0;e<h.length;e++)for(f=d.value(a,h[e].path),b=0;b<f.length;b++)if(0===e)k.push(f[b]);else for(l=0;l<k.length;l++)k[l]=k[l]+"_"+f[b];return k};p.exports=k},{"./Path":10,"./Shared":11}],6:[function(k,p,l){k=k("./Shared");l=function(c){this.init.apply(this,arguments)};l.prototype.init=function(c){this._name=c;this._data={};this._primaryKey="_id"};k.modules.KeyValueStore=
l;l.prototype.name=function(c){return void 0!==c?(this._name=c,this):this._name};l.prototype.primaryKey=function(c){return void 0!==c?(this._primaryKey=c,this):this._primaryKey};l.prototype.truncate=function(){this._data={};return this};l.prototype.set=function(c,a){this._data[c]=a?a:!0;return this};l.prototype.get=function(c){return this._data[c]};l.prototype.lookup=function(c){c=c[this._primaryKey];var a,g,d,h;if(c instanceof Array){g=c.length;h=[];for(a=0;a<g;a++)(d=this._data[c[a]])&&h.push(d);
return h}if(c instanceof RegExp){h=[];for(a in this._data)this._data.hasOwnProperty(a)&&c.test(a)&&h.push(this._data[a]);return h}if("object"===typeof c){if(c.$ne){h=[];for(a in this._data)this._data.hasOwnProperty(a)&&a!==c.$ne&&h.push(this._data[a]);return h}if(c.$in&&c.$in instanceof Array){h=[];for(a in this._data)this._data.hasOwnProperty(a)&&-1<c.$in.indexOf(a)&&h.push(this._data[a]);return h}if(c.$nin&&c.$nin instanceof Array){h=[];for(a in this._data)this._data.hasOwnProperty(a)&&-1===c.$nin.indexOf(a)&&
h.push(this._data[a]);return h}if(c.$or&&c.$or instanceof Array){h=[];for(a=0;a<c.$or.length;a++)h=h.concat(this.lookup(c.$or[a]));return h}}else return d=this._data[c],void 0!==d?[d]:[]};l.prototype.unSet=function(c){delete this._data[c];return this};l.prototype.uniqueSet=function(c,a){return void 0===this._data[c]?(this._data[c]=a,!0):!1};p.exports=l},{"./Shared":11}],7:[function(k,p,l){l=k("./Shared");var c=k("./Operation");k=function(){this.init.apply(this,arguments)};k.prototype.init=function(){this._data=
[]};l.modules.Metrics=k;k.prototype.create=function(a){a=new c(a);this._enabled&&this._data.push(a);return a};k.prototype.start=function(){this._enabled=!0;return this};k.prototype.stop=function(){this._enabled=!1;return this};k.prototype.clear=function(){this._data=[];return this};k.prototype.list=function(){return this._data};p.exports=k},{"./Operation":8,"./Shared":11}],8:[function(k,p,l){l=k("./Shared");var c=k("./Path");k=function(a){this.pathSolver=new c;this.counter=0;this.init.apply(this,
arguments)};k.prototype.init=function(a){this._data={operation:a,index:{potential:[],used:!1},steps:[],time:{startMs:0,stopMs:0,totalMs:0,process:{}},flag:{},log:[]}};l.modules.Operation=k;k.prototype.start=function(){this._data.time.startMs=(new Date).getTime()};k.prototype.log=function(a){if(a){var c=0<this._log.length?this._data.log[this._data.log.length-1].time:0;a={event:a,time:(new Date).getTime(),delta:0};this._data.log.push(a);c&&(a.delta=a.time-c);return this}return this._data.log};k.prototype.time=
function(a){if(void 0!==a){var c=this._data.time.process,c=c[a]=c[a]||{};c.startMs?(c.stopMs=(new Date).getTime(),c.totalMs=c.stopMs-c.startMs,c.stepObj.totalMs=c.totalMs,delete c.stepObj):(c.startMs=(new Date).getTime(),c.stepObj={name:a},this._data.steps.push(c.stepObj));return this}return this._data.time};k.prototype.flag=function(a,c){if(void 0!==a&&void 0!==c)this._data.flag[a]=c;else return void 0!==a?this._data.flag[a]:this._data.flag};k.prototype.data=function(a,c,d){return void 0!==c?(this.pathSolver.set(this._data,
a,c),this):this.pathSolver.get(this._data,a)};k.prototype.pushData=function(a,c,d){this.pathSolver.push(this._data,a,c)};k.prototype.stop=function(){this._data.time.stopMs=(new Date).getTime();this._data.time.totalMs=this._data.time.stopMs-this._data.time.startMs};p.exports=k},{"./Path":10,"./Shared":11}],9:[function(k,p,l){l=function(c){if(c){var a,g=c.length;return function(){for(a=0;a<g;a++)if(c[a].length===arguments.length)return c[a].apply(this,arguments);return null}}return function(){}};k("./Shared").modules.Overload=
l;p.exports=l},{"./Shared":11}],10:[function(k,p,l){k=k("./Shared");l=function(c){this.init.apply(this,arguments)};l.prototype.init=function(c){c&&this.path(c)};k.modules.Path=l;l.prototype.path=function(c){return void 0!==c?(this._path=this.clean(c),this._pathParts=this._path.split("."),this):this._path};l.prototype.hasObjectPaths=function(c,a){var g=!0,d;for(d in c)if(c.hasOwnProperty(d)&&(void 0===a[d]||"object"===typeof c[d]&&(g=this.hasObjectPaths(c[d],a[d]),!g)))return!1;return g};l.prototype.countKeys=
function(c){var a=0,g;for(g in c)c.hasOwnProperty(g)&&void 0!==c[g]&&("object"!==typeof c[g]?a++:a+=this.countKeys(c[g]));return a};l.prototype.countObjectPaths=function(c,a){var g,d={},h=0,k=0,f;for(f in a)a.hasOwnProperty(f)&&("object"===typeof a[f]?(g=this.countObjectPaths(c[f],a[f]),d[f]=g.matchedKeys,k+=g.totalKeyCount,h+=g.matchedKeyCount):(k++,c&&c[f]&&"object"!==typeof c[f]?(d[f]=!0,h++):d[f]=!1));return{matchedKeys:d,matchedKeyCount:h,totalKeyCount:k}};l.prototype.parse=function(c,a){var g=
[],d="",h,k,f;for(k in c)if(c.hasOwnProperty(k))if(d=k,"object"===typeof c[k])if(a)for(h=this.parse(c[k],a),f=0;f<h.length;f++)g.push({path:d+"."+h[f].path,value:h[f].value});else for(h=this.parse(c[k]),f=0;f<h.length;f++)g.push({path:d+"."+h[f].path});else a?g.push({path:d,value:c[k]}):g.push({path:d});return g};l.prototype.parseArr=function(c,a){a=a||{};return this._parseArr(c,"",[],a)};l.prototype._parseArr=function(c,a,g,d){var h,k="";a=a||"";g=g||[];for(h in c)c.hasOwnProperty(h)&&(!d.ignore||
d.ignore&&!d.ignore.test(h))&&(k=a?a+"."+h:h,"object"===typeof c[h]?this._parseArr(c[h],k,g,d):g.push(k));return g};l.prototype.value=function(c,a){if(void 0!==c&&"object"===typeof c){var g,d,h,k,f=[],b;void 0!==a&&(a=this.clean(a),g=a.split("."));g=g||this._pathParts;d=g.length;h=c;for(b=0;b<d;b++){h=h[g[b]];if(k instanceof Array){for(d=0;d<k.length;d++)f=f.concat(this.value(k,d+"."+g[b]));return f}if(!h||"object"!==typeof h)break;k=h}return[h]}return[]};l.prototype.set=function(c,a,g){if(void 0!==
c&&void 0!==a){var d;a=this.clean(a);a=a.split(".");d=a.shift();a.length?(c[d]=c[d]||{},this.set(c[d],a.join("."),g)):c[d]=g}return c};l.prototype.get=function(c,a){return this.value(c,a)[0]};l.prototype.push=function(c,a,g){if(void 0!==c&&void 0!==a){var d;a=this.clean(a);a=a.split(".");d=a.shift();if(a.length)c[d]=c[d]||{},this.set(c[d],a.join("."),g);else if(c[d]=c[d]||[],c[d]instanceof Array)c[d].push(g);else throw"Cannot push to a path whose endpoint is not an array!";}return c};l.prototype.keyValue=
function(c,a){var g,d,h,k,f;void 0!==a&&(a=this.clean(a),g=a.split("."));g=g||this._pathParts;d=g.length;h=c;for(f=0;f<d;f++)if(h=h[g[f]],!h||"object"!==typeof h){k=g[f]+":"+h;break}return k};l.prototype.clean=function(c){"."===c.substr(0,1)&&(c=c.substr(1,c.length-1));return c};p.exports=l},{"./Shared":11}],11:[function(k,p,l){p.exports={idCounter:0,modules:{},prototypes:{}}},{}]},{},[1])(1)});
