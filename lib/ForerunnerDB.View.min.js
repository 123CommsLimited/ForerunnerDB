(function(){var f=function(e){var d=e.classes.Collection,f=d.prototype.init,g=e.prototype.init,c=function(a,b,c){this.init.apply(this,arguments)};c.prototype.init=function(a,b,c){this._name=a;this._collections=[];this._groups=[];this._listeners={};this._querySettings={query:b,options:c};this._data=new d("__FDB__view_"+this._name)};c.prototype.find=function(a,b){return this._data.find(a,b)};c.prototype.insert=function(a,b,c){a=this._data.decouple(a);"function"===typeof b?(c=b,b=this._data.length):
void 0===b&&(b=this._data.length);return this._data._insertHandle(a,b,c)};c.prototype.update=function(a,b){return this._data.update(a,b)};c.prototype.remove=function(a){return this._data.remove(a)};c.prototype.link=function(a,b){return this._data.link(a,b)};c.prototype.unlink=function(a,b){return this._data.unlink(a,b)};c.prototype.from=function(a){void 0!==a&&("string"===typeof a&&(a=this._db.collection(a)),this._addCollection(a));return this};c.prototype._addCollection=function(a){-1===this._collections.indexOf(a)&&
(this._collections.push(a),a._addView(this),this._data.primaryKey(a.primaryKey()),this._data.insert(a.find(this._querySettings.query,this._querySettings.options)));return this};c.prototype._removeCollection=function(a){-1<this._collections.indexOf(a)&&(this._collections.splice(a,1),a._removeView(this),this._data.remove(a.find(this._querySettings.query,this._querySettings.options)));return this};c.prototype.on=function(){this._data.on.apply(this._data,arguments)};c.prototype.off=function(){this._data.off.apply(this._data,
arguments)};c.prototype.emit=function(){this._data.emit.apply(this._data,arguments)};c.prototype.drop=function(){if(this._collections&&this._collections.length){(this._debug||this._db&&this._db._debug)&&console.log("ForerunnerDB.View: Dropping view "+this._name);this.emit("drop");for(var a=this._collections.length;a--;)this._removeCollection(this._collections[a]);this._data.drop();return!0}return!1};c.prototype.db=function(a){return void 0!==a?(this._db=a,this):this._db};c.prototype.primaryKey=function(){return this._data.primaryKey()};
c.prototype.queryData=function(a,b,c){void 0!==a&&(this._querySettings.query=a);void 0!==b&&(this._querySettings.options=b);return void 0!==a||void 0!==b?((void 0===c||!0===c)&&this.refresh(),this):this._querySettings};c.prototype.queryAdd=function(a,b,c){var e=this._querySettings.query,d;if(void 0!==a)for(d in a)if(a.hasOwnProperty(d)&&(void 0===e[d]||void 0!==e[d]&&b))e[d]=a[d];(void 0===c||!0===c)&&this.refresh()};c.prototype.queryRemove=function(a,b){var c=this._querySettings.query,d;if(void 0!==
a)for(d in a)a.hasOwnProperty(d)&&delete c[d];(void 0===b||!0===b)&&this.refresh()};c.prototype.query=function(a,b){return void 0!==a?(this._querySettings.query=a,(void 0===b||!0===b)&&this.refresh(),this):this._querySettings.query};c.prototype.queryOptions=function(a,b){return void 0!==a?(this._querySettings.options=a,void 0===a.decouple&&(a.decouple=!0),(void 0===b||!0===b)&&this.refresh(),this):this._querySettings.options};c.prototype.refresh=function(a){var b;this._data.remove();for(b=0;b<this._collections.length;b++)a=
this._collections[b],this._data.insert(a.find(this._querySettings.query,this._querySettings.options));a=this._data.find({},this._querySettings.options);this._data._linked?$.observable(this._data._data).refresh(a):(this._data._data.length=0,this._data._data=this._data._data.concat(a));return this};c.prototype.count=function(){return this._data&&this._data._data?this._data._data.length:0};d.prototype.init=function(){this._views=[];f.apply(this,arguments)};d.prototype.view=function(a,b,d){a=(new c(a,
b,d))._addCollection(this).db(this._db);this._views=this._views||[];this._views.push(a);return a};d.prototype._addView=function(a){void 0!==a&&this._views.push(a);return this};d.prototype._removeView=function(a){void 0!==a&&(a=this._views.indexOf(a),-1<a&&this._views.splice(a,1));return this};e.prototype.init=function(){this._views={};g.apply(this,arguments)};e.prototype.view=function(a){this._views[a]||(this._debug||this._db&&this._db._debug)&&console.log("ForerunnerDB.View: Creating view "+a);this._views[a]=
this._views[a]||(new c(a)).db(this);return this._views[a]};e.prototype.viewExists=function(a){return Boolean(this._views[a])};e.prototype.views=function(){var a=[],b;for(b in this._views)this._views.hasOwnProperty(b)&&a.push({name:b,count:this._views[b].count()});return a};e.classes.View=c};"function"===typeof define&&define.amd?define(["require","../ForerunnerDB","./ForerunnerDB.CollectionGroup"],function(e,d){return f(d)}):f(ForerunnerDB)})();
