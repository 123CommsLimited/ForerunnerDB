/*
 btree.js (c) 2013 Daniel Wirtz <dcode@dcode.io>
 Released under the Apache License, Version 2.0
 see: http://github.com/dcodeIO/btree.js for details
*/
!function(w){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=w();else if("function"==typeof define&&define.amd)define([],w);else{var c;"undefined"!=typeof window?c=window:"undefined"!=typeof global?c=global:"undefined"!=typeof self&&(c=self);c.ForerunnerDB=w()}}(function(){return function c(n,g,b){function a(e,q){if(!g[e]){if(!n[e]){var d="function"==typeof require&&require;if(!q&&d)return d(e,!0);if(l)return l(e,!0);d=Error("Cannot find module '"+e+"'");throw d.code="MODULE_NOT_FOUND",
d;}d=g[e]={exports:{}};n[e][0].call(d.exports,function(k){var h=n[e][1][k];return a(h?h:k)},d,d.exports,c,n,g,b)}return g[e].exports}for(var l="function"==typeof require&&require,e=0;e<b.length;e++)a(b[e]);return a}({1:[function(c,n,g){c=c("../lib/Core");n.exports=c},{"../lib/Core":3}],2:[function(c,n,g){var b,a,l,e,f,q;g=c("./Shared");var d=function(k){this.init.apply(this,arguments)};d.prototype.init=function(k){this._primaryKey="_id";this._primaryIndex=new a("primary");this._primaryCrc=new a("primaryCrc");
this._crcLookup=new a("crcLookup");this._name=k;this._data=[];this._groups=[];this._metrics=new b;this._deferQueue={insert:[],update:[],remove:[],upsert:[]};this._deferThreshold={insert:100,update:100,remove:100,upsert:100};this._deferTime={insert:1,update:1,remove:1,upsert:1};this._subsetOf(this)};g.addModule("Collection",d);g.mixin(d.prototype,"Mixin.Common");g.mixin(d.prototype,"Mixin.Events");g.mixin(d.prototype,"Mixin.ChainReactor");g.mixin(d.prototype,"Mixin.CRUD");g.mixin(d.prototype,"Mixin.Constants");
g.mixin(d.prototype,"Mixin.Triggers");g.mixin(d.prototype,"Mixin.Sorting");g.mixin(d.prototype,"Mixin.Matching");b=c("./Metrics");a=c("./KeyValueStore");l=c("./Path");e=c("./IndexHashMap");f=c("./IndexBinaryTree");q=c("./Crc");c=g.modules.Core;d.prototype.crc=q;g.synthesize(d.prototype,"state");g.synthesize(d.prototype,"name");d.prototype.data=function(){return this._data};d.prototype.drop=function(){if("dropped"!==this._state){if(this._db&&this._db._collection&&this._name){this.debug()&&console.log("Dropping collection "+
this._name);this._state="dropped";this.emit("drop",this);delete this._db._collection[this._name];if(this._groups&&this._groups.length){var k=[],h;for(h=0;h<this._groups.length;h++)k.push(this._groups[h]);for(h=0;h<k.length;h++)this._groups[h].removeCollection(this)}delete this._primaryKey;delete this._primaryIndex;delete this._primaryCrc;delete this._crcLookup;delete this._name;delete this._data;delete this._groups;delete this._metrics;return!0}}else return!0;return!1};d.prototype.primaryKey=function(k){return void 0!==
k?(this._primaryKey!==k&&(this._primaryKey=k,this._primaryIndex.primaryKey(k),this.rebuildPrimaryKeyIndex()),this):this._primaryKey};d.prototype._onInsert=function(k,h){this.emit("insert",k,h)};d.prototype._onUpdate=function(k){this.emit("update",k)};d.prototype._onRemove=function(k){this.emit("remove",k)};g.synthesize(d.prototype,"db");d.prototype.setData=function(k,h,x){if(k){var a=this._metrics.create("setData");a.start();h=this.options(h);this.preSetData(k,h,x);h.$decouple&&(k=this.decouple(k));
k instanceof Array||(k=[k]);a.time("transformIn");k=this.transformIn(k);a.time("transformIn");var b=[].concat(this._data);this._dataReplace(k);a.time("Rebuild Primary Key Index");this.rebuildPrimaryKeyIndex(h);a.time("Rebuild Primary Key Index");a.time("Rebuild All Other Indexes");this._rebuildIndexes();a.time("Rebuild All Other Indexes");a.time("Resolve chains");this.chainSend("setData",k,{oldData:b});a.time("Resolve chains");a.stop();this.emit("setData",this._data,b)}x&&x(!1);return this};d.prototype.rebuildPrimaryKeyIndex=
function(k){var h=k&&void 0!==k.$ensureKeys?k.$ensureKeys:!0;k=k&&void 0!==k.$violationCheck?k.$violationCheck:!0;var a,b,e,l=this._primaryIndex,d=this._primaryCrc,f=this._crcLookup,c=this._primaryKey,q;l.truncate();d.truncate();f.truncate();a=this._data;for(b=a.length;b--;){e=a[b];h&&this.ensurePrimaryKey(e);if(k){if(!l.uniqueSet(e[c],e))throw'ForerunnerDB.Collection "'+this.name()+'": Call to setData on collection failed because your data violates the primary key unique constraint. One or more documents are using the same primary key: '+
e[this._primaryKey];}else l.set(e[c],e);q=JSON.stringify(e);d.set(e[c],q);f.set(q,e)}};d.prototype.ensurePrimaryKey=function(k){void 0===k[this._primaryKey]&&(k[this._primaryKey]=this.objectId())};d.prototype.truncate=function(){this.emit("truncate",this._data);this._data.length=0;this._primaryIndex=new a("primary");this._primaryCrc=new a("primaryCrc");this._crcLookup=new a("crcLookup");this.deferEmit("change",{type:"truncate"});return this};d.prototype.upsert=function(k,h){if(k){var a=this._deferQueue.upsert,
e=this._deferThreshold.upsert,b={},l;if(k instanceof Array){if(k.length>e)return this._deferQueue.upsert=a.concat(k),this.processQueue("upsert",h),{};b=[];for(a=0;a<k.length;a++)b.push(this.upsert(k[a]));h&&h();return b}k[this._primaryKey]?(l={},l[this._primaryKey]=k[this._primaryKey],this._primaryIndex.lookup(l)[0]?b.op="update":b.op="insert"):b.op="insert";switch(b.op){case "insert":b.result=this.insert(k);break;case "update":b.result=this.update(l,k)}return b}h&&h();return{}};d.prototype.update=
function(k,h,a){h=this.decouple(h);h=this.transformIn(h);this.debug()&&console.log('Updating some collection data for collection "'+this.name()+'"');var b=this,e=this._metrics.create("update"),l,d,f=function(l){var d=b.decouple(l),f,c;if(b.willTrigger(b.TYPE_UPDATE,b.PHASE_BEFORE)||b.willTrigger(b.TYPE_UPDATE,b.PHASE_AFTER)){f={type:"update",query:b.decouple(k),update:b.decouple(h),options:b.decouple(a),op:e};if(!1===b.processTrigger(f,b.TYPE_UPDATE,b.PHASE_BEFORE,d)||b.willTrigger(b.TYPE_UPDATE,
b.PHASE_BEFORE)&&(c=b.updateObject(d,f.update,f.query,f.options,""))&&!1===b.processTrigger(f,b.TYPE_UPDATE,b.PHASE_AFTER,l,d))return!1;c=b.updateObject(l,f.update,f.query,f.options,"")}else c=b.updateObject(l,h,k,a,"");return c};e.start();e.time("Retrieve documents to update");l=this.find(k,{$decouple:!1});e.time("Retrieve documents to update");l.length&&(e.time("Update documents"),d=l.filter(f),e.time("Update documents"),d.length&&(e.time("Resolve chains"),this.chainSend("update",{query:k,update:h,
dataSet:l},a),e.time("Resolve chains"),this._onUpdate(d),this.deferEmit("change",{type:"update",data:d})));e.stop();return d||[]};d.prototype._replaceObj=function(k,h){var a;this._removeFromIndexes(k);for(a in k)k.hasOwnProperty(a)&&delete k[a];for(a in h)h.hasOwnProperty(a)&&(k[a]=h[a]);if(!this._insertIntoIndexes(k))throw'ForerunnerDB.Collection "'+this.name()+'": Primary key violation in update! Key violated: '+k[this._primaryKey];return!0};d.prototype.updateById=function(k,h){var a={};a[this._primaryKey]=
k;return this.update(a,h)};d.prototype.updateObject=function(k,h,a,b,e,d){h=this.decouple(h);e=e||"";"."===e.substr(0,1)&&(e=e.substr(1,e.length-1));this.decouple(k);var f=!1,c=!1,q,g,p,m;for(m in h)if(h.hasOwnProperty(m)){q=!1;if("$"===m.substr(0,1))switch(m){case "$key":case "$index":q=!0;break;default:q=!0,c=this.updateObject(k,h[m],a,b,e,m),f=f||c}if(this._isPositionalKey(m)&&(q=!0,m=m.substr(0,m.length-2),c=new l(e+"."+m),k[m]&&k[m]instanceof Array&&k[m].length)){g=[];for(p=0;p<k[m].length;p++)this._match(k[m][p],
c.value(a)[0])&&g.push(p);for(p=0;p<g.length;p++)c=this.updateObject(k[m][g[p]],h[m+".$"],a,b,e+"."+m,d),f=f||c}if(!q)if(d||"object"!==typeof h[m])switch(d){case "$inc":this._updateIncrement(k,m,h[m]);f=!0;break;case "$push":void 0===k[m]&&this._updateProperty(k,m,[]);if(k[m]instanceof Array){if(void 0!==h[m].$position&&h[m].$each instanceof Array)for(c=h[m].$position,q=h[m].$each.length,p=0;p<q;p++)this._updateSplicePush(k[m],c+p,h[m].$each[p]);else if(h[m].$each instanceof Array)for(q=h[m].$each.length,
p=0;p<q;p++)this._updatePush(k[m],h[m].$each[p]);else this._updatePush(k[m],h[m]);f=!0}else throw'ForerunnerDB.Collection "'+this.name()+'": Cannot push to a key that is not an array! ('+m+")";break;case "$pull":if(k[m]instanceof Array){g=[];for(p=0;p<k[m].length;p++)this._match(k[m][p],h[m])&&g.push(p);for(q=g.length;q--;)this._updatePull(k[m],g[q]),f=!0}break;case "$pullAll":if(k[m]instanceof Array)if(h[m]instanceof Array){if(g=k[m],q=g.length,0<q)for(;q--;){for(c=0;c<h[m].length;c++)g[q]===h[m][c]&&
(this._updatePull(k[m],q),q--,f=!0);if(0>q)break}}else throw'ForerunnerDB.Collection "'+this.name()+'": Cannot pullAll without being given an array of values to pull! ('+m+")";break;case "$addToSet":void 0===k[m]&&this._updateProperty(k,m,[]);if(k[m]instanceof Array){p=k[m];var n;g=p.length;var u;q=!0;n=b&&b.$addToSet;var s;h[m].$key?(c=!1,s=new l(h[m].$key),u=s.value(h[m])[0],delete h[m].$key):n&&n.key?(c=!1,s=new l(n.key),u=s.value(h[m])[0]):(u=JSON.stringify(h[m]),c=!0);for(n=0;n<g;n++)if(c){if(JSON.stringify(p[n])===
u){q=!1;break}}else if(u===s.value(p[n])[0]){q=!1;break}q&&(this._updatePush(k[m],h[m]),f=!0)}else throw'ForerunnerDB.Collection "'+this.name()+'": Cannot addToSet on a key that is not an array! (undefined)';break;case "$splicePush":void 0===k[m]&&this._updateProperty(k,m,[]);if(k[m]instanceof Array)if(c=h.$index,void 0!==c)delete h.$index,c>k[m].length&&(c=k[m].length),this._updateSplicePush(k[m],c,h[m]),f=!0;else throw'ForerunnerDB.Collection "'+this.name()+'": Cannot splicePush without a $index integer value!';
else throw'ForerunnerDB.Collection "'+this.name()+'": Cannot splicePush with a key that is not an array! ('+m+")";break;case "$move":if(k[m]instanceof Array)for(p=0;p<k[m].length;p++){if(this._match(k[m][p],h[m])){f=h.$index;if(void 0!==f)delete h.$index,this._updateSpliceMove(k[m],p,f),f=!0;else throw'ForerunnerDB.Collection "'+this.name()+'": Cannot move without a $index integer value!';break}}else throw'ForerunnerDB.Collection "'+this.name()+'": Cannot move on a key that is not an array! ('+m+
")";break;case "$mul":this._updateMultiply(k,m,h[m]);f=!0;break;case "$rename":this._updateRename(k,m,h[m]);f=!0;break;case "$unset":this._updateUnset(k,m);f=!0;break;case "$pop":if(k[m]instanceof Array)this._updatePop(k[m],h[m])&&(f=!0);else throw'ForerunnerDB.Collection "'+this.name()+'": Cannot pop from a key that is not an array! ('+m+")";break;default:k[m]!==h[m]&&(this._updateProperty(k,m,h[m]),f=!0)}else if(null!==k[m]&&"object"===typeof k[m])if(p=k[m]instanceof Array,g=h[m]instanceof Array,
p||g)if(!g&&p)for(p=0;p<k[m].length;p++)c=this.updateObject(k[m][p],h[m],a,b,e+"."+m,d),f=f||c;else k[m]!==h[m]&&(this._updateProperty(k,m,h[m]),f=!0);else c=this.updateObject(k[m],h[m],a,b,e+"."+m,d),f=f||c;else k[m]!==h[m]&&(this._updateProperty(k,m,h[m]),f=!0)}return f};d.prototype._isPositionalKey=function(k){return".$"===k.substr(k.length-2,2)};d.prototype._updateProperty=function(k,h,a){k[h]=a;this.debug()&&console.log('ForerunnerDB.Collection: Setting non-data-bound document property "'+h+
'" for collection "'+this.name()+'"')};d.prototype._updateIncrement=function(k,h,a){k[h]+=a};d.prototype._updateSpliceMove=function(k,h,a){k.splice(a,0,k.splice(h,1)[0]);this.debug()&&console.log('ForerunnerDB.Collection: Moving non-data-bound document array index from "'+h+'" to "'+a+'" for collection "'+this.name()+'"')};d.prototype._updateSplicePush=function(k,h,a){k.length>h?k.splice(h,0,a):k.push(a)};d.prototype._updatePush=function(k,h){k.push(h)};d.prototype._updatePull=function(k,h){k.splice(h,
1)};d.prototype._updateMultiply=function(k,h,a){k[h]*=a};d.prototype._updateRename=function(k,h,a){k[a]=k[h];delete k[h]};d.prototype._updateUnset=function(k,h){delete k[h]};d.prototype._updatePop=function(k,h){var a=!1;0<k.length&&(1===h?(k.pop(),a=!0):-1===h&&(k.shift(),a=!0));return a};d.prototype.remove=function(a,h,b){var e,l;if(a instanceof Array){e=[];for(b=0;b<a.length;b++)e.push(this.remove(a[b],{noEmit:!0}));(!h||h&&!h.noEmit)&&this._onRemove(e);return e}b=this.find(a,{$decouple:!1});if(b.length){for(var d=
0;d<b.length;d++)l=b[d],this._removeFromIndexes(l),e=this._data.indexOf(l),this._dataRemoveAtIndex(e),this.processTrigger(this.TYPE_REMOVE,this.PHASE_AFTER,l,{});this.chainSend("remove",{query:a,dataSet:b},h);(!h||h&&!h.noEmit)&&this._onRemove(b);this.deferEmit("change",{type:"remove",data:b})}return b};d.prototype.removeById=function(a){var h={};h[this._primaryKey]=a;return this.remove(h)};d.prototype.deferEmit=function(){var a=this,h;this._noEmitDefer||this._db&&(!this._db||this._db._noEmitDefer)?
this.emit.apply(this,arguments):(h=arguments,this._changeTimeout&&clearTimeout(this._changeTimeout),this._changeTimeout=setTimeout(function(){a.debug()&&console.log("ForerunnerDB.Collection: Emitting "+h[0]);a.emit.apply(a,h)},100))};d.prototype.processQueue=function(a,h){var b=this._deferQueue[a],e=this._deferThreshold[a],l=this._deferTime[a];if(b.length){var d=this;b.length&&(b=b.length>e?b.splice(0,e):b.splice(0,b.length),this[a](b));setTimeout(function(){d.processQueue(a,h)},l)}else h&&h()};d.prototype.insert=
function(a,h,b){"function"===typeof h?(b=h,h=this._data.length):void 0===h&&(h=this._data.length);a=this.transformIn(a);return this._insertHandle(a,h,b)};d.prototype._insertHandle=function(a,h,b){var e=this._deferQueue.insert,l=this._deferThreshold.insert,d=[],f=[];if(a instanceof Array){if(a.length>l){this._deferQueue.insert=e.concat(a);this.processQueue("insert",b);return}for(l=0;l<a.length;l++)e=this._insert(a[l],h+l),!0===e?d.push(a[l]):f.push({doc:a[l],reason:e})}else e=this._insert(a,h),!0===
e?d.push(a):f.push({doc:a,reason:e});this.chainSend("insert",a,{index:h});this._onInsert(d,f);b&&b();this.deferEmit("change",{type:"insert",data:d});return{inserted:d,failed:f}};d.prototype._insert=function(a,h){if(a){var b;this.ensurePrimaryKey(a);if(b=this.insertIndexViolation(a))return"Index violation in index: "+b;this._insertIntoIndexes(a);h>this._data.length&&(h=this._data.length);this._dataInsertAtIndex(h,a);this.processTrigger(this.TYPE_INSERT,this.PHASE_AFTER,{},a);return!0}return"No document passed to insert"};
d.prototype._dataInsertAtIndex=function(a,h){this._data.splice(a,0,h)};d.prototype._dataRemoveAtIndex=function(a){this._data.splice(a,1)};d.prototype._dataReplace=function(a){for(;this._data.length;)this._data.pop();this._data=this._data.concat(a)};d.prototype._insertIntoIndexes=function(a){var h=this._indexByName,b,e,l=JSON.stringify(a);e=this._primaryIndex.uniqueSet(a[this._primaryKey],a);this._primaryCrc.uniqueSet(a[this._primaryKey],l);this._crcLookup.uniqueSet(l,a);for(b in h)h.hasOwnProperty(b)&&
h[b].insert(a);return e};d.prototype._removeFromIndexes=function(a){var h=this._indexByName,b,e=JSON.stringify(a);this._primaryIndex.unSet(a[this._primaryKey]);this._primaryCrc.unSet(a[this._primaryKey]);this._crcLookup.unSet(e);for(b in h)h.hasOwnProperty(b)&&h[b].remove(a)};d.prototype._rebuildIndexes=function(){var a=this._indexByName,h;for(h in a)a.hasOwnProperty(h)&&a[h].rebuild()};d.prototype.indexOfDocById=function(a){return this._data.indexOf(this._primaryIndex.get(a[this._primaryKey]))};
d.prototype.subset=function(a,h){var b=this.find(a,h);return(new d)._subsetOf(this).primaryKey(this._primaryKey).setData(b)};d.prototype.subsetOf=function(){return this.__subsetOf};d.prototype._subsetOf=function(a){this.__subsetOf=a;return this};d.prototype.distinct=function(a,h,b){h=this.find(h,b);a=new l(a);b={};var e=[],d,f;for(f=0;f<h.length;f++)(d=a.value(h[f])[0])&&!b[d]&&(b[d]=!0,e.push(d));return e};d.prototype.findById=function(a,h){var b={};b[this._primaryKey]=a;return this.find(b,h)[0]};
d.prototype.peek=function(a,h){var b=this._data,e=b.length,l,f,c=new d;if("string"===typeof a){for(l=0;l<e;l++)f=JSON.stringify(b[l]),-1<f.indexOf(a)&&c.insert(b[l]);return c.find({},h)}return this.find(a,h)};d.prototype.explain=function(a,h){return this.find(a,h).__fdbOp._data};d.prototype.options=function(a){a=a||{};a.$decouple=void 0!==a.$decouple?a.$decouple:!0;a.$explain=void 0!==a.$explain?a.$explain:!1;return a};d.prototype.find=function(a,h){a=a||{};h=this.options(h);var b=this._metrics.create("find"),
e=this,d,f=!0,c,q,g,n,p,m,t,u,s,v=[];q=function(b){return e._match(b,a,"and")};b.start();if(a){b.time("analyseQuery");d=this._analyseQuery(a,h,b);b.time("analyseQuery");b.data("analysis",d);if(d.hasJoin&&d.queriesJoin){b.time("joinReferences");for(g=0;g<d.joinsOn.length;g++)p=d.joinsOn[g],n=new l(d.joinQueries[p]),n=n.value(a)[0],this._db.collection(d.joinsOn[g]).subset(n);b.time("joinReferences")}d.indexMatch.length&&(!h||h&&!h.$skipIndex)?(b.data("index.potential",d.indexMatch),b.data("index.used",
d.indexMatch[0].index),b.time("indexLookup"),c=d.indexMatch[0].lookup,b.time("indexLookup"),d.indexMatch[0].keyData.totalKeyCount===d.indexMatch[0].keyData.score&&(f=!1)):b.flag("usedIndex",!1);f&&(c&&c.length?(d=c.length,b.time("tableScan: "+d),c=c.filter(q)):(d=this._data.length,b.time("tableScan: "+d),c=this._data.filter(q)),h.$orderBy&&(b.time("sort"),c=this.sort(h.$orderBy,c),b.time("sort")),b.time("tableScan: "+d));h.limit&&c&&c.length>h.limit&&(c.length=h.limit,b.data("limit",h.limit));h.$decouple&&
(b.time("decouple"),c=this.decouple(c),b.time("decouple"),b.data("flag.decouple",!0));if(h.join){for(q=0;q<h.join.length;q++)for(p in h.join[q])if(h.join[q].hasOwnProperty(p))for(u=p,d=this._db.collection(p),f=h.join[q][p],s=0;s<c.length;s++){t={};n=g=!1;for(m in f)if(f.hasOwnProperty(m))if("$"===m.substr(0,1))switch(m){case "$as":u=f[m];break;case "$multi":g=f[m];break;case "$require":n=f[m];break;default:m.substr(0,3)}else t[m]=(new l(f[m])).value(c[s])[0];t=d.find(t);!n||n&&t[0]?c[s][u]=!1===g?
t[0]:t:v.push(c[s])}b.data("flag.join",!0)}if(v.length){b.time("removalQueue");for(m=0;m<v.length;m++)p=c.indexOf(v[m]),-1<p&&c.splice(p,1);b.time("removalQueue")}if(h.transform){b.time("transform");for(m=0;m<c.length;m++)c.splice(m,1,h.transform(c[m]));b.time("transform");b.data("flag.transform",!0)}this._transformEnabled&&this._transformOut&&(b.time("transformOut"),c=this.transformOut(c),b.time("transformOut"));b.data("results",c.length);b.stop()}else b.stop(),c=[];c.__fdbOp=b;return c};d.prototype.indexOf=
function(a){if(a=this.find(a,{$decouple:!1})[0])return this._data.indexOf(a)};d.prototype.transform=function(a){return void 0!==a?("object"===typeof a?(void 0!==a.enabled&&(this._transformEnabled=a.enabled),void 0!==a.dataIn&&(this._transformIn=a.dataIn),void 0!==a.dataOut&&(this._transformOut=a.dataOut)):this._transformEnabled=!1===a?!1:!0,this):{enabled:this._transformEnabled,dataIn:this._transformIn,dataOut:this._transformOut}};d.prototype.transformIn=function(a){if(this._transformEnabled&&this._transformIn){if(a instanceof
Array){var b=[],e;for(e=0;e<a.length;e++)b[e]=this._transformIn(a[e]);return b}return this._transformIn(a)}return a};d.prototype.transformOut=function(a){if(this._transformEnabled&&this._transformOut){if(a instanceof Array){var b=[],e;for(e=0;e<a.length;e++)b[e]=this._transformOut(a[e]);return b}return this._transformOut(a)}return a};d.prototype.sort=function(a,b){b=b||[];var e=[],d,l;for(d in a)a.hasOwnProperty(d)&&(l={},l[d]=a[d],l.___fdbKey=d,e.push(l));return 2>e.length?this._sort(a,b):this._bucketSort(e,
b)};d.prototype._bucketSort=function(a,b){var e=a.shift(),d,l,f=[];if(0<a.length){b=this._sort(e,b);d=this.bucket(e.___fdbKey,b);for(l in d)d.hasOwnProperty(l)&&(e=[].concat(a),f=f.concat(this._bucketSort(e,d[l])));return f}return this._sort(e,b)};d.prototype._sort=function(a,b){var e=this,d,f=new l;d=f.parse(a,!0)[0];f.path(d.path);if(1===d.value)d=function(a,b){var h=f.value(a)[0],d=f.value(b)[0];return e.sortAsc(h,d)};else if(-1===d.value)d=function(a,b){var h=f.value(a)[0],d=f.value(b)[0];return e.sortDesc(h,
d)};else throw'ForerunnerDB.Collection "'+this.name()+'": $orderBy clause has invalid direction: '+d.value+", accepted values are 1 or -1 for ascending or descending!";return b.sort(d)};d.prototype.bucket=function(a,b){var e,d={};for(e=0;e<b.length;e++)d[b[e][a]]=d[b[e][a]]||[],d[b[e][a]].push(b[e]);return d};d.prototype._analyseQuery=function(a,b,e){var d={queriesOn:[this._name],indexMatch:[],hasJoin:!1,queriesJoin:!1,joinQueries:{},query:a,options:b},f,c=[],q=[],g,n,r,p,m,t;e.time("checkIndexes");
if(m=(new l).countKeys(a)){void 0!==a[this._primaryKey]&&(e.time("checkIndexMatch: Primary Key"),d.indexMatch.push({lookup:this._primaryIndex.lookup(a,b),keyData:{matchedKeys:[this._primaryKey],totalKeyCount:m,score:1},index:this._primaryIndex}),e.time("checkIndexMatch: Primary Key"));for(t in this._indexById)if(this._indexById.hasOwnProperty(t)&&(n=this._indexById[t],r=n.name(),e.time("checkIndexMatch: "+r),g=n.match(a,b),0<g.score&&(p=n.lookup(a,b),d.indexMatch.push({lookup:p,keyData:g,index:n})),
e.time("checkIndexMatch: "+r),g.score===m))break;e.time("checkIndexes");1<d.indexMatch.length&&(e.time("findOptimalIndex"),d.indexMatch.sort(function(a,b){if(a.keyData.score>b.keyData.score)return-1;if(a.keyData.score<b.keyData.score)return 1;if(a.keyData.score===b.keyData.score)return a.lookup.length-b.lookup.length}),e.time("findOptimalIndex"))}if(b.join){d.hasJoin=!0;for(e=0;e<b.join.length;e++)for(f in b.join[e])b.join[e].hasOwnProperty(f)&&(c.push(f),"$as"in b.join[e][f]?q.push(b.join[e][f].$as):
q.push(f));for(f=0;f<q.length;f++)if(b=this._queryReferencesCollection(a,q[f],""))d.joinQueries[c[f]]=b,d.queriesJoin=!0;d.joinsOn=c;d.queriesOn=d.queriesOn.concat(c)}return d};d.prototype._queryReferencesCollection=function(a,b,e){for(var d in a)if(a.hasOwnProperty(d)){if(d===b)return e&&(e+="."),e+d;if("object"===typeof a[d])return e&&(e+="."),e+=d,this._queryReferencesCollection(a[d],b,e)}return!1};d.prototype.count=function(a,b){return a?this.find(a,b).length:this._data.length};d.prototype.findSub=
function(a,b,e,d){var f=new l(b);a=this.find(a);var c=a.length,q,g,n=this._db.collection("__FDB_temp_"+this.objectId()),r={parents:c,subDocTotal:0,subDocs:[],pathFound:!1,err:""};for(q=0;q<c;q++)if(g=f.value(a[q])[0]){n.setData(g);g=n.find(e,d);if(d.returnFirst&&g.length)return g[0];r.subDocs.push(g);r.subDocTotal+=g.length;r.pathFound=!0}n.drop();if(d.noStats)return r.subDocs;r.pathFound||(r.err="No objects found in the parent documents with a matching path of: "+b);return r};d.prototype.insertIndexViolation=
function(a){var b,e=this._indexByName,d,l;if(this._primaryIndex.get(a[this._primaryKey]))b=this._primaryIndex;else for(d in e)if(e.hasOwnProperty(d)&&(l=e[d],l.unique()&&l.violation(a))){b=l;break}return b?b.name():!1};d.prototype.ensureIndex=function(a,b){this._indexByName=this._indexByName||{};this._indexById=this._indexById||{};var d,l={start:(new Date).getTime()};if(b)switch(b.type){case "hashed":d=new e(a,b,this);break;case "btree":d=new f(a,b,this);break;default:d=new e(a,b,this)}else d=new e(a,
b,this);if(this._indexByName[d.name()])return{err:"Index with that name already exists"};if(this._indexById[d.id()])return{err:"Index with those keys already exists"};d.rebuild();this._indexByName[d.name()]=d;this._indexById[d.id()]=d;l.end=(new Date).getTime();l.total=l.end-l.start;this._lastOp={type:"ensureIndex",stats:{time:l}};return{index:d,id:d.id(),name:d.name(),state:d.state()}};d.prototype.index=function(a){if(this._indexByName)return this._indexByName[a]};d.prototype.lastOp=function(){return this._metrics.list()};
d.prototype.diff=function(a){var b={insert:[],update:[],remove:[]},e=this.primaryKey(),d,l,f,c;if(e===a.primaryKey()){for(d=a._data;d&&!(d instanceof Array);)a=d,d=a._data;c=d.length;for(l=0;l<c;l++)f=d[l],this._primaryIndex.get(f[e])?this._primaryCrc.get(f[e])!==a._primaryCrc.get(f[e])&&b.update.push(f):b.insert.push(f);d=this._data;c=d.length;for(l=0;l<c;l++)f=d[l],a._primaryIndex.get(f[e])||b.remove.push(f)}else throw'ForerunnerDB.Collection "'+this.name()+'": Collection diffing requires that both collections have the same primary key!';
return b};c.prototype.collection=function(a,b){if(a)return this._collection[a]||this.debug()&&console.log("Creating collection "+a),this._collection[a]=this._collection[a]||(new d(a)).db(this),void 0!==b&&this._collection[a].primaryKey(b),this._collection[a];throw'ForerunnerDB.Core "'+this.name()+'": Cannot get collection with undefined name!';};c.prototype.collectionExists=function(a){return Boolean(this._collection[a])};c.prototype.collections=function(a){var b=[],e;a&&(a instanceof RegExp||(a=
RegExp(a)));for(e in this._collection)this._collection.hasOwnProperty(e)&&(a?a.exec(e)&&b.push({name:e,count:this._collection[e].count()}):b.push({name:e,count:this._collection[e].count()}));return b};g.finishModule("Collection");n.exports=d},{"./Crc":4,"./IndexBinaryTree":5,"./IndexHashMap":6,"./KeyValueStore":7,"./Metrics":8,"./Path":19,"./Shared":20}],3:[function(c,n,g){var b,a,l;b=c("./Shared");l=c("./Overload");g=function(a){this.init.apply(this,arguments)};g.prototype.init=function(a){this._name=
a;this._collection={};this._debug={}};g.prototype.moduleLoaded=l({string:function(a){if(void 0!==a){a=a.replace(/ /g,"");a=a.split(",");var l;for(l=0;l<a.length;l++)if(!b.modules[a[l]])return!1;return!0}return!1},"string, function":function(a,l){if(void 0!==a){a=a.replace(/ /g,"");var c=a.split(","),d;for(d=0;d<c.length;d++)if(!b.modules[c[d]])return!1;l()}},"string, function, function":function(a,l,c){if(void 0!==a){a=a.replace(/ /g,"");a=a.split(",");var d;for(d=0;d<a.length;d++)if(!b.modules[a[d]])return c(),
!1;l()}}});g.prototype.version=function(a,l){return void 0!==a?0===b.version.indexOf(a)?(l&&l(),!0):!1:b.version};g.moduleLoaded=g.prototype.moduleLoaded;g.version=g.prototype.version;g.shared=b;g.prototype.shared=b;b.addModule("Core",g);b.mixin(g.prototype,"Mixin.Common");b.mixin(g.prototype,"Mixin.ChainReactor");b.mixin(g.prototype,"Mixin.Constants");a=c("./Collection.js");c("./Metrics.js");c=c("./Crc.js");g.prototype._isServer=!1;b.synthesize(g.prototype,"state");b.synthesize(g.prototype,"name");
g.prototype.isClient=function(){return!this._isServer};g.prototype.isServer=function(){return this._isServer};g.prototype.crc=c;g.prototype.isClient=function(){return!this._isServer};g.prototype.isServer=function(){return this._isServer};g.prototype.arrayToCollection=function(b){return(new a).setData(b)};g.prototype.on=function(a,b){this._listeners=this._listeners||{};this._listeners[a]=this._listeners[a]||[];this._listeners[a].push(b);return this};g.prototype.off=function(a,b){if(a in this._listeners){var l=
this._listeners[a],d=l.indexOf(b);-1<d&&l.splice(d,1)}return this};g.prototype.emit=function(a,b){this._listeners=this._listeners||{};if(a in this._listeners){var l=this._listeners[a],d=l.length,c;for(c=0;c<d;c++)l[c].apply(this,Array.prototype.slice.call(arguments,1))}return this};g.prototype.peek=function(a){var b,l,d=[],c=typeof a;for(b in this._collection)this._collection.hasOwnProperty(b)&&(l=this._collection[b],d="string"===c?d.concat(l.peek(a)):d.concat(l.find(a)));return d};g.prototype.peekCat=
function(a){var b,l,d={},c,h=typeof a;for(b in this._collection)this._collection.hasOwnProperty(b)&&(l=this._collection[b],(c="string"===h?l.peek(a):l.find(a))&&c.length&&(d[l.name()]=c));return d};g.prototype.drop=function(a){if("dropped"!==this._state){var b=this.collections(),l=b.length,d,c=0;this._state="dropped";for(d=0;d<l;d++)this.collection(b[d].name).drop(function(){c++;c===l&&a&&a()}),delete this._collection[b[d].name];this.emit("drop",this)}return!0};n.exports=g},{"./Collection.js":2,"./Crc.js":4,
"./Metrics.js":8,"./Overload":18,"./Shared":20}],4:[function(c,n,g){var b=function(){var a=[],b,e,f;for(e=0;256>e;e++){b=e;for(f=0;8>f;f++)b=b&1?3988292384^b>>>1:b>>>1;a[e]=b}return a}();n.exports=function(a){var l=-1,e;for(e=0;e<a.length;e++)l=l>>>8^b[(l^a.charCodeAt(e))&255];return(l^-1)>>>0}},{}],5:[function(c,n,g){g=c("./Shared");var b=c("./Path"),a=c("./vendor/btree");c=function(){this.init.apply(this,arguments)};c.prototype.init=function(b,e,f){this._btree=new (a.create(2,this.sortAsc));this._size=
0;this._id=this._itemKeyHash(b,b);this.unique(e&&e.unique?e.unique:!1);void 0!==b&&this.keys(b);void 0!==f&&this.collection(f);this.name(e&&e.name?e.name:this._id)};g.addModule("IndexBinaryTree",c);g.mixin(c.prototype,"Mixin.ChainReactor");g.mixin(c.prototype,"Mixin.Sorting");c.prototype.id=function(){return this._id};c.prototype.state=function(){return this._state};c.prototype.size=function(){return this._size};g.synthesize(c.prototype,"data");g.synthesize(c.prototype,"name");g.synthesize(c.prototype,
"collection");g.synthesize(c.prototype,"type");g.synthesize(c.prototype,"unique");c.prototype.keys=function(a){return void 0!==a?(this._keys=a,this._keyCount=(new b).parse(this._keys).length,this):this._keys};c.prototype.rebuild=function(){if(this._collection){var b=this._collection.subset({},{$decouple:!1,$orderBy:this._keys}).find(),e,f=b.length;this._btree=new (a.create(2,this.sortAsc));this._unique&&(this._uniqueLookup={});for(e=0;e<f;e++)this.insert(b[e])}this._state={name:this._name,keys:this._keys,
indexSize:this._size,built:new Date,updated:new Date,ok:!0}};c.prototype.insert=function(a,b){var f=this._unique,c=this._itemKeyHash(a,this._keys);f&&(f=this._itemHash(a,this._keys),this._uniqueLookup[f]=a);f=this._btree.get(c);void 0===f&&(f=[],this._btree.put(c,f));f.push(a);this._size++};c.prototype.remove=function(a,b){var f=this._unique,c=this._itemKeyHash(a,this._keys),d;f&&(f=this._itemHash(a,this._keys),delete this._uniqueLookup[f]);f=this._btree.get(c);void 0!==f&&(d=f.indexOf(a),-1<d&&(1===
f.length?this._btree.del(c):f.splice(d,1),this._size--))};c.prototype.violation=function(a){a=this._itemHash(a,this._keys);return Boolean(this._uniqueLookup[a])};c.prototype.hashViolation=function(a){return Boolean(this._uniqueLookup[a])};c.prototype.lookup=function(a){return this._data[this._itemHash(a,this._keys)]||[]};c.prototype.match=function(a,e){var f=new b,c=f.parseArr(this._keys),f=f.parseArr(a),d=[],k=0,h;for(h=0;h<c.length;h++)if(f[h]===c[h])k++,d.push(f[h]);else return{matchedKeys:[],
totalKeyCount:f.length,score:0};return{matchedKeys:d,totalKeyCount:f.length,score:k}};c.prototype._itemHash=function(a,e){var f=new b,c,d="",k;c=f.parse(e);for(k=0;k<c.length;k++)d&&(d+="_"),d+=f.value(a,c[k].path).join(":");return d};c.prototype._itemKeyHash=function(a,e){var f=new b,c,d="",k;c=f.parse(e);for(k=0;k<c.length;k++)d&&(d+="_"),d+=f.keyValue(a,c[k].path);return d};c.prototype._itemHashArr=function(a,e){var f=new b,c,d=[],k,h,g,n;c=f.parse(e);for(g=0;g<c.length;g++)for(k=f.value(a,c[g].path),
h=0;h<k.length;h++)if(0===g)d.push(k[h]);else for(n=0;n<d.length;n++)d[n]=d[n]+"_"+k[h];return d};g.finishModule("IndexBinaryTree");n.exports=c},{"./Path":19,"./Shared":20,"./vendor/btree":21}],6:[function(c,n,g){g=c("./Shared");var b=c("./Path");c=function(){this.init.apply(this,arguments)};c.prototype.init=function(a,b,e){this._crossRef={};this._size=0;this._id=this._itemKeyHash(a,a);this.data({});this.unique(b&&b.unique?b.unique:!1);void 0!==a&&this.keys(a);void 0!==e&&this.collection(e);this.name(b&&
b.name?b.name:this._id)};g.addModule("IndexHashMap",c);g.mixin(c.prototype,"Mixin.ChainReactor");c.prototype.id=function(){return this._id};c.prototype.state=function(){return this._state};c.prototype.size=function(){return this._size};g.synthesize(c.prototype,"data");g.synthesize(c.prototype,"name");g.synthesize(c.prototype,"collection");g.synthesize(c.prototype,"type");g.synthesize(c.prototype,"unique");c.prototype.keys=function(a){return void 0!==a?(this._keys=a,this._keyCount=(new b).parse(this._keys).length,
this):this._keys};c.prototype.rebuild=function(){if(this._collection){var a=this._collection.subset({},{$decouple:!1,$orderBy:this._keys}).find(),b,e=a.length;this._data={};this._unique&&(this._uniqueLookup={});for(b=0;b<e;b++)this.insert(a[b])}this._state={name:this._name,keys:this._keys,indexSize:this._size,built:new Date,updated:new Date,ok:!0}};c.prototype.insert=function(a,b){var e,f;this._unique&&(e=this._itemHash(a,this._keys),this._uniqueLookup[e]=a);e=this._itemHashArr(a,this._keys);for(f=
0;f<e.length;f++)this.pushToPathValue(e[f],a)};c.prototype.remove=function(a,b){var e,f;this._unique&&(e=this._itemHash(a,this._keys),delete this._uniqueLookup[e]);e=this._itemHashArr(a,this._keys);for(f=0;f<e.length;f++)this.pullFromPathValue(e[f],a)};c.prototype.violation=function(a){a=this._itemHash(a,this._keys);return Boolean(this._uniqueLookup[a])};c.prototype.hashViolation=function(a){return Boolean(this._uniqueLookup[a])};c.prototype.pushToPathValue=function(a,b){var e=this._data[a]=this._data[a]||
[];-1===e.indexOf(b)&&(e.push(b),this._size++,this.pushToCrossRef(b,e))};c.prototype.pullFromPathValue=function(a,b){var e=this._data[a],f;f=e.indexOf(b);-1<f&&(e.splice(f,1),this._size--,this.pullFromCrossRef(b,e));e.length||delete this._data[a]};c.prototype.pull=function(a){var b=a[this._collection.primaryKey()],e=this._crossRef[b],f,c=e.length,d;for(f=0;f<c;f++)d=e[f],this._pullFromArray(d,a);this._size--;delete this._crossRef[b]};c.prototype._pullFromArray=function(a,b){for(var e=a.length;e--;)a[e]===
b&&a.splice(e,1)};c.prototype.pushToCrossRef=function(a,b){var e=a[this._collection.primaryKey()];this._crossRef[e]=this._crossRef[e]||[];e=this._crossRef[e];-1===e.indexOf(b)&&e.push(b)};c.prototype.pullFromCrossRef=function(a,b){var e=a[this._collection.primaryKey()];delete this._crossRef[e]};c.prototype.lookup=function(a){return this._data[this._itemHash(a,this._keys)]||[]};c.prototype.match=function(a,l){var e=new b,f=e.parseArr(this._keys),e=e.parseArr(a),c=[],d=0,k;for(k=0;k<f.length;k++)if(e[k]===
f[k])d++,c.push(e[k]);else return{matchedKeys:[],totalKeyCount:e.length,score:0};return{matchedKeys:c,totalKeyCount:e.length,score:d}};c.prototype._itemHash=function(a,l){var e=new b,f,c="",d;f=e.parse(l);for(d=0;d<f.length;d++)c&&(c+="_"),c+=e.value(a,f[d].path).join(":");return c};c.prototype._itemKeyHash=function(a,l){var e=new b,f,c="",d;f=e.parse(l);for(d=0;d<f.length;d++)c&&(c+="_"),c+=e.keyValue(a,f[d].path);return c};c.prototype._itemHashArr=function(a,l){var e=new b,f,c=[],d,k,h,g;f=e.parse(l);
for(h=0;h<f.length;h++)for(d=e.value(a,f[h].path),k=0;k<d.length;k++)if(0===h)c.push(d[k]);else for(g=0;g<c.length;g++)c[g]=c[g]+"_"+d[k];return c};g.finishModule("IndexHashMap");n.exports=c},{"./Path":19,"./Shared":20}],7:[function(c,n,g){c=c("./Shared");g=function(b){this.init.apply(this,arguments)};g.prototype.init=function(b){this._name=b;this._data={};this._primaryKey="_id"};c.addModule("KeyValueStore",g);c.mixin(g.prototype,"Mixin.ChainReactor");c.synthesize(g.prototype,"name");g.prototype.primaryKey=
function(b){return void 0!==b?(this._primaryKey=b,this):this._primaryKey};g.prototype.truncate=function(){this._data={};return this};g.prototype.set=function(b,a){this._data[b]=a?a:!0;return this};g.prototype.get=function(b){return this._data[b]};g.prototype.lookup=function(b){b=b[this._primaryKey];var a,l,e,f;if(b instanceof Array){l=b.length;f=[];for(a=0;a<l;a++)(e=this._data[b[a]])&&f.push(e);return f}if(b instanceof RegExp){f=[];for(a in this._data)this._data.hasOwnProperty(a)&&b.test(a)&&f.push(this._data[a]);
return f}if("object"===typeof b){if(b.$ne){f=[];for(a in this._data)this._data.hasOwnProperty(a)&&a!==b.$ne&&f.push(this._data[a]);return f}if(b.$in&&b.$in instanceof Array){f=[];for(a in this._data)this._data.hasOwnProperty(a)&&-1<b.$in.indexOf(a)&&f.push(this._data[a]);return f}if(b.$nin&&b.$nin instanceof Array){f=[];for(a in this._data)this._data.hasOwnProperty(a)&&-1===b.$nin.indexOf(a)&&f.push(this._data[a]);return f}if(b.$or&&b.$or instanceof Array){f=[];for(a=0;a<b.$or.length;a++)f=f.concat(this.lookup(b.$or[a]));
return f}}else return e=this._data[b],void 0!==e?[e]:[]};g.prototype.unSet=function(b){delete this._data[b];return this};g.prototype.uniqueSet=function(b,a){return void 0===this._data[b]?(this._data[b]=a,!0):!1};c.finishModule("KeyValueStore");n.exports=g},{"./Shared":20}],8:[function(c,n,g){g=c("./Shared");var b=c("./Operation");c=function(){this.init.apply(this,arguments)};c.prototype.init=function(){this._data=[]};g.addModule("Metrics",c);g.mixin(c.prototype,"Mixin.ChainReactor");c.prototype.create=
function(a){a=new b(a);this._enabled&&this._data.push(a);return a};c.prototype.start=function(){this._enabled=!0;return this};c.prototype.stop=function(){this._enabled=!1;return this};c.prototype.clear=function(){this._data=[];return this};c.prototype.list=function(){return this._data};g.finishModule("Metrics");n.exports=c},{"./Operation":17,"./Shared":20}],9:[function(c,n,g){n.exports={preSetData:function(){},postSetData:function(){}}},{}],10:[function(c,n,g){n.exports={chain:function(b){this._chain=
this._chain||[];-1===this._chain.indexOf(b)&&this._chain.push(b)},unChain:function(b){this._chain&&(b=this._chain.indexOf(b),-1<b&&this._chain.splice(b,1))},chainSend:function(b,a,l){if(this._chain){var e=this._chain,f=e.length,c;for(c=0;c<f;c++)e[c].chainReceive(this,b,a,l)}},chainReceive:function(b,a,l,e){b={sender:b,type:a,data:l,options:e};(!this._chainHandler||this._chainHandler&&!this._chainHandler(b))&&this.chainSend(b.type,b.data,b.options)}}},{}],11:[function(c,n,g){var b=0;c={decouple:function(a,
b){if(void 0!==a){if(b){var e,f=JSON.stringify(a),c=[];for(e=0;e<b;e++)c.push(JSON.parse(f));return c}return JSON.parse(JSON.stringify(a))}},objectId:function(a){var c=Math.pow(10,17);if(a){var e=0,f=a.length,g;for(g=0;g<f;g++)e+=a.charCodeAt(g)*c;a=e.toString(16)}else b++,a=(b+(Math.random()*c+Math.random()*c+Math.random()*c+Math.random()*c)).toString(16);return a},debug:c("./Overload")([function(){return this._debug&&this._debug.all},function(a){return void 0!==a?"boolean"===typeof a?(this._debug=
this._debug||{},this._debug.all=a,this.chainSend("debug",this._debug),this):this._debug&&this._debug[a]||this._db&&this._db._debug&&this._db._debug[a]||this._debug&&this._debug.all:this._debug&&this._debug.all},function(a,b){return void 0!==a?void 0!==b?(this._debug=this._debug||{},this._debug[a]=b,this.chainSend("debug",this._debug),this):this._debug&&this._debug[b]||this._db&&this._db._debug&&this._db._debug[a]:this._debug&&this._debug.all}])};n.exports=c},{"./Overload":18}],12:[function(c,n,g){n.exports=
{TYPE_INSERT:0,TYPE_UPDATE:1,TYPE_REMOVE:2,PHASE_BEFORE:0,PHASE_AFTER:1}},{}],13:[function(c,n,g){c={on:new Overload({"string, function":function(b,a){this._listeners=this._listeners||{};this._listeners[b]=this._listeners[b]||{};this._listeners[b]["*"]=this._listeners[b]["*"]||[];this._listeners[b]["*"].push(a);return this},"string, *, function":function(b,a,c){this._listeners=this._listeners||{};this._listeners[b]=this._listeners[b]||{};this._listeners[b][a]=this._listeners[b][a]||[];this._listeners[b][a].push(c);
return this}}),off:new Overload({string:function(b){this._listeners&&this._listeners[b]&&b in this._listeners&&delete this._listeners[b];return this},"string, function":function(b,a){var c,e;"string"===typeof a?this._listeners&&this._listeners[b]&&this._listeners[b][a]&&delete this._listeners[b][a]:b in this._listeners&&(c=this._listeners[b]["*"],e=c.indexOf(a),-1<e&&c.splice(e,1));return this},"string, *, function":function(b,a,c){this._listeners&&b in this._listeners&&a in this.listeners[b]&&(b=
this._listeners[b][a],c=b.indexOf(c),-1<c&&b.splice(c,1))},"string, *":function(b,a){this._listeners&&b in this._listeners&&a in this._listeners[b]&&delete this._listeners[b][a]}}),emit:function(b,a){this._listeners=this._listeners||{};if(b in this._listeners){if(this._listeners[b]["*"]){var c=this._listeners[b]["*"],e=c.length,f;for(f=0;f<e;f++)c[f].apply(this,Array.prototype.slice.call(arguments,1))}if(a instanceof Array&&a[0]&&a[0][this._primaryKey]){var c=this._listeners[b],g,d,e=a.length;for(f=
0;f<e;f++)if(c[a[f][this._primaryKey]])for(g=c[a[f][this._primaryKey]].length,d=0;d<g;d++)c[a[f][this._primaryKey]][d].apply(this,Array.prototype.slice.call(arguments,1))}}return this}};n.exports=c},{}],14:[function(c,n,g){n.exports={_match:function(b,a,c){var e,f;e=typeof b;f=typeof a;var g=!0,d;if(!("string"!==e&&"number"!==e||"string"!==f&&"number"!==f))b!==a&&(g=!1);else for(d in a)if(a.hasOwnProperty(d)){e=!1;if("$"===d.substr(0,1)&&(f=this._matchOp(d,b,a[d]),-1<f)){if(f){if("or"===c)return!0}else g=
f;e=!0}if(!e&&a[d]instanceof RegExp)if(e=!0,"object"===typeof b&&void 0!==b[d]&&a[d].test(b[d])){if("or"===c)return!0}else g=!1;if(!e)if("object"===typeof a[d])if(void 0!==b[d]){if(b[d]instanceof Array&&!(a[d]instanceof Array))for(e=!1,f=0;f<b[d].length&&!(e=this._match(b[d][f],a[d],void 0));f++);else if(!(b[d]instanceof Array)&&a[d]instanceof Array)for(e=!1,f=0;f<a[d].length&&!(e=this._match(b[d],a[d][f],void 0));f++);else e="object"===typeof b?this._match(b[d],a[d],void 0):this._match(void 0,a[d],
void 0);if(e){if("or"===c)return!0}else g=!1}else if(a[d]&&void 0!==a[d].$exists)if(e=this._match(void 0,a[d],void 0)){if("or"===c)return!0}else g=!1;else g=!1;else if(b&&b[d]===a[d]){if("or"===c)return!0}else if(b&&b[d]&&b[d]instanceof Array&&a[d]&&"object"!==typeof a[d]){e=!1;for(f=0;f<b[d].length&&!(e=this._match(b[d][f],a[d],void 0));f++);if(e){if("or"===c)return!0}else g=!1}else g=!1;if("and"===c&&!g)return!1}return g},_matchOp:function(b,a,c){switch(b){case "$gt":return a>c;case "$gte":return a>=
c;case "$lt":return a<c;case "$lte":return a<=c;case "$exists":return void 0===a!==c;case "$ne":return a!=c;case "$or":for(b=0;b<c.length;b++)if(this._match(a,c[b],"and"))return!0;return!1;case "$and":for(b=0;b<c.length;b++)if(!this._match(a,c[b],"and"))return!1;return!0;case "$in":if(c instanceof Array){b=c.length;var e;for(e=0;e<b;e++)if(c[e]===a)return!0;return!1}throw'ForerunnerDB.Mixin.Matching "'+this.name()+'": Cannot use an $in operator on a non-array key: '+b;case "$nin":if(c instanceof Array){b=
c.length;for(e=0;e<b;e++)if(c[e]===a)return!1;return!0}throw'ForerunnerDB.Mixin.Matching "'+this.name()+'": Cannot use a $nin operator on a non-array key: '+b;}return-1}}},{}],15:[function(c,n,g){n.exports={sortAsc:function(b,a){return"string"===typeof b&&"string"===typeof a?b.localeCompare(a):b>a?1:b<a?-1:0},sortDesc:function(b,a){return"string"===typeof b&&"string"===typeof a?a.localeCompare(b):b>a?-1:b<a?1:0}}},{}],16:[function(c,n,g){n.exports={addTrigger:function(b,a,c,e){return-1===this._triggerIndex(b,
a,c)?(this._trigger=this._trigger||{},this._trigger[a]=this._trigger[a]||{},this._trigger[a][c]=this._trigger[a][c]||[],this._trigger[a][c].push({id:b,method:e}),!0):!1},removeTrigger:function(b,a,c){b=this._triggerIndex(b,a,c);-1<b&&this._trigger[a][c].splice(b,1);return!1},willTrigger:function(b,a){return this._trigger&&this._trigger[b]&&this._trigger[b][a]&&this._trigger[b][a].length},processTrigger:function(b,a,c,e,f){var g,d;if(this._trigger&&this._trigger[a]&&this._trigger[a][c]){a=this._trigger[a][c];
g=a.length;for(c=0;c<g;c++){d=a[c];this.debug();d=d.method.call(this,b,e,f);if(!1===d)return!1;if(void 0!==d&&!0!==d&&!1!==d)throw"ForerunnerDB.Mixin.Triggers: Trigger error: "+d;}return!0}},_triggerIndex:function(b,a,c){var e;if(this._trigger&&this._trigger[a]&&this._trigger[a][c])for(a=this._trigger[a][c],c=a.length,e=0;e<c;e++)if(a[e].id===b)return e;return-1}}},{}],17:[function(c,n,g){g=c("./Shared");var b=c("./Path");c=function(a){this.pathSolver=new b;this.counter=0;this.init.apply(this,arguments)};
c.prototype.init=function(a){this._data={operation:a,index:{potential:[],used:!1},steps:[],time:{startMs:0,stopMs:0,totalMs:0,process:{}},flag:{},log:[]}};g.addModule("Operation",c);g.mixin(c.prototype,"Mixin.ChainReactor");c.prototype.start=function(){this._data.time.startMs=(new Date).getTime()};c.prototype.log=function(a){if(a){var b=0<this._log.length?this._data.log[this._data.log.length-1].time:0;a={event:a,time:(new Date).getTime(),delta:0};this._data.log.push(a);b&&(a.delta=a.time-b);return this}return this._data.log};
c.prototype.time=function(a){if(void 0!==a){var b=this._data.time.process,b=b[a]=b[a]||{};b.startMs?(b.stopMs=(new Date).getTime(),b.totalMs=b.stopMs-b.startMs,b.stepObj.totalMs=b.totalMs,delete b.stepObj):(b.startMs=(new Date).getTime(),b.stepObj={name:a},this._data.steps.push(b.stepObj));return this}return this._data.time};c.prototype.flag=function(a,b){if(void 0!==a&&void 0!==b)this._data.flag[a]=b;else return void 0!==a?this._data.flag[a]:this._data.flag};c.prototype.data=function(a,b,e){return void 0!==
b?(this.pathSolver.set(this._data,a,b),this):this.pathSolver.get(this._data,a)};c.prototype.pushData=function(a,b,e){this.pathSolver.push(this._data,a,b)};c.prototype.stop=function(){this._data.time.stopMs=(new Date).getTime();this._data.time.totalMs=this._data.time.stopMs-this._data.time.startMs};g.finishModule("Operation");n.exports=c},{"./Path":19,"./Shared":20}],18:[function(c,n,g){Overload=function(b){if(b){var a,c,e,f,g;if(!(b instanceof Array)){e={};for(a in b)if(b.hasOwnProperty(a))if(f=a.replace(/ /g,
""),-1===f.indexOf("*"))e[f]=b[a];else for(g=generateSignaturePermutations(f),f=0;f<g.length;f++)e[g[f]]||(e[g[f]]=b[a]);b=e}return function(){if(b instanceof Array)for(c=b.length,a=0;a<c;a++){if(b[a].length===arguments.length)return b[a].apply(this,arguments)}else{var d=[],e;for(a=0;a<arguments.length;a++)e=typeof arguments[a],"object"===e&&arguments[a]instanceof Array&&(e="array"),d.push(e);e=d.join(",");if(b[e])return b[e].apply(this,arguments);for(a=d.length;0<=a;a--)if(e=d.slice(0,a).join(","),
b[e+",..."])return b[e+",..."].apply(this,arguments)}throw'ForerunnerDB.Overload "'+this.name()+'": Overloaded method does not have a matching signature for the passed arguments: '+JSON.stringify(d);}}return function(){}};generateSignaturePermutations=function(b){var a=[],c,e=["string","object","number","function","undefined"],f;if(-1<b.indexOf("*"))for(f=0;f<e.length;f++)c=b.replace("*",e[f]),a=a.concat(generateSignaturePermutations(c));else a.push(b);return a};n.exports=Overload},{}],19:[function(c,
n,g){c=c("./Shared");g=function(b){this.init.apply(this,arguments)};g.prototype.init=function(b){b&&this.path(b)};c.addModule("Path",g);c.mixin(g.prototype,"Mixin.ChainReactor");g.prototype.path=function(b){return void 0!==b?(this._path=this.clean(b),this._pathParts=this._path.split("."),this):this._path};g.prototype.hasObjectPaths=function(b,a){var c=!0,e;for(e in b)if(b.hasOwnProperty(e)&&(void 0===a[e]||"object"===typeof b[e]&&(c=this.hasObjectPaths(b[e],a[e]),!c)))return!1;return c};g.prototype.countKeys=
function(b){var a=0,c;for(c in b)b.hasOwnProperty(c)&&void 0!==b[c]&&("object"!==typeof b[c]?a++:a+=this.countKeys(b[c]));return a};g.prototype.countObjectPaths=function(b,a){var c,e={},f=0,g=0,d;for(d in a)a.hasOwnProperty(d)&&("object"===typeof a[d]?(c=this.countObjectPaths(b[d],a[d]),e[d]=c.matchedKeys,g+=c.totalKeyCount,f+=c.matchedKeyCount):(g++,b&&b[d]&&"object"!==typeof b[d]?(e[d]=!0,f++):e[d]=!1));return{matchedKeys:e,matchedKeyCount:f,totalKeyCount:g}};g.prototype.parse=function(b,a){var c=
[],e="",f,g,d;for(g in b)if(b.hasOwnProperty(g))if(e=g,"object"===typeof b[g])if(a)for(f=this.parse(b[g],a),d=0;d<f.length;d++)c.push({path:e+"."+f[d].path,value:f[d].value});else for(f=this.parse(b[g]),d=0;d<f.length;d++)c.push({path:e+"."+f[d].path});else a?c.push({path:e,value:b[g]}):c.push({path:e});return c};g.prototype.parseArr=function(b,a){a=a||{};return this._parseArr(b,"",[],a)};g.prototype._parseArr=function(b,a,c,e){var f,g="";a=a||"";c=c||[];for(f in b)b.hasOwnProperty(f)&&(!e.ignore||
e.ignore&&!e.ignore.test(f))&&(g=a?a+"."+f:f,"object"===typeof b[f]?this._parseArr(b[f],g,c,e):c.push(g));return c};g.prototype.value=function(b,a){if(void 0!==b&&"object"===typeof b){var c,e,f,g,d=[],k;void 0!==a&&(a=this.clean(a),c=a.split("."));c=c||this._pathParts;e=c.length;f=b;for(k=0;k<e;k++){f=f[c[k]];if(g instanceof Array){for(e=0;e<g.length;e++)d=d.concat(this.value(g,e+"."+c[k]));return d}if(!f||"object"!==typeof f)break;g=f}return[f]}return[]};g.prototype.set=function(b,a,c){if(void 0!==
b&&void 0!==a){var e;a=this.clean(a);a=a.split(".");e=a.shift();a.length?(b[e]=b[e]||{},this.set(b[e],a.join("."),c)):b[e]=c}return b};g.prototype.get=function(b,a){return this.value(b,a)[0]};g.prototype.push=function(b,a,c){if(void 0!==b&&void 0!==a){var e;a=this.clean(a);a=a.split(".");e=a.shift();if(a.length)b[e]=b[e]||{},this.set(b[e],a.join("."),c);else if(b[e]=b[e]||[],b[e]instanceof Array)b[e].push(c);else throw"ForerunnerDB.Path: Cannot push to a path whose endpoint is not an array!";}return b};
g.prototype.keyValue=function(b,a){var c,e,f,g,d;void 0!==a&&(a=this.clean(a),c=a.split("."));c=c||this._pathParts;e=c.length;f=b;for(d=0;d<e;d++)if(f=f[c[d]],!f||"object"!==typeof f){g=c[d]+":"+f;break}return g};g.prototype.clean=function(b){"."===b.substr(0,1)&&(b=b.substr(1,b.length-1));return b};c.finishModule("Path");n.exports=g},{"./Shared":20}],20:[function(c,n,g){c={version:"1.3.4",modules:{},_synth:{},addModule:function(b,a){this.modules[b]=a;this.emit("moduleLoad",[b,a])},finishModule:function(b){if(this.modules[b])this.modules[b]._fdbFinished=
!0,this.emit("moduleFinished",[b,this.modules[b]]);else throw"ForerunnerDB.Shared: finishModule called on a module that has not been registered with addModule(): "+b;},moduleFinished:function(b,a){if(this.modules[b]&&this.modules[b]._fdbFinished)a(b,this.modules[b]);else this.on("moduleFinished",a)},moduleExists:function(b){return Boolean(this.modules[b])},mixin:function(b,a){var c=this.mixins[a];if(c)for(var e in c)c.hasOwnProperty(e)&&(b[e]=c[e]);else throw"ForerunnerDB.Shared: Cannot find mixin named: "+
a;},synthesize:function(b,a,c){this._synth[a]=this._synth[a]||function(b){return void 0!==b?(this["_"+a]=b,this):this["_"+a]};if(c){var e=this;b[a]=function(){var b=this.$super,g;this.$super=e._synth[a];g=c.apply(this,arguments);this.$super=b;return g}}else b[a]=this._synth[a]},overload:c("./Overload"),mixins:{"Mixin.Common":c("./Mixin.Common"),"Mixin.Events":c("./Mixin.Events"),"Mixin.ChainReactor":c("./Mixin.ChainReactor"),"Mixin.CRUD":c("./Mixin.CRUD"),"Mixin.Constants":c("./Mixin.Constants"),
"Mixin.Triggers":c("./Mixin.Triggers"),"Mixin.Sorting":c("./Mixin.Sorting"),"Mixin.Matching":c("./Mixin.Matching")}};c.mixin(c,"Mixin.Events");n.exports=c},{"./Mixin.CRUD":9,"./Mixin.ChainReactor":10,"./Mixin.Common":11,"./Mixin.Constants":12,"./Mixin.Events":13,"./Mixin.Matching":14,"./Mixin.Sorting":15,"./Mixin.Triggers":16,"./Overload":18}],21:[function(c,n,g){c=function(){function b(a){for(var b=[],c=0;c<arguments.length;c++)b=b.concat(arguments[c]);return b}var a={strcmp:function(a,b){for(var c,
g,d=0;d<a.length;d++){if(d>=b.length)return 1;if((c=a.charCodeAt(d))<(g=b.charCodeAt(d)))return-1;if(c>g)return 1}return a.length==b.length?0:-1},numcmp:function(a,b){return a<b?-1:a>b?1:0},create:function(c,e){function f(){this.root=new d(this)}c="undefined"==typeof c?52:"number"==typeof c?Math.floor(c):parseInt(c,10);1>c&&(c=1);var g=1<c?Math.floor(c/2):1;"function"!=typeof e&&(e=a.numcmp);var d=function(a,b,c){this.parent=a;this.leaves=b||[];this.leaves.forEach(function(a){a.parent=this},this);
this.nodes=c||[null];this.nodes.forEach(function(a){null!==a&&(a.parent=this)},this)};d.prototype.search=function(a){if(0<this.leaves.length){var b=this.leaves[0];if(0==e(b.key,a))return{leaf:b,index:0};if(0>e(a,b.key))return null!==this.nodes[0]?this.nodes[0].search(a):{node:this,index:0};for(b=1;b<this.leaves.length;b++){var c=this.leaves[b];if(0==e(c.key,a))return{leaf:c,index:b};if(0>e(a,c.key))break}return null!==this.nodes[b]?this.nodes[b].search(a):{node:this,index:b}}return{node:this,index:0}};
d.prototype.get=function(a){a=this.search(a);if(a.leaf)return a.leaf.value};d.prototype.put=function(a,b,d){var e=this.search(a);if(e.leaf){if("undefined"!==typeof d&&!d)return!1;e.leaf.value=b;return!0}d=e.node;e=e.index;d.leaves.splice(e,0,new k(d,a,b));d.nodes.splice(e+1,0,null);d.leaves.length>c&&d.split();return!0};d.prototype.del=function(a){var b=this.search(a);if(!b.leaf)return!1;a=b.leaf.parent;var b=b.index,c=a.nodes[b];if(null===c)a.leaves.splice(b,1),a.nodes.splice(b,1),a.balance();else{var d=
c.leaves[c.leaves.length-1];c.del(d.key);d.parent=a;a.leaves.splice(b,1,d)}return!0};d.prototype.balance=function(){if(this.parent instanceof f)0==this.leaves.length&&null!==this.nodes[0]&&(this.parent.root=this.nodes[0],this.parent.root.parent=this.parent);else if(!(this.leaves.length>=g)){var a=this.parent.nodes.indexOf(this),c=0<a?this.parent.nodes[a-1]:null,e=this.parent.nodes.length>a+1?this.parent.nodes[a+1]:null,k;if(null!==e&&e.leaves.length>g)k=this.parent.leaves[a],k.parent=this,this.leaves.push(k),
k=e.leaves.shift(),k.parent=this.parent,this.parent.leaves[a]=k,a=e.nodes.shift(),null!==a&&(a.parent=this),this.nodes.push(a);else if(null!==c&&c.leaves.length>g)k=this.parent.leaves[a-1],k.parent=this,this.leaves.unshift(k),k=c.leaves.pop(),k.parent=this.parent,this.parent.leaves[a-1]=k,a=c.nodes.pop(),null!==a&&(a.parent=this),this.nodes.unshift(a);else{if(null!==e)k=this.parent.leaves[a],c=new d(this.parent,b(this.leaves,[k],e.leaves),b(this.nodes,e.nodes)),this.parent.leaves.splice(a,1),this.parent.nodes.splice(a,
2,c);else if(null!==c)k=this.parent.leaves[a-1],c=new d(this.parent,b(c.leaves,[k],this.leaves),b(c.nodes,this.nodes)),this.parent.leaves.splice(a-1,1),this.parent.nodes.splice(a-1,2,c);else throw Error("Internal error: "+this.toString(!0)+" has neither a left nor a right sibling");this.parent.balance()}}};d.prototype.unsplit=function(a,b){a.parent=this;b.parent=this;if(0>e(a.key,this.leaves[0].key))this.leaves.unshift(a),this.nodes.splice(1,0,b);else{for(var d=1;d<this.leaves.length;d++)if(0>e(a.key,
this.leaves[d].key)){this.leaves.splice(d,0,a);this.nodes.splice(d+1,0,b);break}d==this.leaves.length&&(this.leaves.push(a),this.nodes.push(b))}this.leaves.length>c&&this.split()};d.prototype.split=function(){var a=Math.floor(this.leaves.length/2);if(this.parent instanceof f)this.nodes=[new d(this,this.leaves.slice(0,a),this.nodes.slice(0,a+1)),new d(this,this.leaves.slice(a+1),this.nodes.slice(a+1))],this.leaves=[this.leaves[a]];else{var b=this.leaves[a],c=new d(this.parent,this.leaves.slice(a+1),
this.nodes.slice(a+1));this.leaves=this.leaves.slice(0,a);this.nodes=this.nodes.slice(0,a+1);this.parent.unsplit(b,c)}};d.prototype.toString=function(a){for(var b=[],c=0;c<this.leaves.length;c++)b.push(this.leaves[c].key);b="["+b.toString()+"]"+(this.parent instanceof f?":*":":"+this.parent);if(a)for(c=0;c<this.nodes.length;c++)b+=" -> "+this.nodes[c];return b};d.prototype.print=function(a){for(var b="",c=0;c<a;c++)b+=" ";for(c=this.leaves.length-1;0<=c;c--)null!==this.nodes[c+1]&&this.nodes[c+1].print(a+
2),console.log(b+this.leaves[c].key+(this.parent instanceof f?"*":""));null!==this.nodes[0]&&this.nodes[0].print(a+2)};var k=function(a,b,c){this.parent=a;this.key=b;this.value=c};k.prototype.toString=function(){return""+this.key};f.prototype.put=function(a,b,c){if("undefined"===typeof a||null===a)throw Error("Illegal key: "+a);if("undefined"===typeof b)throw Error("Illegal value: "+b);return this.root.put(a,b,c)};f.prototype.get=function(a){if("undefined"===typeof a||null===a)throw Error("Illegal key: "+
a);return this.root.get(a)};f.prototype.del=function(a){if("undefined"===typeof a||null===a)throw Error("Illegal key: "+a);return this.root.del(a)};f.prototype.walkAsc=function(a,b,c){if(0!=this.root.leaves.length){"function"==typeof a?(c=a,a=b=null):"function"==typeof b&&(c=b,b=null);a="undefined"!=typeof a?a:null;b="undefined"!=typeof b?b:null;var d;if(null===a){for(a=this.root;null!==a.nodes[0];)a=a.nodes[0];d=0}else if(d=this.root.search(a),d.leaf)a=d.leaf.parent,d=a.leaves.indexOf(d.leaf);else if(a=
d.node,d=d.index,d>=a.leaves.length){if(a.parent instanceof f)return;d=a.parent.nodes.indexOf(a);if(d>=a.parent.leaves.length)return;a=a.parent}for(;!(null!==b&&0<e(a.leaves[d].key,b)||c(a.leaves[d].key,a.leaves[d].value));)if(null!==a.nodes[d+1])for(a=a.nodes[d+1],d=0;null!==a.nodes[0];)a=a.nodes[0];else if(a.leaves.length>d+1)d++;else{do{if(a.parent instanceof f)return;d=a.parent.nodes.indexOf(a);a=a.parent}while(d>=a.leaves.length)}}};f.prototype.walk=f.prototype.walkAsc;f.prototype.walkDesc=function(a,
b,c){"function"==typeof a?(c=a,a=b=null):"function"==typeof b&&(c=b,b=null);a="undefined"!=typeof a?a:null;b="undefined"!=typeof b?b:null;var d;if(null===b){for(b=this.root;null!==b.nodes[b.nodes.length-1];)b=b.nodes[b.nodes.length-1];d=b.leaves.length-1}else if(d=this.root.search(b),d.leaf)b=d.leaf.parent,d=b.leaves.indexOf(d.leaf);else for(b=d.node,d=d.index-1;0>d;){if(b.parent instanceof f)return;d=b.parent.nodes.indexOf(b)-1;if(0>d)return;b=b.parent}for(;!(null!==a&&0>e(b.leaves[d].key,a)||c(b.leaves[d].key,
b.leaves[d].value));)if(null!==b.nodes[d]){for(b=b.nodes[d];null!==b.nodes[b.nodes.length-1];)b=b.nodes[b.nodes.length-1];d=b.leaves.length-1}else if(0<d)d--;else{do{if(b.parent instanceof f)return;d=b.parent.nodes.indexOf(b)-1;b=b.parent}while(0>d)}};f.prototype.count=function(a,b){var c=0;this.walk("undefined"!=typeof a?a:null,"undefined"!=typeof b?b:null,function(a,b){c++});return c};f.prototype.print=function(){this.root.print(0)};f.prototype.toString=function(){return"Tree("+c+") "+this.root.toString()};
return f}};return a}();n.exports=c},{}]},{},[1])(1)});
