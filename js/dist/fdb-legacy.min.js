!function(y){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=y();else if("function"==typeof define&&define.amd)define([],y);else{var h;"undefined"!=typeof window?h=window:"undefined"!=typeof global?h=global:"undefined"!=typeof self&&(h=self);h.ForerunnerDB=y()}}(function(){return function h(m,k,g){function f(a,b){if(!k[a]){if(!m[a]){var e="function"==typeof require&&require;if(!b&&e)return e(a,!0);if(c)return c(a,!0);e=Error("Cannot find module '"+a+"'");throw e.code="MODULE_NOT_FOUND",
e;}e=k[a]={exports:{}};m[a][0].call(e.exports,function(e){var b=m[a][1][e];return f(b?b:e)},e,e.exports,h,m,k,g)}return k[a].exports}for(var c="function"==typeof require&&require,a=0;a<g.length;a++)f(g[a]);return f}({1:[function(h,m,k){k=h("../lib/Core");h("../lib/CollectionGroup");h("../lib/View");h("../lib/OldView");h("../lib/OldView.Bind");h("../lib/Highcharts");h("../lib/Persist");h("../lib/Document");h("../lib/Overview");m.exports=k},{"../lib/CollectionGroup":4,"../lib/Core":5,"../lib/Document":7,
"../lib/Highcharts":8,"../lib/OldView":13,"../lib/OldView.Bind":12,"../lib/Overview":15,"../lib/Persist":17,"../lib/View":20}],2:[function(h,m,k){m.exports={chain:function(g){this._chain=this._chain||[];-1===this._chain.indexOf(g)&&this._chain.push(g)},unChain:function(g){this._chain&&(g=this._chain.indexOf(g),-1<g&&this._chain.splice(g,1))},chainSend:function(g,f,c){if(this._chain){var a=this._chain,d=a.length,b;for(b=0;b<d;b++)a[b].chainReceive(this,g,f,c)}},chainReceive:function(g,f,c,a){g={sender:g,
type:f,data:c,options:a};(!this._chainHandler||this._chainHandler&&!this._chainHandler(g))&&this.chainSend(g.type,g.data,g.options)}}},{}],3:[function(h,m,k){var g,f,c,a,d;k=h("./Shared");var b=function(e){this.init.apply(this,arguments)};b.prototype.init=function(e){this._primaryKey="_id";this._primaryIndex=new f("primary");this._primaryCrc=new f("primaryCrc");this._crcLookup=new f("crcLookup");this._name=e;this._data=[];this._groups=[];this._metrics=new g;this._linked=0;this._deferQueue={insert:[],
update:[],remove:[],upsert:[]};this._deferThreshold={insert:100,update:100,remove:100,upsert:100};this._deferTime={insert:1,update:1,remove:1,upsert:1};this._subsetOf(this)};k.addModule("Collection",b);k.inherit(b.prototype,k.chainReactor);g=h("./Metrics");f=h("./KeyValueStore");c=h("./Path");a=h("./Index");d=h("./Crc");h=k.modules.Core;b.prototype.debug=k.common.debug;b.prototype.crc=d;k.synthesize(b.prototype,"name");b.prototype.on=k.common.on;b.prototype.off=k.common.off;b.prototype.emit=k.common.emit;
b.prototype.drop=function(){if(this._db&&this._db._collection&&this._name){this.debug()&&console.log("Dropping collection "+this._name);this.emit("drop");delete this._db._collection[this._name];var e=[],r;for(r=0;r<this._groups.length;r++)e.push(this._groups[r]);for(r=0;r<e.length;r++)this._groups[r].removeCollection(this);return!0}return!1};b.prototype.primaryKey=function(e){return void 0!==e?(this._primaryKey!==e&&(this._primaryKey=e,this._primaryIndex.primaryKey(e),this._rebuildPrimaryKeyIndex()),
this):this._primaryKey};b.prototype._onInsert=function(e,r){this.emit("insert",e,r)};b.prototype._onUpdate=function(e){this.emit("update",e)};b.prototype._onRemove=function(e){this.emit("remove",e)};k.synthesize(b.prototype,"db");b.prototype.setData=function(e,r,a){if(e){var b=this._metrics.create("setData");b.start();r=r||{};r.$decouple=void 0!==r.$decouple?r.$decouple:!0;r.$decouple&&(e=this.decouple(e));e instanceof Array||(e=[e]);b.time("transformIn");e=this.transformIn(e);b.time("transformIn");
var c=this._data;this._linked?this.remove():this._data=[];e.length&&(this._linked?this.insert(e):this._data=this._data.concat(e));b.time("Rebuild Primary Key Index");this._rebuildPrimaryKeyIndex(r);b.time("Rebuild Primary Key Index");b.time("Resolve chains");this.chainSend("setData",e,{oldData:c});b.time("Resolve chains");b.stop();this.emit("setData",this._data,c)}a&&a(!1);return this};b.prototype._rebuildPrimaryKeyIndex=function(e){var r=e&&void 0!==e.ensureKeys?e.ensureKeys:!0;e=e&&void 0!==e.violationCheck?
e.violationCheck:!0;var b,a,c,d=this._primaryIndex,f=this._primaryCrc,g=this._crcLookup,h=this._primaryKey,k;d.truncate();f.truncate();g.truncate();b=this._data;for(a=b.length;a--;)if(c=b[a],r&&this._ensurePrimaryKey(c),e){if(!d.uniqueSet(c[h],c))throw"Call to setData failed because your data violates the primary key unique constraint. One or more documents are using the same primary key: "+c[this._primaryKey];}else k=JSON.stringify(c),d.set(c[h],c),f.set(c[h],k),g.set(k,c)};b.prototype._ensurePrimaryKey=
function(e){void 0===e[this._primaryKey]&&(e[this._primaryKey]=this.objectId())};b.prototype.truncate=function(){this.emit("truncate",this._data);this._data.length=0;this.deferEmit("change");return this};b.prototype.upsert=function(e,b){if(e){var a=this._deferQueue.upsert,c=this._deferThreshold.upsert,d={},f;if(e instanceof Array){if(e.length>c){this._deferQueue.upsert=a.concat(e);this.processQueue("upsert",b);return}d=[];for(a=0;a<e.length;a++)d.push(this.upsert(e[a]));b&&b();return d}e[this._primaryKey]?
(f={},f[this._primaryKey]=e[this._primaryKey],this._primaryIndex.lookup(f)[0]?d.op="update":d.op="insert"):d.op="insert";switch(d.op){case "insert":d.result=this.insert(e);break;case "update":d.result=this.update(f,e)}return d}b&&b()};b.prototype.update=function(e,b,a){b=this.decouple(b);b=this.transformIn(b);this.debug()&&console.log('Updating some collection data for collection "'+this.name()+'"');var c=this,d=this._metrics.create("update"),f=this._primaryKey,g,h,k=function(d){if(b&&void 0!==b[f]&&
b[f]!=d[f]){c._primaryIndex.unSet(d[f]);var g=c._updateObject(d,b,e,a,"");if(c._primaryIndex.uniqueSet(d[f],d))return g;throw"Primary key violation in update! Key violated: "+d[f];}return c._updateObject(d,b,e,a,"")};d.start();d.time("Retrieve documents to update");g=this.find(e,{$decouple:!1});d.time("Retrieve documents to update");g.length&&(d.time("Update documents"),h=g.filter(k),d.time("Update documents"),h.length&&(d.time("Resolve chains"),this.chainSend("update",{query:e,update:b},a),d.time("Resolve chains"),
this._onUpdate(h),this.deferEmit("change",{type:"update",data:h})));d.stop();return h||[]};b.prototype.updateById=function(e,b){var a={};a[this._primaryKey]=e;return this.update(a,b)};b.prototype._updateObject=function(e,b,a,d,f,g){b=this.decouple(b);f=f||"";"."===f.substr(0,1)&&(f=f.substr(1,f.length-1));var h=!1,k=!1,q,p,n,l;for(l in b)if(b.hasOwnProperty(l)){q=!1;if("$"===l.substr(0,1))switch(l){case "$index":break;default:q=!0,(k=this._updateObject(e,b[l],a,d,f,l))&&(h=!0)}if(this._isPositionalKey(l)&&
(q=!0,l=l.substr(0,l.length-2),k=new c(f+"."+l),e[l]&&e[l]instanceof Array&&e[l].length)){p=[];for(n=0;n<e[l].length;n++)this._match(e[l][n],k.value(a)[0])&&p.push(n);for(n=0;n<p.length;n++)(k=this._updateObject(e[l][p[n]],b[l+".$"],a,d,f+"."+l,g))&&(h=!0)}if(!q)if(g||"object"!==typeof b[l])switch(g){case "$inc":this._updateIncrement(e,l,b[l]);h=!0;break;case "$push":void 0===e[l]&&(e[l]=[]);if(e[l]instanceof Array){if(void 0!==b[l].$position&&b[l].$each instanceof Array)for(k=b[l].$position,q=b[l].$each.length,
n=0;n<q;n++)this._updateSplicePush(e[l],k+n,b[l].$each[n]);else if(b[l].$each instanceof Array)for(q=b[l].$each.length,n=0;n<q;n++)this._updatePush(e[l],b[l].$each[n]);else this._updatePush(e[l],b[l]);h=!0}else throw"Cannot push to a key that is not an array! ("+l+")";break;case "$pull":if(e[l]instanceof Array){p=[];for(n=0;n<e[l].length;n++)this._match(e[l][n],b[l])&&p.push(n);for(q=p.length;q--;)this._updatePull(e[l],p[q]),h=!0}break;case "$pullAll":if(e[l]instanceof Array)if(b[l]instanceof Array){if(p=
e[l],q=p.length,0<q)for(;q--;){for(k=0;k<b[l].length;k++)p[q]===b[l][k]&&(this._updatePull(e[l],q),q--,h=!0);if(0>q)break}}else throw"Cannot pullAll without being given an array of values to pull! ("+l+")";break;case "$addToSet":void 0===e[l]&&(e[l]=[]);if(e[l]instanceof Array){n=e[l];var m;p=n.length;var t;q=!0;m=d&&d.$addToSet;var s;m&&m.key?(k=!1,s=new c(m.key),t=s.value(b[l])[0]):(t=JSON.stringify(b[l]),k=!0);for(m=0;m<p;m++)if(k){if(JSON.stringify(n[m])===t){q=!1;break}}else if(t===s.value(n[m])[0]){q=
!1;break}q&&(this._updatePush(e[l],b[l]),h=!0)}else throw"Cannot addToSet on a key that is not an array! (undefined)!";break;case "$splicePush":void 0===e[l]&&(e[l]=[]);if(e[l]instanceof Array)if(k=b.$index,void 0!==k)delete b.$index,k>e[l].length&&(k=e[l].length),this._updateSplicePush(e[l],k,b[l]),h=!0;else throw"Cannot splicePush without a $index integer value!";else throw"Cannot splicePush with a key that is not an array! ("+l+")";break;case "$move":if(e[l]instanceof Array)for(n=0;n<e[l].length;n++){if(this._match(e[l][n],
b[l])){h=b[l].$index;if(void 0!==h)this._updateSpliceMove(e[l],n,h),h=!0;else throw"Cannot move without a $index integer value!";break}}else throw"Cannot move on a key that is not an array! ("+l+")";break;case "$mul":this._updateMultiply(e,l,b[l]);h=!0;break;case "$rename":this._updateRename(e,l,b[l]);h=!0;break;case "$unset":this._updateUnset(e,l);h=!0;break;case "$pop":if(e[l]instanceof Array)this._updatePop(e[l],b[l])&&(h=!0);else throw"Cannot pop from a key that is not an array! ("+l+")";break;
default:e[l]!==b[l]&&(this._updateProperty(e,l,b[l]),h=!0)}else if(null!==e[l]&&"object"===typeof e[l])if(n=e[l]instanceof Array,p=b[l]instanceof Array,n||p)if(!p&&n)for(n=0;n<e[l].length;n++)(k=this._updateObject(e[l][n],b[l],a,d,f+"."+l,g))&&(h=!0);else e[l]!==b[l]&&(this._updateProperty(e,l,b[l]),h=!0);else(k=this._updateObject(e[l],b[l],a,d,f+"."+l,g))&&(h=!0);else e[l]!==b[l]&&(this._updateProperty(e,l,b[l]),h=!0)}return h};b.prototype._isPositionalKey=function(e){return".$"===e.substr(e.length-
2,2)};b.prototype._updateProperty=function(e,b,a){this._linked?(jQuery.observable(e).setProperty(b,a),this.debug()&&console.log('ForerunnerDB.Collection: Setting data-bound document property "'+b+'" for collection "'+this.name()+'"')):(e[b]=a,this.debug()&&console.log('ForerunnerDB.Collection: Setting non-data-bound document property "'+b+'" for collection "'+this.name()+'"'))};b.prototype._updateIncrement=function(e,b,a){this._linked?jQuery.observable(e).setProperty(b,e[b]+a):e[b]+=a};b.prototype._updateSpliceMove=
function(e,b,a){this._linked?(jQuery.observable(e).move(b,a),this.debug()&&console.log('ForerunnerDB.Collection: Moving data-bound document array index from "'+b+'" to "'+a+'" for collection "'+this.name()+'"')):(e.splice(a,0,e.splice(b,1)[0]),this.debug()&&console.log('ForerunnerDB.Collection: Moving non-data-bound document array index from "'+b+'" to "'+a+'" for collection "'+this.name()+'"'))};b.prototype._updateSplicePush=function(e,b,a){e.length>b?this._linked?jQuery.observable(e).insert(b,a):
e.splice(b,0,a):this._linked?jQuery.observable(e).insert(a):e.push(a)};b.prototype._updatePush=function(e,b){this._linked?jQuery.observable(e).insert(b):e.push(b)};b.prototype._updatePull=function(e,b){this._linked?jQuery.observable(e).remove(b):e.splice(b,1)};b.prototype._updateMultiply=function(e,b,a){this._linked?jQuery.observable(e).setProperty(b,e[b]*a):e[b]*=a};b.prototype._updateRename=function(e,b,a){var d=e[b];this._linked?(jQuery.observable(e).setProperty(a,d),jQuery.observable(e).removeProperty(b)):
(e[a]=d,delete e[b])};b.prototype._updateUnset=function(e,b){this._linked?jQuery.observable(e).removeProperty(b):delete e[b]};b.prototype._updatePop=function(e,b){var a,d=!1;0<e.length&&(this._linked?(1===b?a=e.length-1:-1===b&&(a=0),-1<a&&(jQuery.observable(arr).remove(a),d=!0)):1===b?(e.pop(),d=!0):-1===b&&(e.shift(),d=!0));return d};b.prototype.remove=function(e,b,a){var d,c;if(e instanceof Array){c=[];for(a=0;a<e.length;a++)c.push(this.remove(e[a],{noEmit:!0}));(!b||b&&!b.noEmit)&&this._onRemove(c);
return c}a=this.find(e,{$decouple:!1});if(a.length){for(c=0;c<a.length;c++)d=a[c],this._removeIndex(d),d=this._data.indexOf(d),this._linked?jQuery.observable(this._data).remove(d):this._data.splice(d,1);this.chainSend("remove",{query:e},b);(!b||b&&!b.noEmit)&&this._onRemove(a);this.deferEmit("change",{type:"remove",data:a})}return a};b.prototype.removeById=function(e){var b={};b[this._primaryKey]=e;return this.remove(b)};b.prototype.deferEmit=function(){var e=this,b;this._noEmitDefer||this._db&&(!this._db||
this._db._noEmitDefer)?this.emit.apply(this,arguments):(b=arguments,this._changeTimeout&&clearTimeout(this._changeTimeout),this._changeTimeout=setTimeout(function(){e.debug()&&console.log("ForerunnerDB.Collection: Emitting "+b[0]);e.emit.apply(e,b)},100))};b.prototype.processQueue=function(e,b){var a=this._deferQueue[e],d=this._deferThreshold[e],c=this._deferTime[e];if(a.length){var f=this;a.length&&(a=a.length>d?a.splice(0,d):a.splice(0,a.length),this[e](a));setTimeout(function(){f.processQueue(e,
b)},c)}else b&&b()};b.prototype.insert=function(e,b,a){"function"===typeof b?(a=b,b=this._data.length):void 0===b&&(b=this._data.length);e=this.transformIn(e);return this._insertHandle(e,b,a)};b.prototype._insertHandle=function(e,b,a){var d=this._deferQueue.insert,c=this._deferThreshold.insert,f=[],h=[];if(e instanceof Array){if(e.length>c){this._deferQueue.insert=d.concat(e);this.processQueue("insert",a);return}for(c=0;c<e.length;c++)d=this._insert(e[c],b+c),!0===d?f.push(e[c]):h.push({doc:e[c],
reason:d})}else d=this._insert(e,b),!0===d?f.push(e):h.push({doc:e,reason:d});this.chainSend("insert",e,{index:b});this._onInsert(f,h);a&&a();this.deferEmit("change",{type:"insert",data:f});return{inserted:f,failed:h}};b.prototype._insert=function(e,b){if(e){var a;this._ensurePrimaryKey(e);if(a=this.insertIndexViolation(e))return"Index violation in index: "+a;this._insertIndex(e);b>this._data.length&&(b=this._data.length);this._linked?jQuery.observable(this._data).insert(b,e):this._data.splice(b,
0,e);return!0}return"No document passed to insert"};b.prototype._insertIndex=function(e){var b=this._indexByName,a,d=JSON.stringify(e);this._primaryIndex.uniqueSet(e[this._primaryKey],e);this._primaryCrc.uniqueSet(e[this._primaryKey],d);this._crcLookup.uniqueSet(d,e);for(a in b)b.hasOwnProperty(a)&&b[a].insert(e)};b.prototype._removeIndex=function(e){var b=this._indexByName,a,d=JSON.stringify(e);this._primaryIndex.unSet(e[this._primaryKey]);this._primaryCrc.unSet(e[this._primaryKey]);this._crcLookup.unSet(d);
for(a in b)b.hasOwnProperty(a)&&b[a].remove(e)};b.prototype.subset=function(e,a){var d=this.find(e,a);return(new b)._subsetOf(this).primaryKey(this._primaryKey).setData(d)};b.prototype.subsetOf=function(){return this.__subsetOf};b.prototype._subsetOf=function(e){this.__subsetOf=e;return this};b.prototype.distinct=function(e,b,a){b=this.find(b,a);e=new c(e);a={};var d=[],f,h;for(h=0;h<b.length;h++)(f=e.value(b[h])[0])&&!a[f]&&(a[f]=!0,d.push(f));return d};b.prototype.decouple=k.common.decouple;b.prototype.findById=
function(e,b){var a={};a[this._primaryKey]=e;return this.find(a,b)[0]};b.prototype.peek=function(e,a){var d=this._data,c=d.length,f,h,g=new b;if("string"===typeof e){for(f=0;f<c;f++)h=JSON.stringify(d[f]),-1<h.indexOf(e)&&g.insert(d[f]);return g.find({},a)}return this.find(e,a)};b.prototype.explain=function(e,b){return this.find(e,b).__fdbOp._data};b.prototype.find=function(e,b){e=e||{};b=b||{};b.$decouple=void 0!==b.$decouple?b.$decouple:!0;var a=this._metrics.create("find"),d=this,f,h=!0,g,k,m,
p,n,l,u,t,s,x=[];k=function(b){return d._match(b,e,"and")};a.start();if(e){a.time("analyseQuery");f=this._analyseQuery(e,b,a);a.time("analyseQuery");a.data("analysis",f);if(f.hasJoin&&f.queriesJoin){a.time("joinReferences");for(m=0;m<f.joinsOn.length;m++)n=f.joinsOn[m],p=new c(f.joinQueries[n]),p=p.value(e)[0],this._db.collection(f.joinsOn[m]).subset(p);a.time("joinReferences")}f.indexMatch.length&&(!b||b&&!b.$skipIndex)?(a.data("index.potential",f.indexMatch),a.data("index.used",f.indexMatch[0].index),
a.time("indexLookup"),g=f.indexMatch[0].lookup,a.time("indexLookup"),f.indexMatch[0].keyData.totalKeyCount===f.indexMatch[0].keyData.matchedKeyCount&&(h=!1)):a.flag("usedIndex",!1);h&&(g&&g.length?(f=g.length,a.time("tableScan: "+f),g=g.filter(k)):(f=this._data.length,a.time("tableScan: "+f),g=this._data.filter(k)),b.$orderBy&&(a.time("sort"),g=this.sort(b.$orderBy,g),a.time("sort")),a.time("tableScan: "+f));b.limit&&g&&g.length>b.limit&&(g.length=b.limit,a.data("limit",b.limit));b.$decouple&&(a.time("decouple"),
g=this.decouple(g),a.time("decouple"),a.data("flag.decouple",!0));if(b.join){for(k=0;k<b.join.length;k++)for(n in b.join[k])if(b.join[k].hasOwnProperty(n))for(t=n,f=this._db.collection(n),h=b.join[k][n],s=0;s<g.length;s++){u={};p=m=!1;for(l in h)if(h.hasOwnProperty(l))if("$"===l.substr(0,1))switch(l){case "$as":t=h[l];break;case "$multi":m=h[l];break;case "$require":p=h[l];break;default:l.substr(0,3)}else u[l]=(new c(h[l])).value(g[s])[0];u=f.find(u);!p||p&&u[0]?g[s][t]=!1===m?u[0]:u:x.push(g[s])}a.data("flag.join",
!0)}if(x.length){a.time("removalQueue");for(l=0;l<x.length;l++)n=g.indexOf(x[l]),-1<n&&g.splice(n,1);a.time("removalQueue")}if(b.transform){a.time("transform");for(l=0;l<g.length;l++)g.splice(l,1,b.transform(g[l]));a.time("transform");a.data("flag.transform",!0)}this._transformEnabled&&this._transformOut&&(a.time("transformOut"),g=this.transformOut(g),a.time("transformOut"));a.data("results",g.length);a.stop()}else a.stop(),g=[];g.__fdbOp=a;return g};b.prototype.indexOf=function(e){if(e=this.find(e,
{$decouple:!1})[0])return this._data.indexOf(e)};b.prototype.transform=function(e){return void 0!==e?("object"===typeof e?(void 0!==e.enabled&&(this._transformEnabled=e.enabled),void 0!==e.dataIn&&(this._transformIn=e.dataIn),void 0!==e.dataOut&&(this._transformOut=e.dataOut)):this._transformEnabled=!1===e?!1:!0,this):{enabled:this._transformEnabled,dataIn:this._transformIn,dataOut:this._transformOut}};b.prototype.transformIn=function(e){if(this._transformEnabled&&this._transformIn){if(e instanceof
Array){var b=[],a;for(a=0;a<e.length;a++)b[a]=this._transformIn(e[a]);return b}return this._transformIn(e)}return e};b.prototype.transformOut=function(e){if(this._transformEnabled&&this._transformOut){if(e instanceof Array){var b=[],a;for(a=0;a<e.length;a++)b[a]=this._transformOut(e[a]);return b}return this._transformOut(e)}return e};b.prototype.sort=function(e,b){b=b||[];var a=[],d,c;for(d in e)e.hasOwnProperty(d)&&(c={},c[d]=e[d],c.___fdbKey=d,a.push(c));return 2>a.length?this._sort(e,b):this._bucketSort(a,
b)};b.prototype._bucketSort=function(e,b){var a=e.shift(),d,c,f=[];if(0<e.length){b=this._sort(a,b);d=this.bucket(a.___fdbKey,b);for(c in d)d.hasOwnProperty(c)&&(a=[].concat(e),f=f.concat(this._bucketSort(a,d[c])));return f}return this._sort(a,b)};b.prototype._sort=function(e,b){var a=new c,d=a.parse(e,!0)[0];a.path(d.path);return b.sort(1===d.value?function(e,b){var d=a.value(e)[0],c=a.value(b)[0];return"string"===typeof d&&"string"===typeof c?d.localeCompare(c):d>c?1:d<c?-1:0}:function(e,b){var d=
a.value(e)[0],c=a.value(b)[0];return"string"===typeof d&&"string"===typeof c?1===d.localeCompare(c)?-1:1:d>c?-1:d<c?1:0})};b.prototype.bucket=function(e,b){var a,d={};for(a=0;a<b.length;a++)d[b[a][e]]=d[b[a][e]]||[],d[b[a][e]].push(b[a]);return d};b.prototype._analyseQuery=function(e,b,a){var d={queriesOn:[this._name],indexMatch:[],hasJoin:!1,queriesJoin:!1,joinQueries:{},query:e,options:b},f,g=[],h=[],k,m,p,n,l;a.time("checkIndexes");void 0!==e[this._primaryKey]&&(a.time("checkIndexMatch: Primary Key"),
k=new c,d.indexMatch.push({lookup:this._primaryIndex.lookup(e,b),keyData:{matchedKeys:[this._primaryKey],matchedKeyCount:1,totalKeyCount:k.countKeys(e)},index:this._primaryIndex}),a.time("checkIndexMatch: Primary Key"));for(l in this._indexById)if(this._indexById.hasOwnProperty(l)&&(m=this._indexById[l],p=m.name(),a.time("checkIndexMatch: "+p),k=m.match(e,b),n=m.lookup(e,b),0<k.matchedKeyCount&&d.indexMatch.push({lookup:n,keyData:k,index:m}),a.time("checkIndexMatch: "+p),k.totalKeyCount===k.matchedKeyCount))break;
a.time("checkIndexes");1<d.indexMatch.length&&(a.time("findOptimalIndex"),d.indexMatch.sort(function(e,b){return e.keyData.totalKeyCount===e.keyData.matchedKeyCount?-1:b.keyData.totalKeyCount===b.keyData.matchedKeyCount?1:e.keyData.matchedKeyCount===b.keyData.matchedKeyCount?e.lookup.length-b.lookup.length:b.keyData.matchedKeyCount-e.keyData.matchedKeyCount}),a.time("findOptimalIndex"));if(b.join){d.hasJoin=!0;for(a=0;a<b.join.length;a++)for(f in b.join[a])b.join[a].hasOwnProperty(f)&&(g.push(f),
"$as"in b.join[a][f]?h.push(b.join[a][f].$as):h.push(f));for(f=0;f<h.length;f++)if(b=this._queryReferencesCollection(e,h[f],""))d.joinQueries[g[f]]=b,d.queriesJoin=!0;d.joinsOn=g;d.queriesOn=d.queriesOn.concat(g)}return d};b.prototype._queryReferencesCollection=function(e,b,a){for(var d in e)if(e.hasOwnProperty(d)){if(d===b)return a&&(a+="."),a+d;if("object"===typeof e[d])return a&&(a+="."),a+=d,this._queryReferencesCollection(e[d],b,a)}return!1};b.prototype._match=function(e,b,a){var d,c;d=typeof e;
c=typeof b;var f=!0,g;if(!("string"!==d&&"number"!==d||"string"!==c&&"number"!==c))e!==b&&(f=!1);else for(g in b)if(b.hasOwnProperty(g)){d=!1;if("$"===g.substr(0,1))switch(g){case "$gt":if(e>b[g]){if("or"===a)return!0}else f=!1;d=!0;break;case "$gte":if(e>=b[g]){if("or"===a)return!0}else f=!1;d=!0;break;case "$lt":if(e<b[g]){if("or"===a)return!0}else f=!1;d=!0;break;case "$lte":if(e<=b[g]){if("or"===a)return!0}else f=!1;d=!0;break;case "$exists":if(void 0===e!==b[g]){if("or"===a)return!0}else f=!1;
d=!0;break;case "$or":d=!0;for(c=0;c<b[g].length;c++){if(this._match(e,b[g][c],"and"))return!0;f=!1}break;case "$and":d=!0;for(c=0;c<b[g].length;c++)if(!this._match(e,b[g][c],"and"))return!1;break;case "$in":if(b[g]instanceof Array){d=b[g];c=d.length;var h,k=!1;for(h=0;h<c;h++)if(d[h]===e){k=!0;break}if(k){if("or"===a)return!0}else f=!1}else throw"Cannot use a $nin operator on a non-array key: "+g;d=!0;break;case "$nin":if(b[g]instanceof Array){d=b[g];c=d.length;k=!0;for(h=0;h<c;h++)if(d[h]===e){k=
!1;break}if(k){if("or"===a)return!0}else f=!1}else throw"Cannot use a $nin operator on a non-array key: "+g;d=!0;break;case "$ne":if(e!=b[g]){if("or"===a)return!0}else f=!1;d=!0}if(!d&&b[g]instanceof RegExp)if(d=!0,"object"===typeof e&&void 0!==e[g]&&b[g].test(e[g])){if("or"===a)return!0}else f=!1;if(!d)if("object"===typeof b[g])if(void 0!==e[g]){if(e[g]instanceof Array&&!(b[g]instanceof Array))for(d=!1,c=0;c<e[g].length&&!(d=this._match(e[g][c],b[g],void 0));c++);else if(!(e[g]instanceof Array)&&
b[g]instanceof Array)for(d=!1,c=0;c<b[g].length&&!(d=this._match(e[g],b[g][c],void 0));c++);else d="object"===typeof e?this._match(e[g],b[g],void 0):this._match(void 0,b[g],void 0);if(d){if("or"===a)return!0}else f=!1}else if(b[g]&&void 0!==b[g].$exists)if(d=this._match(void 0,b[g],void 0)){if("or"===a)return!0}else f=!1;else f=!1;else if(e&&e[g]===b[g]){if("or"===a)return!0}else if(e&&e[g]&&e[g]instanceof Array&&b[g]&&"object"!==typeof b[g]){d=!1;for(c=0;c<e[g].length&&!(d=this._match(e[g][c],b[g],
void 0));c++);if(d){if("or"===a)return!0}else f=!1}else f=!1;if("and"===a&&!f)return!1}return f};b.prototype.count=function(b,a){return b?this.find(b,a).length:this._data.length};b.prototype.link=function(b,a){if(window.jQuery){this._links=this._links||{};var d,c;a&&"object"===typeof a?a.template&&"string"===typeof a.template&&(d=this.objectId(a.template),c=a.template):d=a;if(!this._links[d]){if(jQuery(b).length){if(!jQuery.templates[d]){if(!c)if(c=jQuery(a),c.length)c=jQuery(c[0]).html();else throw"Unable to bind collection to target because template does not exist: "+
a;jQuery.views.templates(d,c)}jQuery.templates[d].link(b,this._data);this._links[d]=b;this._linked++;this.debug()&&console.log('ForerunnerDB.Collection: Added binding collection "'+this.name()+'" to output target: '+b);return this}throw'Cannot bind view data to output target selector "'+b+'" because it does not exist in the DOM!';}throw"Cannot create a duplicate link to the target: "+b+" with the template: "+d;}throw"Cannot data-bind without jQuery, please add jQuery to your page!";};b.prototype.unlink=
function(b,a){if(window.jQuery){this._links=this._links||{};var d;a&&"object"===typeof a?a.template&&"string"===typeof a.template&&(d=this.objectId(a.template)):d=a;if(this._links[d])return jQuery.templates[d].unlink(b),delete this._links[d],this._linked--,this.debug()&&console.log('ForerunnerDB.Collection: Removed binding collection "'+this.name()+'" to output target: '+b),this;console.log("Cannot remove link, one does not exist to the target: "+b+" with the template: "+a)}else throw"Cannot data-bind without jQuery, please add jQuery to your page!";
};b.prototype.findSub=function(b,a,d,f){var g=new c(a);b=this.find(b);var h=b.length,k,m,q=this._db.collection("__FDB_temp_"+this.objectId()),p={parents:h,subDocTotal:0,subDocs:[],pathFound:!1,err:""};for(k=0;k<h;k++)if(m=g.value(b[k])[0]){q.setData(m);m=q.find(d,f);if(f.returnFirst&&m.length)return m[0];p.subDocs.push(m);p.subDocTotal+=m.length;p.pathFound=!0}q.drop();if(f.noStats)return p.subDocs;p.pathFound||(p.err="No objects found in the parent documents with a matching path of: "+a);return p};
b.prototype.insertIndexViolation=function(b){var a,d=this._indexByName,c,f;if(this._primaryIndex.get(b[this._primaryKey]))a=this._primaryIndex;else for(c in d)if(d.hasOwnProperty(c)&&(f=d[c],f.unique()&&f.violation(b))){a=f;break}return a?a.name():!1};b.prototype.ensureIndex=function(b,d){this._indexByName=this._indexByName||{};this._indexById=this._indexById||{};var c=new a(b,d,this),f={start:(new Date).getTime()};if(this._indexByName[c.name()])return{err:"Index with that name already exists"};if(this._indexById[c.id()])return{err:"Index with those keys already exists"};
c.rebuild();this._indexByName[c.name()]=c;this._indexById[c.id()]=c;f.end=(new Date).getTime();f.total=f.end-f.start;this._lastOp={type:"ensureIndex",stats:{time:f}};return{index:c,id:c.id(),name:c.name(),state:c.state()}};b.prototype.index=function(b){if(this._indexByName)return this._indexByName[b]};b.prototype.lastOp=function(){return this._metrics.list()};b.prototype.objectId=k.common.objectId;b.prototype.diff=function(b){var a={insert:[],update:[],remove:[]},d=this.primaryKey(),c,f,g,h;if(d===
b.primaryKey()){for(c=b._data;c&&!(c instanceof Array);)b=c,c=b._data;h=c.length;for(f=0;f<h;f++)g=c[f],this._primaryIndex.get(g[d])?this._primaryCrc.get(g[d])!==b._primaryCrc.get(g[d])&&a.update.push(g):a.insert.push(g);c=this._data;h=c.length;for(f=0;f<h;f++)g=c[f],b._primaryIndex.get(g[d])||a.remove.push(g)}else throw"Collection diffing requires that both collections have the same primary key!";return a};h.prototype.collection=function(a,d){if(a)return this._collection[a]||this.debug()&&console.log("Creating collection "+
a),this._collection[a]=this._collection[a]||(new b(a)).db(this),void 0!==d&&this._collection[a].primaryKey(d),this._collection[a];throw"Cannot get collection with undefined name!";};h.prototype.collectionExists=function(b){return Boolean(this._collection[b])};h.prototype.collections=function(){var b=[],a;for(a in this._collection)this._collection.hasOwnProperty(a)&&b.push({name:a,count:this._collection[a].count()});return b};m.exports=b},{"./Crc":6,"./Index":9,"./KeyValueStore":10,"./Metrics":11,
"./Path":16,"./Shared":19}],4:[function(h,m,k){var g,f;k=h("./Shared");var c=function(){this.init.apply(this,arguments)};c.prototype.init=function(a){this._name=a;this._data=new f("__FDB__cg_data_"+this._name);this._collections=[];this._views=[]};k.addModule("CollectionGroup",c);k.inherit(c.prototype,k.chainReactor);f=h("./Collection");h=k.modules.Core;g=k.modules.Core.prototype.init;c.prototype.debug=k.common.debug;c.prototype.on=function(){this._data.on.apply(this._data,arguments)};c.prototype.off=
function(){this._data.off.apply(this._data,arguments)};c.prototype.emit=function(){this._data.emit.apply(this._data,arguments)};c.prototype.primaryKey=function(a){return void 0!==a?(this._primaryKey=a,this):this._primaryKey};k.synthesize(c.prototype,"db");c.prototype.addCollection=function(a){if(a&&-1===this._collections.indexOf(a)){if(this._collections.length){if(this._primaryKey!==a.primaryKey())throw"All collections in a collection group must have the same primary key!";}else this.primaryKey(a.primaryKey());
this._collections.push(a);a._groups.push(this);a.chain(this);this._data.insert(a.find())}return this};c.prototype.removeCollection=function(a){if(a){var d=this._collections.indexOf(a);-1!==d&&(a.unChain(this),this._collections.splice(d,1),d=a._groups.indexOf(this),-1!==d&&a._groups.splice(d,1));0===this._collections.length&&delete this._primaryKey}return this};c.prototype.decouple=k.common.decouple;c.prototype._chainHandler=function(a){switch(a.type){case "setData":a.data=this.decouple(a.data);this._data.remove(a.options.oldData);
this._data.insert(a.data);break;case "insert":a.data=this.decouple(a.data);this._data.insert(a.data);break;case "update":this._data.update(a.data.query,a.data.update,a.options);break;case "remove":this._data.remove(a.data.query,a.options)}};c.prototype.insert=function(){this._collectionsRun("insert",arguments)};c.prototype.update=function(){this._collectionsRun("update",arguments)};c.prototype.updateById=function(){this._collectionsRun("updateById",arguments)};c.prototype.remove=function(){this._collectionsRun("remove",
arguments)};c.prototype._collectionsRun=function(a,d){for(var b=0;b<this._collections.length;b++)this._collections[b][a].apply(this._collections[b],d)};c.prototype.find=function(a,d){return this._data.find(a,d)};c.prototype.removeById=function(a){for(var d=0;d<this._collections.length;d++)this._collections[d].removeById(a)};c.prototype.subset=function(a,d){var b=this.find(a,d);return(new f)._subsetOf(this).primaryKey(this._primaryKey).setData(b)};c.prototype.drop=function(){var a,d=[].concat(this._collections),
b=[].concat(this._views);this._debug&&console.log("Dropping collection group "+this._name);for(a=0;a<d.length;a++)this.removeCollection(d[a]);for(a=0;a<b.length;a++)this._removeView(b[a]);this.emit("drop");return!0};h.prototype.init=function(){this._collectionGroup={};g.apply(this,arguments)};h.prototype.collectionGroup=function(a){return a?(this._collectionGroup[a]=this._collectionGroup[a]||(new c(a)).db(this),this._collectionGroup[a]):this._collectionGroup};m.exports=c},{"./Collection":3,"./Shared":19}],
5:[function(h,m,k){var g,f;g=h("./Shared.js");k=function(){this.init.apply(this,arguments)};k.prototype.init=function(){this._collection={};this._debug={};this._version="1.2.7"};k.prototype.moduleLoaded=g.overload({string:function(c){if(void 0!==c){c=c.replace(/ /g,"");var a=c.split(","),d;for(d=0;d<a.length;d++)if(!g.modules[c])return!1;return!0}return!1},"string, function":function(c,a){if(void 0!==c){c=c.replace(/ /g,"");var d=c.split(","),b;for(b=0;b<d.length;b++)if(!g.modules[c])return!1;a()}},
"string, function, function":function(c,a,d){if(void 0!==c){c=c.replace(/ /g,"");var b=c.split(","),e;for(e=0;e<b.length;e++)if(!g.modules[c])return d(),!1;a()}}});k.moduleLoaded=k.prototype.moduleLoaded;k.shared=g;k.prototype.shared=g;g.addModule("Core",k);g.inherit(k.prototype,g.chainReactor);f=h("./Collection.js");h("./Metrics.js");h=h("./Crc.js");k.prototype._isServer=!1;k.prototype.isClient=function(){return!this._isServer};k.prototype.isServer=function(){return this._isServer};k.prototype.crc=
h;k.prototype.isClient=function(){return!this._isServer};k.prototype.isServer=function(){return this._isServer};k.prototype.decouple=g.common.decouple;k.prototype.debug=g.common.debug;k.prototype.arrayToCollection=function(c){return(new f).setData(c)};k.prototype.on=function(c,a){this._listeners=this._listeners||{};this._listeners[c]=this._listeners[c]||[];this._listeners[c].push(a);return this};k.prototype.off=function(c,a){if(c in this._listeners){var d=this._listeners[c],b=d.indexOf(a);-1<b&&d.splice(b,
1)}return this};k.prototype.emit=function(c,a){this._listeners=this._listeners||{};if(c in this._listeners){var d=this._listeners[c],b=d.length,e;for(e=0;e<b;e++)d[e].apply(this,Array.prototype.slice.call(arguments,1))}return this};k.prototype.objectId=g.common.objectId;k.prototype.peek=function(c){var a,d,b=[],e=typeof c;for(a in this._collection)this._collection.hasOwnProperty(a)&&(d=this._collection[a],b="string"===e?b.concat(d.peek(c)):b.concat(d.find(c)));return b};k.prototype.peekCat=function(c){var a,
d,b={},e,f=typeof c;for(a in this._collection)this._collection.hasOwnProperty(a)&&(d=this._collection[a],(e="string"===f?d.peek(c):d.find(c))&&e.length&&(b[d.name()]=e));return b};m.exports=k},{"./Collection.js":3,"./Crc.js":6,"./Metrics.js":11,"./Shared.js":19}],6:[function(h,m,k){var g=function(){var f=[],c,a,d;for(a=0;256>a;a++){c=a;for(d=0;8>d;d++)c=c&1?3988292384^c>>>1:c>>>1;f[a]=c}return f}();m.exports=function(f){var c=-1,a;for(a=0;a<f.length;a++)c=c>>>8^g[(c^f.charCodeAt(a))&255];return(c^
-1)>>>0}},{}],7:[function(h,m,k){var g,f;k=h("./Shared");var c=function(){this.init.apply(this,arguments)};c.prototype.init=function(a){this._name=a;this._data={}};k.addModule("Document",c);k.inherit(c.prototype,k.chainReactor);h=h("./Collection");g=k.modules.Core;f=k.modules.Core.prototype.init;k.synthesize(c.prototype,"db");k.synthesize(c.prototype,"name");c.prototype.setData=function(a){var d,b;if(a)if(a=this.decouple(a),this._linked){b={};for(d in this._data)"jQuery"!==d.substr(0,6)&&this._data.hasOwnProperty(d)&&
void 0===a[d]&&(b[d]=1);a.$unset=b;this._updateObject(this._data,a,{})}else this._data=a;return this};c.prototype.decouple=k.common.decouple;c.prototype.objectId=k.common.objectId;c.prototype.on=k.common.on;c.prototype.off=k.common.off;c.prototype.emit=k.common.emit;c.prototype.debug=k.common.debug;c.prototype.update=function(a,d,b){this._updateObject(this._data,d,a,b)};c.prototype._updateObject=h.prototype._updateObject;c.prototype._isPositionalKey=function(a){return".$"===a.substr(a.length-2,2)};
c.prototype._updateProperty=function(a,d,b){this._linked?(jQuery.observable(a).setProperty(d,b),this.debug()&&console.log('ForerunnerDB.Document: Setting data-bound document property "'+d+'" for collection "'+this.name()+'"')):(a[d]=b,this.debug()&&console.log('ForerunnerDB.Document: Setting non-data-bound document property "'+d+'" for collection "'+this.name()+'"'))};c.prototype._updateIncrement=function(a,d,b){this._linked?jQuery.observable(a).setProperty(d,a[d]+b):a[d]+=b};c.prototype._updateSpliceMove=
function(a,d,b){this._linked?(jQuery.observable(a).move(d,b),this.debug()&&console.log('ForerunnerDB.Document: Moving data-bound document array index from "'+d+'" to "'+b+'" for collection "'+this.name()+'"')):(a.splice(b,0,a.splice(d,1)[0]),this.debug()&&console.log('ForerunnerDB.Document: Moving non-data-bound document array index from "'+d+'" to "'+b+'" for collection "'+this.name()+'"'))};c.prototype._updateSplicePush=function(a,d,b){a.length>d?this._linked?jQuery.observable(a).insert(d,b):a.splice(d,
0,b):this._linked?jQuery.observable(a).insert(b):a.push(b)};c.prototype._updatePush=function(a,d){this._linked?jQuery.observable(a).insert(d):a.push(d)};c.prototype._updatePull=function(a,d){this._linked?jQuery.observable(a).remove(d):a.splice(d,1)};c.prototype._updateMultiply=function(a,d,b){this._linked?jQuery.observable(a).setProperty(d,a[d]*b):a[d]*=b};c.prototype._updateRename=function(a,d,b){var e=a[d];this._linked?(jQuery.observable(a).setProperty(b,e),jQuery.observable(a).removeProperty(d)):
(a[b]=e,delete a[d])};c.prototype._updateUnset=function(a,d){this._linked?jQuery.observable(a).removeProperty(d):delete a[d]};c.prototype._updatePop=function(a,d){var b,e=!1;0<a.length&&(this._linked?(1===d?b=a.length-1:-1===d&&(b=0),-1<b&&(jQuery.observable(arr).remove(b),e=!0)):1===d?(a.pop(),e=!0):-1===d&&(a.shift(),e=!0));return e};c.prototype.link=function(a,d){if(window.jQuery){this._links=this._links||{};this._linked||(this._linked=0);var b,e;d&&"object"===typeof d?d.template&&"string"===typeof d.template&&
(b=this.objectId(d.template),e=d.template):b=d;if(!this._links[b]){if(jQuery(a).length){if(!jQuery.templates[b]){if(!e)if(e=jQuery(d),e.length)e=jQuery(e[0]).html();else throw"Unable to bind document to target because template does not exist: "+d;jQuery.views.templates(b,e)}jQuery.templates[b].link(a,this._data);this._links[b]=a;this._linked++;this.debug()&&console.log('ForerunnerDB.Document: Added binding document "'+this.name()+'" to output target: '+a);return this}throw'Cannot bind view data to output target selector "'+
a+'" because it does not exist in the DOM!';}throw"Cannot create a duplicate link to the target: "+a+" with the template: "+b;}throw"Cannot data-bind without jQuery, please add jQuery to your page!";};c.prototype.unlink=function(a,d){if(window.jQuery){this._links=this._links||{};var b;d&&"object"===typeof d?d.template&&"string"===typeof d.template&&(b=this.objectId(d.template)):b=d;if(this._links[b])return jQuery.templates[b].unlink(a),delete this._links[b],this._linked--,this.debug()&&console.log('ForerunnerDB.Document: Removed binding document "'+
this.name()+'" to output target: '+a),this;console.log("Cannot remove link, one does not exist to the target: "+a+" with the template: "+d)}else throw"Cannot data-bind without jQuery, please add jQuery to your page!";};c.prototype.drop=function(){this._db&&this._name&&this._db&&this._db._document&&this._db._document[this._name]&&(delete this._db._document[this._name],this._data={})};g.prototype.init=function(){f.apply(this,arguments)};g.prototype.document=function(a){return a?(this._document=this._document||
{},this._document[a]=this._document[a]||(new c(a)).db(this),this._document[a]):this._document};m.exports=c},{"./Collection":3,"./Shared":19}],8:[function(h,m,k){var g;h=h("./Shared");var f=function(c,a){this.init.apply(this,arguments)};f.prototype.init=function(c,a){this._options=a;this._selector=$(this._options.selector);this._listeners={};this._collection=c;this._options.series=[];var d,b;switch(this._options.type){case "pie":this._selector.highcharts(this._options.chartOptions);this._chart=this._selector.highcharts();
d=this._collection.find();b={allowPointSelect:!0,cursor:"pointer",dataLabels:{enabled:!0,format:"<b>{point.name}</b>: {y} ({point.percentage:.0f}%)",style:{color:Highcharts.theme&&Highcharts.theme.contrastTextColor||"black"}}};d=this.pieDataFromCollectionData(d,this._options.keyField,this._options.valField);$.extend(b,this._options.seriesOptions);$.extend(b,{type:"pie",name:this._options.seriesName,data:d});this._chart.addSeries(b);break;case "line":d=this.lineDataFromCollectionData(this._options.seriesField,
this._options.keyField,this._options.valField,this._options.orderBy),this._options.chartOptions.xAxis=d.xAxis,this._options.chartOptions.series=d.series,this._selector.highcharts(this._options.chartOptions),this._chart=this._selector.highcharts()}this._hookEvents()};h=h.modules.Collection;g=h.prototype.init;f.prototype.pieDataFromCollectionData=function(c,a,d){var b=[],e;for(e=0;e<c.length;e++)b.push([c[e][a],c[e][d]]);return b};f.prototype.lineDataFromCollectionData=function(c,a,d,b){var e=this._collection.distinct(c),
f=[],g={categories:[]},h,k,m,w,v;for(w=0;w<e.length;w++){h=e[w];k={};k[c]=h;m=[];k=this._collection.find(k,{orderBy:b});for(v=0;v<k.length;v++)g.categories.push(k[v][a]),m.push(k[v][d]);f.push({name:h,data:m})}return{xAxis:g,series:f}};f.prototype._hookEvents=function(){this._collection.on("change",this._changeListener);this._collection.on("drop",this._dropListener)};f.prototype._changeListener=function(){if("undefined"!==typeof this._collection&&this._chart){var c=this._collection.find();switch(this._options.type){case "pie":this._chart.series[0].setData(this.pieDataFromCollectionData(c,
this._options.keyField,this._options.valField));break;case "line":c=this.lineDataFromCollectionData(this._options.seriesField,this._options.keyField,this._options.valField,this._options.orderBy);this._chart.xAxis[0].setCategories(c.xAxis.categories);for(var a=0;a<c.series.length;a++)this._chart.series[a].setData(c.series[a].data)}}};f.prototype._dropListener=function(){this._collection.off("change",this._changeListener);this._collection.off("drop",this._dropListener)};f.prototype.drop=function(){this._chart.destroy();
this._collection.off("change",this._changeListener);this._collection.off("drop",this._dropListener);delete this._collection._highcharts[this._options.selector];delete this._chart;delete this._options;delete this._collection;return this};h.prototype.init=function(){this._highcharts={};g.apply(this,arguments)};h.prototype.chart=function(c){this._highcharts[c.selector]||(this._highcharts[c.selector]=new f(this,c));return this._highcharts[c.selector]};h.prototype.dropChart=function(c){this._highcharts[c]&&
this._highcharts[c].drop()};m.exports=f},{"./Shared":19}],9:[function(h,m,k){k=h("./Shared");var g=h("./Path");h=function(){this.init.apply(this,arguments)};h.prototype.init=function(f,c,a){this._crossRef={};this._size=0;this._id=this._itemKeyHash(f,f);this.data({});this.unique(c&&c.unique?c.unique:!1);void 0!==f&&this.keys(f);void 0!==a&&this.collection(a);this.name(c&&c.name?c.name:this._id)};k.addModule("Index",h);k.inherit(h.prototype,k.chainReactor);h.prototype.id=function(){return this._id};
h.prototype.state=function(){return this._state};h.prototype.size=function(){return this._size};h.prototype.data=function(f){return void 0!==f?(this._data=f,this):this._data};k.synthesize(h.prototype,"name");h.prototype.collection=function(f){return void 0!==f?(this._collection=f,this):this._collection};h.prototype.keys=function(f){return void 0!==f?(this._keys=f,this._keyCount=(new g).parse(this._keys).length,this):this._keys};h.prototype.type=function(f){return void 0!==f?(this._type=f,this):this._type};
h.prototype.unique=function(f){return void 0!==f?(this._unique=f,this):this._unique};h.prototype.rebuild=function(){if(this._collection){var f=this._collection.subset({},{$decouple:!1,$orderBy:this._keys}).find(),c,a=f.length;this._data={};this._unique&&(this._uniqueLookup={});for(c=0;c<a;c++)this.insert(f[c])}this._state={name:this._name,keys:this._keys,indexSize:this._size,built:new Date,updated:new Date,ok:!0}};h.prototype.insert=function(f,c){var a,d;this._unique&&(a=this._itemHash(f,this._keys),
this._uniqueLookup[a]=f);a=this._itemHashArr(f,this._keys);for(d=0;d<a.length;d++)this.pushToPathValue(a[d],f)};h.prototype.remove=function(f,c){var a,d;this._unique&&(a=this._itemHash(f,this._keys),delete this._uniqueLookup[a]);a=this._itemHashArr(f,this._keys);for(d=0;d<a.length;d++)this.pullFromPathValue(a[d],f)};h.prototype.violation=function(f){f=this._itemHash(f,this._keys);return Boolean(this._uniqueLookup[f])};h.prototype.hashViolation=function(f){return Boolean(this._uniqueLookup[f])};h.prototype.pushToPathValue=
function(f,c){var a=this._data[f]=this._data[f]||[];-1===a.indexOf(c)&&(a.push(c),this._size++,this.pushToCrossRef(c,a))};h.prototype.pullFromPathValue=function(f,c){var a=this._data[f],d;d=a.indexOf(c);-1<d&&(a.splice(d,1),this._size--,this.pullFromCrossRef(c,a));a.length||delete this._data[f]};h.prototype.pull=function(f){var c=f[this._collection.primaryKey()],a=this._crossRef[c],d,b=a.length,e;for(d=0;d<b;d++)e=a[d],this._pullFromArray(e,f);this._size--;delete this._crossRef[c]};h.prototype._pullFromArray=
function(f,c){for(var a=f.length;a--;)f[a]===c&&f.splice(a,1)};h.prototype.pushToCrossRef=function(f,c){var a=f[this._collection.primaryKey()];this._crossRef[a]=this._crossRef[a]||[];a=this._crossRef[a];-1===a.indexOf(c)&&a.push(c)};h.prototype.pullFromCrossRef=function(f,c){var a=f[this._collection.primaryKey()];delete this._crossRef[a]};h.prototype.lookup=function(f){return this._data[this._itemHash(f,this._keys)]||[]};h.prototype.match=function(f,c){return(new g).countObjectPaths(this._keys,f)};
h.prototype._itemHash=function(f,c){var a=new g,d,b="",e;d=a.parse(c);for(e=0;e<d.length;e++)b&&(b+="_"),b+=a.value(f,d[e].path).join(":");return b};h.prototype._itemKeyHash=function(f,c){var a=new g,d,b="",e;d=a.parse(c);for(e=0;e<d.length;e++)b&&(b+="_"),b+=a.keyValue(f,d[e].path);return b};h.prototype._itemHashArr=function(f,c){var a=new g,d,b=[],e,h,k,m;d=a.parse(c);for(k=0;k<d.length;k++)for(e=a.value(f,d[k].path),h=0;h<e.length;h++)if(0===k)b.push(e[h]);else for(m=0;m<b.length;m++)b[m]=b[m]+
"_"+e[h];return b};m.exports=h},{"./Path":16,"./Shared":19}],10:[function(h,m,k){h=h("./Shared");k=function(g){this.init.apply(this,arguments)};k.prototype.init=function(g){this._name=g;this._data={};this._primaryKey="_id"};h.addModule("KeyValueStore",k);h.inherit(k.prototype,h.chainReactor);h.synthesize(k.prototype,"name");k.prototype.primaryKey=function(g){return void 0!==g?(this._primaryKey=g,this):this._primaryKey};k.prototype.truncate=function(){this._data={};return this};k.prototype.set=function(g,
f){this._data[g]=f?f:!0;return this};k.prototype.get=function(g){return this._data[g]};k.prototype.lookup=function(g){g=g[this._primaryKey];var f,c,a,d;if(g instanceof Array){c=g.length;d=[];for(f=0;f<c;f++)(a=this._data[g[f]])&&d.push(a);return d}if(g instanceof RegExp){d=[];for(f in this._data)this._data.hasOwnProperty(f)&&g.test(f)&&d.push(this._data[f]);return d}if("object"===typeof g){if(g.$ne){d=[];for(f in this._data)this._data.hasOwnProperty(f)&&f!==g.$ne&&d.push(this._data[f]);return d}if(g.$in&&
g.$in instanceof Array){d=[];for(f in this._data)this._data.hasOwnProperty(f)&&-1<g.$in.indexOf(f)&&d.push(this._data[f]);return d}if(g.$nin&&g.$nin instanceof Array){d=[];for(f in this._data)this._data.hasOwnProperty(f)&&-1===g.$nin.indexOf(f)&&d.push(this._data[f]);return d}if(g.$or&&g.$or instanceof Array){d=[];for(f=0;f<g.$or.length;f++)d=d.concat(this.lookup(g.$or[f]));return d}}else return a=this._data[g],void 0!==a?[a]:[]};k.prototype.unSet=function(g){delete this._data[g];return this};k.prototype.uniqueSet=
function(g,f){return void 0===this._data[g]?(this._data[g]=f,!0):!1};m.exports=k},{"./Shared":19}],11:[function(h,m,k){k=h("./Shared");var g=h("./Operation");h=function(){this.init.apply(this,arguments)};h.prototype.init=function(){this._data=[]};k.addModule("Metrics",h);k.inherit(h.prototype,k.chainReactor);h.prototype.create=function(f){f=new g(f);this._enabled&&this._data.push(f);return f};h.prototype.start=function(){this._enabled=!0;return this};h.prototype.stop=function(){this._enabled=!1;return this};
h.prototype.clear=function(){this._data=[];return this};h.prototype.list=function(){return this._data};m.exports=h},{"./Operation":14,"./Shared":19}],12:[function(h,m,k){var g;h=h("./Shared").modules.OldView;g=h.prototype.init;h.prototype.init=function(){var f=this;this._binds=[];this._renderEnd=this._renderStart=0;this._deferQueue={insert:[],update:[],remove:[],upsert:[],_bindInsert:[],_bindUpdate:[],_bindRemove:[],_bindUpsert:[]};this._deferThreshold={insert:100,update:100,remove:100,upsert:100,
_bindInsert:100,_bindUpdate:100,_bindRemove:100,_bindUpsert:100};this._deferTime={insert:100,update:1,remove:1,upsert:1,_bindInsert:100,_bindUpdate:1,_bindRemove:1,_bindUpsert:1};g.apply(this,arguments);this.on("insert",function(c,a){f._bindEvent("insert",c,a)});this.on("update",function(c,a){f._bindEvent("update",c,a)});this.on("remove",function(c,a){f._bindEvent("remove",c,a)});this.on("change",f._bindChange)};h.prototype.bind=function(f,c){if(c&&c.template)this._binds[f]=c;else throw"Cannot bind data to element, missing options information!";
return this};h.prototype.unBind=function(f){delete this._binds[f];return this};h.prototype.isBound=function(f){return Boolean(this._binds[f])};h.prototype.bindSortDom=function(f,c){var a=$(f),d,b,e;this.debug()&&console.log("ForerunnerDB.OldView.Bind: Sorting data in DOM...",c);for(d=0;d<c.length;d++)b=c[d],e=a.find("#"+b[this._primaryKey]),e.length?0===d?(this.debug()&&console.log("ForerunnerDB.OldView.Bind: Sort, moving to index 0...",e),a.prepend(e)):(this.debug()&&console.log("ForerunnerDB.OldView.Bind: Sort, moving to index "+
d+"...",e),e.insertAfter(a.children(":eq("+(d-1)+")"))):this.debug()&&console.log("ForerunnerDB.OldView.Bind: Warning, element for array item not found!",b)};h.prototype.bindRefresh=function(f){var c=this._binds,a,d;f||(f={data:this.find()});for(a in c)c.hasOwnProperty(a)&&(d=c[a],this.debug()&&console.log("ForerunnerDB.OldView.Bind: Sorting DOM..."),this.bindSortDom(a,f.data),d.afterOperation&&d.afterOperation(),d.refresh&&d.refresh())};h.prototype.bindRender=function(f,c){var a=this._binds[f],d=
$(f),b,e,g=$("<ul></ul>"),h;if(a){b=this._data.find();for(h=0;h<b.length;h++)e=b[h],a.template(e,function(b){g.append(b)});c?c(f,g.html()):d.append(g.html())}};h.prototype.processQueue=function(f,c){var a=this._deferQueue[f],d=this._deferThreshold[f],b=this._deferTime[f];if(a.length){var e=this;a.length&&(a=a.length>d?a.splice(0,d):a.splice(0,a.length),this._bindEvent(f,a,[]));setTimeout(function(){e.processQueue(f,c)},b)}else c&&c(),this.emit("bindQueueComplete")};h.prototype._bindEvent=function(f,
c,a){var d=this._binds,b=this.find({}),e,g;for(g in d)if(d.hasOwnProperty(g))switch(e=d[g].reduce?this.find(d[g].reduce.query,d[g].reduce.options):b,f){case "insert":this._bindInsert(g,d[g],c,a,e);break;case "update":this._bindUpdate(g,d[g],c,a,e);break;case "remove":this._bindRemove(g,d[g],c,a,e)}};h.prototype._bindChange=function(f){this.debug()&&console.log("ForerunnerDB.OldView.Bind: Bind data change, refreshing bind...",f);this.bindRefresh(f)};h.prototype._bindInsert=function(f,c,a,d,b){var e=
$(f),g;for(g=0;g<a.length;g++)f=e.find("#"+a[g][this._primaryKey]),f.length||c.template(a[g],function(b,a,d,f){return function(b){c.insert?c.insert(b,a,d,f):c.prependInsert?e.prepend(b):e.append(b);c.afterInsert&&c.afterInsert(b,a,d,f)}}(f,a[g],d,b))};h.prototype._bindUpdate=function(f,c,a,d,b){var e=$(f);for(d=0;d<a.length;d++)f=e.find("#"+a[d][this._primaryKey]),c.template(a[d],function(a,d){return function(f){c.update?c.update(f,d,b,a.length?"update":"append"):a.length?a.replaceWith(f):c.prependUpdate?
e.prepend(f):e.append(f);c.afterUpdate&&c.afterUpdate(f,d,b)}}(f,a[d]))};h.prototype._bindRemove=function(f,c,a,d,b){f=$(f);var e;for(e=0;e<a.length;e++)d=f.find("#"+a[e][this._primaryKey]),d.length&&(c.beforeRemove?c.beforeRemove(d,a[e],b,function(b,a,e){return function(){c.remove?c.remove(b,a,e):(b.remove(),c.afterRemove&&c.afterRemove(b,a,e))}}(d,a[e],b)):c.remove?c.remove(d,a[e],b):(d.remove(),c.afterRemove&&c.afterRemove(d,a[e],b)))}},{"./Shared":19}],13:[function(h,m,k){var g,f,c,a,d;k=h("./Shared");
var b=function(){this.init.apply(this,arguments)};b.prototype.init=function(b){var a=this;this._name=b;this._groups=[];this._listeners={};this._query={query:{},options:{}};this._onFromSetData=function(){a._onSetData.apply(a,arguments)};this._onFromInsert=function(){a._onInsert.apply(a,arguments)};this._onFromUpdate=function(){a._onUpdate.apply(a,arguments)};this._onFromRemove=function(){a._onRemove.apply(a,arguments)};this._onFromChange=function(){a.debug()&&console.log("ForerunnerDB.OldView: Received change");
a._onChange.apply(a,arguments)}};k.modules.OldView=b;g=h("./CollectionGroup");f=h("./Collection");c=f.prototype.init;a=g.prototype.init;h=k.modules.Core;d=h.prototype.init;b.prototype.on=k.common.on;b.prototype.off=k.common.off;b.prototype.emit=k.common.emit;b.prototype.drop=function(){return(this._db||this._from)&&this._name?(this.debug()&&console.log("ForerunnerDB.OldView: Dropping view "+this._name),this.emit("drop"),this._db&&delete this._db._oldViews[this._name],this._from&&delete this._from._oldViews[this._name],
!0):!1};b.prototype.debug=function(){return!1};b.prototype.db=function(b){return void 0!==b?(this._db=b,this):this._db};b.prototype.from=function(b){if(void 0!==b){if("string"===typeof b)if(this._db.collectionExists(b))b=this._db.collection(b);else throw"Invalid collection in view.from() call.";this._from!==b&&(this._from&&this.removeFrom(),this.addFrom(b));return this}return this._from};b.prototype.addFrom=function(b){if(this._from=b)return this._from.on("setData",this._onFromSetData),this._from.on("change",
this._onFromChange),this._from._addOldView(this),this._primaryKey=this._from._primaryKey,this.refresh(),this;throw"Cannot determine collection type in view.from()";};b.prototype.removeFrom=function(){this._from.off("setData",this._onFromSetData);this._from.off("change",this._onFromChange);this._from._removeOldView(this)};b.prototype.primaryKey=function(){if(this._from)return this._from.primaryKey()};b.prototype.queryData=function(b,a,d){void 0!==b&&(this._query.query=b);void 0!==a&&(this._query.options=
a);return void 0!==b||void 0!==a?(void 0!==d&&!0!==d||this.refresh(),this):this._query};b.prototype.queryAdd=function(b,a,d){var c=this._query.query,f;if(void 0!==b)for(f in b)b.hasOwnProperty(f)&&(void 0===c[f]||void 0!==c[f]&&a)&&(c[f]=b[f]);void 0!==d&&!0!==d||this.refresh()};b.prototype.queryRemove=function(b,a){var d=this._query.query,c;if(void 0!==b)for(c in b)b.hasOwnProperty(c)&&delete d[c];void 0!==a&&!0!==a||this.refresh()};b.prototype.query=function(b,a){return void 0!==b?(this._query.query=
b,void 0!==a&&!0!==a||this.refresh(),this):this._query.query};b.prototype.queryOptions=function(b,a){return void 0!==b?(this._query.options=b,void 0!==a&&!0!==a||this.refresh(),this):this._query.options};b.prototype.refresh=function(b){if(this._from){var a=this._data,d,c,f,g,h,k=[],m=[],p=[],n;this.debug()&&(console.log("ForerunnerDB.OldView: Refreshing view "+this._name),console.log("ForerunnerDB.OldView: Existing data: "+("undefined"!==typeof this._data)),"undefined"!==typeof this._data&&console.log("ForerunnerDB.OldView: Current data rows: "+
this._data.find().length));this._query?(this.debug()&&console.log("ForerunnerDB.OldView: View has query and options, getting subset..."),this._data=this._from.subset(this._query.query,this._query.options)):this._query.options?(this.debug()&&console.log("ForerunnerDB.OldView: View has options, getting subset..."),this._data=this._from.subset({},this._query.options)):(this.debug()&&console.log("ForerunnerDB.OldView: View has no query or options, getting subset..."),this._data=this._from.subset({}));
if(!b&&a)if(this.debug()&&console.log("ForerunnerDB.OldView: Refresh not forced, old data detected..."),c=this._data,a.subsetOf()===c.subsetOf()){this.debug()&&console.log("ForerunnerDB.OldView: Old and new data are from same collection...");f=c.find();b=a.find();g=c._primaryKey;for(n=0;n<f.length;n++)h=f[n],d={},d[g]=h[g],(d=a.find(d)[0])?JSON.stringify(d)!==JSON.stringify(h)&&m.push(h):k.push(h);for(n=0;n<b.length;n++)h=b[n],d={},d[g]=h[g],c.find(d)[0]||p.push(h);this.debug()&&(console.log("ForerunnerDB.OldView: Removed "+
p.length+" rows"),console.log("ForerunnerDB.OldView: Inserted "+k.length+" rows"),console.log("ForerunnerDB.OldView: Updated "+m.length+" rows"));k.length&&this._onInsert(k,[]);m.length&&this._onUpdate(m,[]);p.length&&this._onRemove(p,[])}else this.debug()&&console.log("ForerunnerDB.OldView: Old and new data are from different collections..."),p=a.find(),p.length&&this._onRemove(p),k=c.find(),k.length&&this._onInsert(k);else this.debug()&&console.log("ForerunnerDB.OldView: Forcing data update",f),
this._data=this._from.subset(this._query.query,this._query.options),f=this._data.find(),this.debug()&&console.log("ForerunnerDB.OldView: Emitting change event with data",f),this._onInsert(f,[]);this.debug()&&console.log("ForerunnerDB.OldView: Emitting change");this.emit("change")}return this};b.prototype.count=function(){return this._data&&this._data._data?this._data._data.length:0};b.prototype.find=function(){return this._data?(this.debug()&&console.log("ForerunnerDB.OldView: Finding data in view collection...",
this._data),this._data.find.apply(this._data,arguments)):[]};b.prototype.insert=function(){return this._from?this._from.insert.apply(this._from,arguments):[]};b.prototype.update=function(){return this._from?this._from.update.apply(this._from,arguments):[]};b.prototype.remove=function(){return this._from?this._from.remove.apply(this._from,arguments):[]};b.prototype._onSetData=function(b,a){this.emit("remove",a,[]);this.emit("insert",b,[])};b.prototype._onInsert=function(b,a){this.emit("insert",b,a)};
b.prototype._onUpdate=function(b,a){this.emit("update",b,a)};b.prototype._onRemove=function(b,a){this.emit("remove",b,a)};b.prototype._onChange=function(){this.debug()&&console.log("ForerunnerDB.OldView: Refreshing data");this.refresh()};f.prototype.init=function(){this._oldViews=[];c.apply(this,arguments)};f.prototype._addOldView=function(b){void 0!==b&&(this._oldViews[b._name]=b);return this};f.prototype._removeOldView=function(b){void 0!==b&&delete this._oldViews[b._name];return this};g.prototype.init=
function(){this._oldViews=[];a.apply(this,arguments)};g.prototype._addOldView=function(b){void 0!==b&&(this._oldViews[b._name]=b);return this};g.prototype._removeOldView=function(b){void 0!==b&&delete this._oldViews[b._name];return this};h.prototype.init=function(){this._oldViews={};d.apply(this,arguments)};h.prototype.oldView=function(a){this._oldViews[a]||this.debug()&&console.log("ForerunnerDB.OldView: Creating view "+a);this._oldViews[a]=this._oldViews[a]||(new b(a)).db(this);return this._oldViews[a]};
h.prototype.oldViewExists=function(b){return Boolean(this._oldViews[b])};h.prototype.oldViews=function(){var b=[],a;for(a in this._oldViews)this._oldViews.hasOwnProperty(a)&&b.push({name:a,count:this._oldViews[a].count()});return b};m.exports=b},{"./Collection":3,"./CollectionGroup":4,"./Shared":19}],14:[function(h,m,k){k=h("./Shared");var g=h("./Path");h=function(f){this.pathSolver=new g;this.counter=0;this.init.apply(this,arguments)};h.prototype.init=function(f){this._data={operation:f,index:{potential:[],
used:!1},steps:[],time:{startMs:0,stopMs:0,totalMs:0,process:{}},flag:{},log:[]}};k.addModule("Operation",h);k.inherit(h.prototype,k.chainReactor);h.prototype.start=function(){this._data.time.startMs=(new Date).getTime()};h.prototype.log=function(f){if(f){var c=0<this._log.length?this._data.log[this._data.log.length-1].time:0;f={event:f,time:(new Date).getTime(),delta:0};this._data.log.push(f);c&&(f.delta=f.time-c);return this}return this._data.log};h.prototype.time=function(f){if(void 0!==f){var c=
this._data.time.process,c=c[f]=c[f]||{};c.startMs?(c.stopMs=(new Date).getTime(),c.totalMs=c.stopMs-c.startMs,c.stepObj.totalMs=c.totalMs,delete c.stepObj):(c.startMs=(new Date).getTime(),c.stepObj={name:f},this._data.steps.push(c.stepObj));return this}return this._data.time};h.prototype.flag=function(f,c){if(void 0!==f&&void 0!==c)this._data.flag[f]=c;else return void 0!==f?this._data.flag[f]:this._data.flag};h.prototype.data=function(f,c,a){return void 0!==c?(this.pathSolver.set(this._data,f,c),
this):this.pathSolver.get(this._data,f)};h.prototype.pushData=function(f,c,a){this.pathSolver.push(this._data,f,c)};h.prototype.stop=function(){this._data.time.stopMs=(new Date).getTime();this._data.time.totalMs=this._data.time.stopMs-this._data.time.startMs};m.exports=h},{"./Path":16,"./Shared":19}],15:[function(h,m,k){var g,f,c;k=h("./Shared");var a=function(){this.init.apply(this,arguments)};a.prototype.init=function(a){this._name=a;this._data=new c("__FDB__dc_data_"+this._name);this._collData=
new f;this._collections=[]};k.addModule("Overview",a);k.inherit(a.prototype,k.chainReactor);f=h("./Collection");c=h("./Document");h=k.modules.Core;g=k.modules.Core.prototype.init;k.synthesize(a.prototype,"db");k.synthesize(a.prototype,"name");k.synthesize(a.prototype,"query",function(a){var b=this.$super(a);void 0!==a&&this._refresh();return b});k.synthesize(a.prototype,"queryOptions",function(a){var b=this.$super(a);void 0!==a&&this._refresh();return b});k.synthesize(a.prototype,"reduce",function(a){var b=
this.$super(a);void 0!==a&&this._refresh();return b});a.prototype.debug=k.common.debug;a.prototype.objectId=k.common.objectId;a.prototype.from=function(a){void 0!==a&&("string"===typeof a&&(a=this._db.collection(a)),this._addCollection(a));return this};a.prototype.find=function(){return this._collData.find.apply(this._collData,arguments)};a.prototype.count=function(){return this._collData.count.apply(this._collData,arguments)};a.prototype._addCollection=function(a){-1===this._collections.indexOf(a)&&
(this._collections.push(a),a.chain(this),this._refresh());return this};a.prototype._removeCollection=function(a){-1<this._collections.indexOf(a)&&(this._collections.splice(a,1),a.unChain(this),this._refresh());return this};a.prototype._refresh=function(){if(this._collections&&this._collections[0]){this._collData.primaryKey(this._collections[0].primaryKey());var a=[],b;for(b=0;b<this._collections.length;b++)a=a.concat(this._collections[b].find(this._query,this._queryOptions));this._collData.setData(a)}this._reduce&&
(a=this._reduce(),this._data.setData(a))};a.prototype._chainHandler=function(a){switch(a.type){case "setData":case "insert":case "update":case "remove":this._refresh()}};a.prototype.link=function(a,b){this._data.link.apply(this._data,arguments);this._refresh()};a.prototype.unlink=function(a,b){this._data.unlink.apply(this._data,arguments);this._refresh()};h.prototype.init=function(){this._overview={};g.apply(this,arguments)};h.prototype.overview=function(d){return d?(this._overview[d]=this._overview[d]||
(new a(d)).db(this),this._overview[d]):this._overview};m.exports=a},{"./Collection":3,"./Document":7,"./Shared":19}],16:[function(h,m,k){h=h("./Shared");k=function(g){this.init.apply(this,arguments)};k.prototype.init=function(g){g&&this.path(g)};h.addModule("Path",k);h.inherit(k.prototype,h.chainReactor);k.prototype.path=function(g){return void 0!==g?(this._path=this.clean(g),this._pathParts=this._path.split("."),this):this._path};k.prototype.hasObjectPaths=function(g,f){var c=!0,a;for(a in g)if(g.hasOwnProperty(a)&&
(void 0===f[a]||"object"===typeof g[a]&&(c=this.hasObjectPaths(g[a],f[a]),!c)))return!1;return c};k.prototype.countKeys=function(g){var f=0,c;for(c in g)g.hasOwnProperty(c)&&void 0!==g[c]&&("object"!==typeof g[c]?f++:f+=this.countKeys(g[c]));return f};k.prototype.countObjectPaths=function(g,f){var c,a={},d=0,b=0,e;for(e in f)f.hasOwnProperty(e)&&("object"===typeof f[e]?(c=this.countObjectPaths(g[e],f[e]),a[e]=c.matchedKeys,b+=c.totalKeyCount,d+=c.matchedKeyCount):(b++,g&&g[e]&&"object"!==typeof g[e]?
(a[e]=!0,d++):a[e]=!1));return{matchedKeys:a,matchedKeyCount:d,totalKeyCount:b}};k.prototype.parse=function(g,f){var c=[],a="",d,b,e;for(b in g)if(g.hasOwnProperty(b))if(a=b,"object"===typeof g[b])if(f)for(d=this.parse(g[b],f),e=0;e<d.length;e++)c.push({path:a+"."+d[e].path,value:d[e].value});else for(d=this.parse(g[b]),e=0;e<d.length;e++)c.push({path:a+"."+d[e].path});else f?c.push({path:a,value:g[b]}):c.push({path:a});return c};k.prototype.parseArr=function(g,f){f=f||{};return this._parseArr(g,
"",[],f)};k.prototype._parseArr=function(g,f,c,a){var d,b="";f=f||"";c=c||[];for(d in g)g.hasOwnProperty(d)&&(!a.ignore||a.ignore&&!a.ignore.test(d))&&(b=f?f+"."+d:d,"object"===typeof g[d]?this._parseArr(g[d],b,c,a):c.push(b));return c};k.prototype.value=function(g,f){if(void 0!==g&&"object"===typeof g){var c,a,d,b,e=[],h;void 0!==f&&(f=this.clean(f),c=f.split("."));c=c||this._pathParts;a=c.length;d=g;for(h=0;h<a;h++){d=d[c[h]];if(b instanceof Array){for(a=0;a<b.length;a++)e=e.concat(this.value(b,
a+"."+c[h]));return e}if(!d||"object"!==typeof d)break;b=d}return[d]}return[]};k.prototype.set=function(g,f,c){if(void 0!==g&&void 0!==f){var a;f=this.clean(f);f=f.split(".");a=f.shift();f.length?(g[a]=g[a]||{},this.set(g[a],f.join("."),c)):g[a]=c}return g};k.prototype.get=function(g,f){return this.value(g,f)[0]};k.prototype.push=function(g,f,c){if(void 0!==g&&void 0!==f){var a;f=this.clean(f);f=f.split(".");a=f.shift();if(f.length)g[a]=g[a]||{},this.set(g[a],f.join("."),c);else if(g[a]=g[a]||[],
g[a]instanceof Array)g[a].push(c);else throw"Cannot push to a path whose endpoint is not an array!";}return g};k.prototype.keyValue=function(g,f){var c,a,d,b,e;void 0!==f&&(f=this.clean(f),c=f.split("."));c=c||this._pathParts;a=c.length;d=g;for(e=0;e<a;e++)if(d=d[c[e]],!d||"object"!==typeof d){b=c[e]+":"+d;break}return b};k.prototype.clean=function(g){"."===g.substr(0,1)&&(g=g.substr(1,g.length-1));return g};m.exports=k},{"./Shared":19}],17:[function(h,m,k){k=h("./Shared");var g,f,c,a;a=function(){this.init.apply(this,
arguments)};a.prototype.init=function(a){a.isClient()&&void 0!==Storage&&this.mode("localStorage")};k.addModule("Persist",a);k.inherit(a.prototype,k.chainReactor);k=k.modules.Core;g=h("./Collection");f=g.prototype.drop;h("./CollectionGroup");c=k.prototype.init;a.prototype.mode=function(a){return void 0!==a?(this._mode=a,this):this._mode};a.prototype.save=function(a,b,e){switch(this.mode()){case "localStorage":b="object"===typeof b?"json::fdb::"+JSON.stringify(b):"raw::fdb::"+b;try{localStorage.setItem(a,
b)}catch(c){if(e)e(c);else throw c;break}if(e)e(!1);else return!1;break;default:if(e)e("No data handler.");else throw"No data handler.";}};a.prototype.load=function(a,b){var e,c;switch(this.mode()){case "localStorage":try{e=localStorage.getItem(a)}catch(f){b(f,null)}if(e){e=e.split("::fdb::");switch(e[0]){case "json":c=JSON.parse(e[1]);break;case "raw":c=e[1]}if(b)b(!1,c);else return c}break;default:if(b)b("No data handler or unrecognised data type.");else throw"No data handler or unrecognised data type.";
}};a.prototype.drop=function(a,b){switch(this.mode()){case "localStorage":try{localStorage.removeItem(a)}catch(e){b&&b(e)}b&&b(!1);break;default:b&&b("No data handler or unrecognised data type.")}};g.prototype.drop=function(a){if(a)if(this._name)if(this._db)this._db.persist.drop(this._name);else return callback&&callback("Cannot drop a collection's persistent storage when the collection is not attached to a database!"),"Cannot drop a collection's persistent storage when the collection is not attached to a database!";
else return callback&&callback("Cannot drop a collection's persistent storage when no name assigned to collection!"),"Cannot drop a collection's persistent storage when no name assigned to collection!";f.apply(this)};g.prototype.save=function(a){if(this._name)if(this._db)this._db.persist.save(this._name,this._data,a);else return a&&a("Cannot save a collection that is not attached to a database!"),"Cannot save a collection that is not attached to a database!";else return a&&a("Cannot save a collection with no assigned name!"),
"Cannot save a collection with no assigned name!"};g.prototype.load=function(a){var b=this;if(this._name)if(this._db)this._db.persist.load(this._name,function(e,c){if(e)return a&&a(e),e;c&&b.setData(c);a&&a(!1)});else return a&&a("Cannot load a collection that is not attached to a database!"),"Cannot load a collection that is not attached to a database!";else return a&&a("Cannot load a collection with no assigned name!"),"Cannot load a collection with no assigned name!"};k.prototype.init=function(){this.persist=
new a(this);c.apply(this,arguments)};m.exports=a},{"./Collection":3,"./CollectionGroup":4,"./Shared":19}],18:[function(h,m,k){h=h("./Shared");k=function(g,f,c){if(g&&f&&c){this._reactorIn=g;this._reactorOut=f;this._chainHandler=c;if(!g.chain||!f.chainReceive)throw"ReactorIO requires passed in and out objects to implement the ChainReactor mixin!";g.chain(this);this.chain(f)}else throw"ReactorIO requires an in, out and process argument to instantiate!";};k.prototype.drop=function(){this._reactorIn.unChain(this);
this.unChain(this._reactorOut);delete this._reactorIn;delete this._reactorOut;delete this._chainHandler};h.addModule("ReactorIO",k);h.inherit(k.prototype,h.chainReactor);m.exports=k},{"./Shared":19}],19:[function(h,m,k){var g=0,f=function(c){var a=[],d,b=["string","object","number","function","undefined"],e;if(-1<c.indexOf("*"))for(e=0;e<b.length;e++)d=c.replace("*",b[e]),a=a.concat(f(d));else a.push(c);return a};k=function(c){if(c){var a,d,b,e,g;if(!(c instanceof Array)){b={};for(a in c)if(c.hasOwnProperty(a))if(e=
a.replace(/ /g,""),-1===e.indexOf("*"))b[e]=c[a];else for(g=f(e),e=0;e<g.length;e++)b[g[e]]||(b[g[e]]=c[a]);c=b}return function(){if(c instanceof Array)for(d=c.length,a=0;a<d;a++){if(c[a].length===arguments.length)return c[a].apply(this,arguments)}else{var b=[],e;for(a=0;a<arguments.length;a++)b.push(typeof arguments[a]);e=b.join(",");if(c[e])return c[e].apply(this,arguments);for(a=b.length;0<=a;a--)if(e=b.slice(0,a).join(","),c[e+",..."])return c[e+",..."].apply(this,arguments)}throw"Overloaded method does not have a matching signature for the passed arguments!";
}}return function(){}};h={modules:{},common:{decouple:function(c){if(void 0!==c)return JSON.parse(JSON.stringify(c))},objectId:function(c){var a=Math.pow(10,17);if(c){var d=0,b=c.length,e;for(e=0;e<b;e++)d+=c.charCodeAt(e)*a;c=d.toString(16)}else g++,c=(g+(Math.random()*a+Math.random()*a+Math.random()*a+Math.random()*a)).toString(16);return c},debug:new k([function(){return this._debug&&this._debug.all},function(c){return void 0!==c?"boolean"===typeof c?(this._debug=this._debug||{},this._debug.all=
c,this.chainSend("debug",this._debug),this):this._debug&&this._debug[c]||this._db&&this._db._debug&&this._db._debug[c]||this._debug&&this._debug.all:this._debug&&this._debug.all},function(c,a){return void 0!==c?void 0!==a?(this._debug=this._debug||{},this._debug[c]=a,this.chainSend("debug",this._debug),this):this._debug&&this._debug[a]||this._db&&this._db._debug&&this._db._debug[c]:this._debug&&this._debug.all}]),on:new k({"string, function":function(c,a){this._listeners=this._listeners||{};this._listeners[c]=
this._listeners[c]||{};this._listeners[c]["*"]=this._listeners[c]["*"]||[];this._listeners[c]["*"].push(a);return this},"string, *, function":function(c,a,d){this._listeners=this._listeners||{};this._listeners[c]=this._listeners[c]||{};this._listeners[c][a]=this._listeners[c][a]||[];this._listeners[c][a].push(d);return this}}),off:new k({string:function(c){this._listeners&&this._listeners[c]&&c in this._listeners&&delete this._listeners[c];return this},"string, function":function(c,a){var d,b;"string"===
typeof a?this._listeners&&this._listeners[c]&&this._listeners[c][a]&&delete this._listeners[c][a]:c in this._listeners&&(d=this._listeners[c]["*"],b=d.indexOf(a),-1<b&&d.splice(b,1));return this},"string, *, function":function(c,a,d){this._listeners&&c in this._listeners&&a in this.listeners[c]&&(c=this._listeners[c][a],d=c.indexOf(d),-1<d&&c.splice(d,1))},"string, *":function(c,a){this._listeners&&c in this._listeners&&a in this._listeners[c]&&delete this._listeners[c][a]}}),emit:function(c,a){this._listeners=
this._listeners||{};if(c in this._listeners){if(this._listeners[c]["*"]){var d=this._listeners[c]["*"],b=d.length,e;for(e=0;e<b;e++)d[e].apply(this,Array.prototype.slice.call(arguments,1))}if(a instanceof Array&&a[0]&&a[0][this._primaryKey]){var d=this._listeners[c],f,g,b=a.length;for(e=0;e<b;e++)if(d[a[e][this._primaryKey]])for(f=d[a[e][this._primaryKey]].length,g=0;g<f;g++)d[a[e][this._primaryKey]][g].apply(this,Array.prototype.slice.call(arguments,1))}}return this}},_synth:{},addModule:function(c,
a){this.modules[c]=a},inherit:function(c,a){for(var d in a)a.hasOwnProperty(d)&&(c[d]=a[d])},synthesize:function(c,a,d){this._synth[a]=this._synth[a]||function(b){return void 0!==b?(this["_"+a]=b,this):this["_"+a]};if(d){var b=this;c[a]=function(){var e=this.$super,c;this.$super=b._synth[a];c=d.apply(this,arguments);this.$super=e;return c}}else c[a]=this._synth[a]},overload:k,chainReactor:h("./ChainReactor")};m.exports=h},{"./ChainReactor":2}],20:[function(h,m,k){var g,f,c,a;k=h("./Shared");var d=
function(b,a,c){this.init.apply(this,arguments)};d.prototype.init=function(b,a,c){this._name=b;this._groups=[];this._listeners={};this._querySettings={query:a,options:c};this._debug={};this._privateData=new g("__FDB__view_privateData_"+this._name)};k.addModule("View",d);k.inherit(d.prototype,k.chainReactor);g=h("./Collection");CollectionGroup=h("./CollectionGroup");a=h("./ReactorIO");f=g.prototype.init;h=k.modules.Core;c=h.prototype.init;k.synthesize(d.prototype,"name");d.prototype.debug=k.common.debug;
d.prototype.insert=function(){this._from.insert.apply(this._from,arguments)};d.prototype.update=function(){this._from.update.apply(this._from,arguments)};d.prototype.updateById=function(){this._from.updateById.apply(this._from,arguments)};d.prototype.remove=function(){this._from.remove.apply(this._from,arguments)};d.prototype.find=function(b,a){return this.publicData().find(b,a)};d.prototype.link=function(b,a){var c=this.publicData();this.debug()&&console.log('ForerunnerDB.View: Setting up data binding on view "'+
this.name()+'" in underlying (internal) view collection "'+c.name()+'" for output target: '+b);return c.link(b,a)};d.prototype.unlink=function(b,a){var c=this.publicData();this.debug()&&console.log('ForerunnerDB.View: Removing data binding on view "'+this.name()+'" in underlying (internal) view collection "'+c.name()+'" for output target: '+b);return c.unlink(b,a)};d.prototype.decouple=k.common.decouple;d.prototype.from=function(b){var e=this;if(void 0!==b){"string"===typeof b&&(b=this._db.collection(b));
this._from=b;this._io=new a(b,this,function(b){var a,c,d;if("insert"===b.type){if(e._querySettings.query){a=b.data;if(a instanceof Array)for(c=[],b=0;b<a.length;b++)e._privateData._match(a[b],e._querySettings.query,"and")&&(c.push(a[b]),d=!0);else e._privateData._match(a,e._querySettings.query,"and")&&(c=a,d=!0);d&&this.chainSend("insert",c);return!0}return!1}if("update"===b.type){if(e._querySettings.query&&(c=e._privateData.diff(e._from.subset(e._querySettings.query,e._querySettings.options)),c.insert.length||
c.remove.length)){c.insert.length&&this.chainSend("insert",c.insert);if(c.update.length)for(a=e._privateData.primaryKey(),b=0;b<c.update.length;b++)d={},d[a]=c.update[b][a],this.chainSend("update",{query:d,update:c.update[b]});c.remove.length&&this.chainSend("remove",c.remove);return!0}return!1}});var c=b.find(this._querySettings.query,this._querySettings.options);this._transformPrimaryKey(b.primaryKey());this._transformInsert(c);this._privateData.primaryKey(b.primaryKey());this._privateData.insert(c)}return this};
d.prototype._chainHandler=function(b){var a,c,d,f;switch(b.type){case "setData":this.debug()&&console.log('ForerunnerDB.View: Setting data on view "'+this.name()+'" in underlying (internal) view collection "'+this._privateData.name()+'"');b.data=this.decouple(b.data);this._transformSetData(b.data);this._privateData.setData(b.data);break;case "insert":this.debug()&&console.log('ForerunnerDB.View: Inserting some data on view "'+this.name()+'" in underlying (internal) view collection "'+this._privateData.name()+
'"');b.data=this.decouple(b.data);b.data instanceof Array||(b.data=[b.data]);a=this._privateData._data.length;this._transformInsert(b.data,a);this._privateData._insertHandle(b.data,a);this._refreshSort(b.data);break;case "update":this.debug()&&console.log('ForerunnerDB.View: Updating some data on view "'+this.name()+'" in underlying (internal) view collection "'+this._privateData.name()+'"');this._privateData.primaryKey();b=this._privateData.update(b.data.query,b.data.update,b.data.options);this._refreshSort(b);
if(this._transformEnabled&&this._transformIn)for(a=this._publicData.primaryKey(),f=0;f<b.length;f++)c={},d=b[f],c[a]=d[a],this._transformUpdate(c,d);break;case "remove":this.debug()&&console.log('ForerunnerDB.View: Removing some data on view "'+this.name()+'" in underlying (internal) view collection "'+this._privateData.name()+'"'),this._transformRemove(b.data.query,b.options),this._privateData.remove(b.data.query,b.options)}};d.prototype._refreshSort=function(a){if(this._querySettings.options&&this._querySettings.options.$orderBy){var c,
d,f,g;a||(a=this._privateData._data);c=[].concat(this._privateData._data);c=this._privateData.sort(this._querySettings.options.$orderBy,c);c.sort(function(a,b){return c.indexOf(a)-c.indexOf(b)});for(g=0;g<a.length;g++)d=this._privateData._data.indexOf(a[g]),f=c.indexOf(a[g]),d!==f&&this._privateData._updateSpliceMove(this._privateData._data,d,f)}};d.prototype.on=function(){this._privateData.on.apply(this._privateData,arguments)};d.prototype.off=function(){this._privateData.off.apply(this._privateData,
arguments)};d.prototype.emit=function(){this._privateData.emit.apply(this._privateData,arguments)};d.prototype.drop=function(){return this._from?((this.debug()||this._db&&this._db.debug())&&console.log("ForerunnerDB.View: Dropping view "+this._name),this._io.drop(),this._privateData.drop(),!0):!1};d.prototype.db=function(a){return void 0!==a?(this._db=a,this.privateData().db(a),this.publicData().db(a),this):this._db};d.prototype.primaryKey=function(){return this._privateData.primaryKey()};d.prototype.queryData=
function(a,c,d){void 0!==a&&(this._querySettings.query=a);void 0!==c&&(this._querySettings.options=c);return void 0!==a||void 0!==c?(void 0!==d&&!0!==d||this.refresh(),this):this._querySettings};d.prototype.queryAdd=function(a,c,d){var f=this._querySettings.query,g;if(void 0!==a)for(g in a)a.hasOwnProperty(g)&&(void 0===f[g]||void 0!==f[g]&&c)&&(f[g]=a[g]);void 0!==d&&!0!==d||this.refresh()};d.prototype.queryRemove=function(a,c){var d=this._querySettings.query,f;if(void 0!==a)for(f in a)a.hasOwnProperty(f)&&
delete d[f];void 0!==c&&!0!==c||this.refresh()};d.prototype.query=function(a,c){return void 0!==a?(this._querySettings.query=a,void 0!==c&&!0!==c||this.refresh(),this):this._querySettings.query};d.prototype.queryOptions=function(a,c){return void 0!==a?(this._querySettings.options=a,void 0===a.$decouple&&(a.$decouple=!0),void 0!==c&&!0!==c||this.refresh(),this):this._querySettings.options};d.prototype.refresh=function(){if(this._from){var a=this.publicData();this._privateData.remove();a.remove();this._privateData.insert(this._from.find(this._querySettings.query,
this._querySettings.options));if(a._linked){var c=this._privateData.find();jQuery.observable(a._data).refresh(c)}}return this};d.prototype.count=function(){return this._privateData&&this._privateData._data?this._privateData._data.length:0};d.prototype.transform=function(a){return void 0!==a?("object"===typeof a?(void 0!==a.enabled&&(this._transformEnabled=a.enabled),void 0!==a.dataIn&&(this._transformIn=a.dataIn),void 0!==a.dataOut&&(this._transformOut=a.dataOut)):this._transformEnabled=!1===a?!1:
!0,this._transformPrimaryKey(this.privateData().primaryKey()),this._transformSetData(this.privateData().find()),this):{enabled:this._transformEnabled,dataIn:this._transformIn,dataOut:this._transformOut}};d.prototype.privateData=function(){return this._privateData};d.prototype.publicData=function(){return this._transformEnabled?this._publicData:this._privateData};d.prototype._transformSetData=function(a){this._transformEnabled&&(this._publicData=new g("__FDB__view_publicData_"+this._name),this._publicData.db(this._privateData._db),
this._publicData.transform({enabled:!0,dataIn:this._transformIn,dataOut:this._transformOut}),this._publicData.setData(a))};d.prototype._transformInsert=function(a,c){this._transformEnabled&&this._publicData&&this._publicData.insert(a,c)};d.prototype._transformUpdate=function(a,c,d){this._transformEnabled&&this._publicData&&this._publicData.update(a,c,d)};d.prototype._transformRemove=function(a,c){this._transformEnabled&&this._publicData&&this._publicData.remove(a,c)};d.prototype._transformPrimaryKey=
function(a){this._transformEnabled&&this._publicData&&this._publicData.primaryKey(a)};g.prototype.init=function(){this._views=[];f.apply(this,arguments)};g.prototype.view=function(a,c,f){if(this._db&&this._db._views){if(this._db._views[a])throw"Cannot create a view using this collection because one with this name already exists: "+a;a=(new d(a,c,f)).db(this._db)._addCollection(this);this._views=this._views||[];this._views.push(a);return a}};g.prototype._addView=CollectionGroup.prototype._addView=
function(a){void 0!==a&&this._views.push(a);return this};g.prototype._removeView=CollectionGroup.prototype._removeView=function(a){void 0!==a&&(a=this._views.indexOf(a),-1<a&&this._views.splice(a,1));return this};h.prototype.init=function(){this._views={};c.apply(this,arguments)};h.prototype.view=function(a){this._views[a]||(this.debug()||this._db&&this._db.debug())&&console.log("Core.View: Creating view "+a);this._views[a]=this._views[a]||(new d(a)).db(this);return this._views[a]};h.prototype.viewExists=
function(a){return Boolean(this._views[a])};h.prototype.views=function(){var a=[],c;for(c in this._views)this._views.hasOwnProperty(c)&&a.push({name:c,count:this._views[c].count()});return a};m.exports=d},{"./Collection":3,"./CollectionGroup":4,"./ReactorIO":18,"./Shared":19}]},{},[1])(1)});
