!function(w){if("object"==typeof exports&&"undefined"!=typeof module)module.exports=w();else if("function"==typeof define&&define.amd)define([],w);else{var k;"undefined"!=typeof window?k=window:"undefined"!=typeof global?k=global:"undefined"!=typeof self&&(k=self);k.ForerunnerDB=w()}}(function(){return function k(p,m,g){function a(b,e){if(!m[b]){if(!p[b]){var f="function"==typeof require&&require;if(!e&&f)return f(b,!0);if(c)return c(b,!0);f=Error("Cannot find module '"+b+"'");throw f.code="MODULE_NOT_FOUND",
f;}f=m[b]={exports:{}};p[b][0].call(f.exports,function(d){var h=p[b][1][d];return a(h?h:d)},f,f.exports,k,p,m,g)}return m[b].exports}for(var c="function"==typeof require&&require,e=0;e<g.length;e++)a(g[e]);return a}({1:[function(k,p,m){m=k("../lib/Core");k("../lib/View");p.exports=m},{"../lib/Core":4,"../lib/View":13}],2:[function(k,p,m){var g,a,c,e,b,l;g=k("./Shared");var f=function(d){this.init.apply(this,arguments)};f.prototype.init=function(d){this._primaryKey="_id";this._primaryIndex=new c("primary");
this._primaryCrc=new c("primaryCrc");this._crcLookup=new c("crcLookup");this._name=d;this._data=[];this._groups=[];this._metrics=new a;this._linked=0;this._debug={};this._deferQueue={insert:[],update:[],remove:[],upsert:[]};this._deferThreshold={insert:100,update:100,remove:100,upsert:100};this._deferTime={insert:1,update:1,remove:1,upsert:1};this._subsetOf(this)};g.addModule("Collection",f);g.inherit(f.prototype,g.chainSystem);m=k("./Overload");a=k("./Metrics");c=k("./KeyValueStore");e=k("./Path");
b=k("./Index");l=k("./Crc");k=g.modules.Core;f.prototype.debug=new m([function(){return this._debug.all},function(d){return void 0!==d?"boolean"===typeof d?(this._debug.all=d,this.chainSend("debug",this._debug),this):this._debug[d]||this._db&&this._db._debug&&this._db._debug[d]||this._debug.all:this._debug.all},function(d,h){return void 0!==d?void 0!==h?(this._debug[d]=h,this.chainSend("debug",this._debug),this):this._debug[d]||this._db&&this._db._debug&&this._db._debug[d]:this._debug.all}]);f.prototype.crc=
l;f.prototype.name=function(d){return void 0!==d?(this._name=d,this):this._name};f.prototype.on=new m([function(d,h){this._listeners=this._listeners||{};this._listeners[d]=this._listeners[d]||{};this._listeners[d]["*"]=this._listeners[d]["*"]||[];this._listeners[d]["*"].push(h);return this},function(d,h,b){this._listeners=this._listeners||{};this._listeners[d]=this._listeners[d]||{};this._listeners[d][h]=this._listeners[d][h]||[];this._listeners[d][h].push(b);return this}]);f.prototype.off=new m([function(d){this._listeners&&
this._listeners[d]&&d in this._listeners&&delete this._listeners[d];return this},function(d,h){var b,e;"string"===typeof h?this._listeners&&this._listeners[d]&&this._listeners[d][h]&&delete this._listeners[d][h]:d in this._listeners&&(b=this._listeners[d]["*"],e=b.indexOf(h),-1<e&&b.splice(e,1));return this},function(d,h,b){this._listeners&&d in this._listeners&&(d=this._listeners[d][h],b=d.indexOf(b),-1<b&&d.splice(b,1))}]);f.prototype.emit=function(d,h){this._listeners=this._listeners||{};if(d in
this._listeners){if(this._listeners[d]["*"]){var b=this._listeners[d]["*"],e=b.length,a;for(a=0;a<e;a++)b[a].apply(this,Array.prototype.slice.call(arguments,1))}if(h instanceof Array&&h[0]&&h[0][this._primaryKey]){var b=this._listeners[d],f,c,e=h.length;for(a=0;a<e;a++)if(b[h[a][this._primaryKey]])for(f=b[h[a][this._primaryKey]].length,c=0;c<f;c++)b[h[a][this._primaryKey]][c].apply(this,Array.prototype.slice.call(arguments,1))}}return this};f.prototype.drop=function(){if(this._db&&this._name){this.debug()&&
console.log("Dropping collection "+this._name);this.emit("drop");delete this._db._collection[this._name];var d=[],h;for(h=0;h<this._groups.length;h++)d.push(this._groups[h]);for(h=0;h<d.length;h++)this._groups[h].removeCollection(this);return!0}return!1};f.prototype.primaryKey=function(d){return void 0!==d?(this._primaryKey=d,this._primaryIndex.primaryKey(d),this._rebuildPrimaryKeyIndex(),this):this._primaryKey};f.prototype._onInsert=function(d,h){this.emit("insert",d,h)};f.prototype._onUpdate=function(d){this.emit("update",
d)};f.prototype._onRemove=function(d){this.emit("remove",d)};f.prototype.db=function(d){return void 0!==d?(this._db=d,this):this._db};f.prototype.setData=function(d,h,b){if(d){var e=this._metrics.create("setData");e.start();h=h||{};h.$decouple=void 0!==h.$decouple?h.$decouple:!0;h.$decouple&&(d=this.decouple(d));d instanceof Array||(d=[d]);e.time("transformIn");d=this.transformIn(d);e.time("transformIn");var a=this._data;this._linked?this.remove():this._data=[];d.length&&(this._linked?this.insert(d):
this._data=this._data.concat(d));e.time("Rebuild Primary Key Index");this._rebuildPrimaryKeyIndex(h);e.time("Rebuild Primary Key Index");e.time("Resolve chains");this.chainSend("setData",d,{oldData:a});e.time("Resolve chains");e.stop();this.emit("setData",this._data,a)}b&&b(!1);return this};f.prototype._rebuildPrimaryKeyIndex=function(d){var h=d&&void 0!==d.ensureKeys?d.ensureKeys:!0;d=d&&void 0!==d.violationCheck?d.violationCheck:!0;var b,e,a,f=this._primaryIndex,c=this._primaryCrc,g=this._crcLookup,
l=this._primaryKey,k;f.truncate();c.truncate();g.truncate();b=this._data;for(e=b.length;e--;)if(a=b[e],h&&this._ensurePrimaryKey(a),d){if(!f.uniqueSet(a[l],a))throw"Call to setData failed because your data violates the primary key unique constraint. One or more documents are using the same primary key: "+a[this._primaryKey];}else k=JSON.stringify(a),f.set(a[l],a),c.set(a[l],k),g.set(k,a)};f.prototype._ensurePrimaryKey=function(d){void 0===d[this._primaryKey]&&(d[this._primaryKey]=this.objectId())};
f.prototype.truncate=function(){this.emit("truncate",this._data);this._data.length=0;this.deferEmit("change");return this};f.prototype.upsert=function(d,h){if(d){var b=this._deferQueue.upsert,e=this._deferThreshold.upsert,a={},f;if(d instanceof Array){if(d.length>e){this._deferQueue.upsert=b.concat(d);this.processQueue("upsert",h);return}a=[];for(b=0;b<d.length;b++)a.push(this.upsert(d[b]));h&&h();return a}d[this._primaryKey]?(f={},f[this._primaryKey]=d[this._primaryKey],this.count(f)?a.op="update":
a.op="insert"):a.op="insert";switch(a.op){case "insert":a.result=this.insert(d);break;case "update":a.result=this.update(f,d)}return a}h&&h()};f.prototype.update=function(d,h,b){h=this.decouple(h);h=this.transformIn(h);this.debug()&&console.log('Updating some collection data for collection "'+this.name()+'"');var e=this,a=this._metrics.create("update"),f=this._primaryKey,c,g,l=function(a){if(h&&void 0!==h[f]&&h[f]!=a[f]){e._primaryIndex.unSet(a[f]);var c=e._updateObject(a,h,d,b,"");if(e._primaryIndex.uniqueSet(a[f],
a))return c;throw"Primary key violation in update! Key violated: "+a[f];}return e._updateObject(a,h,d,b,"")};a.start();a.time("Retrieve documents to update");c=this.find(d,{$decouple:!1});a.time("Retrieve documents to update");c.length&&(a.time("Update documents"),g=c.filter(l),a.time("Update documents"),g.length&&(a.time("Resolve chains"),this.chainSend("update",{query:d,update:h},b),a.time("Resolve chains"),this._onUpdate(g),this.deferEmit("change",{type:"update",data:g})));a.stop();return g||[]};
f.prototype.updateById=function(d,h){var b={};b[this._primaryKey]=d;return this.update(b,h)};f.prototype._updateObject=function(d,h,b,a,f,c){h=this.decouple(h);f=f||"";"."===f.substr(0,1)&&(f=f.substr(1,f.length-1));var g=!1,l=!1,k,m,q,n;for(n in h)if(h.hasOwnProperty(n)){k=!1;if("$"===n.substr(0,1))switch(n){case "$index":break;default:k=!0,(l=this._updateObject(d,h[n],b,a,f,n))&&(g=!0)}if(this._isPositionalKey(n)&&(k=!0,n=n.substr(0,n.length-2),l=new e(f+"."+n),d[n]&&d[n]instanceof Array&&d[n].length)){m=
[];for(q=0;q<d[n].length;q++)this._match(d[n][q],l.value(b)[0])&&m.push(q);for(q=0;q<m.length;q++)(l=this._updateObject(d[n][m[q]],h[n+".$"],b,a,f+"."+n,c))&&(g=!0)}if(!k)if(c||"object"!==typeof h[n])switch(c){case "$inc":this._updateIncrement(d,n,h[n]);g=!0;break;case "$push":void 0===d[n]&&(d[n]=[]);if(d[n]instanceof Array){if(void 0!==h[n].$position&&h[n].$each instanceof Array)for(l=h[n].$position,k=h[n].$each.length,q=0;q<k;q++)this._updateSplicePush(d[n],l+q,h[n].$each[q]);else if(h[n].$each instanceof
Array)for(k=h[n].$each.length,q=0;q<k;q++)this._updatePush(d[n],h[n].$each[q]);else this._updatePush(d[n],h[n]);g=!0}else throw"Cannot push to a key that is not an array! ("+n+")";break;case "$pull":if(d[n]instanceof Array){m=[];for(q=0;q<d[n].length;q++)this._match(d[n][q],h[n])&&m.push(q);for(k=m.length;k--;)this._updatePull(d[n],m[k]),g=!0}break;case "$pullAll":if(d[n]instanceof Array)if(h[n]instanceof Array){if(m=d[n],k=m.length,0<k)for(;k--;){for(l=0;l<h[n].length;l++)m[k]===h[n][l]&&(this._updatePull(d[n],
k),k--,g=!0);if(0>k)break}}else throw"Cannot pullAll without being given an array of values to pull! ("+n+")";break;case "$addToSet":void 0===d[n]&&(d[n]=[]);if(d[n]instanceof Array){q=d[n];var p;m=q.length;var t;k=!0;p=a&&a.$addToSet;var r;p&&p.key?(l=!1,r=new e(p.key),t=r.value(h[n])[0]):(t=JSON.stringify(h[n]),l=!0);for(p=0;p<m;p++)if(l){if(JSON.stringify(q[p])===t){k=!1;break}}else if(t===r.value(q[p])[0]){k=!1;break}k&&(this._updatePush(d[n],h[n]),g=!0)}else throw"Cannot addToSet on a key that is not an array! (undefined)!";
break;case "$splicePush":void 0===d[n]&&(d[n]=[]);if(d[n]instanceof Array)if(l=h.$index,void 0!==l)delete h.$index,this._updateSplicePush(d[n],l,h[n]),g=!0;else throw"Cannot splicePush without a $index integer value!";else throw"Cannot splicePush with a key that is not an array! ("+n+")";break;case "$move":if(d[n]instanceof Array)for(q=0;q<d[n].length;q++){if(this._match(d[n][q],h[n])){g=h[n].$index;if(void 0!==g)this._updateSpliceMove(d[n],q,g),g=!0;else throw"Cannot move without a $index integer value!";
break}}else throw"Cannot move on a key that is not an array! ("+n+")";break;case "$mul":this._updateMultiply(d,n,h[n]);g=!0;break;case "$rename":this._updateRename(d,n,h[n]);g=!0;break;case "$unset":this._updateUnset(d,n);g=!0;break;case "$pop":if(d[n]instanceof Array)this._updatePop(d[n],h[n])&&(g=!0);else throw"Cannot pop from a key that is not an array! ("+n+")";break;default:d[n]!==h[n]&&(this._updateProperty(d,n,h[n]),g=!0)}else if(null!==d[n]&&"object"===typeof d[n])if(q=d[n]instanceof Array,
m=h[n]instanceof Array,q||m)if(!m&&q)for(q=0;q<d[n].length;q++)(l=this._updateObject(d[n][q],h[n],b,a,f+"."+n,c))&&(g=!0);else d[n]!==h[n]&&(this._updateProperty(d,n,h[n]),g=!0);else(l=this._updateObject(d[n],h[n],b,a,f+"."+n,c))&&(g=!0);else d[n]!==h[n]&&(this._updateProperty(d,n,h[n]),g=!0)}return g};f.prototype._isPositionalKey=function(d){return".$"===d.substr(d.length-2,2)};f.prototype._updateProperty=function(d,h,b){this._linked?(jQuery.observable(d).setProperty(h,b),this.debug()&&console.log('ForerunnerDB.Collection: Setting data-bound document property "'+
h+'" for collection "'+this.name()+'"')):(d[h]=b,this.debug()&&console.log('ForerunnerDB.Collection: Setting non-data-bound document property "'+h+'" for collection "'+this.name()+'"'))};f.prototype._updateIncrement=function(d,h,b){this._linked?jQuery.observable(d).setProperty(h,d[h]+b):d[h]+=b};f.prototype._updateSpliceMove=function(d,h,b){this._linked?(jQuery.observable(d).move(h,b),this.debug()&&console.log('ForerunnerDB.Collection: Moving data-bound document array index from "'+h+'" to "'+b+'" for collection "'+
this.name()+'"')):(d.splice(b,0,d.splice(h,1)[0]),this.debug()&&console.log('ForerunnerDB.Collection: Moving non-data-bound document array index from "'+h+'" to "'+b+'" for collection "'+this.name()+'"'))};f.prototype._updateSplicePush=function(d,h,b){d.length>h?this._linked?jQuery.observable(d).insert(h,b):d.splice(h,0,b):this._linked?jQuery.observable(d).insert(b):d.push(b)};f.prototype._updatePush=function(d,h){this._linked?jQuery.observable(d).insert(h):d.push(h)};f.prototype._updatePull=function(d,
h){this._linked?jQuery.observable(d).remove(h):d.splice(h,1)};f.prototype._updateMultiply=function(d,h,b){this._linked?jQuery.observable(d).setProperty(h,d[h]*b):d[h]*=b};f.prototype._updateRename=function(d,h,b){var e=d[h];this._linked?(jQuery.observable(d).setProperty(b,e),jQuery.observable(d).removeProperty(h)):(d[b]=e,delete d[h])};f.prototype._updateUnset=function(d,h){this._linked?jQuery.observable(d).removeProperty(h):delete d[h]};f.prototype._updatePop=function(d,h){var b,e=!1;0<d.length&&
(this._linked?(1===h?b=d.length-1:-1===h&&(b=0),-1<b&&(jQuery.observable(arr).remove(b),e=!0)):1===h?(d.pop(),e=!0):-1===h&&(d.shift(),e=!0));return e};f.prototype.remove=function(d,h,b){var e,a;if(d instanceof Array){a=[];for(b=0;b<d.length;b++)a.push(this.remove(d[b],{noEmit:!0}));(!h||h&&!h.noEmit)&&this._onRemove(a);return a}b=this.find(d,{$decouple:!1});if(b.length){for(a=0;a<b.length;a++)e=b[a],this._removeIndex(e),e=this._data.indexOf(e),this._linked?jQuery.observable(this._data).remove(e):
this._data.splice(e,1);this.chainSend("remove",{query:d},h);(!h||h&&!h.noEmit)&&this._onRemove(b);this.deferEmit("change",{type:"remove",data:b})}return b};f.prototype.removeById=function(d){var h={};h[this._primaryKey]=d;return this.remove(h)};f.prototype.deferEmit=function(){var d=this,h;this._noEmitDefer||this._db&&(!this._db||this._db._noEmitDefer)?this.emit.apply(this,arguments):(h=arguments,this._changeTimeout&&clearTimeout(this._changeTimeout),this._changeTimeout=setTimeout(function(){d.debug()&&
console.log("ForerunnerDB.Collection: Emitting "+h[0]);d.emit.apply(d,h)},100))};f.prototype.processQueue=function(d,h){var b=this._deferQueue[d],e=this._deferThreshold[d],a=this._deferTime[d];if(b.length){var f=this;b.length&&(b=b.length>e?b.splice(0,e):b.splice(0,b.length),this[d](b));setTimeout(function(){f.processQueue(d,h)},a)}else h&&h()};f.prototype.insert=function(d,h,b){"function"===typeof h?(b=h,h=this._data.length):void 0===h&&(h=this._data.length);d=this.transformIn(d);return this._insertHandle(d,
h,b)};f.prototype._insertHandle=function(d,h,b){var e=this._deferQueue.insert,a=this._deferThreshold.insert,f=[],c=[];if(d instanceof Array){if(d.length>a){this._deferQueue.insert=e.concat(d);this.processQueue("insert",b);return}for(a=0;a<d.length;a++)e=this._insert(d[a],h+a),!0===e?f.push(d[a]):c.push({doc:d[a],reason:e})}else e=this._insert(d,h),!0===e?f.push(d):c.push({doc:d,reason:e});this.chainSend("insert",d,{index:h});this._onInsert(f,c);b&&b();this.deferEmit("change",{type:"insert",data:f});
return{inserted:f,failed:c}};f.prototype._insert=function(d,b){if(d){var e;this._ensurePrimaryKey(d);if(e=this.insertIndexViolation(d))return"Index violation in index: "+e;this._insertIndex(d);this._linked?jQuery.observable(this._data).insert(b,d):this._data.splice(b,0,d);return!0}return"No document passed to insert"};f.prototype._insertIndex=function(d){var b=this._indexByName,e,a=JSON.stringify(d);this._primaryIndex.uniqueSet(d[this._primaryKey],d);this._primaryCrc.uniqueSet(d[this._primaryKey],
a);this._crcLookup.uniqueSet(a,d);for(e in b)b.hasOwnProperty(e)&&b[e].insert(d)};f.prototype._removeIndex=function(d){var b=this._indexByName,e,a=JSON.stringify(d);this._primaryIndex.unSet(d[this._primaryKey]);this._primaryCrc.unSet(d[this._primaryKey]);this._crcLookup.unSet(a);for(e in b)b.hasOwnProperty(e)&&b[e].remove(d)};f.prototype.subset=function(d,b){var e=this.find(d,b);return(new f)._subsetOf(this).primaryKey(this._primaryKey).setData(e)};f.prototype.subsetOf=function(){return this.__subsetOf};
f.prototype._subsetOf=function(d){this.__subsetOf=d;return this};f.prototype.distinct=function(d,b,a){b=this.find(b,a);d=new e(d);a={};var f=[],c,g;for(g=0;g<b.length;g++)(c=d.value(b[g])[0])&&!a[c]&&(a[c]=!0,f.push(c));return f};f.prototype.decouple=function(d){return JSON.parse(JSON.stringify(d))};f.prototype.findById=function(d,b){var e={};e[this._primaryKey]=d;return this.find(e,b)[0]};f.prototype.peek=function(d,b){var e=this._data,a=e.length,c,g,l=new f;if("string"===typeof d){for(c=0;c<a;c++)g=
JSON.stringify(e[c]),-1<g.indexOf(d)&&l.insert(e[c]);return l.find({},b)}return this.find(d,b)};f.prototype.explain=function(d,b){return this.find(d,b).__fdbOp._data};f.prototype.find=function(d,b){d=d||{};b=b||{};b.$decouple=void 0!==b.$decouple?b.$decouple:!0;var a=this._metrics.create("find"),f=this,c,g=!0,l,k,m,p,q,n,u,t,r,v=[];k=function(b){return f._match(b,d,"and")};a.start();if(d){a.time("analyseQuery");c=this._analyseQuery(d,b,a);a.time("analyseQuery");a.data("analysis",c);if(c.hasJoin&&
c.queriesJoin){a.time("joinReferences");for(m=0;m<c.joinsOn.length;m++)q=c.joinsOn[m],p=new e(c.joinQueries[q]),p=p.value(d)[0],this._db.collection(c.joinsOn[m]).subset(p);a.time("joinReferences")}c.indexMatch.length&&(!b||b&&!b.$skipIndex)?(a.data("index.potential",c.indexMatch),a.data("index.used",c.indexMatch[0].index),a.time("indexLookup"),l=c.indexMatch[0].lookup,a.time("indexLookup"),c.indexMatch[0].keyData.totalKeyCount===c.indexMatch[0].keyData.matchedKeyCount&&(g=!1)):a.flag("usedIndex",
!1);g&&(l&&l.length?(c=l.length,a.time("tableScan: "+c),l=l.filter(k)):(c=this._data.length,a.time("tableScan: "+c),l=this._data.filter(k)),b.$orderBy&&(a.time("sort"),l=this.sort(b.$orderBy,l),a.time("sort")),a.time("tableScan: "+c));b.limit&&l&&l.length>b.limit&&(l.length=b.limit,a.data("limit",b.limit));b.$decouple&&(a.time("decouple"),l=this.decouple(l),a.time("decouple"),a.data("flag.decouple",!0));if(b.join){for(k=0;k<b.join.length;k++)for(q in b.join[k])if(b.join[k].hasOwnProperty(q))for(t=
q,c=this._db.collection(q),g=b.join[k][q],r=0;r<l.length;r++){u={};p=m=!1;for(n in g)if(g.hasOwnProperty(n))if("$"===n.substr(0,1))switch(n){case "$as":t=g[n];break;case "$multi":m=g[n];break;case "$require":p=g[n];break;default:n.substr(0,3)}else u[n]=(new e(g[n])).value(l[r])[0];u=c.find(u);!p||p&&u[0]?l[r][t]=!1===m?u[0]:u:v.push(l[r])}a.data("flag.join",!0)}if(v.length){a.time("removalQueue");for(n=0;n<v.length;n++)q=l.indexOf(v[n]),-1<q&&l.splice(q,1);a.time("removalQueue")}if(b.transform){a.time("transform");
for(n=0;n<l.length;n++)l.splice(n,1,b.transform(l[n]));a.time("transform");a.data("flag.transform",!0)}this._transformEnabled&&this._transformOut&&(a.time("transformOut"),l=this.transformOut(l),a.time("transformOut"));a.data("results",l.length);a.stop()}else a.stop(),l=[];l.__fdbOp=a;return l};f.prototype.indexOf=function(d){if(d=this.find(d,{$decouple:!1})[0])return this._data.indexOf(d)};f.prototype.transform=function(d){return void 0!==d?("object"===typeof d?(void 0!==d.enabled&&(this._transformEnabled=
d.enabled),void 0!==d.dataIn&&(this._transformIn=d.dataIn),void 0!==d.dataOut&&(this._transformOut=d.dataOut)):this._transformEnabled=!1===d?!1:!0,this):{enabled:this._transformEnabled,dataIn:this._transformIn,dataOut:this._transformOut}};f.prototype.transformIn=function(d){if(this._transformEnabled&&this._transformIn){if(d instanceof Array){var b=[],a;for(a=0;a<d.length;a++)b[a]=this._transformIn(d[a]);return b}return this._transformIn(d)}return d};f.prototype.transformOut=function(d){if(this._transformEnabled&&
this._transformOut){if(d instanceof Array){var b=[],a;for(a=0;a<d.length;a++)b[a]=this._transformOut(d[a]);return b}return this._transformOut(d)}return d};f.prototype.sort=function(d,b){b=b||[];var a=[],e,f;for(e in d)d.hasOwnProperty(e)&&(f={},f[e]=d[e],f.___fdbKey=e,a.push(f));return 2>a.length?this._sort(d,b):this._bucketSort(a,b)};f.prototype._bucketSort=function(d,b){var a=d.shift(),e,f,c=[];if(0<d.length){b=this._sort(a,b);e=this.bucket(a.___fdbKey,b);for(f in e)e.hasOwnProperty(f)&&(a=[].concat(d),
c=c.concat(this._bucketSort(a,e[f])));return c}return this._sort(a,b)};f.prototype._sort=function(d,b){var a=new e,f=a.parse(d,!0)[0];a.path(f.path);return b.sort(1===f.value?function(d,b){var e=a.value(d)[0],h=a.value(b)[0];return"string"===typeof e&&"string"===typeof h?e.localeCompare(h):e>h?1:e<h?-1:0}:function(d,b){var e=a.value(d)[0],h=a.value(b)[0];return"string"===typeof e&&"string"===typeof h?1===e.localeCompare(h)?-1:1:e>h?-1:e<h?1:0})};f.prototype.bucket=function(d,b){var a,e={};for(a=0;a<
b.length;a++)e[b[a][d]]=e[b[a][d]]||[],e[b[a][d]].push(b[a]);return e};f.prototype._analyseQuery=function(d,b,a){var f={queriesOn:[this._name],indexMatch:[],hasJoin:!1,queriesJoin:!1,joinQueries:{},query:d,options:b},c,g=[],l=[],k,m,p,q,n;a.time("checkIndexes");void 0!==d[this._primaryKey]&&(a.time("checkIndexMatch: Primary Key"),k=new e,f.indexMatch.push({lookup:this._primaryIndex.lookup(d,b),keyData:{matchedKeys:[this._primaryKey],matchedKeyCount:1,totalKeyCount:k.countKeys(d)},index:this._primaryIndex}),
a.time("checkIndexMatch: Primary Key"));for(n in this._indexById)if(this._indexById.hasOwnProperty(n)&&(m=this._indexById[n],p=m.name(),a.time("checkIndexMatch: "+p),k=m.match(d,b),q=m.lookup(d,b),0<k.matchedKeyCount&&f.indexMatch.push({lookup:q,keyData:k,index:m}),a.time("checkIndexMatch: "+p),k.totalKeyCount===k.matchedKeyCount))break;a.time("checkIndexes");1<f.indexMatch.length&&(a.time("findOptimalIndex"),f.indexMatch.sort(function(b,d){return b.keyData.totalKeyCount===b.keyData.matchedKeyCount?
-1:d.keyData.totalKeyCount===d.keyData.matchedKeyCount?1:b.keyData.matchedKeyCount===d.keyData.matchedKeyCount?b.lookup.length-d.lookup.length:d.keyData.matchedKeyCount-b.keyData.matchedKeyCount}),a.time("findOptimalIndex"));if(b.join){f.hasJoin=!0;for(a=0;a<b.join.length;a++)for(c in b.join[a])b.join[a].hasOwnProperty(c)&&(g.push(c),"$as"in b.join[a][c]?l.push(b.join[a][c].$as):l.push(c));for(c=0;c<l.length;c++)if(b=this._queryReferencesCollection(d,l[c],""))f.joinQueries[g[c]]=b,f.queriesJoin=!0;
f.joinsOn=g;f.queriesOn=f.queriesOn.concat(g)}return f};f.prototype._queryReferencesCollection=function(b,a,e){for(var f in b)if(b.hasOwnProperty(f)){if(f===a)return e&&(e+="."),e+f;if("object"===typeof b[f])return e&&(e+="."),e+=f,this._queryReferencesCollection(b[f],a,e)}return!1};f.prototype._match=function(b,a,e){var f,c;f=typeof b;c=typeof a;var g=!0,l;if(!("string"!==f&&"number"!==f||"string"!==c&&"number"!==c))b!==a&&(g=!1);else for(l in a)if(a.hasOwnProperty(l)){f=!1;if("$"===l.substr(0,1))switch(l){case "$gt":if(b>
a[l]){if("or"===e)return!0}else g=!1;f=!0;break;case "$gte":if(b>=a[l]){if("or"===e)return!0}else g=!1;f=!0;break;case "$lt":if(b<a[l]){if("or"===e)return!0}else g=!1;f=!0;break;case "$lte":if(b<=a[l]){if("or"===e)return!0}else g=!1;f=!0;break;case "$exists":if(void 0===b!==a[l]){if("or"===e)return!0}else g=!1;f=!0;break;case "$or":f=!0;for(c=0;c<a[l].length;c++){if(this._match(b,a[l][c],"and"))return!0;g=!1}break;case "$and":f=!0;for(c=0;c<a[l].length;c++)if(!this._match(b,a[l][c],"and"))return!1;
break;case "$in":if(a[l]instanceof Array){f=a[l];c=f.length;var k,m=!1;for(k=0;k<c;k++)if(f[k]===b){m=!0;break}if(m){if("or"===e)return!0}else g=!1}else throw"Cannot use a $nin operator on a non-array key: "+l;f=!0;break;case "$nin":if(a[l]instanceof Array){f=a[l];c=f.length;m=!0;for(k=0;k<c;k++)if(f[k]===b){m=!1;break}if(m){if("or"===e)return!0}else g=!1}else throw"Cannot use a $nin operator on a non-array key: "+l;f=!0;break;case "$ne":if(b!=a[l]){if("or"===e)return!0}else g=!1;f=!0}if(!f&&a[l]instanceof
RegExp)if(f=!0,"object"===typeof b&&void 0!==b[l]&&a[l].test(b[l])){if("or"===e)return!0}else g=!1;if(!f)if("object"===typeof a[l])if(void 0!==b[l]){if(b[l]instanceof Array&&!(a[l]instanceof Array))for(f=!1,c=0;c<b[l].length&&!(f=this._match(b[l][c],a[l],void 0));c++);else if(!(b[l]instanceof Array)&&a[l]instanceof Array)for(f=!1,c=0;c<a[l].length&&!(f=this._match(b[l],a[l][c],void 0));c++);else f="object"===typeof b?this._match(b[l],a[l],void 0):this._match(void 0,a[l],void 0);if(f){if("or"===e)return!0}else g=
!1}else if(a[l]&&void 0!==a[l].$exists)if(f=this._match(void 0,a[l],void 0)){if("or"===e)return!0}else g=!1;else g=!1;else if(b&&b[l]===a[l]){if("or"===e)return!0}else if(b&&b[l]&&b[l]instanceof Array&&a[l]&&"object"!==typeof a[l]){f=!1;for(c=0;c<b[l].length&&!(f=this._match(b[l][c],a[l],void 0));c++);if(f){if("or"===e)return!0}else g=!1}else g=!1;if("and"===e&&!g)return!1}return g};f.prototype.count=function(b,a){return b?this.find(b,a).length:this._data.length};f.prototype.link=function(b,a){if(window.jQuery){this._links=
this._links||{};var e,f;a&&"object"===typeof a?a.template&&"string"===typeof a.template&&(e=this.objectId(a.template),f=a.template):e=a;if(!this._links[e]){if(jQuery(b).length){if(!jQuery.templates[e]){if(!f)if(f=jQuery(a),f.length)f=jQuery(f[0]).html();else throw"Unable to bind collection to target because template does not exist: "+a;jQuery.views.templates(e,f)}jQuery.templates[e].link(b,this._data);this._links[e]=b;this._linked++;this.debug()&&console.log('ForerunnerDB.Collection: Added binding collection "'+
this.name()+'" to output target: '+b);return this}throw'Cannot bind view data to output target selector "'+b+'" because it does not exist in the DOM!';}throw"Cannot create a duplicate link to the target: "+b+" with the template: "+e;}throw"Cannot data-bind without jQuery, please add jQuery to your page!";};f.prototype.unlink=function(b,a){if(window.jQuery){this._links=this._links||{};var e;a&&"object"===typeof a?a.template&&"string"===typeof a.template&&(e=this.objectId(a.template)):e=a;if(this._links[e])return jQuery.templates[e].unlink(b),
delete this._links[e],this._linked--,this.debug()&&console.log('ForerunnerDB.Collection: Removed binding collection "'+this.name()+'" to output target: '+b),this;console.log("Cannot remove link, one does not exist to the target: "+b+" with the template: "+a)}else throw"Cannot data-bind without jQuery, please add jQuery to your page!";};f.prototype.findSub=function(b,a,f,c){var l=new e(a);b=this.find(b);var g=b.length,k,m,p=this._db.collection("__FDB_temp_"+this.objectId()),s={parents:g,subDocTotal:0,
subDocs:[],pathFound:!1,err:""};for(k=0;k<g;k++)if(m=l.value(b[k])[0]){p.setData(m);m=p.find(f,c);if(c.returnFirst&&m.length)return m[0];s.subDocs.push(m);s.subDocTotal+=m.length;s.pathFound=!0}p.drop();if(c.noStats)return s.subDocs;s.pathFound||(s.err="No objects found in the parent documents with a matching path of: "+a);return s};f.prototype.insertIndexViolation=function(b){var a,e=this._indexByName,f,c;if(this._primaryIndex.get(b[this._primaryKey]))a=this._primaryIndex;else for(f in e)if(e.hasOwnProperty(f)&&
(c=e[f],c.unique()&&c.violation(b))){a=c;break}return a?a.name():!1};f.prototype.ensureIndex=function(a,e){this._indexByName=this._indexByName||{};this._indexById=this._indexById||{};var f=new b(a,e,this),c={start:(new Date).getTime()};if(this._indexByName[f.name()])return{err:"Index with that name already exists"};if(this._indexById[f.id()])return{err:"Index with those keys already exists"};f.rebuild();this._indexByName[f.name()]=f;this._indexById[f.id()]=f;c.end=(new Date).getTime();c.total=c.end-
c.start;this._lastOp={type:"ensureIndex",stats:{time:c}};return{index:f,id:f.id(),name:f.name(),state:f.state()}};f.prototype.index=function(b){if(this._indexByName)return this._indexByName[b]};f.prototype.lastOp=function(){return this._metrics.list()};f.prototype.objectId=function(b){var a=Math.pow(10,17);if(b){var e=0,f=b.length,c;for(c=0;c<f;c++)e+=b.charCodeAt(c)*a;b=e.toString(16)}else g.idCounter++,b=(g.idCounter+(Math.random()*a+Math.random()*a+Math.random()*a+Math.random()*a)).toString(16);
return b};f.prototype.diff=function(b){var a={insert:[],update:[],remove:[]},e=this.primaryKey(),f,c,l,g;if(e===b.primaryKey()){f=b._data;g=f.length;for(c=0;c<g;c++)l=f[c],this._primaryIndex.get(l[e])?this._primaryCrc.get(l[e])!==b._primaryCrc.get(l[e])&&a.update.push(l):a.insert.push(l);f=this._data;g=f.length;for(c=0;c<g;c++)l=f[c],b._primaryIndex.get(l[e])||a.remove.push(l)}return a};k.prototype.collection=function(b,a){if(b)return this._collection[b]||this.debug()&&console.log("Creating collection "+
b),this._collection[b]=this._collection[b]||(new f(b)).db(this),void 0!==a&&this._collection[b].primaryKey(a),this._collection[b];throw"Cannot get collection with undefined name!";};k.prototype.collectionExists=function(b){return Boolean(this._collection[b])};k.prototype.collections=function(){var b=[],a;for(a in this._collection)this._collection.hasOwnProperty(a)&&b.push({name:a,count:this._collection[a].count()});return b};p.exports=f},{"./Crc":5,"./Index":6,"./KeyValueStore":7,"./Metrics":8,"./Overload":10,
"./Path":11,"./Shared":12}],3:[function(k,p,m){var g,a;m=k("./Shared");var c=function(){this.init.apply(this,arguments)};c.prototype.init=function(e){this._name=e;this._data=new a("__FDB__cg_data_"+this._name);this._collections=[];this._views=[]};m.addModule("CollectionGroup",c);m.inherit(c.prototype,m.chainSystem);a=k("./Collection");k("./Overload");k=m.modules.Core;g=m.modules.Core.prototype.init;c.prototype.on=function(){this._data.on.apply(this._data,arguments)};c.prototype.off=function(){this._data.off.apply(this._data,
arguments)};c.prototype.emit=function(){this._data.emit.apply(this._data,arguments)};c.prototype.primaryKey=function(a){return void 0!==a?(this._primaryKey=a,this):this._primaryKey};c.prototype.db=function(a){return void 0!==a?(this._db=a,this):this._db};c.prototype.addCollection=function(a){if(a&&-1===this._collections.indexOf(a)){if(this._collections.length){if(this._primaryKey!==a.primaryKey())throw"All collections in a collection group must have the same primary key!";}else this.primaryKey(a.primaryKey());
this._collections.push(a);a._groups.push(this);a.chain(this);this._data.insert(a.find())}return this};c.prototype.removeCollection=function(a){if(a){var b=this._collections.indexOf(a);-1!==b&&(a.unChain(this),this._collections.splice(b,1),b=a._groups.indexOf(this),-1!==b&&a._groups.splice(b,1));0===this._collections.length&&delete this._primaryKey}return this};c.prototype._chainHandler=function(a,b,c,f){switch(b){case "setData":c=this._data.decouple(c);this._data.remove(f.oldData);this._data.insert(c);
break;case "insert":c=this._data.decouple(c);this._data.insert(c);break;case "update":this._data.update(c.query,c.update,f);break;case "remove":this._data.remove(c.query,f)}};c.prototype.insert=function(){this._collectionsRun("insert",arguments)};c.prototype.update=function(){this._collectionsRun("update",arguments)};c.prototype.updateById=function(){this._collectionsRun("updateById",arguments)};c.prototype.remove=function(){this._collectionsRun("remove",arguments)};c.prototype._collectionsRun=function(a,
b){for(var c=0;c<this._collections.length;c++)this._collections[c][a].apply(this._collections[c],b)};c.prototype.find=function(a,b){return this._data.find(a,b)};c.prototype.removeById=function(a){for(var b=0;b<this._collections.length;b++)this._collections[b].removeById(a)};c.prototype.subset=function(e,b){var c=this.find(e,b);return(new a)._subsetOf(this).primaryKey(this._primaryKey).setData(c)};c.prototype.drop=function(){var a,b=[].concat(this._collections),c=[].concat(this._views);this._debug&&
console.log("Dropping collection group "+this._name);for(a=0;a<b.length;a++)this.removeCollection(b[a]);for(a=0;a<c.length;a++)this._removeView(c[a]);this.emit("drop");return!0};k.prototype.init=function(){this._collectionGroup={};g.apply(this,arguments)};k.prototype.collectionGroup=function(a){return a?(this._collectionGroup[a]=this._collectionGroup[a]||(new c(a)).db(this),this._collectionGroup[a]):this._collectionGroup};p.exports=c},{"./Collection":2,"./Overload":10,"./Shared":12}],4:[function(k,
p,m){var g,a;g=k("./Shared.js");var c=function(){this.init.apply(this,arguments)};c.prototype.init=function(){this._collection={};this._debug={}};g.addModule("Core",c);g.inherit(c.prototype,g.chainSystem);m=k("./Overload.js");a=k("./Collection.js");k("./Metrics.js");k=k("./Crc.js");c.prototype._isServer=!1;c.prototype.isClient=function(){return!this._isServer};c.prototype.isServer=function(){return this._isServer};c.prototype.crc=k;c.prototype.isClient=function(){return!this._isServer};c.prototype.isServer=
function(){return this._isServer};c.prototype.decouple=function(a){return JSON.parse(JSON.stringify(a))};c.prototype.debug=new m([function(){return this._debug.all},function(a){return void 0!==a&&"boolean"===typeof a?(this._debug.all=a,this):this._debug.all},function(a,b){return void 0!==a?void 0!==b?(this._debug[a]=b,this):this._debug[a]:this._debug.all}]);c.prototype.arrayToCollection=function(e){return(new a).setData(e)};c.prototype.on=function(a,b){this._listeners=this._listeners||{};this._listeners[a]=
this._listeners[a]||[];this._listeners[a].push(b);return this};c.prototype.off=function(a,b){if(a in this._listeners){var c=this._listeners[a],f=c.indexOf(b);-1<f&&c.splice(f,1)}return this};c.prototype.emit=function(a,b){this._listeners=this._listeners||{};if(a in this._listeners){var c=this._listeners[a],f=c.length,d;for(d=0;d<f;d++)c[d].apply(this,Array.prototype.slice.call(arguments,1))}return this};c.prototype.objectId=function(a){var b,c,f=Math.pow(10,17),d;if(a){b=0;c=a.length;for(d=0;d<c;d++)b+=
a.charCodeAt(d)*f;a=b.toString(16)}else g.idCounter++,a=(g.idCounter+(Math.random()*f+Math.random()*f+Math.random()*f+Math.random()*f)).toString(16);return a};c.prototype.peek=function(a){var b,c,f=[],d=typeof a;for(b in this._collection)this._collection.hasOwnProperty(b)&&(c=this._collection[b],f="string"===d?f.concat(c.peek(a)):f.concat(c.find(a)));return f};c.prototype.peekCat=function(a){var b,c,f={},d,g=typeof a;for(b in this._collection)this._collection.hasOwnProperty(b)&&(c=this._collection[b],
(d="string"===g?c.peek(a):c.find(a))&&d.length&&(f[c.name()]=d));return f};p.exports=c},{"./Collection.js":2,"./Crc.js":5,"./Metrics.js":8,"./Overload.js":10,"./Shared.js":12}],5:[function(k,p,m){var g=function(){var a=[],c,e,b;for(e=0;256>e;e++){c=e;for(b=0;8>b;b++)c=c&1?3988292384^c>>>1:c>>>1;a[e]=c}return a}();p.exports=function(a){var c=-1,e;for(e=0;e<a.length;e++)c=c>>>8^g[(c^a.charCodeAt(e))&255];return(c^-1)>>>0}},{}],6:[function(k,p,m){m=k("./Shared");var g=k("./Path");k=function(){this.init.apply(this,
arguments)};k.prototype.init=function(a,c,e){this._crossRef={};this._size=0;this._id=this._itemKeyHash(a,a);this.data({});this.unique(c&&c.unique?c.unique:!1);void 0!==a&&this.keys(a);void 0!==e&&this.collection(e);this.name(c&&c.name?c.name:this._id)};m.addModule("Index",k);m.inherit(k.prototype,m.chainSystem);k.prototype.id=function(){return this._id};k.prototype.state=function(){return this._state};k.prototype.size=function(){return this._size};k.prototype.data=function(a){return void 0!==a?(this._data=
a,this):this._data};k.prototype.name=function(a){return void 0!==a?(this._name=a,this):this._name};k.prototype.collection=function(a){return void 0!==a?(this._collection=a,this):this._collection};k.prototype.keys=function(a){return void 0!==a?(this._keys=a,this._keyCount=(new g).parse(this._keys).length,this):this._keys};k.prototype.type=function(a){return void 0!==a?(this._type=a,this):this._type};k.prototype.unique=function(a){return void 0!==a?(this._unique=a,this):this._unique};k.prototype.rebuild=
function(){if(this._collection){var a=this._collection.subset({},{$decouple:!1,$orderBy:this._keys}).find(),c,e=a.length;this._data={};this._unique&&(this._uniqueLookup={});for(c=0;c<e;c++)this.insert(a[c])}this._state={name:this._name,keys:this._keys,indexSize:this._size,built:new Date,updated:new Date,ok:!0}};k.prototype.insert=function(a,c){var e,b;this._unique&&(e=this._itemHash(a,this._keys),this._uniqueLookup[e]=a);e=this._itemHashArr(a,this._keys);for(b=0;b<e.length;b++)this.pushToPathValue(e[b],
a)};k.prototype.remove=function(a,c){var e,b;this._unique&&(e=this._itemHash(a,this._keys),delete this._uniqueLookup[e]);e=this._itemHashArr(a,this._keys);for(b=0;b<e.length;b++)this.pullFromPathValue(e[b],a)};k.prototype.violation=function(a){a=this._itemHash(a,this._keys);return Boolean(this._uniqueLookup[a])};k.prototype.hashViolation=function(a){return Boolean(this._uniqueLookup[a])};k.prototype.pushToPathValue=function(a,c){var e=this._data[a]=this._data[a]||[];-1===e.indexOf(c)&&(e.push(c),
this._size++,this.pushToCrossRef(c,e))};k.prototype.pullFromPathValue=function(a,c){var e=this._data[a],b;b=e.indexOf(c);-1<b&&(e.splice(b,1),this._size--,this.pullFromCrossRef(c,e));e.length||delete this._data[a]};k.prototype.pull=function(a){var c=a[this._collection.primaryKey()],e=this._crossRef[c],b,g=e.length,f;for(b=0;b<g;b++)f=e[b],this._pullFromArray(f,a);this._size--;delete this._crossRef[c]};k.prototype._pullFromArray=function(a,c){for(var e=a.length;e--;)a[e]===c&&a.splice(e,1)};k.prototype.pushToCrossRef=
function(a,c){var e=a[this._collection.primaryKey()];this._crossRef[e]=this._crossRef[e]||[];e=this._crossRef[e];-1===e.indexOf(c)&&e.push(c)};k.prototype.pullFromCrossRef=function(a,c){var e=a[this._collection.primaryKey()];delete this._crossRef[e]};k.prototype.lookup=function(a){return this._data[this._itemHash(a,this._keys)]||[]};k.prototype.match=function(a,c){return(new g).countObjectPaths(this._keys,a)};k.prototype._itemHash=function(a,c){var e=new g,b,l="",f;b=e.parse(c);for(f=0;f<b.length;f++)l&&
(l+="_"),l+=e.value(a,b[f].path).join(":");return l};k.prototype._itemKeyHash=function(a,c){var e=new g,b,l="",f;b=e.parse(c);for(f=0;f<b.length;f++)l&&(l+="_"),l+=e.keyValue(a,b[f].path);return l};k.prototype._itemHashArr=function(a,c){var e=new g,b,l=[],f,d,h,k;b=e.parse(c);for(h=0;h<b.length;h++)for(f=e.value(a,b[h].path),d=0;d<f.length;d++)if(0===h)l.push(f[d]);else for(k=0;k<l.length;k++)l[k]=l[k]+"_"+f[d];return l};p.exports=k},{"./Path":11,"./Shared":12}],7:[function(k,p,m){k=k("./Shared");
m=function(g){this.init.apply(this,arguments)};m.prototype.init=function(g){this._name=g;this._data={};this._primaryKey="_id"};k.addModule("KeyValueStore",m);k.inherit(m.prototype,k.chainSystem);m.prototype.name=function(g){return void 0!==g?(this._name=g,this):this._name};m.prototype.primaryKey=function(g){return void 0!==g?(this._primaryKey=g,this):this._primaryKey};m.prototype.truncate=function(){this._data={};return this};m.prototype.set=function(g,a){this._data[g]=a?a:!0;return this};m.prototype.get=
function(g){return this._data[g]};m.prototype.lookup=function(g){g=g[this._primaryKey];var a,c,e,b;if(g instanceof Array){c=g.length;b=[];for(a=0;a<c;a++)(e=this._data[g[a]])&&b.push(e);return b}if(g instanceof RegExp){b=[];for(a in this._data)this._data.hasOwnProperty(a)&&g.test(a)&&b.push(this._data[a]);return b}if("object"===typeof g){if(g.$ne){b=[];for(a in this._data)this._data.hasOwnProperty(a)&&a!==g.$ne&&b.push(this._data[a]);return b}if(g.$in&&g.$in instanceof Array){b=[];for(a in this._data)this._data.hasOwnProperty(a)&&
-1<g.$in.indexOf(a)&&b.push(this._data[a]);return b}if(g.$nin&&g.$nin instanceof Array){b=[];for(a in this._data)this._data.hasOwnProperty(a)&&-1===g.$nin.indexOf(a)&&b.push(this._data[a]);return b}if(g.$or&&g.$or instanceof Array){b=[];for(a=0;a<g.$or.length;a++)b=b.concat(this.lookup(g.$or[a]));return b}}else return e=this._data[g],void 0!==e?[e]:[]};m.prototype.unSet=function(g){delete this._data[g];return this};m.prototype.uniqueSet=function(g,a){return void 0===this._data[g]?(this._data[g]=a,
!0):!1};p.exports=m},{"./Shared":12}],8:[function(k,p,m){m=k("./Shared");var g=k("./Operation");k=function(){this.init.apply(this,arguments)};k.prototype.init=function(){this._data=[]};m.addModule("Metrics",k);m.inherit(k.prototype,m.chainSystem);k.prototype.create=function(a){a=new g(a);this._enabled&&this._data.push(a);return a};k.prototype.start=function(){this._enabled=!0;return this};k.prototype.stop=function(){this._enabled=!1;return this};k.prototype.clear=function(){this._data=[];return this};
k.prototype.list=function(){return this._data};p.exports=k},{"./Operation":9,"./Shared":12}],9:[function(k,p,m){m=k("./Shared");var g=k("./Path");k=function(a){this.pathSolver=new g;this.counter=0;this.init.apply(this,arguments)};k.prototype.init=function(a){this._data={operation:a,index:{potential:[],used:!1},steps:[],time:{startMs:0,stopMs:0,totalMs:0,process:{}},flag:{},log:[]}};m.addModule("Operation",k);m.inherit(k.prototype,m.chainSystem);k.prototype.start=function(){this._data.time.startMs=
(new Date).getTime()};k.prototype.log=function(a){if(a){var c=0<this._log.length?this._data.log[this._data.log.length-1].time:0;a={event:a,time:(new Date).getTime(),delta:0};this._data.log.push(a);c&&(a.delta=a.time-c);return this}return this._data.log};k.prototype.time=function(a){if(void 0!==a){var c=this._data.time.process,c=c[a]=c[a]||{};c.startMs?(c.stopMs=(new Date).getTime(),c.totalMs=c.stopMs-c.startMs,c.stepObj.totalMs=c.totalMs,delete c.stepObj):(c.startMs=(new Date).getTime(),c.stepObj=
{name:a},this._data.steps.push(c.stepObj));return this}return this._data.time};k.prototype.flag=function(a,c){if(void 0!==a&&void 0!==c)this._data.flag[a]=c;else return void 0!==a?this._data.flag[a]:this._data.flag};k.prototype.data=function(a,c,e){return void 0!==c?(this.pathSolver.set(this._data,a,c),this):this.pathSolver.get(this._data,a)};k.prototype.pushData=function(a,c,e){this.pathSolver.push(this._data,a,c)};k.prototype.stop=function(){this._data.time.stopMs=(new Date).getTime();this._data.time.totalMs=
this._data.time.stopMs-this._data.time.startMs};p.exports=k},{"./Path":11,"./Shared":12}],10:[function(k,p,m){m=function(g){if(g){var a,c=g.length;return function(){for(a=0;a<c;a++)if(g[a].length===arguments.length)return g[a].apply(this,arguments);return null}}return function(){}};k("./Shared").addModule("Overload",m);p.exports=m},{"./Shared":12}],11:[function(k,p,m){k=k("./Shared");m=function(g){this.init.apply(this,arguments)};m.prototype.init=function(g){g&&this.path(g)};k.addModule("Path",m);
k.inherit(m.prototype,k.chainSystem);m.prototype.path=function(g){return void 0!==g?(this._path=this.clean(g),this._pathParts=this._path.split("."),this):this._path};m.prototype.hasObjectPaths=function(g,a){var c=!0,e;for(e in g)if(g.hasOwnProperty(e)&&(void 0===a[e]||"object"===typeof g[e]&&(c=this.hasObjectPaths(g[e],a[e]),!c)))return!1;return c};m.prototype.countKeys=function(g){var a=0,c;for(c in g)g.hasOwnProperty(c)&&void 0!==g[c]&&("object"!==typeof g[c]?a++:a+=this.countKeys(g[c]));return a};
m.prototype.countObjectPaths=function(g,a){var c,e={},b=0,l=0,f;for(f in a)a.hasOwnProperty(f)&&("object"===typeof a[f]?(c=this.countObjectPaths(g[f],a[f]),e[f]=c.matchedKeys,l+=c.totalKeyCount,b+=c.matchedKeyCount):(l++,g&&g[f]&&"object"!==typeof g[f]?(e[f]=!0,b++):e[f]=!1));return{matchedKeys:e,matchedKeyCount:b,totalKeyCount:l}};m.prototype.parse=function(g,a){var c=[],e="",b,l,f;for(l in g)if(g.hasOwnProperty(l))if(e=l,"object"===typeof g[l])if(a)for(b=this.parse(g[l],a),f=0;f<b.length;f++)c.push({path:e+
"."+b[f].path,value:b[f].value});else for(b=this.parse(g[l]),f=0;f<b.length;f++)c.push({path:e+"."+b[f].path});else a?c.push({path:e,value:g[l]}):c.push({path:e});return c};m.prototype.parseArr=function(g,a){a=a||{};return this._parseArr(g,"",[],a)};m.prototype._parseArr=function(g,a,c,e){var b,l="";a=a||"";c=c||[];for(b in g)g.hasOwnProperty(b)&&(!e.ignore||e.ignore&&!e.ignore.test(b))&&(l=a?a+"."+b:b,"object"===typeof g[b]?this._parseArr(g[b],l,c,e):c.push(l));return c};m.prototype.value=function(g,
a){if(void 0!==g&&"object"===typeof g){var c,e,b,l,f=[],d;void 0!==a&&(a=this.clean(a),c=a.split("."));c=c||this._pathParts;e=c.length;b=g;for(d=0;d<e;d++){b=b[c[d]];if(l instanceof Array){for(e=0;e<l.length;e++)f=f.concat(this.value(l,e+"."+c[d]));return f}if(!b||"object"!==typeof b)break;l=b}return[b]}return[]};m.prototype.set=function(g,a,c){if(void 0!==g&&void 0!==a){var e;a=this.clean(a);a=a.split(".");e=a.shift();a.length?(g[e]=g[e]||{},this.set(g[e],a.join("."),c)):g[e]=c}return g};m.prototype.get=
function(g,a){return this.value(g,a)[0]};m.prototype.push=function(g,a,c){if(void 0!==g&&void 0!==a){var e;a=this.clean(a);a=a.split(".");e=a.shift();if(a.length)g[e]=g[e]||{},this.set(g[e],a.join("."),c);else if(g[e]=g[e]||[],g[e]instanceof Array)g[e].push(c);else throw"Cannot push to a path whose endpoint is not an array!";}return g};m.prototype.keyValue=function(g,a){var c,e,b,l,f;void 0!==a&&(a=this.clean(a),c=a.split("."));c=c||this._pathParts;e=c.length;b=g;for(f=0;f<e;f++)if(b=b[c[f]],!b||
"object"!==typeof b){l=c[f]+":"+b;break}return l};m.prototype.clean=function(g){"."===g.substr(0,1)&&(g=g.substr(1,g.length-1));return g};p.exports=m},{"./Shared":12}],12:[function(k,p,m){p.exports={idCounter:0,modules:{},addModule:function(g,a){this.modules[g]=a},inherit:function(g,a){for(var c in a)a.hasOwnProperty(c)&&(g[c]=a[c])},chainSystem:{chain:function(g){this._chain=this._chain||[];-1===this._chain.indexOf(g)&&this._chain.push(g)},unChain:function(g){this._chain&&(g=this._chain.indexOf(g),
-1<g&&this._chain.splice(g,1))},chainSend:function(g,a,c){if(this._chain){var e=this._chain,b=e.length,l;for(l=0;l<b;l++)e[l].chainReceive(this,g,a,c)}},chainReceive:function(g,a,c,e){(!this._chainHandler||this._chainHandler&&!this._chainHandler(g,a,c,e))&&this.chainSend(a,c,e)}}}},{}],13:[function(k,p,m){var g,a,c;m=k("./Shared");var e=function(b,a,f){this.init.apply(this,arguments)};e.prototype.init=function(b,a,f){this._name=b;this._collections=[];this._groups=[];this._listeners={};this._querySettings=
{query:a,options:f};this._debug={};this._privateData=new g("__FDB__view_privateData_"+this._name)};m.addModule("View",e);m.inherit(e.prototype,m.chainSystem);g=k("./Collection");CollectionGroup=k("./CollectionGroup");k=k("./Overload");a=g.prototype.init;m=m.modules.Core;c=m.prototype.init;e.prototype.debug=new k([function(){return this._debug.all},function(b){return void 0!==b&&"boolean"===typeof b?(this._debug.all=b,this.privateData().debug(b),this.publicData().debug(b),this):this._debug.all},function(b,
a){return void 0!==b?void 0!==a?(this._debug[b]=a,this.privateData().debug(b,a),this.publicData().debug(b,a),this):this._debug[b]:this._debug.all}]);e.prototype.name=function(a){return void 0!==a?(this._name=a,this):this._name};e.prototype.insert=function(){this._collectionsRun("insert",arguments)};e.prototype.update=function(){this._collectionsRun("update",arguments)};e.prototype.updateById=function(){this._collectionsRun("updateById",arguments)};e.prototype.remove=function(){this._collectionsRun("remove",
arguments)};e.prototype._collectionsRun=function(a,c){for(var f=0;f<this._collections.length;f++)this._collections[f][a].apply(this._collections[f],c)};e.prototype.find=function(a,c){return this.publicData().find(a,c)};e.prototype.link=function(a,c){var f=this.publicData();this.debug()&&console.log('ForerunnerDB.View: Setting up data binding on view "'+this.name()+'" in underlying (internal) view collection "'+f.name()+'" for output target: '+a);return f.link(a,c)};e.prototype.unlink=function(a,c){var f=
this.publicData();this.debug()&&console.log('ForerunnerDB.View: Removing data binding on view "'+this.name()+'" in underlying (internal) view collection "'+f.name()+'" for output target: '+a);return f.unlink(a,c)};e.prototype.from=function(a){void 0!==a&&("string"===typeof a&&(a=this._db.collection(a)),this._addCollection(a));return this};e.prototype._addCollection=function(a){if(-1===this._collections.indexOf(a)){this._collections.push(a);a.chain(this);var c=a.find(this._querySettings.query,this._querySettings.options);
this._transformPrimaryKey(a.primaryKey());this._transformInsert(c);this._privateData.primaryKey(a.primaryKey());this._privateData.insert(c)}return this};e.prototype._removeCollection=function(a){-1<this._collections.indexOf(a)&&(this._collections.splice(a,1),a.unChain(this),this._privateData.remove(a.find(this._querySettings.query,this._querySettings.options)));return this};e.prototype._chainHandler=function(a,c,f,d){var e,g;switch(c){case "setData":this.debug()&&console.log('ForerunnerDB.View: Setting data on view "'+
this.name()+'" in underlying (internal) view collection "'+this._privateData.name()+'"');f=this._privateData.decouple(f);this._transformSetData(f);this._privateData.setData(f);break;case "insert":this.debug()&&console.log('ForerunnerDB.View: Inserting some data on view "'+this.name()+'" in underlying (internal) view collection "'+this._privateData.name()+'"');f=this._privateData.decouple(f);if(this._querySettings.options&&this._querySettings.options.$orderBy)if(e=[].concat(this._privateData._data),
(a=f instanceof Array)?e=e.concat(f):e.push(f),e=this._privateData.sort(this._querySettings.options.$orderBy,e),a)for(f.sort(function(a,b){return e.indexOf(a)-e.indexOf(b)}),a=0;a<f.length;a++)c=e.indexOf(f[a]),this._transformInsert(f,c),this._privateData._insertHandle(f,c);else c=e.indexOf(f),this._transformInsert(f,c),this._privateData._insertHandle(f,c);else c=d&&d.index?d.index:this._privateData._data.length,this._transformInsert(f,c),this._privateData._insertHandle(f,c);break;case "update":this.debug()&&
console.log('ForerunnerDB.View: Updating some data on view "'+this.name()+'" in underlying (internal) view collection "'+this._privateData.name()+'"');f=this._privateData.update(f.query,f.update,f.options);if(this._querySettings.options&&this._querySettings.options.$orderBy)for(e=[].concat(this._privateData._data),e=this._privateData.sort(this._querySettings.options.$orderBy,e),f.sort(function(a,b){return e.indexOf(a)-e.indexOf(b)}),a=0;a<f.length;a++)d=this._privateData._data.indexOf(f[a]),c=e.indexOf(f[a]),
this._privateData._updateSpliceMove(this._privateData._data,d,c);if(this._transformEnabled&&this._transformIn)for(c=this._publicData.primaryKey(),a=0;a<f.length;a++)d={},g=f[a],d[c]=g[c],this._transformUpdate(d,g);break;case "remove":this.debug()&&console.log('ForerunnerDB.View: Removing some data on view "'+this.name()+'" in underlying (internal) view collection "'+this._privateData.name()+'"'),this._transformRemove(f.query,d),this._privateData.remove(f.query,d)}};e.prototype.on=function(){this._privateData.on.apply(this._privateData,
arguments)};e.prototype.off=function(){this._privateData.off.apply(this._privateData,arguments)};e.prototype.emit=function(){this._privateData.emit.apply(this._privateData,arguments)};e.prototype.drop=function(){if(this._collections&&this._collections.length){(this.debug()||this._db&&this._db.debug())&&console.log("ForerunnerDB.View: Dropping view "+this._name);for(var a=this._collections.length;a--;)this._removeCollection(this._collections[a]);this._privateData.drop();return!0}return!1};e.prototype.db=
function(a){return void 0!==a?(this._db=a,this.privateData().db(a),this.publicData().db(a),this):this._db};e.prototype.primaryKey=function(){return this._privateData.primaryKey()};e.prototype.queryData=function(a,c,f){void 0!==a&&(this._querySettings.query=a);void 0!==c&&(this._querySettings.options=c);return void 0!==a||void 0!==c?(void 0!==f&&!0!==f||this.refresh(),this):this._querySettings};e.prototype.queryAdd=function(a,c,f){var d=this._querySettings.query,e;if(void 0!==a)for(e in a)a.hasOwnProperty(e)&&
(void 0===d[e]||void 0!==d[e]&&c)&&(d[e]=a[e]);void 0!==f&&!0!==f||this.refresh()};e.prototype.queryRemove=function(a,c){var e=this._querySettings.query,d;if(void 0!==a)for(d in a)a.hasOwnProperty(d)&&delete e[d];void 0!==c&&!0!==c||this.refresh()};e.prototype.query=function(a,c){return void 0!==a?(this._querySettings.query=a,void 0!==c&&!0!==c||this.refresh(),this):this._querySettings.query};e.prototype.queryOptions=function(a,c){return void 0!==a?(this._querySettings.options=a,void 0===a.$decouple&&
(a.$decouple=!0),void 0!==c&&!0!==c||this.refresh(),this):this._querySettings.options};e.prototype.refresh=function(a){var c;a=this.publicData();var e;this._privateData.remove();a.remove();for(e=0;e<this._collections.length;e++)c=this._collections[e],this._privateData.insert(c.find(this._querySettings.query,this._querySettings.options));c=this._privateData.find({},this._querySettings.options);a._linked?jQuery.observable(a._data).refresh(c):(this._privateData._data.length=0,this._privateData._data=
this._privateData._data.concat(c));return this};e.prototype.count=function(){return this._privateData&&this._privateData._data?this._privateData._data.length:0};e.prototype.transform=function(a){return void 0!==a?("object"===typeof a?(void 0!==a.enabled&&(this._transformEnabled=a.enabled),void 0!==a.dataIn&&(this._transformIn=a.dataIn),void 0!==a.dataOut&&(this._transformOut=a.dataOut)):this._transformEnabled=!1===a?!1:!0,this._transformPrimaryKey(this.privateData().primaryKey()),this._transformSetData(this.privateData().find()),
this):{enabled:this._transformEnabled,dataIn:this._transformIn,dataOut:this._transformOut}};e.prototype.privateData=function(){return this._privateData};e.prototype.publicData=function(){return this._transformEnabled?this._publicData:this._privateData};e.prototype._transformSetData=function(a){this._transformEnabled&&(this._publicData=new g("__FDB__view_publicData_"+this._name),this._publicData.db(this._privateData._db),this._publicData.transform({enabled:!0,dataIn:this._transformIn,dataOut:this._transformOut}),
this._publicData.setData(a))};e.prototype._transformInsert=function(a,c){this._transformEnabled&&this._publicData&&this._publicData.insert(a,c)};e.prototype._transformUpdate=function(a,c,e){this._transformEnabled&&this._publicData&&this._publicData.update(a,c,e)};e.prototype._transformRemove=function(a,c){this._transformEnabled&&this._publicData&&this._publicData.remove(a,c)};e.prototype._transformPrimaryKey=function(a){this._transformEnabled&&this._publicData&&this._publicData.primaryKey(a)};g.prototype.init=
function(){this._views=[];a.apply(this,arguments)};g.prototype.view=function(a,c,f){a=(new e(a,c,f)).db(this._db)._addCollection(this);this._views=this._views||[];this._views.push(a);return a};g.prototype._addView=CollectionGroup.prototype._addView=function(a){void 0!==a&&this._views.push(a);return this};g.prototype._removeView=CollectionGroup.prototype._removeView=function(a){void 0!==a&&(a=this._views.indexOf(a),-1<a&&this._views.splice(a,1));return this};m.prototype.init=function(){this._views=
{};c.apply(this,arguments)};m.prototype.view=function(a){this._views[a]||(this.debug()||this._db&&this._db.debug())&&console.log("Core.View: Creating view "+a);this._views[a]=this._views[a]||(new e(a)).db(this);return this._views[a]};m.prototype.viewExists=function(a){return Boolean(this._views[a])};m.prototype.views=function(){var a=[],c;for(c in this._views)this._views.hasOwnProperty(c)&&a.push({name:c,count:this._views[c].count()});return a};p.exports=e},{"./Collection":2,"./CollectionGroup":3,
"./Overload":10,"./Shared":12}]},{},[1])(1)});
